<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Accept Admin Invite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #0f0f0f;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .box {
      background: #1c1c1c;
      padding: 24px;
      border-radius: 12px;
      width: 100%;
      max-width: 420px;
    }
    h2 {
      margin-bottom: 12px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
    }
    button {
      background: #4caf50;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    .error {
      color: #ff6b6b;
      margin-top: 10px;
    }
    .success {
      color: #4caf50;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="box">
    <h2>üîê Accept Admin Invite</h2>
    <p id="info"></p>

    <form id="acceptForm" class="hidden">
      <input
        type="password"
        id="password"
        placeholder="Set password (min 6 chars)"
        required
      />
      <button type="submit">Create Account</button>
    </form>

    <div id="msg"></div>
     <div style="margin-top:16px; text-align:center;">
  <p style="font-size:14px; color:#555; margin-bottom:6px;">
    Have Amin Account?
  </p>
  <a
    href="admin-login.html"
    style="
      display:inline-block;
      padding:8px 14px;
      background:#1677ff;
      color:#fff;
      border-radius:6px;
      text-decoration:none;
      font-weight:600;
      font-size:14px;
    "
  >
    Login Admin
  </a>
    </div>
</div>

<script src="db-core.js"></script>

<script>
/* ======================================================
   DOM
====================================================== */
const info = document.getElementById("info");
const msg = document.getElementById("msg");
const form = document.getElementById("acceptForm");

/* ======================================================
   TOKEN
====================================================== */
const params = new URLSearchParams(location.search);
const token = params.get("token");

if (!token) {
  msg.innerHTML = "<div class='error'>‚ùå Invalid invite link</div>";
  throw new Error("Missing token");
}

/* ======================================================
   LOAD INVITE FROM DB
====================================================== */
let invite;

(async () => {
  const invites = await dbGetAll("admin_invites");
  invite = invites.find(i => i.token === token && i.status === "pending");

  if (!invite) {
    msg.innerHTML =
      "<div class='error'>‚ùå Invite not found or already used</div>";
    return;
  }

  info.innerHTML = `
    ‚úÖ You are invited as <b>${invite.role.replaceAll("_", " ")}</b><br>
    Email: <b>${invite.email}</b>
  `;

  form.classList.remove("hidden");
})();

/* ======================================================
   PIN UTILS
====================================================== */
function generatePIN() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

async function hashPIN(pin) {
  const data = new TextEncoder().encode(pin);
  const hash = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(hash))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

/* ======================================================
   ACCEPT INVITE
====================================================== */
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  msg.innerHTML = "";

  if (!invite) return;

  const pin = generatePIN();
  const pinHash = await hashPIN(pin);
  const now = Date.now();

  /* ================= CREATE ADMIN ================= */
  const admin = {
    id: "ADM-" + crypto.randomUUID(),
    email: invite.email,
    role: invite.role,
    restoID: invite.restoID,

    pinHash,
    pinUsed: false,

    status: "active",
    createdAt: now
  };

  await dbPut("admins", admin);

  /* ================= CLOSE INVITE ================= */
  invite.status = "accepted";
  invite.acceptedAt = now;
  await dbPut("admin_invites", invite);

  /* ================= RESULT ================= */
  msg.innerHTML = `
    <div class="success">
      ‚úÖ Account activated<br><br>
      üîê <b>Your One-Time PIN:</b><br>
      <div style="font-size:22px;letter-spacing:4px;margin:10px 0;">
        ${pin}
      </div>
      <small>Save this PIN. It will be required for approvals.</small>
    </div>
  `;
});
</script>


</body>
</html>


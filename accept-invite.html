<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Accept Admin Invite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #0f0f0f;
      color: #fff;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .box {
      background: #1c1c1c;
      padding: 24px;
      border-radius: 12px;
      width: 100%;
      max-width: 420px;
    }
    h2 {
      margin-bottom: 12px;
    }
    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
    }
    button {
      background: #4caf50;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }
    .error {
      color: #ff6b6b;
      margin-top: 10px;
    }
    .success {
      color: #4caf50;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="box">
    <h2>üîê Accept Admin Invite</h2>
    <p id="info"></p>

    <form id="acceptForm" class="hidden">
      <input
        type="password"
        id="password"
        placeholder="Set password (min 6 chars)"
        required
      />
      <button type="submit">Create Account</button>
    </form>

    <div id="msg"></div>
     <div style="margin-top:16px; text-align:center;">
  <p style="font-size:14px; color:#555; margin-bottom:6px;">
    Have Amin Account?
  </p>
  <a
    href="admin-login.html"
    style="
      display:inline-block;
      padding:8px 14px;
      background:#1677ff;
      color:#fff;
      border-radius:6px;
      text-decoration:none;
      font-weight:600;
      font-size:14px;
    "
  >
    Login Admin
  </a>
    </div>
</div>

<script src="./db-core.js"></script>
<script>
/* ======================================================
   DOM
====================================================== */
const info = document.getElementById("info");
const msg = document.getElementById("msg");
const form = document.getElementById("acceptForm");

/* ======================================================
   TOKEN
====================================================== */
const token = new URLSearchParams(location.search).get("token");

if (!token) {
  msg.innerHTML = "<div class='error'>‚ùå Invalid invite link</div>";
  throw new Error("Missing token");
}

/* ======================================================
   ROLE CONFIG
====================================================== */
const NEED_PIN_KEYWORDS = ["supervisor", "manager", "general_manager"];

const ROLE_REDIRECT = {
  cashier: "recieves.html",

  kitchen_admin: "menu-manager.html",
  kitchen_supervisor: "menu-manager.html",
  kitchen_manager: "menu-manager.html",

  bar_admin: "drink-manager.html",
  bar_supervisor: "drink-manager.html",
  bar_manager: "drink-manager.html",

  room_admin: "room-manager.html",

  front_office_supervisor: "recieves.html",
  front_office_manager: "recieves.html",

  general_manager: "admin.html"
};

/* ======================================================
   PIN UTILS
====================================================== */
function generatePIN() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}

function hashPIN(pin) {
  return btoa(pin); // konsisten dengan sistem lu
}

let invite = null;

(async () => {
  if (!window.MENUVA_DB) {
    msg.innerHTML = "<div class='error'>‚ùå DB Core not ready</div>";
    return;
  }

  const token = new URLSearchParams(location.search).get("token");
  if (!token) {
    msg.innerHTML = "<div class='error'>‚ùå Invalid invite link</div>";
    return;
  }

  const invites = await MENUVA_DB.getAll("admin_invites");

  invite = invites.find(
    i => i.token === token && i.status === "pending"
  );

  if (!invite) {
    msg.innerHTML =
      "<div class='error'>‚ùå Invite tidak ditemukan / sudah dipakai</div>";
    return;
  }

  info.innerHTML = `
    ‚úÖ Anda diundang sebagai <b>${invite.role.replaceAll("_"," ")}</b><br>
    Email: <b>${invite.email}</b>
  `;

  form.classList.remove("hidden");
})();


/* ======================================================
   ACCEPT INVITE
====================================================== */
form.addEventListener("submit", async e => {
  e.preventDefault();
  msg.innerHTML = "";

  if (!invite) return;

  const now = Date.now();

  let pin = null;
  let pinHash = null;

  if (isSupervisorUp(invite.role)) {
    pin = Math.floor(100000 + Math.random() * 900000).toString();
    const enc = new TextEncoder().encode(pin);
    const hash = await crypto.subtle.digest("SHA-256", enc);
    pinHash = Array.from(new Uint8Array(hash))
      .map(b => b.toString(16).padStart(2,"0"))
      .join("");
  }

  const admin = {
    id: "ADM-" + crypto.randomUUID(),
    email: invite.email,
    role: invite.role,
    restoID: invite.restoID,
    status: "active",
    createdAt: now,

    ...(pinHash ? { pinHash, pinUsed:false } : {})
  };

  await MENUVA_DB.add("admins", admin);

  invite.status = "accepted";
  invite.acceptedAt = now;
  await MENUVA_DB.add("admin_invites", invite);

  await MENUVA_DB.setSession({
    userID: admin.id,
    email: admin.email,
    role: admin.role,
    restoID: admin.restoID
  });

  msg.innerHTML = `
    <div class="success">
      ‚úÖ Akun admin aktif<br>
      ${pin ? `<b>üîê PIN Anda:</b><div style="font-size:22px">${pin}</div>` : ""}
      <br>Redirecting...
    </div>
  `;

  setTimeout(() => {
    location.replace(getAdminRedirect(admin.role));
  }, 1800);
});


  function isSupervisorUp(role) {
  return role.includes("supervisor")
      || role.includes("manager")
      || role === "general_manager";
}

function getAdminRedirect(role) {
  if (role.includes("kitchen")) return "kitchen.html";
  if (role.includes("bar")) return "bar.html";
  if (role.includes("room")) return "room.html";
  if (role.includes("finance")) return "finance.html";
  if (role.includes("inventory")) return "inventory.html";
  return "admin.html";
}

</script>

</body>
</html>


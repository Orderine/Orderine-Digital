<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receives - Admin</title>

<style>
/* copy root theme & base dari template lo */
:root{
  --bg: #f4f8ff;
  --surface: #ffffff;
  --text: #1f2a44;
  --muted: #6b7a99;
  --border: #d8e1ff;
  --brand: #1f70ff;
  --brand-2: #2a5298;
  --brand-3: #1e3c72;
  --chip: #eef4ff;
  --danger: #e54646;
  --success: #25d366;
  --shadow: 0 6px 24px rgba(0,0,0,.08);
  --qty-btn-bg: #eef4ff;
  --qty-btn-text: #1f2a44;
  --container-max: 1200px;
}
body.dark-mode{
  --bg: #0e1116;
  --surface: #141922;
  --text: #e6ebff;
  --muted: #aab6db;
  --border: #263148;
  --brand: #4da3ff;
  --chip: #0f1a2a;
  --shadow: 0 8px 28px rgba(0,0,0,.5);
  --qty-btn-bg: #263148;
  --qty-btn-text: #e6ebff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family: Inter, system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background .25s, color .25s;
}

/* header */
header{
  background: linear-gradient(90deg,var(--brand-2),var(--brand-3));
  color:#fff;
  padding:16px;
  box-shadow:var(--shadow);
}
.header-inner{display:flex;align-items:center;justify-content:space-between}
#restoLogo{height:50px;width:50px;border-radius:8px;object-fit:contain;background:rgba(255,255,255,.15)}
#restoName{margin:0;font-size:18px;font-weight:800}
.dark-toggle{
  background:rgba(255,255,255,0.12);
  border:none;
  font-size:1.2rem;
  cursor:pointer;
  color:#fff;
  padding:6px 8px;
  border-radius:6px;
}

/* order list */
.container{max-width:var(--container-max);margin:20px auto;padding:0 16px}
.order-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:16px;
  margin-bottom:20px;
}
.order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.order-header h3{margin:0;font-size:16px;font-weight:800}
.order-meta{font-size:13px;color:var(--muted);margin-bottom:8px}
.order-items{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
.order-item{display:flex;justify-content:space-between;margin-bottom:6px;font-size:14px}
.order-summary{margin-top:10px;font-weight:700;font-size:14px}
.order-actions{margin-top:12px;display:flex;gap:8px}
.btn{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:0}
.btn-print{background:var(--brand);color:#fff}
.btn-void{background:var(--danger);color:#fff}

  .theme-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1.4rem;
  transition: transform 0.2s ease;
}
.theme-btn:hover {
  transform: scale(1.2);
}
* {
  transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}
.date-btn {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  box-shadow: var(--shadow);
}
.date-btn.active {
  background: var(--brand);
  color: #fff;
}
.date-btn:hover {
  opacity: 0.85;
}
.order-note {
  margin: 6px 0;
  padding: 6px 10px;
  background: rgba(255, 255, 0, 0.1);
  border-left: 3px solid orange;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.4;
  white-space: pre-wrap; /* biar line break di notes muncul */
}
.new-order-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #222;
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  opacity: 0;
  transform: translateY(30px);
  transition: all 0.4s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 9999;
}
.new-order-toast.show {
  opacity: 1;
  transform: translateY(0);
}
.toast-icon {
  font-size: 1.4em;
}
  #backToAdmin {
  text-align: left;
  margin: 12px 0 16px 12px;
}

#backToAdmin button {
  background-color: var(--accent, #2563eb);
  color: white;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: 0.25s;
}

#backToAdmin button:hover {
  background-color: #1e40af;
  transform: scale(1.03);
}

/* ===== VOID AUTH MODAL ===== */
.modal {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at top, rgba(0,0,0,.55), rgba(0,0,0,.85));
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  animation: fadeIn .25s ease;
}

.modal.hidden {
  display: none;
}

.modal-box {
  background: linear-gradient(180deg, #ffffff, #f6f7f9);
  border-radius: 16px;
  width: 100%;
  max-width: 360px;
  padding: 22px 22px 18px;
  box-shadow:
    0 20px 40px rgba(0,0,0,.35),
    inset 0 1px 0 rgba(255,255,255,.8);
  animation: slideUp .25s ease;
}

.modal-box h3 {
  margin: 0 0 6px;
  font-size: 18px;
  font-weight: 700;
  text-align: center;
}

.modal-box p {
  margin: 0 0 14px;
  font-size: 13px;
  color: #666;
  text-align: center;
}

/* PIN INPUT */
#voidPinInput {
  width: 100%;
  padding: 12px 14px;
  font-size: 18px;
  letter-spacing: 4px;
  text-align: center;
  border-radius: 12px;
  border: 1px solid #ddd;
  outline: none;
  transition: .2s;
}

#voidPinInput:focus {
  border-color: #ff4d4f;
  box-shadow: 0 0 0 3px rgba(255,77,79,.2);
}

/* ACTIONS */
.modal-actions {
  margin-top: 18px;
  display: flex;
  gap: 10px;
}

.modal-actions button {
  flex: 1;
  padding: 10px 0;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: .2s;
}

/* CANCEL */
#voidCancelBtn {
  background: #e9e9e9;
  color: #555;
}

#voidCancelBtn:hover {
  background: #ddd;
}

/* CONFIRM */
#voidConfirmBtn {
  background: linear-gradient(135deg, #ff4d4f, #d9363e);
  color: white;
  box-shadow: 0 6px 14px rgba(255,77,79,.4);
}

#voidConfirmBtn:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 20px rgba(255,77,79,.5);
}

/* ANIMATIONS */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(20px) scale(.96); opacity: 0; }
  to { transform: translateY(0) scale(1); opacity: 1; }
}

  #voidReasonSelect,
#voidReasonOther {
  width: 100%;
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid #ddd;
  font-size: 14px;
}

#voidReasonSelect:focus,
#voidReasonOther:focus {
  border-color: #ff4d4f;
  outline: none;
}


</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="restoLogo" alt="Logo">
      <div>
        <h1 id="restoName">Loading...</h1>
        <p id="restoAddress" style="font-size:12px;margin:2px 0 0;opacity:0.8"></p>
        <p id="restoPhone" style="font-size:12px;margin:0;opacity:0.8"></p>
      </div>
    </div>
   <button id="themeToggle" class="theme-btn" aria-label="Toggle Dark Mode">
  <span id="themeIcon">üåô</span>
</button>

  </div>
</header>

<main class="container">
  <h2 style="margin-bottom:16px">üì• Incoming Orders</h2>
  <div id="ordersBox"></div>
</main>
  
<!-- Tombol kembali -->
<button id="btnBackToAdmin" style="display:none;">
  ‚¨Ö Back to Admin
</button>


  <div id="voidAuthModal" class="modal hidden">
  <div class="modal-box">
    <h3>üîê Otorisasi Void</h3>
    <p>Masukkan PIN Supervisor</p>

    <input
      type="password"
      id="voidPinInput"
      placeholder="PIN Supervisor"
      autocomplete="off"
    />

    <div id="voidPinMsg" class="text-red"></div>


    <select id="voidReasonSelect">
  <option value="">-- Pilih Alasan Void --</option>
  <option value="Salah input">Salah input</option>
  <option value="Cancel customer">Cancel customer</option>
  <option value="Menu habis">Menu habis</option>
  <option value="Lainnya">Lainnya</option>
</select>

<input
  type="text"
  id="voidReasonOther"
  placeholder="Tulis alasan void..."
  style="display:none"
/>

    <div class="modal-actions">
      <button id="voidCancelBtn">‚ùå Cancel</button>
      <button id="voidConfirmBtn">‚úÖ Lanjut</button>
    </div>
  </div>
</div>

<script src="db-core.js"></script>
<script>
/* =====================================================
   RECEIVES.html ‚Äî FINAL VERSION
   VOID ITEM + PIN AUTH (ADMIN / SUPERVISOR / MANAGER)
===================================================== */

/* ================== UTIL ================== */
async function hashPIN(pin) {
  const enc = new TextEncoder().encode(pin);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

function getTodayDate() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function formatHarga(v) {
  return new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency: "IDR",
    minimumFractionDigits: 0
  }).format(v || 0);
}

/* ================== NOTIFICATION ================== */
function showNewOrderNotification() {
  const n = document.createElement("div");
  n.className = "new-order-toast";
  n.innerHTML = `<div class="toast-icon">üõéÔ∏è</div><div>New Order!</div>`;
  document.body.appendChild(n);
  setTimeout(() => n.classList.add("show"), 50);
  setTimeout(() => n.remove(), 8000);
  try { new Audio("./beep.mp3").play(); } catch {}
}

/* ================== REALTIME ================== */
const bc = new BroadcastChannel("menuvaOrders");
bc.onmessage = e => {
  if (["newOrder","update_orders","order_changed"].includes(e.data?.type)) {
    loadOrders();
    if (e.data.type === "newOrder") showNewOrderNotification();
  }
};
function notifyOrdersUpdated() {
  bc.postMessage({ type:"update_orders" });
}

/* ================== STATE ================== */
let cachedOrders = [];
let activeDate = sessionStorage.getItem("receivesActiveDate");
let pendingVoidAction = null;

/* ================== LOAD DATA ================== */
async function loadOrders() {
  const orders = await MENUVA_DB.getAll("ordersData");
  cachedOrders = orders || [];
  renderOrders(cachedOrders);
}

async function loadRestoInfo() {
  try {
    // üîê SINGLE SOURCE: RESTO DI DB
    const restos = await MENUVA_DB.getAll("restos");

    if (!restos || !restos.length) {
      console.warn("‚ö†Ô∏è Tidak ada data resto di DB");
      return;
    }

    // üëâ asumsi 1 device = 1 resto aktif
    const resto = restos[0];

    document.getElementById("restoName").textContent =
      resto.namaRestoran || "Unknown Resto";

    if (resto.logo)
      document.getElementById("restoLogo").src = resto.logo;

    if (resto.restoAddress)
      document.getElementById("restoAddress").textContent =
        resto.restoAddress;

    if (resto.restoPhone)
      document.getElementById("restoPhone").textContent =
        `üìû ${resto.restoPhone}`;

  } catch (err) {
    console.warn("‚ö†Ô∏è Gagal load resto info:", err);
  }
}


/* ================== RENDER ================== */
function renderOrders(data) {
  const box = document.getElementById("ordersBox");
  box.innerHTML = "";

  if (!data.length) {
    box.innerHTML = `<p style="color:var(--muted)">No orders</p>`;
    return;
  }

  data.sort((a,b)=>(b.orderTime||0)-(a.orderTime||0));
  const dates = [...new Set(data.map(o=>o.date))];
  const today = getTodayDate();
  if (!activeDate || !dates.includes(activeDate))
    activeDate = dates.includes(today) ? today : dates[0];

  sessionStorage.setItem("receivesActiveDate", activeDate);

  box.innerHTML = `
    <div class="filter-bar">
      ${dates.map(d=>`<button class="date-btn ${d===activeDate?'active':''}" data-date="${d}">${d}</button>`).join("")}
    </div>
    <div id="ordersList"></div>
  `;

  box.querySelectorAll(".date-btn").forEach(b=>{
    b.onclick=()=>{ activeDate=b.dataset.date; renderOrders(cachedOrders); };
  });

  renderOrdersByDate(data, activeDate);
}

function renderOrdersByDate(data, date) {
  const list = document.getElementById("ordersList");
  list.innerHTML = "";

  data.filter(o=>o.date===date).forEach(order=>{
    const activeItems = order.items.filter(i=>!i.void);
    order.subtotal = activeItems.reduce((s,i)=>s+(i.total||0),0);
    order.grandTotal = order.subtotal - (order.discount||0);

    const div = document.createElement("div");
    div.className="order-card";
    div.innerHTML = `
      <h3>Table ${order.table||"-"} - ${order.customer||"-"}</h3>
      <small>Order #${order.id}</small>

      <div class="order-items">
        ${order.items.map((i,idx)=>`
          <div class="order-item" ${i.void?'style="opacity:.5;text-decoration:line-through"':''}>
            <span>${i.nama} √ó${i.qty}</span>
            <span>${formatHarga(i.total)}</span>
            ${!i.void?`<button class="void-item-btn" data-order="${order.id}" data-index="${idx}">‚ùå Void</button>`:""}
          </div>
        `).join("")}
      </div>

      <strong>Total: ${formatHarga(order.grandTotal)}</strong>
    `;
    list.appendChild(div);
  });
}

/* ================== VOID AUTH ================== */
async function authorizeVoid(pin) {
  const hash = await hashPIN(pin);
  const admins = await MENUVA_DB.getAll("admins");
  return admins.find(a =>
    ["supervisor","manager"].includes(a.role) &&
    a.voidPinHash === hash
  );
}

/* ================== VOID ACTION ================== */
async function voidOrderItem(orderId, itemIndex, admin, reason) {
  const order = await MENUVA_DB.get("ordersData", orderId);
  if (!order) return alert("Order not found");

  const item = order.items[itemIndex];
  if (!item || item.void) return;

  item.void = true;
  item.total = 0;
  item.voidReason = reason;
  item.voidBy = admin.username;
  item.voidAt = Date.now();

  await MENUVA_DB.add("ordersData", order);
  notifyOrdersUpdated();
  loadOrders();
}

/* ================== MODAL ================== */
function openVoidModal(action) {
  pendingVoidAction = action;
  voidPinInput.value="";
  voidReasonSelect.value="";
  voidReasonOther.value="";
  voidAuthModal.classList.remove("hidden");
}
function closeVoidModal() {
  pendingVoidAction=null;
  voidAuthModal.classList.add("hidden");
}

/* ================== EVENTS ================== */
document.addEventListener("click",e=>{
  if (e.target.classList.contains("void-item-btn")) {
    openVoidModal({
      type:"item",
      orderId:Number(e.target.dataset.order),
      itemIndex:Number(e.target.dataset.index)
    });
  }
});

voidConfirmBtn.onclick = async ()=>{
  const pin = voidPinInput.value.trim();
  if (!pin) return alert("PIN wajib");

  const admin = await authorizeVoid(pin);
  if (!admin) return alert("PIN salah / tidak berwenang");

  const reason = voidReasonSelect.value==="Lainnya"
    ? voidReasonOther.value.trim()
    : voidReasonSelect.value;
  if (!reason) return alert("Alasan wajib");

  if (pendingVoidAction?.type==="item") {
    await voidOrderItem(
      pendingVoidAction.orderId,
      pendingVoidAction.itemIndex,
      admin,
      reason
    );
  }
  closeVoidModal();
};

voidCancelBtn.onclick = closeVoidModal;

/* ================== INIT ================== */
MENUVA_DB.openDB().then(()=>{
  loadRestoInfo();
  loadOrders();
});

</script>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const role = localStorage.getItem("role");
    const btn = document.getElementById("btnBackToAdmin");

    // hanya manager & owner yang boleh lihat
    if (role === "manager" || role === "owner") {
      btn.style.display = "inline-block";
      btn.onclick = goBackToAdmin;
    } else {
      btn.remove(); // üî• lebih aman daripada cuma hide
    }
  });

  function goBackToAdmin() {
    window.location.href = "admin.html";
  }
</script>


</body>
</html>

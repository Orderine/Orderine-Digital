<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receives - Admin</title>

<style>
/* copy root theme & base dari template lo */
:root{
  --bg: #f4f8ff;
  --surface: #ffffff;
  --text: #1f2a44;
  --muted: #6b7a99;
  --border: #d8e1ff;
  --brand: #1f70ff;
  --brand-2: #2a5298;
  --brand-3: #1e3c72;
  --chip: #eef4ff;
  --danger: #e54646;
  --success: #25d366;
  --shadow: 0 6px 24px rgba(0,0,0,.08);
  --qty-btn-bg: #eef4ff;
  --qty-btn-text: #1f2a44;
  --container-max: 1200px;
}
body.dark-mode{
  --bg: #0e1116;
  --surface: #141922;
  --text: #e6ebff;
  --muted: #aab6db;
  --border: #263148;
  --brand: #4da3ff;
  --chip: #0f1a2a;
  --shadow: 0 8px 28px rgba(0,0,0,.5);
  --qty-btn-bg: #263148;
  --qty-btn-text: #e6ebff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family: Inter, system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background .25s, color .25s;
}

/* header */
header{
  background: linear-gradient(90deg,var(--brand-2),var(--brand-3));
  color:#fff;
  padding:16px;
  box-shadow:var(--shadow);
}
.header-inner{display:flex;align-items:center;justify-content:space-between}
#restoLogo{height:50px;width:50px;border-radius:8px;object-fit:contain;background:rgba(255,255,255,.15)}
#restoName{margin:0;font-size:18px;font-weight:800}
.dark-toggle{
  background:rgba(255,255,255,0.12);
  border:none;
  font-size:1.2rem;
  cursor:pointer;
  color:#fff;
  padding:6px 8px;
  border-radius:6px;
}

/* order list */
.container{max-width:var(--container-max);margin:20px auto;padding:0 16px}
.order-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:16px;
  margin-bottom:20px;
}
.order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.order-header h3{margin:0;font-size:16px;font-weight:800}
.order-meta{font-size:13px;color:var(--muted);margin-bottom:8px}
.order-items{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
.order-item{display:flex;justify-content:space-between;margin-bottom:6px;font-size:14px}
.order-summary{margin-top:10px;font-weight:700;font-size:14px}
.order-actions{margin-top:12px;display:flex;gap:8px}
.btn{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:0}
.btn-print{background:var(--brand);color:#fff}
.btn-void{background:var(--danger);color:#fff}

  .theme-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1.4rem;
  transition: transform 0.2s ease;
}
.theme-btn:hover {
  transform: scale(1.2);
}
* {
  transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}
.date-btn {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  box-shadow: var(--shadow);
}
.date-btn.active {
  background: var(--brand);
  color: #fff;
}
.date-btn:hover {
  opacity: 0.85;
}
.order-note {
  margin: 6px 0;
  padding: 6px 10px;
  background: rgba(255, 255, 0, 0.1);
  border-left: 3px solid orange;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.4;
  white-space: pre-wrap; /* biar line break di notes muncul */
}
.new-order-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #222;
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  opacity: 0;
  transform: translateY(30px);
  transition: all 0.4s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 9999;
}
.new-order-toast.show {
  opacity: 1;
  transform: translateY(0);
}
.toast-icon {
  font-size: 1.4em;
}
  #backToAdmin {
  text-align: left;
  margin: 12px 0 16px 12px;
}

#backToAdmin button {
  background-color: var(--accent, #2563eb);
  color: white;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: 0.25s;
}

#backToAdmin button:hover {
  background-color: #1e40af;
  transform: scale(1.03);
}

</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="restoLogo" alt="Logo">
      <div>
        <h1 id="restoName">Loading...</h1>
        <p id="restoAddress" style="font-size:12px;margin:2px 0 0;opacity:0.8"></p>
        <p id="restoPhone" style="font-size:12px;margin:0;opacity:0.8"></p>
      </div>
    </div>
   <button id="themeToggle" class="theme-btn" aria-label="Toggle Dark Mode">
  <span id="themeIcon">üåô</span>
</button>

  </div>
</header>

<main class="container">
  <h2 style="margin-bottom:16px">üì• Incoming Orders</h2>
  <div id="ordersBox"></div>
</main>
  
<!-- Tombol kembali -->
<div id="backToAdmin">
  <button onclick="goBackToAdmin()">‚¨Ö Kembali ke Admin</button>
</div>

<script src="db-core.js"></script>
<script>
  
  function getTodayDate() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}


/* =====================================================
   RECEIEVES ‚Äî PATUH MENUVA_DB (NO DB MANDIRI)
===================================================== */

/* ================== NOTIFIKASI ORDER BARU ================== */
function showNewOrderNotification() {
  const notif = document.createElement('div');
  notif.className = 'new-order-toast';
  notif.innerHTML = `
    <div class="toast-icon">üõéÔ∏è</div>
    <div class="toast-text">New Order!</div>
  `;
  document.body.appendChild(notif);

  setTimeout(() => notif.classList.add('show'), 50);

  setTimeout(() => {
    notif.classList.remove('show');
    setTimeout(() => notif.remove(), 500);
  }, 8000);

  try {
    const audio = new Audio('./beep.mp3');
    audio.volume = 0.6;
    audio.play().catch(() => {
      console.warn('‚ö†Ô∏è Autoplay suara diblokir browser');
    });
  } catch (err) {
    console.warn('‚ö†Ô∏è Gagal play audio:', err);
  }
}

/* ================== REAL-TIME CHANNEL ================== */
const bc = new BroadcastChannel("menuvaOrders");

bc.onmessage = (event) => {
  const type = event.data?.type;

  if (type === 'newOrder' || type === 'update_orders' || type === 'order_changed') {
    console.log('üì° Orders updated:', type);
    loadOrders();

    if (type === 'newOrder') {
      showNewOrderNotification();
    }
  }
};


function notifyOrdersUpdated() {
  bc.postMessage({ type: 'update_orders' });
}

  let audioUnlocked = false;

document.addEventListener('click', () => {
  if (!audioUnlocked) {
    const a = new Audio('./beep.mp3');
    a.volume = 0;
    a.play().then(() => {
      a.pause();
      audioUnlocked = true;
      console.log('üîì Audio unlocked');
    }).catch(() => {});
  }
});


let activeDate = sessionStorage.getItem('receivesActiveDate');
let cachedOrders = [];
let userSelectingDate = false;

async function loadOrders() {
  try {
    const orders = await MENUVA_DB.getAll("ordersData");
    cachedOrders = orders || [];
    renderOrders(cachedOrders);
  } catch (err) {
    console.error('‚ùå loadOrders error:', err);
  }
}


/* ================= LOAD RESTO INFO ================= */
async function loadRestoInfo() {
  try {
    const restoId =
      localStorage.getItem("restoId") ||
      localStorage.getItem("activeRestoId");

    if (!restoId) {
      console.warn("‚ö†Ô∏è restoId tidak ditemukan");
      return;
    }

    const resto = await MENUVA_DB.get("restos", restoId);

    if (!resto) {
      console.warn("‚ö†Ô∏è resto tidak ditemukan di DB");
      return;
    }

    document.getElementById('restoName').textContent =
      resto.namaRestoran || 'Unknown Resto';

    if (resto.logo)
      document.getElementById('restoLogo').src = resto.logo;

    if (resto.restoAddress)
      document.getElementById('restoAddress').textContent = resto.restoAddress;

    if (resto.restoPhone)
      document.getElementById('restoPhone').textContent = `üìû ${resto.restoPhone}`;

  } catch (err) {
    console.warn('‚ö†Ô∏è Gagal load resto info:', err);
  }
}

function renderOrders(data) {
  const box = document.getElementById('ordersBox');
  box.innerHTML = '';

  if (!data.length) {
    box.innerHTML = `<p style="color:var(--muted)">No orders yet.</p>`;
    return;
  }

  cachedOrders = data;

  // urutkan order terbaru
  data.sort((a, b) => (b.orderTime || 0) - (a.orderTime || 0));

  const uniqueDates = [...new Set(data.map(o => o.date))];
  const today = getTodayDate();

  // PRIORITAS ACTIVE DATE
  if (!activeDate || !uniqueDates.includes(activeDate)) {
    activeDate = uniqueDates.includes(today) ? today : uniqueDates[0];
  }

  sessionStorage.setItem('receivesActiveDate', activeDate);

  // === FILTER BAR ===
  const filterBar = document.createElement('div');
  filterBar.className = 'filter-bar';
  filterBar.innerHTML = uniqueDates.map(tgl => `
    <button class="date-btn ${tgl === activeDate ? 'active' : ''}" data-date="${tgl}">
      ${tgl}
    </button>
  `).join('');

  box.appendChild(filterBar);

  // === LIST ===
  const listContainer = document.createElement('div');
  listContainer.id = 'ordersList';
  box.appendChild(listContainer);

  renderOrdersByDate(cachedOrders, activeDate);

  box.querySelectorAll('.date-btn').forEach(btn => {
    btn.onclick = () => {
      activeDate = btn.dataset.date;
      sessionStorage.setItem('receivesActiveDate', activeDate);

      box.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      renderOrdersByDate(cachedOrders, activeDate);
    };
  });
}
  function normalizeDate(d) {
  return (d || '').trim();
}

function renderOrdersByDate(data, date) {
  const list = document.getElementById('ordersList');
  list.innerHTML = '';

  const filtered = data.filter(o => o.date === date);

  if (!filtered.length) {
    list.innerHTML = `<p style="color:var(--muted)">No orders for ${date}</p>`;
    return;
  }

  filtered.forEach(order => {
    // hitung ulang subtotal & grand total
    const activeItems = order.items.filter(i => !i.void);
    order.subtotal = activeItems.reduce((sum, i) => sum + (i.total || 0), 0);
    order.grandTotal = order.subtotal - (order.discount || 0);

    const div = document.createElement('div');
    div.className = 'order-card';
    div.innerHTML = `
      <div class="order-header">
        <h3>Table ${order.table || '-'} - ${order.customer || '-'}</h3>
        <span>${order.time || ''}</span>
      </div>

      <div class="order-meta">
        Order ID: ${order.id} | Status: ${order.status}
      </div>

      ${order.note ? `<div class="order-note">üìù ${order.note}</div>` : ''}

      <div class="order-items">
        ${order.items.map((i, idx) => `
          <div class="order-item" ${i.void ? 'style="opacity:0.5;text-decoration:line-through"' : ''}>
            <span>${i.nama} √ó${i.qty}</span>
            <span>${formatHarga(i.total)}</span>
            ${!i.void ? `
              <button class="void-item-btn"
                data-orderid="${order.id}"
                data-itemindex="${idx}">
                ‚ùå Void Item
              </button>
            ` : ''}
          </div>
        `).join('')}
      </div>

      <div class="order-summary">
        <div>Subtotal: ${formatHarga(order.subtotal)}</div>
        ${order.voucherCode ? `
          <div style="color:green">
            Voucher ${order.voucherCode}
            ${order.discountPercent ? `(${order.discountPercent}%)` : ""}
            - ${formatHarga(order.discount)}
          </div>
        ` : ""}
        <strong>Grand Total: ${formatHarga(order.grandTotal)}</strong>
      </div>

      <div class="order-actions">
        <button onclick="printOrder(${order.id})">üñ® Print</button>
        <button onclick="voidOrder(${order.id})">‚ùå Void Order</button>
      </div>
    `;
    list.appendChild(div);
  });
}
  
/* ================= ACTIONS ================= */
function formatHarga(v) {
  return new Intl.NumberFormat('id-ID', {
    style: 'currency', currency: 'IDR', minimumFractionDigits: 0
  }).format(v || 0);
}

/* ================= VOID ITEM (FINAL) ================= */
async function voidOrderItem(orderId, itemIndex) {
  orderId = Number(orderId);
  itemIndex = Number(itemIndex);

  const order = await MENUVA_DB.get("ordersData", orderId);
  if (!order) return alert("Order tidak ditemukan");

  const item = order.items[itemIndex];
  if (!item) return alert("Item tidak ditemukan");

  if (!confirm(`VOID item ${item.nama}?`)) return;

  item.void = true;
  item.total = 0;

  await MENUVA_DB.put("ordersData", order);

  const idx = cachedOrders.findIndex(o => o.id === orderId);
  if (idx !== -1) cachedOrders[idx] = order;

  renderOrdersByDate(cachedOrders, activeDate);
  notifyOrdersUpdated();
}

/* ================= CLICK HANDLER ================= */
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('void-item-btn')) {
    const orderId = e.target.dataset.orderid;
    const itemIndex = e.target.dataset.itemindex;
    voidOrderItem(orderId, itemIndex);
  }
});
  
async function voidOrder(id) {
  const order = await MENUVA_DB.get("ordersData", id);
  if (!order) return alert("Order tidak ditemukan");

  if (!confirm(`VOID Order #${id}?`)) return;

  order.status = "void";
  await MENUVA_DB.put("ordersData", order);

  const idx = cachedOrders.findIndex(o => o.id === id);
  if (idx !== -1) cachedOrders[idx] = order;

  renderOrdersByDate(cachedOrders, activeDate);
  notifyOrdersUpdated();
}
  


/* ================= INIT ================= */
document.getElementById('ordersBox').innerHTML =
  `<p style="color:var(--muted)">‚è≥ Loading orders...</p>`;

MENUVA_DB.openDB().then(() => {
  loadRestoInfo();
  loadOrders();
});

  //setInterval(() => {loadOrders();}, 5000);

  function goBackToAdmin() {
  window.location.href = "admin.html";
}


</script>

</body>
</html>



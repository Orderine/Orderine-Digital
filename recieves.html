<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receives - Admin</title>

<style>

/* ================= ROOT ================= */
:root{
  --bg:#f4f8ff;
  --surface:#ffffff;
  --text:#1f2a44;
  --muted:#6b7a99;
  --border:#d8e1ff;
  --brand:#1f70ff;
  --brand-2:#2a5298;
  --brand-3:#1e3c72;
  --chip:#eef4ff;
  --danger:#e54646;
  --success:#25d366;
  --shadow:0 6px 24px rgba(0,0,0,.08);
  --qty-btn-bg:#eef4ff;
  --qty-btn-text:#1f2a44;
  --container-max:1200px;
}

body.dark-mode{
  --bg:#0e1116;
  --surface:#141922;
  --text:#e6ebff;
  --muted:#aab6db;
  --border:#263148;
  --brand:#4da3ff;
  --chip:#0f1a2a;
  --shadow:0 8px 28px rgba(0,0,0,.5);
  --qty-btn-bg:#263148;
  --qty-btn-text:#e6ebff;
}

/* ================= GLOBAL ================= */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  transition:background-color .25s ease,color .25s ease,border-color .25s ease;
}

body{
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ================= HEADER ================= */
header{
  background:linear-gradient(90deg,var(--brand-2),var(--brand-3));
  color:#fff;
  padding:16px;
  box-shadow:var(--shadow);
}

.header-inner{display:flex;align-items:center;justify-content:space-between}
#restoLogo{height:50px;width:50px;border-radius:8px;object-fit:contain;background:rgba(255,255,255,.15)}
#restoName{margin:0;font-size:18px;font-weight:800}

.dark-toggle,
.theme-btn{
  background:transparent;
  border:none;
  cursor:pointer;
  color:#fff;
  font-size:1.2rem;
  padding:6px 8px;
  border-radius:6px;
}
.theme-btn:hover{transform:scale(1.2)}

/* ================= CONTAINER ================= */
.container{
  max-width:var(--container-max);
  margin:20px auto;
  padding:0 16px;
}

/* ================= ORDER CARD ================= */
.order-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:16px;
  margin-bottom:20px;
}

.order-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.order-header h3{
  font-size:16px;
  font-weight:800;
}

.order-time{
  font-size:13px;
  color:var(--muted);
  font-weight:600;
}

.order-meta{
  font-size:12px;
  color:var(--muted);
  margin-bottom:8px;
}

.order-items{
  margin-top:10px;
  border-top:1px dashed var(--border);
  padding-top:10px;
}

.order-item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr;
  align-items:center;
  padding:6px 0;
  border-bottom:1px solid var(--border);
  font-size:14px;
}

.order-summary{
  margin-top:10px;
  font-weight:700;
  font-size:14px;
}

.order-actions{
  margin-top:14px;
  display:flex;
  gap:10px;
}

/* ================= BUTTONS ================= */
.btn{
  padding:8px 14px;
  border-radius:8px;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  border:0;
}

.btn-print{background:var(--brand);color:#fff}
.btn-void{background:var(--danger);color:#fff}

.btn-submit{
  background:linear-gradient(135deg,#2ecc71,#27ae60);
  color:#fff;
}

.btn-paid{
  background:linear-gradient(135deg,#3498db,#1f70ff);
  color:#fff;
}

/* ================= STATUS BADGE ================= */
.status-badge{
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
  letter-spacing:.5px;
}

.status-open{background:#e3f2fd;color:#1976d2}
.status-partial{background:#fff3e0;color:#f57c00}
.status-paid{background:#e8f5e9;color:#2e7d32}
.status-voided{background:#ffebee;color:#c62828}
.status-sent{background:#3498db;color:#fff}

/* ================= FILTER ================= */
.filter-bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:16px;
}

.date-btn{
  padding:6px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--surface);
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}

.date-btn.active{
  background:var(--brand);
  color:#fff;
}

/* ================= NOTES ================= */
.order-note{
  margin:6px 0;
  padding:6px 10px;
  background:rgba(255,255,0,.1);
  border-left:3px solid orange;
  border-radius:6px;
  font-size:14px;
  white-space:pre-wrap;
}

/* ================= REVENUE ================= */
.revenue-dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
  margin-bottom:20px;
}

.rev-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  box-shadow:var(--shadow);
  text-align:center;
}

.rev-title{font-size:12px;opacity:.6;margin-bottom:6px}
.rev-value{font-size:18px;font-weight:800}

/* ================= MENU CARD ================= */
.menu-card{
  background:#fff;
  border-radius:12px;
  padding:20px;
  width:180px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  text-align:center;
}

.menu-card:hover{
  transform:translateY(-4px);
  box-shadow:0 8px 18px rgba(0,0,0,.15);
}

.card-icon{font-size:32px;margin-bottom:10px}
.card-title{font-weight:bold;font-size:16px}
.card-desc{font-size:13px;color:#666;margin-top:4px}

/* ================= SUMMARY ================= */
.summary-filter{
  display:flex;
  gap:12px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.summary-btn{
  padding:10px 18px;
  font-size:14px;
  font-weight:600;
  border-radius:8px;
  border:none;
  cursor:pointer;
  opacity:.85;
}

.summary-btn.active{
  transform:scale(1.05);
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  opacity:1;
}

.summary-btn[data-mode="void"]{background:#ff4d4f;color:#fff}
.summary-btn[data-mode="daily"]{background:#1890ff;color:#fff}
.summary-btn[data-mode="weekly"]{background:#52c41a;color:#fff}
.summary-btn[data-mode="monthly"]{background:#722ed1;color:#fff}

.back-btn{
  padding:10px 16px;
  font-size:14px;
  font-weight:600;
  border-radius:8px;
  border:none;
  cursor:pointer;
  background:#333;
  color:#fff;
}

.back-btn:hover{
  background:#000;
  transform:translateY(-2px);
}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,rgba(0,0,0,.55),rgba(0,0,0,.85));
  backdrop-filter:blur(4px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal.hidden{display:none}

.modal-box{
  background:linear-gradient(180deg,#fff,#f6f7f9);
  border-radius:16px;
  max-width:360px;
  width:100%;
  padding:22px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

.modal-actions{
  margin-top:18px;
  display:flex;
  gap:10px;
}

#voidPinInput,
#voidReasonSelect,
#voidReasonOther{
  width:100%;
  margin-top:10px;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #ddd;
}

#voidConfirmBtn{
  background:linear-gradient(135deg,#ff4d4f,#d9363e);
  color:#fff;
}

#voidCancelBtn{
  background:#e9e9e9;
  color:#555;
}

</style>

</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="restoLogo" alt="Logo">
      <div>
        <h1 id="restoName">Loading...</h1>
        <p id="restoAddress" style="font-size:12px;margin:2px 0 0;opacity:0.8"></p>
        <p id="restoPhone" style="font-size:12px;margin:0;opacity:0.8"></p>
      </div>
    </div>
   <button id="themeToggle" class="theme-btn" aria-label="Toggle Dark Mode">
  <span id="themeIcon">üåô</span>
</button>

  </div>
</header>

<div id="mainReceives">

  <!-- ================= ORDER PAGE ================= -->
  <div id="orderPage">

    <div class="revenue-dashboard">
      <div class="rev-card">
        <div class="rev-title">Revenue</div>
        <div class="rev-value" id="revTotal">Rp 0</div>
      </div>

      <div class="rev-card">
        <div class="rev-title">Orders</div>
        <div class="rev-value" id="revOrders">0</div>
      </div>

      <div class="rev-card">
        <div class="rev-title">OPEN</div>
        <div class="rev-value" id="revOpen">0</div>
      </div>

      <div class="rev-card">
        <div class="rev-title">PAID</div>
        <div class="rev-value" id="revPaid">0</div>
      </div>
    </div>

    <!-- Card ke Summary -->
    <div class="menu-card" onclick="renderSummaryPage()">
      <div class="card-icon">üìä</div>
      <div class="card-title">Summary</div>
      <div class="card-desc">Lihat ringkasan laporan</div>
    </div>

    <main class="container">
      <h2 style="margin-bottom:16px">üì• Incoming Orders</h2>
      <div id="ordersBox"></div>
    </main>

  </div>


  <!-- ================= SUMMARY PAGE ================= -->
  <div id="summaryPage" style="display:none;">

    <main class="container">
      <h2 style="margin-bottom:16px">üìä Summary</h2>

      <div id="summaryContent"></div>

    <button class="back-btn" onclick="backToOrders()">‚¨Ö Back</button>

    </main>

  </div>

</div>


<script src="db-core.js"></script>
<script>
/* =====================================================
   RECEIVES.html ‚Äî FINAL VERSION
   VOID ITEM + PIN AUTH (ADMIN / SUPERVISOR / MANAGER)
===================================================== */

/* ================== UTIL ================== */
async function hashPIN(pin) {
  const enc = new TextEncoder().encode(pin);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

  function updateRevenueDashboard(orders, date) {

  const todayOrders = orders.filter(o => o.date === date);

  let totalRevenue = 0;
  let open = 0;
  let paid = 0;

  todayOrders.forEach(order => {
    if (order.status === "paid") {
      totalRevenue += Number(order.grandTotal) || 0;
      paid++;
    } else {
      open++;
    }
  });

  document.getElementById("revTotal").textContent = formatHarga(totalRevenue);
  document.getElementById("revOrders").textContent = todayOrders.length;
  document.getElementById("revOpen").textContent = open;
  document.getElementById("revPaid").textContent = paid;
}


function getTodayDate() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function formatHarga(v) {
  return new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency: "IDR",
    minimumFractionDigits: 0
  }).format(v || 0);
}

/* ================== NOTIFICATION ================== */
function showNewOrderNotification() {
  const n = document.createElement("div");
  n.className = "new-order-toast";
  n.innerHTML = `<div class="toast-icon">üõéÔ∏è</div><div>New Order!</div>`;
  document.body.appendChild(n);
  setTimeout(() => n.classList.add("show"), 50);
  setTimeout(() => n.remove(), 8000);
  try { new Audio("./beep.mp3").play(); } catch {}
}

/* ================== REALTIME ================== */
const bc = new BroadcastChannel("menuvaOrders");
bc.onmessage = e => {
  if (["newOrder","update_orders","order_changed"].includes(e.data?.type)) {
    loadOrders();
    if (e.data.type === "newOrder") showNewOrderNotification();
  }
};
function notifyOrdersUpdated() {
  bc.postMessage({ type:"update_orders" });
}

/* ================== STATE ================== */
let cachedOrders = [];
let activeDate = sessionStorage.getItem("receivesActiveDate");
let pendingVoidAction = null;

/* ================== LOAD DATA ================== */
async function loadOrders() {
  const orders = await MENUVA_DB.getAll("ordersData");
  cachedOrders = orders || [];
  renderOrders(cachedOrders);
}

async function loadRestoInfo() {
  try {
    // üîê SINGLE SOURCE: RESTO DI DB
    const restos = await MENUVA_DB.getAll("restos");

    if (!restos || !restos.length) {
      console.warn("‚ö†Ô∏è Tidak ada data resto di DB");
      return;
    }

    // üëâ asumsi 1 device = 1 resto aktif
    const resto = restos[0];

    document.getElementById("restoName").textContent =
      resto.namaRestoran || "Unknown Resto";

    if (resto.logo)
      document.getElementById("restoLogo").src = resto.logo;

    if (resto.restoAddress)
      document.getElementById("restoAddress").textContent =
        resto.restoAddress;

    if (resto.restoPhone)
      document.getElementById("restoPhone").textContent =
        `üìû ${resto.restoPhone}`;

  } catch (err) {
    console.warn("‚ö†Ô∏è Gagal load resto info:", err);
  }
}


/* ================== RENDER ================== */
function renderOrders(data) {
  const box = document.getElementById("ordersBox");
  box.innerHTML = "";

  if (!data.length) {
    box.innerHTML = `<p style="color:var(--muted)">No orders</p>`;
    return;
  }

  data.sort((a,b)=>(b.orderTime||0)-(a.orderTime||0));
  const dates = [...new Set(data.map(o=>o.date))];
  const today = getTodayDate();
  if (!activeDate || !dates.includes(activeDate))
    activeDate = dates.includes(today) ? today : dates[0];

  sessionStorage.setItem("receivesActiveDate", activeDate);

  box.innerHTML = `
    <div class="filter-bar">
      ${dates.map(d=>`<button class="date-btn ${d===activeDate?'active':''}" data-date="${d}">${d}</button>`).join("")}
    </div>
    <div id="ordersList"></div>
  `;

  box.querySelectorAll(".date-btn").forEach(b=>{
    b.onclick=()=>{ activeDate=b.dataset.date; renderOrders(cachedOrders); };
  });

  renderOrdersByDate(data, activeDate);
}

  function formatDateTime(ts) {
  if (!ts) return "-";
  const d = new Date(ts);
  return d.toLocaleString("id-ID", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function renderOrdersByDate(data, date) {
  const list = document.getElementById("ordersList");
  if (!list) return;

  list.innerHTML = "";

  if (!Array.isArray(data)) return;

  const filtered = data.filter(o => o && o.date === date);

  if (filtered.length === 0) {
    list.innerHTML = `<div style="opacity:.6">Tidak ada order di tanggal ini</div>`;
    return;
  }

  filtered.forEach(order => {
  
    /* ================= SAFETY NORMALIZATION ================= */
    order.items = Array.isArray(order.items) ? order.items : [];
    order.discountPercent = Number(order.discountPercent) || 0;
    order.discount = Number(order.discount) || 0;

    /* ================= SUBTOTAL RECALC ================= */
    const activeItems = order.items.filter(i => !i?.void);

    const subtotal = activeItems.reduce((sum, item) => {
      return sum + (Number(item?.total) || 0);
    }, 0);

    order.subtotal = subtotal;

    /* ================= DISCOUNT RECALC ================= */
    let discount = 0;

    if (order.discountPercent > 0) {
      discount = subtotal * (order.discountPercent / 100);
    } else {
      discount = order.discount;
    }

    if (discount > subtotal) discount = subtotal;

    order.discount = discount;

    /* ================= GRAND TOTAL ================= */
    let grandTotal = subtotal - discount;
    if (grandTotal < 0) grandTotal = 0;

    order.grandTotal = grandTotal;

    /* ================= STATUS ENGINE ================= */
    const totalItems = order.items.length;
    const voidedItems = order.items.filter(i => i?.void).length;

    let status = "OPEN";
    let statusClass = "status-open";

 if (order.status === "paid") {
  status = "PAID";
  statusClass = "status-paid";
}
else if (order.status === "sent") {
  status = "SENT";
  statusClass = "status-sent";
}
else if (voidedItems === totalItems && totalItems > 0) {
  status = "VOIDED";
  statusClass = "status-voided";
}
else if (voidedItems > 0) {
  status = "PARTIAL";
  statusClass = "status-partial";
}

    /* ================= BUILD CARD ================= */
    const div = document.createElement("div");
    div.className = "order-card";

    div.innerHTML = `
      <div class="order-header">
        <div>
          <h3>Table ${order.table || "-"} - ${order.customer || "-"}</h3>
          <small>Order #${order.id}</small>
        </div>
        <div class="status-badge ${statusClass}">
          ${status}
        </div>
      </div>

      <div class="order-time">
        ${typeof formatDateTime === "function" ? formatDateTime(order.orderTime) : ""}
      </div>

      ${order.note && order.note !== "-" ? `
        <div class="order-note">
          üìù Note: ${order.note}
        </div>
      ` : ""}

      <div class="order-items">
        ${order.items.map((item, idx) => `
          <div class="order-item ${item?.void ? 'voided' : ''}">
            
            <div class="item-left">
              ${item?.nama || "-"} √ó${Number(item?.qty) || 0}
            </div>

            <div class="item-center">
              ${formatHarga(Number(item?.total) || 0)}
            </div>

            <div class="item-right">
              ${!item?.void ? `
                <button 
                  class="void-item-btn"
                  data-order="${order.id}"
                  data-index="${idx}">
                  ‚ùå Void
                </button>
              ` : ""}
            </div>

          </div>
        `).join("")}
      </div>

      <div class="order-summary">
        <div>Subtotal: ${formatHarga(order.subtotal)}</div>

        ${order.discount > 0 ? `
          <div style="color:red;">
            Discount 
            ${order.discountPercent > 0 ? `(${order.discountPercent}%)` : ""}:
            - ${formatHarga(order.discount)}
          </div>
        ` : ""}

        <strong>Total: ${formatHarga(order.grandTotal)}</strong>
      </div>

      <div class="order-actions">

  ${order.status !== "sent" && order.status !== "paid" ? `
    <button 
      class="btn btn-submit"
      data-order="${order.id}">
      üöÄ Submit Order
    </button>
  ` : ""}

  ${order.status !== "paid" ? `
    <button 
      class="btn btn-paid"
      data-order="${order.id}">
      üí∞ Paid
    </button>
  ` : ""}

</div>
    `;

    list.appendChild(div);
  });
  updateRevenueDashboard(data, date);
}

/* ================== VOID AUTH ================== */
async function authorizeVoid(pin) {
  const hash = await hashPIN(pin);
  const admins = await MENUVA_DB.getAll("admins");

  const allowedRoles = [
    "supervisor",
    "manager",
    "general_manager",
    "owner"
  ];

  return admins.find(a => {
    const role = (a.role || "").toLowerCase();

    const pinMatch =
      a.voidPinHash === hash ||
      a.pinHash === hash ||
      a.pin === pin; // fallback kalau ternyata disimpan plain

    return allowedRoles.includes(role) && pinMatch;
  });
}


/* ================== VOID ACTION ================== */
async function voidOrderItem(orderId, itemIndex, admin, reason) {

  orderId = Number(orderId); // üî• WAJIB convert ke number

  const order = await MENUVA_DB.get("ordersData", orderId);
  if (!order) return alert("Order not found");

  const item = order.items[itemIndex];
  if (!item || item.void) return;

  item.void = true;
  item.totalBeforeVoid = item.total; // simpan nilai asli
  item.total = 0;
  item.voidReason = reason;
  item.voidBy = admin.username;
  item.voidAt = Date.now();

  await MENUVA_DB.add("ordersData", order); // tetap pakai add kalau memang itu update di sistem lu

  notifyOrdersUpdated();
  loadOrders();
}

  async function getAllVoidItems() {
  const orders = await MENUVA_DB.getAll("ordersData");
  const voids = [];

  orders.forEach(order => {
    order.items.forEach(item => {
      if (item.void) {
        voids.push({
          orderId: order.id,
          itemName: item.nama || "-",
          qty: item.qty || 0,
          amount: Number(item.totalBeforeVoid || 0),
          by: item.voidBy || "Unknown",
          reason: item.voidReason || "-",
          voidAt: item.voidAt,
          date: new Date(item.voidAt)
        });
      }
    });
  });

  return voids;
}

  async function attachRolesToVoids(voids) {
  const admins = await MENUVA_DB.getAll("admins");

  return voids.map(v => {
    const admin = admins.find(a => a.username === v.by);
    return {
      ...v,
      role: admin?.role || "Unknown"
    };
  });
}

  async function renderDailyVoidTable() {
  const voidsRaw = await getAllVoidItems();
  const voidsWithRole = await attachRolesToVoids(voidsRaw);

  const today = new Date().toISOString().slice(0,10);

  const todayVoids = voidsWithRole.filter(v =>
    new Date(v.voidAt).toISOString().slice(0,10) === today
  );

  const container = document.getElementById("dailyVoidTable");

  container.innerHTML = todayVoids.map(v => `
    <tr>
      <td>${v.itemName}</td>
      <td>${v.qty}</td>
      <td>${formatHarga(v.amount)}</td>
      <td>${v.by}</td>
      <td>${v.role}</td>
      <td>${v.reason}</td>
    </tr>
  `).join("");
}

/* ================== MODAL ================== */
function openVoidModal(action) {
  pendingVoidAction = action;
  voidPinInput.value="";
  voidReasonSelect.value="";
  voidReasonOther.value="";
  voidAuthModal.classList.remove("hidden");
}
function closeVoidModal() {
  pendingVoidAction=null;
  voidAuthModal.classList.add("hidden");
}

/* ================== EVENTS ================== */
document.addEventListener("click", async (e) => {

  // ================= VOID ITEM =================
  if (e.target.classList.contains("void-item-btn")) {
    openVoidModal({
      type: "item",
      orderId: e.target.dataset.order,
      itemIndex: Number(e.target.dataset.index)
    });
  }

// ================= SUBMIT ORDER =================
if (e.target.classList.contains("btn-submit")) {

  const orderId = Number(e.target.dataset.order);

  const order = await MENUVA_DB.get("ordersData", orderId);
  if (!order) return alert("Order tidak ditemukan");

  order.status = "sent";
  order.sentTime = Date.now();

 await MENUVA_DB.add("ordersData", order);

  alert("Order berhasil dikirim ke kitchen & bar üöÄ");

  loadOrders(); // refresh list
}

 // ================= PAID =================
if (e.target.classList.contains("btn-paid")) {

  const orderId = Number(e.target.dataset.order);

  const order = await MENUVA_DB.get("ordersData", orderId);
  if (!order) return alert("Order tidak ditemukan");

  order.status = "paid";
  order.paidTime = Date.now();

  await MENUVA_DB.add("ordersData", order);

  window.location.href = `paid-manager.html?id=${orderId}`;
}
});


/* ================== INIT ================== */
MENUVA_DB.openDB().then(()=>{
  loadRestoInfo();
  loadOrders();
});

</script>
<script>
  
let activeSummaryMode = "void";

async function renderSummaryPage() {

  // toggle halaman
  document.getElementById("orderPage").style.display = "none";
  document.getElementById("summaryPage").style.display = "block";

  const summaryPage = document.getElementById("summaryPage");

  summaryPage.innerHTML = `
    <main class="container">

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2>üìä Summary</h2>
        <button onclick="backToOrders()">‚¨Ö Back</button>
      </div>

      <div class="filter-bar summary-filter">
        <button class="summary-btn ${activeSummaryMode==="void"?"active":""}" data-mode="void">Void</button>
        <button class="summary-btn ${activeSummaryMode==="daily"?"active":""}" data-mode="daily">Daily</button>
        <button class="summary-btn ${activeSummaryMode==="weekly"?"active":""}" data-mode="weekly">Weekly</button>
        <button class="summary-btn ${activeSummaryMode==="monthly"?"active":""}" data-mode="monthly">Monthly</button>
      </div>

      <div id="summaryContent"></div>

    </main>
  `;

  // event filter
  document.querySelectorAll(".summary-btn").forEach(btn=>{
    btn.onclick = ()=>{
      activeSummaryMode = btn.dataset.mode;
      renderSummaryPage();
    };
  });

  renderSummaryDetail(activeSummaryMode);
}

  function backToOrders() {
  document.getElementById("summaryPage").style.display = "none";
  document.getElementById("orderPage").style.display = "block";
}

  async function renderSummaryDetail(mode) {

  const container = document.getElementById("summaryContent");
  container.innerHTML = "Loading...";

  if (mode === "void") {
    renderVoidSummary();
  }

  if (mode === "daily") {
    renderDailySummary();
  }

  if (mode === "weekly") {
    renderWeeklySummary();
  }

  if (mode === "monthly") {
    renderMonthlySummary();
  }
}

  async function renderVoidSummary() {

  const voidsRaw = await getAllVoidItems();
  const voids = await attachRolesToVoids(voidsRaw);

  const container = document.getElementById("summaryContent");

  if (!voids.length) {
    container.innerHTML = "<p style='opacity:.6'>Tidak ada void data</p>";
    return;
  }

  const dates = [...new Set(
    voids.map(v => new Date(v.voidAt).toISOString().slice(0,10))
  )].sort().reverse();

  let activeVoidDate = dates[0];

  container.innerHTML = `
    <div class="filter-bar">
      ${dates.map(d=>`
        <button class="void-date-btn ${d===activeVoidDate?'active':''}" data-date="${d}">
          ${d}
        </button>
      `).join("")}
    </div>

    <div id="voidList"></div>
  `;

  document.querySelectorAll(".void-date-btn").forEach(btn=>{
    btn.onclick = ()=>{
      activeVoidDate = btn.dataset.date;
      renderVoidList(voids, activeVoidDate);
      document.querySelectorAll(".void-date-btn")
        .forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    };
  });

  renderVoidList(voids, activeVoidDate);
}

  function renderVoidList(voids, date) {

  const list = document.getElementById("voidList");

  const filtered = voids.filter(v =>
    new Date(v.voidAt).toISOString().slice(0,10) === date
  );

  if (!filtered.length) {
    list.innerHTML = "<div style='opacity:.6'>Tidak ada void di tanggal ini</div>";
    return;
  }

  list.innerHTML = filtered.map(v=>`
    <div class="order-card">
      <div class="order-header">
        <h3>${v.itemName}</h3>
        <div class="status-badge status-voided">VOID</div>
      </div>

      <div>Qty: ${v.qty}</div>
      <div>Amount: ${formatHarga(v.amount)}</div>
      <div>By: ${v.by} (${v.role})</div>
      <div>Reason: ${v.reason}</div>
    </div>
  `).join("");
}

  async function renderDailySummary(){
  document.getElementById("summaryContent").innerHTML =
    "<div class='order-card'>Daily Summary Coming Soon</div>";
}

async function renderWeeklySummary(){
  document.getElementById("summaryContent").innerHTML =
    "<div class='order-card'>Weekly Summary Coming Soon</div>";
}

async function renderMonthlySummary(){
  document.getElementById("summaryContent").innerHTML =
    "<div class='order-card'>Monthly Summary Coming Soon</div>";
}

  
// ================= DOM READY =================

document.addEventListener("DOMContentLoaded", async () => {

  // ===== VOID ELEMENTS (WAJIB ADA) =====
  const voidConfirmBtn = document.getElementById("voidConfirmBtn");
  const voidCancelBtn = document.getElementById("voidCancelBtn");
  const voidPinInput = document.getElementById("voidPinInput");
  const voidReasonSelect = document.getElementById("voidReasonSelect");
  const voidReasonOther = document.getElementById("voidReasonOther");
  const voidAuthModal = document.getElementById("voidAuthModal");

  // ===== VOID BUTTON EVENTS =====
  if (voidConfirmBtn) {
    voidConfirmBtn.onclick = async () => {
      const pin = voidPinInput.value.trim();
      if (!pin) return alert("PIN wajib");

      const admin = await authorizeVoid(pin);
      if (!admin) return alert("PIN salah / tidak berwenang");

      const reason = voidReasonSelect.value === "Lainnya"
        ? voidReasonOther.value.trim()
        : voidReasonSelect.value;

      if (!reason) return alert("Alasan wajib");

      if (pendingVoidAction?.type === "item") {
        await voidOrderItem(
          pendingVoidAction.orderId,
          pendingVoidAction.itemIndex,
          admin,
          reason
        );
      }

      voidAuthModal.classList.add("hidden");
    };
  }

  if (voidCancelBtn) {
    voidCancelBtn.onclick = () => {
      voidAuthModal.classList.add("hidden");
    };
  }

  // ===== SESSION CHECK =====
  const btn = document.getElementById("btnBackToAdmin");

  try {
    const session = await MENUVA_DB.getSession();
    const role = session?.role;

    if (role === "manager" || role === "owner") {
      if (btn) {
        btn.style.display = "inline-block";
        btn.onclick = goBackToAdmin;
      }
    } else {
      if (btn) btn.remove();
    }

  } catch (err) {
    console.error("‚ùå gagal ambil session", err);
    if (btn) btn.remove();
  }

});

  function goBackToAdmin() {
    window.location.href = "admin.html";
  }
</script>

</body>
</html>







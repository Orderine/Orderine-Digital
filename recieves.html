<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receives - Admin</title>

<style>

/* ================= ROOT ================= */
:root{
  --bg:#f4f8ff;
  --surface:#ffffff;
  --text:#1f2a44;
  --muted:#6b7a99;
  --border:#d8e1ff;
  --brand:#1f70ff;
  --brand-2:#2a5298;
  --brand-3:#1e3c72;
  --chip:#eef4ff;
  --danger:#e54646;
  --success:#25d366;
  --shadow:0 6px 24px rgba(0,0,0,.08);
  --qty-btn-bg:#eef4ff;
  --qty-btn-text:#1f2a44;
  --container-max:1200px;
}

body.dark-mode{
  --bg:#0e1116;
  --surface:#141922;
  --text:#e6ebff;
  --muted:#aab6db;
  --border:#263148;
  --brand:#4da3ff;
  --chip:#0f1a2a;
  --shadow:0 8px 28px rgba(0,0,0,.5);
  --qty-btn-bg:#263148;
  --qty-btn-text:#e6ebff;
}


/* ================= GLOBAL ================= */
*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  transition:background-color .25s ease,color .25s ease,border-color .25s ease;
}

body{
  font-family:Inter,system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ================= HEADER ================= */
header{
  background:linear-gradient(90deg,var(--brand-2),var(--brand-3));
  color:#fff;
  padding:16px;
  box-shadow:var(--shadow);
}

.header-inner{display:flex;align-items:center;justify-content:space-between}
#restoLogo{height:50px;width:50px;border-radius:8px;object-fit:contain;background:rgba(255,255,255,.15)}
#restoName{margin:0;font-size:18px;font-weight:800}

.dark-toggle,
.theme-btn{
  background:transparent;
  border:none;
  cursor:pointer;
  color:#fff;
  font-size:1.2rem;
  padding:6px 8px;
  border-radius:6px;
}
.theme-btn:hover{transform:scale(1.2)}

/* ================= CONTAINER ================= */
.container{
  max-width:var(--container-max);
  margin:20px auto;
  padding:0 16px;
}

/* ================= ORDER CARD ================= */
.order-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:16px;
  margin-bottom:20px;
}

.order-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:8px;
}

.order-header h3{
  font-size:16px;
  font-weight:800;
}

.order-time{
  font-size:13px;
  color:var(--muted);
  font-weight:600;
}

.order-meta{
  font-size:12px;
  color:var(--muted);
  margin-bottom:8px;
}

.order-items{
  margin-top:10px;
  border-top:1px dashed var(--border);
  padding-top:10px;
}

.order-item{
  display:grid;
  grid-template-columns:2fr 1fr 1fr;
  align-items:center;
  padding:6px 0;
  border-bottom:1px solid var(--border);
  font-size:14px;
}

.order-summary{
  margin-top:10px;
  font-weight:700;
  font-size:14px;
}

.order-actions{
  margin-top:14px;
  display:flex;
  gap:10px;
}

/* ================= BUTTONS ================= */
.btn{
  padding:8px 14px;
  border-radius:8px;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  border:0;
}

.btn-print{background:var(--brand);color:#fff}
.btn-void{background:var(--danger);color:#fff}

.btn-submit{
  background:linear-gradient(135deg,#2ecc71,#27ae60);
  color:#fff;
}

.btn-paid{
  background:linear-gradient(135deg,#3498db,#1f70ff);
  color:#fff;
}

/* ================= STATUS BADGE ================= */
.status-badge{
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
  letter-spacing:.5px;
}

.status-open{background:#e3f2fd;color:#1976d2}
.status-partial{background:#fff3e0;color:#f57c00}
.status-paid{background:#e8f5e9;color:#2e7d32}
.status-voided{background:#ffebee;color:#c62828}
.status-sent{background:#3498db;color:#fff}

/* ================= FILTER ================= */
.filter-bar{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:16px;
}

.date-btn{
  padding:6px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--surface);
  font-size:13px;
  font-weight:600;
  cursor:pointer;
}

.date-btn.active{
  background:var(--brand);
  color:#fff;
}

/* ================= NOTES ================= */
.order-note{
  margin:6px 0;
  padding:6px 10px;
  background:rgba(255,255,0,.1);
  border-left:3px solid orange;
  border-radius:6px;
  font-size:14px;
  white-space:pre-wrap;
}

/* ================= REVENUE ================= */
.revenue-dashboard{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
  margin-bottom:20px;
}

.rev-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  box-shadow:var(--shadow);
  text-align:center;
}

.rev-title{font-size:12px;opacity:.6;margin-bottom:6px}
.rev-value{font-size:18px;font-weight:800}

/* ================= MENU CARD ================= */
.menu-card{
  background:#fff;
  border-radius:12px;
  padding:20px;
  width:180px;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.08);
  text-align:center;
}

.menu-card:hover{
  transform:translateY(-4px);
  box-shadow:0 8px 18px rgba(0,0,0,.15);
}

.card-icon{font-size:32px;margin-bottom:10px}
.card-title{font-weight:bold;font-size:16px}
.card-desc{font-size:13px;color:#666;margin-top:4px}

/* ================= SUMMARY ================= */
.summary-filter{
  display:flex;
  gap:12px;
  margin-bottom:20px;
  flex-wrap:wrap;
}

.summary-btn{
  padding:10px 18px;
  font-size:14px;
  font-weight:600;
  border-radius:8px;
  border:none;
  cursor:pointer;
  opacity:.85;
}

.summary-btn.active{
  transform:scale(1.05);
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  opacity:1;
}

.summary-btn[data-mode="void"]{background:#ff4d4f;color:#fff}
.summary-btn[data-mode="daily"]{background:#1890ff;color:#fff}
.summary-btn[data-mode="weekly"]{background:#52c41a;color:#fff}
.summary-btn[data-mode="monthly"]{background:#722ed1;color:#fff}

.back-btn{
  padding:10px 16px;
  font-size:14px;
  font-weight:600;
  border-radius:8px;
  border:none;
  cursor:pointer;
  background:#333;
  color:#fff;
}

.back-btn:hover{
  background:#000;
  transform:translateY(-2px);
}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:radial-gradient(circle at top,rgba(0,0,0,.55),rgba(0,0,0,.85));
  backdrop-filter:blur(4px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.modal.hidden{display:none}

.modal-box{
  background:linear-gradient(180deg,#fff,#f6f7f9);
  border-radius:16px;
  max-width:360px;
  width:100%;
  padding:22px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

.modal-actions{
  margin-top:18px;
  display:flex;
  gap:10px;
}

#voidPinInput,
#voidReasonSelect,
#voidReasonOther{
  width:100%;
  margin-top:10px;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid #ddd;
}

/* ================= VOID DATE PAGINATION ================= */

.void-date-btn {
  padding: 10px 18px;
  margin: 4px;
  border-radius: 30px;
  border: 1px solid rgba(0,0,0,0.08);
  background: #f5f7fa;
  color: #34495e;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
}

/* Hover effect */
.void-date-btn:hover {
  background: #e8ecf3;
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

/* ACTIVE MODE ‚Äì elegan tapi tegas */
.void-date-btn.active {
  background: linear-gradient(135deg, #7b1e1e, #b22222);
  color: white;
  box-shadow: 0 6px 16px rgba(178,34,34,0.35);
}


  /* ================= SUMMARY DATE PAGINATION ================= */

#summaryPage .date-btn {
  padding: 8px 16px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

/* Hover */
#summaryPage .date-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* Active Elegan */
#summaryPage .date-btn.active {
  background: linear-gradient(135deg, #2a5298, #1e3c72);
  color: #fff;
  border: 1px solid transparent;
  box-shadow: 0 6px 18px rgba(30,60,114,0.35);
}
#summaryPage .date-btn.active {
  position: relative;
}

#summaryPage .date-btn.active::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 20px;
  box-shadow: 0 0 12px rgba(31,112,255,0.4);
  pointer-events: none;
}

 .back-btn {
  padding: 10px 20px;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.2);
  cursor: pointer;
  font-size: 14px;
  font-weight: 700;
  letter-spacing: .5px;

  background: linear-gradient(135deg, #d4af37, #b8860b);
  color: #1f1f1f;

  box-shadow:
    0 6px 18px rgba(184,134,11,0.45),
    inset 0 1px 0 rgba(255,255,255,0.4);

  transition: all 0.25s ease;
}

.back-btn:hover {
  transform: translateY(-3px);
  box-shadow:
    0 10px 24px rgba(184,134,11,0.6),
    inset 0 1px 0 rgba(255,255,255,0.6);
}

.back-btn:active {
  transform: translateY(0) scale(0.97);
  box-shadow: 0 4px 12px rgba(184,134,11,0.4);
}

.void-item-btn {
  padding: 6px 14px;
  border-radius: 10px;
  border: 1px solid rgba(255,77,79,0.4);

  background: linear-gradient(135deg, #ff4d4f, #c62828);
  color: #fff;

  font-size: 12px;
  font-weight: 700;
  letter-spacing: .5px;
  cursor: pointer;

  box-shadow:
    0 4px 12px rgba(198,40,40,0.35),
    inset 0 1px 0 rgba(255,255,255,0.25);

  transition: all 0.2s ease;
}

/* Hover */
.void-item-btn:hover {
  transform: translateY(-2px);
  box-shadow:
    0 8px 18px rgba(198,40,40,0.5),
    inset 0 1px 0 rgba(255,255,255,0.35);
}

/* Active Click */
.void-item-btn:active {
  transform: scale(0.95);
  box-shadow: 0 3px 8px rgba(198,40,40,0.4);
}

  .item-row {
  display:flex;
  justify-content:space-between;
  font-size:14px;
  margin:2px 0;
}
.item-group {
  margin-top:8px;
  border-top:1px dashed #ccc;
  padding-top:6px;
}

  .modal-actions{
  margin-top:20px;
  display:flex;
  justify-content:space-between; /* üî• kiri kanan */
}

.btn-cancel{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  background:#2f2f2f; /* nggak pucat lagi */
  color:white;
  font-weight:500;
  cursor:pointer;
  transition:0.2s;
}

.btn-cancel:hover{
  background:#444;
}

.btn-confirm{
  padding:10px 18px;
  border:none;
  border-radius:10px;
  background:#b30000;
  color:white;
  font-weight:bold;
  cursor:pointer;
  transition:0.2s;
}

.btn-confirm:hover{
  background:#e60000;
}

  .input-error{
  border:2px solid #ff3b3b !important;
  background:#2a0f0f;
}

.input-success{
  border:2px solid #00c853 !important;
  background:#0f2a18;
}

  .void-detail {
  margin-top: 8px;
  padding: 10px;
  background: rgba(179,0,0,0.08);
  border-left: 4px solid #b30000;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.5;
}

/* ===== MAIN CONTAINER ===== */
.modern-dashboard-container {
  display: flex;
  flex-direction: column;
  gap: 24px;
}


/* ===== TOP FLEX AREA ===== */
.dashboard-top {
  display: flex;
  gap: 20px;
  align-items: stretch;
  justify-content: space-between;
  flex-wrap: wrap;
}

/* ===== REVENUE CARDS ===== */
.revenue-dashboard {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  flex: 3;
}

.rev-card {
  background: rgba(255,255,255,0.05);
  padding: 18px;
  border-radius: 14px;
  min-width: 140px;
  flex: 1;
  backdrop-filter: blur(10px);
  transition: 0.3s ease;
}

.rev-card:hover {
  transform: translateY(-4px);
  background: rgba(255,255,255,0.08);
}

.rev-title {
  font-size: 13px;
  opacity: 0.7;
  margin-bottom: 6px;
}

.rev-value {
  font-size: 20px;
  font-weight: 600;
}

/* ===== LIVE INFO PANEL ===== */
.live-info-container {
  flex: 1;
  background: rgba(255,255,255,0.05);
  padding: 20px;
  border-radius: 14px;
  backdrop-filter: blur(12px);
  display: flex;
  align-items: center;
  justify-content: center;
}

.live-info {
  text-align: center;
}

.clock-line {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 8px;
}

.shift-line,
.user-line {
  font-size: 14px;
  opacity: 0.8;
  margin-bottom: 4px;
}

/* ===== SUMMARY CARD MODERN ===== */
.modern-summary-card {
  margin-top: 25px;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  border-radius: 14px;
  padding: 20px;
  cursor: pointer;
  transition: 0.3s ease;

  /* CENTER CONTENT */
  display: flex;
  flex-direction: column;
  justify-content: center;  /* vertical center */
  align-items: center;      /* horizontal center */
  text-align: center;       /* center text */

  min-height: 120px;        /* optional: biar center kelihatan jelas */
}

.modern-summary-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
}


  .modern-dashboard-container {
  display: grid;
  grid-template-columns: 1.5fr 1fr;
  gap: 20px;
}

.insight-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.quick-stats-card,
.mini-chart-card {
  background: linear-gradient(145deg, #1e1e2f, #25253a);
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
}

.insight-title {
  margin-bottom: 15px;
  font-size: 15px;
  opacity: .8;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 10px;
  font-size: 14px;
}

.stat-item strong {
  font-size: 15px;
}

.dashboard-wrapper {
  width: 100%;
  max-width: 1100px;   /* samakan dengan header/container utama */
  margin: 0 auto;
  padding: 20px;
}

/* ===== TOP REVENUE ===== */
.dashboard-top {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 25px;
}

.rev-card {
  background: #1e293b;
  padding: 20px;
  border-radius: 16px;
  height: 120px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.rev-title {
  font-size: 14px;
  color: #94a3b8;
}

.rev-value {
  font-size: 22px;
  font-weight: bold;
  margin-top: 8px;
  color: #38bdf8;
}


/* ===== ROW GRID ===== */
/* container row */
.dashboard-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px; /* ini jarak antar card */
  margin-bottom: 20px;
}

/* ===== CARD BASE ===== */
.card-square,
.card-rectangle {
  background: linear-gradient(145deg, #111111, #1a1a1a);
  color: #f1f1f1;

  border-radius: 14px;
  padding: 18px;

  box-shadow:
    0 4px 12px rgba(0,0,0,0.4),
    inset 0 1px 0 rgba(255,255,255,0.05);

  border: 1px solid rgba(255,255,255,0.06);

  display: flex;
  flex-direction: column;

  height: 100%;
  min-height: 220px;

  transition: all 0.25s ease;
}

/* hover effect elegan */
.card-square:hover,
.card-rectangle:hover {
  transform: translateY(-3px);
  box-shadow:
    0 8px 20px rgba(0,0,0,0.6),
    inset 0 1px 0 rgba(255,255,255,0.08);
}


/* TEXT */
.card-title {
  font-size: 18px;
  font-weight: 600;
  margin-top: 10px;
}

.card-desc {
  font-size: 13px;
  color: #94a3b8;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  margin: 8px 0;
  color: #e2e8f0;
}

.orders-section {
  max-width: 1300px;
  margin: auto;
  padding: 0 25px 40px 25px;
}

.card-rectangle {
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

  .revenue-chart-card canvas {
  max-height: 150px;
}

  .page-container {
  max-width: 1300px;   /* samakan dengan orders-section */
  margin: 0 auto;
  padding: 0 25px;
}

  /* SUMMARY CARD BUTTON EFFECT */
.summary-card {
  cursor: pointer;
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
}

/* Hover Effect */
.summary-card:hover {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  transform: translateY(-5px);
  box-shadow: 0 10px 25px rgba(37,99,235,0.4);
}

/* Text berubah saat hover */
.summary-card:hover .card-title,
.summary-card:hover .card-desc,
.summary-card:hover .card-icon {
  color: #ffffff;
}

/* Click effect */
.summary-card:active {
  transform: scale(0.97);
  box-shadow: 0 5px 15px rgba(37,99,235,0.3);
}

  .card-square h3,
.card-rectangle h3 {
  color: #ffffff;
  font-weight: 600;
}

  /* container isi live card */
.live-card {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  text-align: center;
  gap: 6px;
}

/* clock */
#liveClock {
  font-size: clamp(20px, 3vw, 28px);
  font-weight: bold;
  color: #4fd1c5;
  line-height: 1.2;
}

/* shift & user */
#shiftInfo,
#userInfo {
  color: #bbbbbb;
  font-size: clamp(13px, 2vw, 16px);
  line-height: 1.3;
}

/* chart wrapper */
.revenue-chart-card canvas {
  width: 100% !important;
  height: auto !important;
  flex-grow: 1;
}

/* tablet portrait */
@media (max-width: 1024px) {
  .dashboard-row {
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
}

/* mobile */
@media (max-width: 640px) {
  .dashboard-row {
    grid-template-columns: 1fr;
  }
}

  /* OVERLAY */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

/* MODAL BOX */
.cash-modal{
  background:#111;
  color:#fff;
  padding:20px;
  border-radius:12px;
  width:320px;
  box-shadow:0 0 20px rgba(0,0,0,0.5);
}

/* HEADER */
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}

/* BODY */
.payment-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:12px;
  align-items:center;
}

.payment-row input{
  width:140px;
  padding:6px;
  background:#222;
  border:1px solid #444;
  color:#fff;
  border-radius:6px;
}

/* ===== OVERLAY ===== */
.report-overlay {
  position: fixed;
  inset: 0;
  background: rgba(5,10,25,.85);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* ===== TERMINAL BOX ===== */
.report-terminal {
  width: 95%;
  max-width: 1200px;
  background: #0a0f1c;
  border-radius: 18px;
  padding: 30px;
  box-shadow: 0 0 60px rgba(0,0,0,.7);
  color: #fff;
  display: flex;
  flex-direction: column;
  gap: 30px;
}

/* ===== HEADER ===== */
.terminal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.terminal-title {
  font-size: 20px;
  font-weight: bold;
  letter-spacing: 1px;
}

.terminal-sub {
  display: block;
  font-size: 12px;
  opacity: .5;
  margin-top: 4px;
}

/* ===== CLOSE BUTTON SULTAN ===== */
.terminal-close {
  background: linear-gradient(145deg,#7c3aed,#4f46e5);
  border: none;
  padding: 10px 18px;
  border-radius: 12px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: .3s ease;
}

.terminal-close:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(124,58,237,.6);
}

/* ===== STATS GRID ===== */
.terminal-stats {
  display: grid;
  grid-template-columns: repeat(3,1fr);
  gap: 20px;
}

.terminal-card {
  background: linear-gradient(145deg,#111827,#0f172a);
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.05);
  text-align: center;
  transition: .3s ease;
}

.terminal-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 35px rgba(0,0,0,.5);
}

.terminal-card.highlight {
  background: linear-gradient(145deg,#1e3a8a,#0f172a);
  border: 1px solid rgba(59,130,246,.4);
  box-shadow: 0 0 25px rgba(59,130,246,.3);
}

  .terminal-card.orders {
  border: 1px solid rgba(16,185,129,.4);
  box-shadow: 0 0 20px rgba(16,185,129,.3);
}

.terminal-card.period {
  border: 1px solid rgba(124,58,237,.4);
  box-shadow: 0 0 20px rgba(124,58,237,.3);
}


.card-label {
  font-size: 12px;
  opacity: .6;
  margin-bottom: 8px;
  letter-spacing: 1px;
}

.card-value {
  font-size: 16px;
  font-weight: bold;
  letter-spacing: 1px;
}

/* ===== CHART ===== */
.terminal-chart {
  background: #111827;
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.05);
}

/* ===== FOOTER ===== */
.terminal-footer {
  display: flex;
  justify-content: flex-end;
}

.terminal-export {
  background: linear-gradient(145deg,#059669,#047857);
  border: none;
  padding: 10px 20px;
  border-radius: 12px;
  color: white;
  font-weight: bold;
  cursor: pointer;
  transition: .3s ease;
}

.terminal-export:hover {
  transform: scale(1.05);
  box-shadow: 0 0 20px rgba(5,150,105,.6);
}

.hidden {
display: none !important;
}

.terminal-chart {
  background: #111827;
  padding: 25px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.05);
  height: 350px;
}

</style>

</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="restoLogo" alt="Logo">
      <div>
        <h1 id="restoName">Loading...</h1>
        <p id="restoAddress" style="font-size:12px;margin:2px 0 0;opacity:0.8"></p>
        <p id="restoPhone" style="font-size:12px;margin:0;opacity:0.8"></p>
      </div>
    </div>
   <button id="themeToggle" class="theme-btn" aria-label="Toggle Dark Mode">
  <span id="themeIcon">üåô</span>
</button>

  </div>
</header>

<div id="orderPage">

  <div class="page-container">

    <!-- ================= TOP REVENUE ================= -->
    <section class="revenue-dashboard">
      <div class="rev-card">
        <div class="rev-title">Revenue</div>
        <div class="rev-value" id="revTotal">Rp 0</div>
      </div>

      <div class="rev-card">
        <div class="rev-title">Orders</div>
        <div class="rev-value" id="revOrders">0</div>
      </div>

      <div class="rev-card">
        <div class="rev-title">OPEN</div>
        <div class="rev-value" id="revOpen">0</div>
      </div>

      <div class="rev-card">
        <div class="rev-title">PAID</div>
        <div class="rev-value" id="revPaid">0</div>
      </div>
    </section>


    <!-- ================= ROW 2 ================= -->
    <section class="dashboard-row">

      <!-- Summary (KOTAK) -->
      <div class="card-square summary-card" onclick="renderSummaryPage()">
        <div class="card-icon">üìä</div>
        <div class="card-title">Summary</div>
        <div class="card-desc">Lihat laporan lengkap</div>
      </div>

      <!-- Insight (PANJANG) -->
      <div class="card-rectangle insight-card">

        <h3>üìà Today Insight</h3>

        <div class="stat-item">
          <span>üßæ Today Orders</span>
          <strong id="todayOrdersStat">0</strong>
        </div>

        <div class="stat-item">
          <span>üí∞ Avg Order</span>
          <strong id="avgOrderStat">Rp 0</strong>
        </div>

        <div class="stat-item">
          <span>‚è≥ Avg Prep</span>
          <strong id="avgPrepStat">0 min</strong>
        </div>

        <div class="stat-item">
          <span>üî• Top Item</span>
          <strong id="topItemStat">-</strong>
        </div>

      </div>

    </section>


    <!-- ================= ROW 3 ================= -->
    <section class="dashboard-row">

      <!-- Live Info (KOTAK) -->
      <div class="card-square live-card">
        <div class="clock-line">
          üïí <span id="liveClock">00:00:00</span>
        </div>
        <div id="shiftInfo">Shift: -</div>
        <div id="userInfo">User: -</div>
      </div>

     
    <!-- Revenue Trend Chart -->
<div class="card-rectangle revenue-chart-card">
  <h3>üìä Revenue Trend (7 Days)</h3>
  <canvas id="revenueTrendChart" height="120"></canvas>
</div>


    </section>

  </div>

  <!-- ================= ORDERS ================= -->
  <main class="orders-section">
    <h2>üì• Incoming Orders</h2>
    <div id="ordersBox"></div>
  </main>

</div>


  <!-- ================= VOID AUTH MODAL ================= -->
<div id="voidAuthModal" class="modal hidden">

  <div class="modal-box" style="
    background: #2b0f0f;
    color: white;
    border: 1px solid #5a1a1a;
  ">

    <h3 style="margin-bottom:16px; color:#ff4d4d;">
      üîê Void Authorization
    </h3>

    <input 
      type="password"
      id="voidPinInput"
      placeholder="Masukkan PIN"
    />

    <select id="voidReasonSelect">
      <option value="">Pilih Alasan</option>
      <option value="Salah Input">Salah Input</option>
      <option value="Customer Batal">Customer Batal</option>
      <option value="Lainnya">Lainnya</option>
    </select>

    <input 
      type="text"
      id="voidReasonOther"
      placeholder="Alasan lainnya..."
    />

   <div class="modal-actions">
  <button type="button" id="voidCancelBtn" class="btn-cancel">
    Cancel
  </button>

  <button type="button" id="voidConfirmBtn" class="btn-confirm">
    Confirm
  </button>
</div>

  </div>
</div>

  <!-- =========================
MODAL PEMBAYARAN CASH
========================= -->
<div id="cashPaymentModal" class="modal-overlay" style="display:none;">
  <div class="modal-content cash-modal">

    <div class="modal-header">
      <h3>üí∞ Pembayaran Cash</h3>
      <button id="closeCashModal" class="modal-close">‚úï</button>
    </div>

    <div class="modal-body">

      <div class="payment-row">
        <span>Total Tagihan</span>
        <strong id="cashTotal">Rp 0</strong>
      </div>

      <div class="payment-row">
        <span>Uang Diterima</span>
        <input 
          type="number" 
          id="cashReceived"
          placeholder="Masukkan jumlah uang"
        />
      </div>

      <div class="payment-row">
        <span>Kembalian</span>
        <strong id="cashChange">Rp 0</strong>
      </div>

    </div>

    <div class="modal-footer">
      <button id="confirmCashBtn" class="btn btn-confirm">
        ‚úî Konfirmasi Pembayaran
      </button>
    </div>

  </div>
</div>

<!-- ================= REPORT MODAL ================= -->
<div id="reportModal" class="report-overlay hidden">

  <div class="report-terminal">

    <!-- HEADER -->
    <div class="terminal-header">
      <div class="terminal-title">
        üìä REVENUE ANALYTICS TERMINAL
        <span class="terminal-sub">Enterprise Performance Monitor</span>
      </div>

      <button class="terminal-close" onclick="closeReportModal()">
        Close Terminal
      </button>
    </div>

   <!-- SUMMARY STATS -->
<div class="terminal-stats">

  <div class="terminal-card orders">
    <div class="card-label">TOTAL ORDERS</div>
    <div class="card-value" id="reportOrders">0</div>
  </div>

  <div class="terminal-card highlight">
    <div class="card-label">TOTAL REVENUE</div>
    <div class="card-value" id="reportRevenue">Rp 0</div>
  </div>

  <div class="terminal-card period">
    <div class="card-label">PERIOD</div>
    <div class="card-value" id="reportPeriod">-</div>
  </div>

</div>


    <!-- CHART AREA -->
    <div class="terminal-chart">
      <canvas id="reportChart"></canvas>
    </div>

    <!-- FOOTER -->
    <div class="terminal-footer">
      <button class="terminal-export" onclick="exportReport()">
        ‚¨á Export CSV
      </button>
    </div>

  </div>
</div>

<script src="db-core.js"></script>
<script>
/* =====================================================
   RECEIVES.html ‚Äî FINAL VERSION
   VOID ITEM + PIN AUTH (ADMIN / SUPERVISOR / MANAGER)
===================================================== */

/* ================== UTIL ================== */
async function hashPIN(pin) {
  const enc = new TextEncoder().encode(pin);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}

 function updateRevenueDashboard(orders, date) {

  const todayOrders = orders.filter(o => o.date === date);

  let gross = 0;
  let discount = 0;
  let net = 0;
  let open = 0;
  let paid = 0;

  todayOrders.forEach(order => {

    if (order.status === "paid") {
      gross += Number(order.subtotal) || 0;
      discount += Number(order.discount) || 0;
      net += Number(order.grandTotal) || 0;
      paid++;
    } else {
      open++;
    }

  });

  document.getElementById("revTotal").textContent = formatHarga(net);
  document.getElementById("revOrders").textContent = todayOrders.length;
  document.getElementById("revOpen").textContent = open;
  document.getElementById("revPaid").textContent = paid;

  // OPTIONAL kalau ada UI
  if (document.getElementById("revGross"))
    document.getElementById("revGross").textContent = formatHarga(gross);

  if (document.getElementById("revDiscount"))
    document.getElementById("revDiscount").textContent = formatHarga(discount);
}


function getTodayDate() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function formatHarga(v) {
  return new Intl.NumberFormat("id-ID", {
    style: "currency",
    currency: "IDR",
    minimumFractionDigits: 0
  }).format(v || 0);
}

/* ================== NOTIFICATION ================== */
function showNewOrderNotification() {
  const n = document.createElement("div");
  n.className = "new-order-toast";
  n.innerHTML = `<div class="toast-icon">üõéÔ∏è</div><div>New Order!</div>`;
  document.body.appendChild(n);
  setTimeout(() => n.classList.add("show"), 50);
  setTimeout(() => n.remove(), 8000);
  try { new Audio("./beep.mp3").play(); } catch {}
}

/* ================== REALTIME ================== */
const bc = new BroadcastChannel("menuvaOrders");
bc.onmessage = e => {
  if (["newOrder","update_orders","order_changed"].includes(e.data?.type)) {
    loadOrders();
    if (e.data.type === "newOrder") showNewOrderNotification();
  }
};
function notifyOrdersUpdated() {
  bc.postMessage({ type:"update_orders" });
}

/* ================== STATE ================== */
let cachedOrders = [];
let activeDate = sessionStorage.getItem("receivesActiveDate");
let pendingVoidAction = null;

/* ================== LOAD DATA ================== */
async function loadOrders() {
  const orders = await MENUVA_DB.getAll("ordersData");
  cachedOrders = orders || [];
  renderOrders(cachedOrders);
}

async function loadRestoInfo() {
  try {
    // üîê SINGLE SOURCE: RESTO DI DB
    const restos = await MENUVA_DB.getAll("restos");

    if (!restos || !restos.length) {
      console.warn("‚ö†Ô∏è Tidak ada data resto di DB");
      return;
    }

    // üëâ asumsi 1 device = 1 resto aktif
    const resto = restos[0];

    document.getElementById("restoName").textContent =
      resto.namaRestoran || "Unknown Resto";

    if (resto.logo)
      document.getElementById("restoLogo").src = resto.logo;

    if (resto.restoAddress)
      document.getElementById("restoAddress").textContent =
        resto.restoAddress;

    if (resto.restoPhone)
      document.getElementById("restoPhone").textContent =
        `üìû ${resto.restoPhone}`;

  } catch (err) {
    console.warn("‚ö†Ô∏è Gagal load resto info:", err);
  }
}


/* ================== RENDER ================== */
function renderOrders(data) {
  const box = document.getElementById("ordersBox");
  box.innerHTML = "";

  if (!data.length) {
    box.innerHTML = `<p style="color:var(--muted)">No orders</p>`;
    return;
  }

  data.sort((a,b)=>(b.orderTime||0)-(a.orderTime||0));
  const dates = [...new Set(data.map(o=>o.date))];
  const today = getTodayDate();
  if (!activeDate || !dates.includes(activeDate))
    activeDate = dates.includes(today) ? today : dates[0];

  sessionStorage.setItem("receivesActiveDate", activeDate);

  box.innerHTML = `
    <div class="filter-bar">
      ${dates.map(d=>`<button class="date-btn ${d===activeDate?'active':''}" data-date="${d}">${d}</button>`).join("")}
    </div>
    <div id="ordersList"></div>
  `;

  box.querySelectorAll(".date-btn").forEach(b=>{
    b.onclick=()=>{ activeDate=b.dataset.date; renderOrders(cachedOrders); };
  });

  renderOrdersByDate(data, activeDate);
}

  function formatDateTime(ts) {
  if (!ts) return "-";
  const d = new Date(ts);
  return d.toLocaleString("id-ID", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit"
  });
}

function renderOrdersByDate(data, date) {
  const list = document.getElementById("ordersList");
  if (!list) return;

  list.innerHTML = "";

  if (!Array.isArray(data)) return;

  const filtered = data.filter(o => o && o.date === date);

  if (filtered.length === 0) {
    list.innerHTML = `<div style="opacity:.6">Tidak ada order di tanggal ini</div>`;
    return;
  }

  filtered.forEach(order => {
  
    /* ================= SAFETY NORMALIZATION ================= */
    order.items = Array.isArray(order.items) ? order.items : [];
    order.discountPercent = Number(order.discountPercent) || 0;
    order.discount = Number(order.discount) || 0;
    order.subtotal = Number(order.subtotal) || 0;
    order.grandTotal = Number(order.grandTotal) || 0;

    /* ================= RECALC ONLY IF NOT PAID ================= */
    if ((order.status || "").toLowerCase() !== "paid") {

      const activeItems = order.items.filter(i => !i?.void);

      const subtotal = activeItems.reduce((sum, item) => {
        return sum + (Number(item?.total) || 0);
      }, 0);

      order.subtotal = subtotal;

      let discount = 0;

      if (order.discountPercent > 0) {
        discount = subtotal * (order.discountPercent / 100);
      } else {
        discount = order.discount;
      }

      if (discount > subtotal) discount = subtotal;

      order.discount = discount;

      let grandTotal = subtotal - discount;
      if (grandTotal < 0) grandTotal = 0;

      order.grandTotal = grandTotal;
    }

    /* ================= STATUS ENGINE ================= */
    const totalItems = order.items.length;
    const voidedItems = order.items.filter(i => i?.void).length;

    let status = "OPEN";
    let statusClass = "status-open";

    if (order.status === "paid") {
      status = "PAID";
      statusClass = "status-paid";
    }
    else if (order.status === "sent") {
      status = "SENT";
      statusClass = "status-sent";
    }
    else if (voidedItems === totalItems && totalItems > 0) {
      status = "VOIDED";
      statusClass = "status-voided";
    }
    else if (voidedItems > 0) {
      status = "PARTIAL";
      statusClass = "status-partial";
    }

    /* ================= BUILD CARD ================= */
    const div = document.createElement("div");
    div.className = "order-card";

    div.innerHTML = `
      <div class="order-header">
        <div>
          <h3>Table ${order.table || "-"} - ${order.customer || "-"}</h3>
          <small>Order #${order.id}</small>
        </div>
        <div class="status-badge ${statusClass}">
          ${status}
        </div>
      </div>

      <div class="order-time">
        ${typeof formatDateTime === "function" ? formatDateTime(order.orderTime) : ""}
      </div>

      ${order.note && order.note !== "-" ? `
        <div class="order-note">
          üìù Note: ${order.note}
        </div>
      ` : ""}

      <div class="order-items">
        ${order.items.map((item, idx) => `
          <div class="order-item ${item?.void ? 'voided' : ''}">
            
            <div class="item-left">
              ${item?.nama || "-"} √ó${Number(item?.qty) || 0}
            </div>

            <div class="item-center">
              ${formatHarga(Number(item?.total) || 0)}
            </div>

            <div class="item-right">
              ${!item?.void ? `
                <button 
                  class="void-item-btn"
                  data-order="${order.id}"
                  data-index="${idx}">
                  ‚ùå Void
                </button>
              ` : ""}
            </div>

          </div>
        `).join("")}
      </div>

      <div class="order-summary">
        <div>Subtotal: ${formatHarga(order.subtotal)}</div>

        ${order.discount > 0 ? `
          <div style="color:red;">
            Discount 
            ${order.discountPercent > 0 ? `(${order.discountPercent}%)` : ""}:
            - ${formatHarga(order.discount)}
          </div>
        ` : ""}

        <strong>Total: ${formatHarga(order.grandTotal)}</strong>
      </div>

      <div class="order-actions">

  ${order.status !== "sent" && order.status !== "paid" ? `
    <button class="btn btn-submit" data-order="${order.id}">
      üöÄ Submit Order
    </button>
  ` : ""}

  ${order.status !== "paid" ? `
    <button class="btn btn-paid" data-order="${order.id}">
      üí∞ Paid
    </button>
  ` : ""}

</div>
    `;

    list.appendChild(div);
  });

  updateRevenueDashboard(data, date);
  // setelah semua order dirender
  attachPaidButtonEvents();

}

  function attachPaidButtonEvents() {

  document.querySelectorAll(".btn-paid").forEach(btn => {

    btn.onclick = () => {

      const orderId = btn.dataset.order;

      const order = cachedOrders.find(o => o.id == orderId);

      if (!order) {
        console.error("Order tidak ditemukan:", orderId);
        return;
      }

      openCashPaymentModal(order);

    };

  });

}

/* ================= CASH PAYMENT MODAL ENGINE ================= */

let activeCashOrder = null;


/* ================= OPEN MODAL ================= */
function openCashPaymentModal(order) {

  if (!order) {
    console.error("openCashPaymentModal: order kosong");
    return;
  }

  activeCashOrder = order;

  const modal = document.getElementById("cashPaymentModal");
  const totalEl = document.getElementById("cashTotal");
  const receivedInput = document.getElementById("cashReceived");
  const changeEl = document.getElementById("cashChange");

  if (!modal || !totalEl || !receivedInput || !changeEl) {
    console.error("Elemen cash modal tidak lengkap");
    return;
  }

  totalEl.textContent = formatHarga(order.grandTotal || 0);

  receivedInput.value = "";

  changeEl.textContent = formatHarga(0);

  modal.style.display = "flex";

  // auto focus biar kasir cepat input
  setTimeout(() => receivedInput.focus(), 50);
}


/* ================= CLOSE MODAL ================= */
document.getElementById("closeCashModal").onclick = (e) => {

  e.stopPropagation();

  document.getElementById("cashPaymentModal").style.display = "none";

  activeCashOrder = null;

};


/* ================= HITUNG KEMBALIAN REALTIME ================= */
document.getElementById("cashReceived").oninput = (e) => {

  e.stopPropagation();

  if (!activeCashOrder) return;

  const received =
    Number(e.target.value) || 0;

  const total =
    Number(activeCashOrder.grandTotal) || 0;

  const change = received - total;

  document.getElementById("cashChange").textContent =
    formatHarga(change > 0 ? change : 0);

};


/* ================= CONFIRM PAYMENT ================= */
const confirmBtn = document.getElementById("confirmCashBtn");

// hapus onclick lama jika ada
confirmBtn.onclick = null;

// pasang handler baru
confirmBtn.addEventListener("click", async function(e) {

  e.stopPropagation();
  e.preventDefault();

  if (!activeCashOrder) {
    console.error("Active order kosong");
    return;
  }

  const received =
    Number(document.getElementById("cashReceived").value) || 0;

  const total =
    Number(activeCashOrder.grandTotal) || 0;

  if (received < total) {
    alert("Uang kurang");
    return;
  }

  activeCashOrder.status = "paid";
  activeCashOrder.paidTime = Date.now();
  activeCashOrder.paymentMethod = "cash";
  activeCashOrder.cashReceived = received;
  activeCashOrder.cashChange = received - total;
  activeCashOrder.locked = true;

  await MENUVA_DB.add("ordersData", activeCashOrder);

  document.getElementById("cashPaymentModal").style.display = "none";

  activeCashOrder = null;

  await loadOrders();

  if (typeof notifyOrdersUpdated === "function")
    notifyOrdersUpdated();

});

/* ================== VOID AUTH ================== */
async function authorizeVoid(pin) {
  const hash = await hashPIN(pin);
  const admins = await MENUVA_DB.getAll("admins");

  const allowedRoles = [
    "supervisor",
    "manager",
    "general_manager",
    "owner"
  ];

  return admins.find(a => {
    const role = (a.role || "").toLowerCase();

    const pinMatch =
      a.voidPinHash === hash ||
      a.pinHash === hash ||
      a.pin === pin; // fallback kalau ternyata disimpan plain

    return allowedRoles.includes(role) && pinMatch;
  });
}


async function voidOrderItem(orderId, itemIndex, admin, reason) {

  const order = await MENUVA_DB.get("ordersData", Number(orderId));
  if (!order) return;

  const item = order.items?.[itemIndex];
  if (!item) return;

  const voidData = {
  type: "VOID",
  qty: Number(item.qty) || 0,
  amount: Number(item.total) || 0,
  reason: reason,
  voidedBy: {
    id: admin.id,
    email: admin.email,
    role: admin.role
  },
  voidedAt: Date.now()
};

  // simpan nilai sebelum void
  item.totalBeforeVoid = voidData.amount;

  // kosongkan qty & harga
  item.qty = 0;
  item.total = 0;

  item.void = true;
  item.voidInfo = voidData;

  // üî• RECALCULATE
 order.subtotal = order.items.reduce((sum, i) => {
  if (i.void) return sum;
  return sum + (Number(i.total) || 0);
}, 0);

  order.grandTotal = order.subtotal - (order.discount || 0);
  if (order.grandTotal < 0) order.grandTotal = 0;

  // ‚úÖ PAKAI add BUKAN put
  await MENUVA_DB.add("ordersData", order);

  await loadOrders(); // reload dari DB
}

async function getAllVoidItems() {
  const orders = await MENUVA_DB.getAll("ordersData");
  const voids = [];

  orders.forEach(order => {
    order.items.forEach(item => {
      if (item.void) {

        const voidInfo = item.voidInfo || {};

        // ===== NORMALIZE TIMESTAMP =====
        let voidedAt = null;

        if (voidInfo.voidedAt) {
          voidedAt = new Date(Number(voidInfo.voidedAt)).toISOString();
        } else if (order.createdAt) {
          voidedAt = new Date(Number(order.createdAt)).toISOString();
        }

        voids.push({
          orderId: order.id,
          itemName: item.nama || "-",
          qty: voidInfo.qty ?? item.qty ?? 0,
          amount: Number(voidInfo.amount ?? item.harga * (item.qty || 1) ?? 0),
          reason: voidInfo.reason || "Void (old system)",
          voidedAt,
          voidedBy: voidInfo.voidedBy || null
        });

      }
    });
  });

  return voids;
}

 async function renderDailyVoidTable() {
  const voidsRaw = await getAllVoidItems();

  const today = new Date().toISOString().slice(0, 10);

  const todayVoids = voidsRaw.filter(v =>
    new Date(v.voidedAt).toISOString().slice(0, 10) === today
  );

  const container = document.getElementById("dailyVoidTable");

  container.innerHTML = todayVoids.map(v => {
    const date = new Date(v.voidedAt);
    const timeFormatted = date.toLocaleTimeString("id-ID", {
      hour: "2-digit",
      minute: "2-digit"
    });

    return `
      <tr>
        <td>${v.itemName}</td>
        <td>${v.qty}</td>
        <td>${formatHarga(v.amount)}</td>
        <td>${v.voidedBy?.email || "Unknown"}</td>
        <td>${v.voidedBy?.role || "Unknown"}</td>
        <td>${timeFormatted}</td>
        <td>${v.reason}</td>
      </tr>
    `;
  }).join("");
}

   let voidConfirmBtn,
    voidCancelBtn,
    voidPinInput,
    voidReasonSelect,
    voidReasonOther,
    voidAuthModal;

function openVoidModal(action) {
  pendingVoidAction = action;

  if (!voidAuthModal) {
    console.error("Void modal tidak ditemukan");
    return;
  }

  voidPinInput.value = "";
  voidReasonSelect.value = "";
  voidReasonOther.value = "";

  voidAuthModal.classList.remove("hidden");
}

  function initVoidModalElements() {

  voidConfirmBtn = document.getElementById("voidConfirmBtn");
  voidCancelBtn = document.getElementById("voidCancelBtn");
  voidPinInput = document.getElementById("voidPinInput");
  voidReasonSelect = document.getElementById("voidReasonSelect");
  voidReasonOther = document.getElementById("voidReasonOther");
  voidAuthModal = document.getElementById("voidAuthModal");

  if (!voidAuthModal) return;

  /* ================= PIN REALTIME VALIDATION ================= */

  if (voidPinInput) {

    // Reset warna saat user ngetik
    voidPinInput.oninput = () => {
      voidPinInput.classList.remove("input-error", "input-success");
    };

    // Validasi saat keluar dari input
    voidPinInput.onblur = async () => {
      const pin = voidPinInput.value.trim();
      if (!pin) return;

      const admin = await authorizeVoid(pin);

      voidPinInput.classList.remove("input-error", "input-success");

      if (admin) {
        voidPinInput.classList.add("input-success");
      } else {
        voidPinInput.classList.add("input-error");
      }
    };
  }

  /* ================= CONFIRM ================= */

  if (voidConfirmBtn) {
    voidConfirmBtn.onclick = async () => {

      const pin = voidPinInput.value.trim();
      if (!pin) return alert("PIN wajib");

      const admin = await authorizeVoid(pin);

      voidPinInput.classList.remove("input-error", "input-success");

      if (!admin) {
        voidPinInput.classList.add("input-error");
        return alert("PIN salah / tidak berwenang");
      }

      voidPinInput.classList.add("input-success");

      const reason = voidReasonSelect.value === "Lainnya"
        ? voidReasonOther.value.trim()
        : voidReasonSelect.value;

      if (!reason) return alert("Alasan wajib");

      if (pendingVoidAction?.type === "item") {
        await voidOrderItem(
          pendingVoidAction.orderId,
          pendingVoidAction.itemIndex,
          admin,
          reason
        );
      }

      // üî• RESET & CLOSE
      pendingVoidAction = null;

      voidPinInput.value = "";
      voidPinInput.classList.remove("input-error", "input-success");

      voidReasonSelect.value = "";
      voidReasonOther.value = "";

      voidAuthModal.classList.add("hidden");
    };
  }

  /* ================= CANCEL ================= */

  if (voidCancelBtn) {
    voidCancelBtn.onclick = () => {

      pendingVoidAction = null;

      voidPinInput.value = "";
      voidPinInput.classList.remove("input-error", "input-success");

      voidReasonSelect.value = "";
      voidReasonOther.value = "";

      voidAuthModal.classList.add("hidden");
    };
  }
}

function closeVoidModal() {
  pendingVoidAction = null;
  if (voidAuthModal) {
    voidAuthModal.classList.add("hidden");
    pendingVoidAction = null;

  }
}


/* ================== EVENTS ================== */
document.addEventListener("click", async (e) => {
  
  // ================= VOID ITEM =================
  const voidBtn = e.target.closest(".void-item-btn");
  if (voidBtn) {

    const orderId = Number(voidBtn.dataset.order);
    const itemIndex = Number(voidBtn.dataset.index);

    if (isNaN(orderId)) {
      console.error("Order ID invalid");
      return;
    }

    openVoidModal({
      type: "item",
      orderId: orderId,
      itemIndex: itemIndex
    });

    return;
  }


  // ================= SUBMIT ORDER =================
  const submitBtn = e.target.closest(".btn-submit");
  if (submitBtn) {

    const orderId = Number(submitBtn.dataset.order);

    if (isNaN(orderId)) {
      alert("Order ID tidak valid");
      return;
    }

    const order = await MENUVA_DB.get("ordersData", orderId);

    if (!order) {
      alert("Order tidak ditemukan");
      return;
    }

    order.status = "sent";
    order.sentTime = Date.now();

    // gunakan ADD sesuai mother DB lo
    await MENUVA_DB.add("ordersData", order);

    alert("Order berhasil dikirim ke kitchen & bar üöÄ");

    loadOrders();

    return;
  }


  // ================= PAID ORDER =================
  const paidBtn = e.target.closest(".btn-paid");
  if (paidBtn) {

    const orderId = Number(paidBtn.dataset.order);

    if (isNaN(orderId)) {
      alert("Order ID tidak valid");
      return;
    }

    const order = await MENUVA_DB.get("ordersData", orderId);

    if (!order) {
      console.error("Order tidak ditemukan:", orderId);
      alert("Order tidak ditemukan");
      return;
    }

    order.subtotal = Number(order.subtotal) || 0;
    order.discount = Number(order.discount) || 0;
    order.grandTotal = Number(order.grandTotal) || 0;

    // buka modal dulu
    openCashPaymentModal(order);

    return;
  }

});


/* ================== INIT ================== */
MENUVA_DB.openDB().then(()=>{
  loadRestoInfo();
  loadOrders();
});

</script>
<script>
  
let activeSummaryMode = "void";

  async function getAllOrders() {
  try {
    const orders = await MENUVA_DB.getAll("ordersData"
);
    return orders || [];
  } catch (err) {
    console.error("Failed load orders:", err);
    return [];
  }
}

async function renderSummaryPage() {

  // toggle halaman
  document.getElementById("orderPage").style.display = "none";
  document.getElementById("summaryPage").style.display = "block";

  const summaryPage = document.getElementById("summaryPage");

  const today = new Date().toISOString().slice(0,10);

  summaryPage.innerHTML = `
    <main class="container">

      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2>üìä Summary</h2>
        <button class="back-btn" onclick="backToOrders()">‚¨Ö Back</button>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;">

        <!-- LEFT: FILTER -->
        <div class="filter-bar summary-filter">
          <button class="summary-btn ${activeSummaryMode==="void"?"active":""}" data-mode="void">Void</button>
          <button class="summary-btn ${activeSummaryMode==="daily"?"active":""}" data-mode="daily">Daily</button>
          <button class="summary-btn ${activeSummaryMode==="weekly"?"active":""}" data-mode="weekly">Weekly</button>
          <button class="summary-btn ${activeSummaryMode==="monthly"?"active":""}" data-mode="monthly">Monthly</button>
        </div>

        <!-- RIGHT: CUSTOM RANGE -->
        <div style="display:flex;gap:6px;align-items:center;background:#fff;padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,.08);">

          <input 
            type="date" 
            id="customStart"
            value="${today}"
            style="font-size:12px;padding:4px;border-radius:6px;border:1px solid rgba(0,0,0,.15);"
          >

          <span style="opacity:.5;font-size:12px;">‚Üí</span>

          <input 
            type="date" 
            id="customEnd"
            value="${today}"
            style="font-size:12px;padding:4px;border-radius:6px;border:1px solid rgba(0,0,0,.15);"
          >

          <button 
            class="summary-btn"
            id="customRangeBtn"
            style="padding:4px 10px;font-size:12px;">
            View
          </button>

        </div>

      </div>

      <div id="summaryContent"></div>

    </main>
  `;

  // filter mode buttons
  document.querySelectorAll(".summary-btn[data-mode]").forEach(btn=>{
    btn.onclick = ()=>{
      activeSummaryMode = btn.dataset.mode;
      renderSummaryPage();
    };
  });

  // custom range button
  document.getElementById("customRangeBtn").onclick = handleCustomRange;

  renderSummaryDetail(activeSummaryMode);

}

  function backToOrders() {
  document.getElementById("summaryPage").style.display = "none";
  document.getElementById("orderPage").style.display = "block";
}

async function renderSummaryDetail(mode) {

  const container = document.getElementById("summaryContent");
  container.innerHTML = "Loading...";

  if (mode === "void") {
    return renderVoidSummary();
  }

  if (mode === "daily") {
    return renderDailySummary();
  }

  if (mode === "weekly") {
    return renderWeeklySummary();
  }

  if (mode === "monthly") {
    return renderMonthlySummary();
  }

}

  async function renderCustomRangeSummary(startDate, endDate) {

  const orders = await getAllOrders();

  const paidOrders = orders.filter(o => {

    if ((o.status || "").toUpperCase() !== "PAID")
      return false;

    if (!o.createdAt)
      return false;

    const d =
      new Date(o.createdAt)
      .toISOString()
      .slice(0,10);

    return d >= startDate && d <= endDate;

  });

  const grouped = {};

  paidOrders.forEach(order => {

    const date =
      new Date(order.createdAt)
      .toISOString()
      .slice(0,10);

    if (!grouped[date]) {
      grouped[date] = {
        gross: 0,
        discount: 0,
        net: 0,
        orders: 0,
        items: {}
      };
    }

    const g = grouped[date];

    g.gross += Number(order.subtotal) || 0;
    g.discount += Number(order.discount) || 0;
    g.net += Number(order.grandTotal) || 0;
    g.orders += 1;

    (order.items || []).forEach(it => {

      if (it.void === true) return;

      const name = it.nama || "Unknown";
      const qty = Number(it.qty) || 1;
      const price = Number(it.harga) || 0;

      if (!g.items[name]) {
        g.items[name] = { qty: 0, total: 0 };
      }

      g.items[name].qty += qty;
      g.items[name].total += qty * price;

    });

  });

  const sortedDates =
    Object.keys(grouped).sort().reverse();

  const container =
    document.getElementById("summaryContent");

  if (!sortedDates.length) {
    container.innerHTML =
      "<div class='order-card'>Tidak ada transaksi di range ini</div>";
    return;
  }

  container.innerHTML = `

    <div class="order-card" style="background:#f8fafc;">
      <b>Custom Range:</b> ${startDate} ‚Üí ${endDate}
    </div>

    ${sortedDates.map(date => {

      const g = grouped[date];

      const itemHtml =
        Object.entries(g.items).map(([name, data])=>`
          <div style="display:flex;justify-content:space-between;font-size:14px;opacity:.9">
            <div>${name} ${data.qty} porsi</div>
            <div>${formatHarga(data.total)}</div>
          </div>
        `).join("");

      return `
        <div class="order-card">

          <div class="order-header">
            <h3>${date}</h3>
            <div>${g.orders} Orders</div>
          </div>

          <div style="margin:8px 0">
            ${itemHtml || "<div style='opacity:.6'>No Items</div>"}
          </div>

          <div>Gross: ${formatHarga(g.gross)}</div>
          <div style="color:red">Discount: -${formatHarga(g.discount)}</div>
          <div><b>Net: ${formatHarga(g.net)}</b></div>

        </div>
      `;

    }).join("")}

  `;

}

  async function getPaidOrdersInRange(startDate, endDate) {
  const orders = await getAllOrders();

  return orders.filter(o => {
    if ((o.status || "").toUpperCase() !== "PAID")
      return false;

    const raw = o.createdAt || o.orderTime;
    if (!raw) return false;

    const d = new Date(Number(raw)).toISOString().slice(0,10);
    return d >= startDate && d <= endDate;
  });
}

  async function loadReportChart() {

  const { labels, values } =
    await buildReportChartData();

  renderReportChart(labels, values);

}

 async function openReportModal() {

  document
    .getElementById("reportModal")
    .classList.remove("hidden");

  await loadReportChart();

}


function closeReportModal() {

  document
    .getElementById("reportModal")
    .classList.add("hidden");

  if (reportChartInstance) {
    reportChartInstance.destroy();
    reportChartInstance = null;
  }
}


function handleCustomRange() {

  const start = document.getElementById("customStart").value;
  const end = document.getElementById("customEnd").value;

  if (!start || !end) {
    alert("Pilih tanggal dulu bro");
    return;
  }

  openReportModal();

  renderReportAnalytics(start, end); // ‚úÖ kirim param
}

async function renderReportAnalytics(startDate, endDate) {

  const orders = await getAllOrders();

  const paidOrders = orders.filter(o => {

    if ((o.status || "").toUpperCase() !== "PAID")
      return false;

    if (!o.createdAt)
      return false;

    const d = new Date(o.createdAt)
      .toISOString()
      .slice(0,10);

    return d >= startDate && d <= endDate;
  });

  const totalRevenue = paidOrders
    .reduce((sum, o) => sum + (o.grandTotal || 0), 0);

  /* ===== UPDATE TERMINAL CARDS ===== */

  document.getElementById("reportOrders").textContent =
    paidOrders.length;

  document.getElementById("reportRevenue").textContent =
    formatHarga(totalRevenue);

  document.getElementById("reportPeriod").textContent =
    `${startDate} ‚Üí ${endDate}`;
}

async function buildReportChartData(startDate, endDate) {

  const orders = await MENUVA_DB.getAll("ordersData");

  const revenuePerDay = {};

  orders
    .filter(o => o.status?.toLowerCase() === "paid")
    .forEach(order => {

      const date = order.date; // langsung pakai field date

      // filter periode jika ada
      if (startDate && date < startDate) return;
      if (endDate && date > endDate) return;

      revenuePerDay[date] =
        (revenuePerDay[date] || 0) + (order.grandTotal || 0);

    });

  const labels = Object.keys(revenuePerDay).sort();
  const values = labels.map(d => revenuePerDay[d]);

  console.log("RevenueMap FINAL:", revenuePerDay);

  return { labels, values };
}

  let reportChartInstance = null;

  function renderReportChart(labels, values) {

  const ctx = document
    .getElementById("reportChart")
    .getContext("2d");

  if (reportChartInstance) {
    reportChartInstance.destroy();
  }

  const gradient = ctx.createLinearGradient(0, 0, 0, 350);
  gradient.addColorStop(0, "rgba(59,130,246,0.6)");
  gradient.addColorStop(1, "rgba(59,130,246,0)");

  reportChartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
     datasets: [

  // üî• GLOW LAYER (bawah)
  {
    data: values,
    borderColor: "rgba(59,130,246,0.3)",
    borderWidth: 8,
    tension: 0,
    pointRadius: 0,
    fill: false
  },

  // üíé MAIN LINE (atas)
  {
    label: "Revenue",
    data: values,
    borderColor: "#3b82f6",
    borderWidth: 3,
    tension: 0,
    pointRadius: 4,
    pointBackgroundColor: "#60a5fa",
    pointHoverRadius: 7,
    fill: true,
    backgroundColor: gradient
  }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: "index",
        intersect: false
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: "#0f172a",
          borderColor: "#3b82f6",
          borderWidth: 1,
          titleColor: "#fff",
          bodyColor: "#fff",
          padding: 12,
          callbacks: {
            label: function(context) {
              return "Rp " + context.raw.toLocaleString("id-ID");
            }
          }
        }
      },
      scales: {
        x: {
          grid: {
            color: "rgba(255,255,255,0.05)"
          },
          ticks: {
            color: "#94a3b8"
          }
        },
        y: {
          grid: {
            color: "rgba(255,255,255,0.05)"
          },
          ticks: {
            color: "#94a3b8",
            callback: function(value) {
              return "Rp " + value.toLocaleString("id-ID");
            }
          }
        }
      }
    }
  });
}

async function renderVoidSummary() {

  const voids = await getAllVoidItems();
  const container = document.getElementById("summaryContent");

  if (!voids.length) {
    container.innerHTML = "<p style='opacity:.6'>Tidak ada void data</p>";
    return;
  }

  // ‚úÖ Ambil semua tanggal unik pakai LOCAL timezone
  const dates = [...new Set(
    voids
      .map(v => {
        const rawDate = v.voidedAt || v.voidAt;
        if (!rawDate) return null;

        const d = new Date(rawDate);
        if (isNaN(d.getTime())) return null;

        // format YYYY-MM-DD tapi LOCAL (bukan UTC)
        return d.toLocaleDateString("sv-SE");
      })
      .filter(Boolean)
  )].sort().reverse();

  if (!dates.length) {
    container.innerHTML = "<p style='opacity:.6'>Tidak ada tanggal valid</p>";
    return;
  }

  let activeVoidDate = dates[0];

  container.innerHTML = `
    <div class="filter-bar">
      ${dates.map(d=>`
        <button class="void-date-btn ${d===activeVoidDate?'active':''}" data-date="${d}">
          ${d}
        </button>
      `).join("")}
    </div>

    <div id="voidList"></div>
  `;

  document.querySelectorAll(".void-date-btn").forEach(btn=>{
    btn.onclick = ()=>{
      activeVoidDate = btn.dataset.date;

      renderVoidList(voids, activeVoidDate);

      document.querySelectorAll(".void-date-btn")
        .forEach(b=>b.classList.remove("active"));

      btn.classList.add("active");
    };
  });

  renderVoidList(voids, activeVoidDate);
}

 function renderVoidList(voids, date) {

  const list = document.getElementById("voidList");

  const filtered = voids.filter(v => {
    const rawDate = v.voidedAt || v.voidAt;
    if (!rawDate) return false;

    const d = new Date(rawDate);
    if (isNaN(d.getTime())) return false;

    return d.toLocaleDateString("sv-SE") === date;
  });

  if (!filtered.length) {
    list.innerHTML = "<div style='opacity:.6'>Tidak ada void di tanggal ini</div>";
    return;
  }

  list.innerHTML = filtered.map(v => {

    const rawDate = v.voidedAt || v.voidAt;
    const time = rawDate
      ? new Date(rawDate).toLocaleTimeString("id-ID", {
          hour: "2-digit",
          minute: "2-digit"
        })
      : "-";

    const email = v.voidedBy?.email || v.by || "Unknown";
    const role = v.voidedBy?.role || v.role || "Unknown";

    return `
      <div class="order-card">
        <div class="order-header">
          <h3>${v.itemName}</h3>
          <div class="status-badge status-voided">VOID</div>
        </div>

        <div>Qty: ${v.qty}</div>
        <div>Amount: ${formatHarga(v.amount)}</div>
        <div>Time: ${time}</div>
        <div>By: ${email} (${role})</div>
        <div>Reason: ${v.reason}</div>
      </div>
    `;
  }).join("");
}

async function renderDailySummary() {
  const orders = await getAllOrders();

  const paidOrders = orders.filter(o =>
    (o.status || "").toUpperCase() === "PAID"
  );

  const grouped = {};

  paidOrders.forEach(order => {
    if (!order.createdAt) return;

    const date = new Date(order.createdAt).toISOString().slice(0, 10);

    if (!grouped[date]) {
      grouped[date] = {
        gross: 0,
        discount: 0,
        net: 0,
        orders: 0,
        items: {}
      };
    }

    const g = grouped[date];

    // ================= MONEY ENGINE =================
    g.gross += Number(order.subtotal) || 0;
    g.discount += Number(order.discount) || 0;
    g.net += Number(order.grandTotal) || 0;
    g.orders += 1;

    // ================= ITEMS ENGINE =================
    const items = order.items || [];

    items.forEach(it => {
      if (it.void === true) return;

      const name = it.nama || "Unknown";
      const qty = Number(it.qty) || 1;
      const price = Number(it.harga) || 0;

      if (!g.items[name]) {
        g.items[name] = { qty: 0, total: 0 };
      }

      g.items[name].qty += qty;
      g.items[name].total += qty * price;
    });
  });

  const sortedDates = Object.keys(grouped).sort().reverse();
  const container = document.getElementById("summaryContent");

  if (!sortedDates.length) {
    container.innerHTML = "<div class='order-card'>Belum ada transaksi</div>";
    return;
  }

  container.innerHTML = sortedDates.map(date => {
    const g = grouped[date];

    const itemHtml = Object.entries(g.items).map(([name, data]) => `
      <div style="display:flex;justify-content:space-between;font-size:14px;opacity:.9">
        <div>${name} ${data.qty} porsi</div>
        <div>${formatHarga(data.total)}</div>
      </div>
    `).join("");

    return `
      <div class="order-card">
        <div class="order-header">
          <h3>${date}</h3>
          <div>${g.orders} Orders</div>
        </div>

        <div style="margin:8px 0">
          ${itemHtml || "<div style='opacity:.6'>No Items</div>"}
        </div>

        <div>Gross: ${formatHarga(g.gross)}</div>
        <div style="color:red">Discount: -${formatHarga(g.discount)}</div>
        <div><b>Net: ${formatHarga(g.net)}</b></div>
      </div>
    `;
  }).join("");
}

async function renderWeeklySummary() {
  const orders = await getAllOrders();

  const paidOrders = orders.filter(o =>
    (o.status || "").toUpperCase() === "PAID"
  );

  const grouped = {};

  paidOrders.forEach(order => {
    if (!order.createdAt) return;

    const d = new Date(order.createdAt);
    const year = d.getFullYear();
    const week = getWeekNumber(d);
    const key = `${year}-W${week}`;

    if (!grouped[key]) {
      grouped[key] = {
        gross: 0,
        discount: 0,
        net: 0,
        orders: 0,
        items: {}
      };
    }

    const g = grouped[key];

    g.gross += Number(order.subtotal) || 0;
    g.discount += Number(order.discount) || 0;
    g.net += Number(order.grandTotal) || 0;
    g.orders += 1;

    const items = order.items || [];

    items.forEach(it => {
      if (it.void === true) return;

      const name = it.nama || "Unknown";
      const qty = Number(it.qty) || 1;
      const price = Number(it.harga) || 0;

      if (!g.items[name]) {
        g.items[name] = { qty: 0, total: 0 };
      }

      g.items[name].qty += qty;
      g.items[name].total += qty * price;
    });
  });

  const sorted = Object.keys(grouped).sort().reverse();
  const container = document.getElementById("summaryContent");

  if (!sorted.length) {
    container.innerHTML = "<div class='order-card'>Belum ada transaksi</div>";
    return;
  }

  container.innerHTML = sorted.map(week => {
    const g = grouped[week];

    const itemRows = Object.entries(g.items).map(([name, val]) => `
      <div style="display:flex;justify-content:space-between;font-size:14px;opacity:.9">
        <span>${name} ${val.qty} porsi</span>
        <span>${formatHarga(val.total)}</span>
      </div>
    `).join("");

    return `
      <div class="order-card">
        <div class="order-header">
          <h3>${week}</h3>
          <div>${g.orders} Orders</div>
        </div>

        <div style="margin:8px 0">
          ${itemRows || "<i style='opacity:.6'>Tidak ada item</i>"}
        </div>

        <div>Gross: ${formatHarga(g.gross)}</div>
        <div style="color:red">Discount: -${formatHarga(g.discount)}</div>
        <div><b>Net: ${formatHarga(g.net)}</b></div>
      </div>
    `;
  }).join("");
}

   function getWeekNumber(date) {
  const temp = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = temp.getUTCDay() || 7;
  temp.setUTCDate(temp.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(temp.getUTCFullYear(),0,1));
  return Math.ceil((((temp - yearStart) / 86400000) + 1)/7);
}

async function renderMonthlySummary() {
  const orders = await getAllOrders();

  const paidOrders = orders.filter(o =>
    (o.status || "").toUpperCase() === "PAID"
  );

  const grouped = {};

  paidOrders.forEach(order => {
    if (!order.createdAt) return;

    const d = new Date(order.createdAt);
    const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;

    if (!grouped[key]) {
      grouped[key] = {
        gross: 0,
        discount: 0,
        net: 0,
        orders: 0,
        items: {}
      };
    }

    const g = grouped[key];

    g.gross += Number(order.subtotal) || 0;
    g.discount += Number(order.discount) || 0;
    g.net += Number(order.grandTotal) || 0;
    g.orders += 1;

    const items = order.items || [];

    items.forEach(it => {
      if (it.void === true) return;

      const name = it.nama || "Unknown";
      const qty = Number(it.qty) || 1;
      const price = Number(it.harga) || 0;

      if (!g.items[name]) {
        g.items[name] = { qty: 0, total: 0 };
      }

      g.items[name].qty += qty;
      g.items[name].total += qty * price;
    });
  });

  const sorted = Object.keys(grouped).sort().reverse();
  const container = document.getElementById("summaryContent");

  if (!sorted.length) {
    container.innerHTML = "<div class='order-card'>Belum ada transaksi</div>";
    return;
  }

  container.innerHTML = sorted.map(month => {
    const g = grouped[month];

    const itemRows = Object.entries(g.items).map(([name, val]) => `
      <div style="display:flex;justify-content:space-between;font-size:14px;opacity:.9">
        <span>${name} ${val.qty} porsi</span>
        <span>${formatHarga(val.total)}</span>
      </div>
    `).join("");

    return `
      <div class="order-card">
        <div class="order-header">
          <h3>${month}</h3>
          <div>${g.orders} Orders</div>
        </div>

        <div style="margin:8px 0">
          ${itemRows || "<i style='opacity:.6'>Tidak ada item</i>"}
        </div>

        <div>Gross: ${formatHarga(g.gross)}</div>
        <div style="color:red">Discount: -${formatHarga(g.discount)}</div>
        <div><b>Net: ${formatHarga(g.net)}</b></div>
      </div>
    `;
  }).join("");
}

function renderRevenueTrendChart(allOrders) {

  const canvas = document.getElementById("revenueTrendChart");
  if (!canvas) return;

  const ctx = canvas.getContext("2d");

  // fungsi ambil key tanggal lokal
  function getLocalDateKey(timestamp) {
    const d = new Date(Number(timestamp));
    const year = d.getFullYear();
    const month = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  // ambil 7 hari terakhir berdasarkan tanggal lokal
  const labels = [];
  const revenueMap = {};

  for (let i = 6; i >= 0; i--) {

    const d = new Date();
    d.setDate(d.getDate() - i);

    const key = getLocalDateKey(d.getTime());

    labels.push(
      d.toLocaleDateString("id-ID", {
        day: "2-digit",
        month: "short"
      })
    );

    revenueMap[key] = 0;
  }

  // jumlahkan revenue per tanggal
  allOrders.forEach(order => {

    if (!order.createdAt) return;

    const key = getLocalDateKey(order.createdAt);

    if (revenueMap.hasOwnProperty(key)) {

      revenueMap[key] += Number(order.grandTotal || 0);

    }

  });

  const data = Object.values(revenueMap);

  console.log("RevenueMap:", revenueMap); // debug

  // destroy chart lama
  if (window.revenueChartInstance) {
    window.revenueChartInstance.destroy();
  }

  // render chart
  window.revenueChartInstance = new Chart(ctx, {

    type: "line",

    data: {
      labels: labels,
      datasets: [{
        data: data,
        borderColor: "#4fd1c5",
        backgroundColor: "rgba(79,209,197,0.15)",
        tension: 0.4,
        fill: true,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },

    options: {

      responsive: true,
      maintainAspectRatio: false,

      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx =>
              "Rp " + ctx.raw.toLocaleString("id-ID")
          }
        }
      },

      scales: {

        x: {
          ticks: { color: "#aaa" },
          grid: { color: "rgba(255,255,255,0.05)" }
        },

        y: {
          ticks: {
            color: "#aaa",
            callback: v =>
              "Rp " + v.toLocaleString("id-ID")
          },
          grid: { color: "rgba(255,255,255,0.05)" }
        }

      }

    }

  });

}

  
document.addEventListener("DOMContentLoaded", async () => {

  initVoidModalElements();
  initClock();
  initUserInfo();

  try {

    const allOrders = await updateTodayInsights();

    renderRevenueTrendChart(allOrders);

  } catch (err) {

    console.error("‚ùå gagal load dashboard:", err);

  }

  // ===== SESSION CHECK =====

  const btn = document.getElementById("btnBackToAdmin");

  try {

    const session = await MENUVA_DB.getSession();
    const role = session?.role;

    if (role === "manager" || role === "owner") {

      if (btn) {
        btn.style.display = "inline-block";
        btn.onclick = goBackToAdmin;
      }

    } else {

      if (btn) btn.remove();

    }

  } catch (err) {

    console.error("‚ùå gagal ambil session", err);

    if (btn) btn.remove();

  }

});

 function initClock() {

  const clockEl = document.getElementById("liveClock");
  const clockElSummary = document.getElementById("liveClockSummary");
  const shiftEl = document.getElementById("shiftInfo");

  function updateAll() {
    const now = new Date();

    // ===== CLOCK =====
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');

    const timeString = `${hours}:${minutes}:${seconds}`;

    if (clockEl) clockEl.textContent = timeString;
    if (clockElSummary) clockElSummary.textContent = timeString;

    // ===== SHIFT =====
    const hour = now.getHours();
    let shift = "Morning";

    if (hour >= 6 && hour < 14) shift = "Morning";
    else if (hour >= 14 && hour < 22) shift = "Afternoon";
    else shift = "Night";

    if (shiftEl) shiftEl.textContent = "Shift: " + shift;
  }

  updateAll();
  setInterval(updateAll, 1000);
}

  function detectShift() {
  const hour = new Date().getHours();
  let shift = "Morning";

  if (hour >= 6 && hour < 14) shift = "Morning";
  else if (hour >= 14 && hour < 22) shift = "Afternoon";
  else shift = "Night";

  document.getElementById("shiftInfo").textContent = 
    "Shift: " + shift;
}

 async function initUserInfo() {
  try {
    const session = await MENUVA_DB.getSession();

    if (!session) {
      document.getElementById("userInfo").textContent =
        "User: Unknown";
      return;
    }

    const name = session.name || session.email || "User";
    const role = session.role || "-";

    document.getElementById("userInfo").textContent =
      `User: ${name} (${role})`;

  } catch (err) {
    console.error("Gagal ambil session:", err);
  }
}

 async function updateTodayInsights() {

  const orders = await MENUVA_DB.getAll("ordersData");

  const today = new Date().toISOString().slice(0,10);

  const todayOrders = orders.filter(o => {
    const d = new Date(Number(o.createdAt))
      .toISOString().slice(0,10);
    return d === today;
  });

  const totalOrders = todayOrders.length;

  let totalRevenue = 0;
  const itemMap = {};

  todayOrders.forEach(order => {

    totalRevenue += Number(order.grandTotal || 0);

    order.items?.forEach(item => {

      if (!item.void) {

        itemMap[item.nama] =
          (itemMap[item.nama] || 0) + (item.qty || 1);

      }

    });

  });

  const avgOrder = totalOrders
    ? Math.round(totalRevenue / totalOrders)
    : 0;

  const topItem = Object.entries(itemMap)
    .sort((a,b)=>b[1]-a[1])[0]?.[0] || "-";

  document.getElementById("todayOrdersStat").textContent = totalOrders;

  document.getElementById("avgOrderStat").textContent =
    "Rp " + avgOrder.toLocaleString("id-ID");

  document.getElementById("avgPrepStat").textContent = "12 min";

  document.getElementById("topItemStat").textContent = topItem;

  return orders; // ‚Üê penting untuk chart 7 hari

}

  function goBackToAdmin() {
    window.location.href = "admin.html";
  }
</script>

  
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div id="summaryPage" style="display:none;"></div>

</body>
</html>






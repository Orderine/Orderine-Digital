<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Receives - Admin</title>

<style>
/* copy root theme & base dari template lo */
:root{
  --bg: #f4f8ff;
  --surface: #ffffff;
  --text: #1f2a44;
  --muted: #6b7a99;
  --border: #d8e1ff;
  --brand: #1f70ff;
  --brand-2: #2a5298;
  --brand-3: #1e3c72;
  --chip: #eef4ff;
  --danger: #e54646;
  --success: #25d366;
  --shadow: 0 6px 24px rgba(0,0,0,.08);
  --qty-btn-bg: #eef4ff;
  --qty-btn-text: #1f2a44;
  --container-max: 1200px;
}
body.dark-mode{
  --bg: #0e1116;
  --surface: #141922;
  --text: #e6ebff;
  --muted: #aab6db;
  --border: #263148;
  --brand: #4da3ff;
  --chip: #0f1a2a;
  --shadow: 0 8px 28px rgba(0,0,0,.5);
  --qty-btn-bg: #263148;
  --qty-btn-text: #e6ebff;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family: Inter, system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background .25s, color .25s;
}

/* header */
header{
  background: linear-gradient(90deg,var(--brand-2),var(--brand-3));
  color:#fff;
  padding:16px;
  box-shadow:var(--shadow);
}
.header-inner{display:flex;align-items:center;justify-content:space-between}
#restoLogo{height:50px;width:50px;border-radius:8px;object-fit:contain;background:rgba(255,255,255,.15)}
#restoName{margin:0;font-size:18px;font-weight:800}
.dark-toggle{
  background:rgba(255,255,255,0.12);
  border:none;
  font-size:1.2rem;
  cursor:pointer;
  color:#fff;
  padding:6px 8px;
  border-radius:6px;
}

/* order list */
.container{max-width:var(--container-max);margin:20px auto;padding:0 16px}
.order-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  padding:16px;
  margin-bottom:20px;
}
.order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.order-header h3{margin:0;font-size:16px;font-weight:800}
.order-meta{font-size:13px;color:var(--muted);margin-bottom:8px}
.order-items{margin-top:10px;border-top:1px dashed var(--border);padding-top:10px}
.order-item{display:flex;justify-content:space-between;margin-bottom:6px;font-size:14px}
.order-summary{margin-top:10px;font-weight:700;font-size:14px}
.order-actions{margin-top:12px;display:flex;gap:8px}
.btn{padding:8px 14px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:0}
.btn-print{background:var(--brand);color:#fff}
.btn-void{background:var(--danger);color:#fff}

  .theme-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  font-size: 1.4rem;
  transition: transform 0.2s ease;
}
.theme-btn:hover {
  transform: scale(1.2);
}
* {
  transition: background-color 0.25s ease, color 0.25s ease, border-color 0.25s ease;
}
.filter-bar {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}
.date-btn {
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  box-shadow: var(--shadow);
}
.date-btn.active {
  background: var(--brand);
  color: #fff;
}
.date-btn:hover {
  opacity: 0.85;
}
.order-note {
  margin: 6px 0;
  padding: 6px 10px;
  background: rgba(255, 255, 0, 0.1);
  border-left: 3px solid orange;
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.4;
  white-space: pre-wrap; /* biar line break di notes muncul */
}
.new-order-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #222;
  color: #fff;
  padding: 14px 18px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
  opacity: 0;
  transform: translateY(30px);
  transition: all 0.4s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  z-index: 9999;
}
.new-order-toast.show {
  opacity: 1;
  transform: translateY(0);
}
.toast-icon {
  font-size: 1.4em;
}
  #backToAdmin {
  text-align: left;
  margin: 12px 0 16px 12px;
}

#backToAdmin button {
  background-color: var(--accent, #2563eb);
  color: white;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  transition: 0.25s;
}

#backToAdmin button:hover {
  background-color: #1e40af;
  transform: scale(1.03);
}

</style>
</head>
<body>

<header>
  <div class="header-inner">
    <div style="display:flex;align-items:center;gap:10px">
      <img id="restoLogo" alt="Logo">
      <div>
        <h1 id="restoName">Loading...</h1>
        <p id="restoAddress" style="font-size:12px;margin:2px 0 0;opacity:0.8"></p>
        <p id="restoPhone" style="font-size:12px;margin:0;opacity:0.8"></p>
      </div>
    </div>
   <button id="themeToggle" class="theme-btn" aria-label="Toggle Dark Mode">
  <span id="themeIcon">üåô</span>
</button>

  </div>
</header>

<main class="container">
  <h2 style="margin-bottom:16px">üì• Incoming Orders</h2>
  <div id="ordersBox"></div>
</main>
  
<!-- Tombol kembali -->
<div id="backToAdmin">
  <button onclick="goBackToAdmin()">‚¨Ö Kembali ke Admin</button>
</div>

<script>
/* ================== DB CONFIG (v9) =================== */
const DB_NAME = 'MenuvaDB';
let db;

function initDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 14);

    req.onupgradeneeded = (e) => {
      db = e.target.result;

      // ====== ordersData ======
      if (!db.objectStoreNames.contains('ordersData')) {
        const store = db.createObjectStore('ordersData', { keyPath: 'id', autoIncrement: true });
        store.createIndex('status', 'status', { unique: false });
      }

      // ====== menuvaData (buat resto info) ======
      if (!db.objectStoreNames.contains('menuvaData')) {
        db.createObjectStore('menuvaData', { keyPath: 'id', autoIncrement: true });
      }

      console.log('‚úÖ stores checked/created');
    };

    req.onsuccess = (e) => {
      db = e.target.result;
      console.log('‚úÖ DB connected');
      resolve();
    };

    req.onerror = () => {
      console.error('‚ùå DB Init Error:', req.error);
      reject(req.error);
    };
  });
}
  /* ================== NOTIFIKASI ORDER BARU ================== */
function showNewOrderNotification() {
  // ====== 1Ô∏è‚É£ Notifikasi visual ======
  const notif = document.createElement('div');
  notif.className = 'new-order-toast';
  notif.innerHTML = `
    <div class="toast-icon">üõéÔ∏è</div>
    <div class="toast-text">New Order!</div>
  `;
  document.body.appendChild(notif);

  // animasi muncul
  setTimeout(() => notif.classList.add('show'), 50);

  // hilang otomatis setelah 4 detik
  setTimeout(() => {
    notif.classList.remove('show');
    setTimeout(() => notif.remove(), 500);
  }, 8000);

  // ====== 2Ô∏è‚É£ Notifikasi suara (pakai file lokal) ======
  try {
    const audio = new Audio('./beep.mp3'); // ‚úÖ file lokal
    audio.volume = 0.6;                    // sesuaikan volume
    audio.play().catch(() => {
      console.warn('‚ö†Ô∏è Browser menolak autoplay suara (butuh interaksi user dulu).');
    });
  } catch (err) {
    console.warn('‚ö†Ô∏è Gagal memutar suara notif:', err);
  }
}

/* ================== REAL-TIME UPDATER ================== */
const bc = new BroadcastChannel("menuvaOrders");


// Dengarkan sinyal update dari tab lain
bc.onmessage = (event) => {
  if (event.data?.type === 'newOrder') {
    console.log('üì° Pesanan baru diterima dari book.html');
    loadOrders(); // üîÑ reload daftar order
    showNewOrderNotification(); // üîî tampilkan notifikasi visual + suara
  }
};

// Fungsi untuk kirim sinyal update ke semua tab
function notifyOrdersUpdated() {
  bc.postMessage('update_orders');
}

/* amanin akses ke store */
function safeTransaction(storeName, mode = 'readonly') {
  if (!db) {
    console.error('‚ùå Database belum siap.');
    return null;
  }
  try {
    return db.transaction(storeName, mode).objectStore(storeName);
  } catch (err) {
    console.error(`‚ùå Gagal buka store ${storeName}:`, err);
    return null;
  }
}

/* ambil semua order dari store ordersData */
function loadOrders() {
  const store = safeTransaction('ordersData', 'readonly');
  if (!store) {
    document.getElementById('ordersBox').innerHTML =
      "<p style='color:red'>‚ùå ordersData tidak ditemukan. Pastikan book.html sudah mengirim pesanan.</p>";
    return;
  }

  const req = store.getAll();
  req.onsuccess = () => {
    const orders = req.result || [];
    renderOrders(orders);
  };
  req.onerror = (e) => {
    console.error('‚ùå Gagal load orders:', e.target.error);
    document.getElementById('ordersBox').innerHTML =
      "<p style='color:red'>‚ùå Error loading orders.</p>";
  };
}

/* ================= LOAD RESTO INFO ================= */
function loadRestoInfo(){
  const tx = db.transaction('menuvaData', 'readonly');
  const store = tx.objectStore('menuvaData');
  const req = store.get(1); // data resto tersimpan di id=1

  req.onsuccess = () => {
    const data = req.result;
    if (!data) {
      console.warn('‚ö†Ô∏è Data resto tidak ditemukan di IndexedDB');
      document.getElementById('restoName').textContent = 'Unknown Resto';
      return;
    }

    // nama resto
    const name = data.namaRestoran || data.restoName || 'Unknown Resto';
    document.getElementById('restoName').textContent = name;

    // logo
    if (data.logo)
      document.getElementById('restoLogo').src = data.logo;

    // alamat
    if (data.restoAddress)
      document.getElementById('restoAddress').textContent = data.restoAddress;

    // nomor telepon
    if (data.restoPhone)
      document.getElementById('restoPhone').textContent = `üìû ${data.restoPhone}`;
  };

  req.onerror = () => {
    console.warn('‚ö†Ô∏è Gagal load resto info');
    document.getElementById('restoName').textContent = 'Unknown Resto';
  };
}

function renderOrders(data) {
  const box = document.getElementById('ordersBox');
  box.innerHTML = '';

  if (!data.length) {
    box.innerHTML = `<p style="color:var(--muted)">No orders yet.</p>`;
    return;
  }

  // Urutkan berdasarkan tanggal (lama ke baru)
  data.sort((a, b) => new Date(a.date) - new Date(b.date));

  // Ambil semua tanggal unik
  const uniqueDates = [...new Set(data.map(o => o.date || 'Unknown Date'))];

  // ======== FILTER NAV (TOMBOL PER TANGGAL) ========
  const filterBar = document.createElement('div');
  filterBar.className = 'filter-bar';
  filterBar.innerHTML = uniqueDates
    .map(
      (tgl, idx) =>
        `<button class="date-btn ${idx === uniqueDates.length - 1 ? 'active' : ''}" data-date="${tgl}">${tgl}</button>`
    )
    .join('');
  box.appendChild(filterBar);

  // ======== TEMPAT ORDER ========
  const listContainer = document.createElement('div');
  listContainer.id = 'ordersList';
  box.appendChild(listContainer);

  // tampilkan default tanggal terakhir
  const defaultDate = uniqueDates[uniqueDates.length - 1];
  renderOrdersByDate(data, defaultDate);

  // Event klik pada tombol tanggal
  box.querySelectorAll('.date-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // ubah highlight
      box.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      // render ulang
      renderOrdersByDate(data, btn.dataset.date);
    });
  });
}

/* render hanya untuk tanggal tertentu */
function renderOrdersByDate(data, selectedDate) {
  const listContainer = document.getElementById('ordersList');
  listContainer.innerHTML = '';

  const filtered = data.filter(o => (o.date || 'Unknown Date') === selectedDate);

  if (!filtered.length) {
    listContainer.innerHTML = `<p style="color:var(--muted)">No orders for ${selectedDate}.</p>`;
    return;
  }

  filtered.forEach(order => {
    const div = document.createElement('div');
    div.className = 'order-card';
    div.innerHTML = `
      <div class="order-header">
        <h3>Table ${order.table || '-'} - ${order.customer || '-'}</h3>
        <span>${order.time || ''}</span>
      </div>
      <div class="order-meta">
        Order ID: ${order.id} | Status: ${order.status}
      </div>

      ${order.note ? `
      <div class="order-note">
        üìù <b>Note:</b> ${order.note}
      </div>` : ''}

      <div class="order-items">
        ${order.items.map(i => `
          <div class="order-item">
            <span>${i.nama} √ó${i.qty}</span>
            <span>${formatHarga(i.total)}</span>
          </div>
        `).join('')}
      </div>

      <div class="order-summary">
        Subtotal: ${formatHarga(order.subtotal)}<br>
        ${order.discount > 0
          ? `Discount (${order.voucherCode || ''} - ${order.discountPercent}%): -${formatHarga(order.discount)}<br>`
          : ''
        }
        <strong>Grand Total: ${formatHarga(order.grandTotal)}</strong>
      </div>

      <div class="order-actions">
        <button class="btn btn-print" onclick="printOrder(${order.id})">üñ® Print</button>
        <button class="btn btn-void" onclick="voidOrder(${order.id})">‚ùå Void</button>
      </div>
    `;
    listContainer.appendChild(div);
  });
}

/* format harga */
function formatHarga(amount){
  return new Intl.NumberFormat('id-ID', {
    style: 'currency', currency: 'IDR', minimumFractionDigits: 0
  }).format(amount || 0);
}

function printOrder(id) {
  const card = document.querySelector(`.order-card:nth-child(${id})`);
  if (!card) {
    alert("‚ö†Ô∏è Order tidak ditemukan.");
    return;
  }

  // buat clone elemen card
  const printContent = card.cloneNode(true);

  // gaya minimal khusus print
  const printStyle = `
    <style>
      * { font-family: Inter, sans-serif; color: #000; }
      body { background: #fff; margin: 20px; }
      .order-card {
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 16px;
        max-width: 500px;
        margin: auto;
      }
      h3 { margin: 0 0 8px 0; }
      .order-item { display:flex; justify-content:space-between; margin-bottom:4px; }
      .order-summary { margin-top:12px; font-weight:bold; }
      .order-actions { display:none; }
    </style>
  `;

  // buka window print
  const win = window.open('', '', 'width=600,height=800');
  win.document.write(`
    <html>
      <head>
        <title>Print Order #${id}</title>
        ${printStyle}
      </head>
      <body>${printContent.outerHTML}</body>
    </html>
  `);
  win.document.close();
  win.focus();

  // tunggu sedikit supaya CSS kebaca, baru print
  setTimeout(() => {
    win.print();
    win.close();
  }, 500);
}
/* aksi void (real-time update) */
function voidOrder(id) {
  const tx = db.transaction('ordersData', 'readwrite');
  const store = tx.objectStore('ordersData');
  const req = store.get(id);

  req.onsuccess = () => {
    const order = req.result;
    if (order) {
      // Konfirmasi manual aja biar gak ke-klik sembarangan
      const confirmVoid = confirm(`Yakin ingin VOID Order #${id}?`);
      if (!confirmVoid) return;

      order.status = 'void';
      store.put(order);

      tx.oncomplete = () => {
        console.log(`üóë Order #${id} berhasil diubah menjadi void`);
        loadOrders();        // üîÑ refresh tampilan lokal
        notifyOrdersUpdated(); // üì° kirim sinyal update ke tab lain
        alert(`‚úÖ Order #${id} berhasil di-VOID.`);
      };
    } else {
      console.warn(`‚ö†Ô∏è Order dengan ID ${id} tidak ditemukan.`);
    }
  };

  req.onerror = (e) => {
    console.error('‚ùå Gagal mengambil order:', e.target.error);
  };
}


const themeToggle = document.getElementById('themeToggle');
const themeIcon = document.getElementById('themeIcon');

// === apply theme saat load ===
if (localStorage.getItem('theme') === 'dark') {
  document.body.classList.add('dark-mode');
  themeIcon.textContent = 'üåû';
} else {
  document.body.classList.remove('dark-mode');
  themeIcon.textContent = 'üåô';
}

// === toggle saat diklik ===
themeToggle.addEventListener('click', () => {
  const isDark = document.body.classList.toggle('dark-mode');
  themeIcon.textContent = isDark ? 'üåû' : 'üåô';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
});

/* start */
document.getElementById('ordersBox').innerHTML = `
  <p style="color:var(--muted)">‚è≥ Loading orders...</p>
`;

initDB()
  .then(() => {
    // ‚úÖ tampilkan logo & nama resto
    loadRestoInfo();

    // ‚úÖ tampilkan daftar pesanan
    loadOrders();
  })
  .catch(err => {
    console.error('‚ùå DB Init Error:', err);
    document.getElementById('ordersBox').innerHTML = `
      <p style="color:red">‚ùå Gagal membuka database. Periksa IndexedDB di browser.</p>
    `;
  });
  
function goBackToAdmin() {
  // arahkan balik ke admin.html
  window.location.href = 'admin.html';
}

</script>
  
<script>
localStorage.setItem("lastViewedOrderTime", Date.now());
</script>

</body>
</html>





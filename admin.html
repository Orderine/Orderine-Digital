<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <!-- DB CORE (SINGLE SOURCE OF TRUTH) -->
<script src="./db-core.js"></script>

<!-- AUTH GUARD (NON MODULE) -->
<script src="./auth-guard.js"></script>

<!-- IONICONS -->
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<link rel="icon" href="data:,">

<!-- CDN BIASA -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<audio id="notifAudio" src="./beep.mp3" preload="auto"></audio>
<audio id="clickAudio" src="./click.mp3" preload="auto"></audio>

  <title>Admin Orderine</title>
  <style>
    * {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 20px;
  padding-bottom: 80px;
  font-family: Arial, sans-serif;
  background: #003366;
  overflow-x: hidden;
  color: #cfefff;
}

/* ================= SECTION CORE ================= */

.section,
.setting-card {
  background: #0b0f14;
  border: 1px solid #00f0ff33;
  border-radius: 12px;
  padding: 18px 20px;
  margin-bottom: 28px;
  position: relative;
  box-shadow:
    0 0 8px #00f0ff22,
    inset 0 0 12px #000000aa;
}

.section h2,
.setting-card h2 {
  color: #00f0ff;
  font-size: 17px;
  margin-bottom: 14px;
  text-shadow: 0 0 6px #00f0ff55;
}

/* ================= INPUT ================= */

input,
textarea {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: 1px solid #00f0ff33;
  background: #02070c;
  color: #00f0ff;
  margin-bottom: 10px;
}

input:focus,
textarea:focus {
  outline: none;
  border-color: #00f0ff;
  box-shadow: 0 0 8px #00f0ff55;
}

/* ================= BUTTON SYSTEM ================= */

.btn {
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  border: 1px solid transparent;
  transition: 0.2s;
}

/* Primary Neon */
.btn-primary {
  background: #002a2a;
  color: #00f0ff;
  border: 1px solid #00f0ff;
}

.btn-primary:hover {
  background: #00f0ff;
  color: #000;
  box-shadow: 0 0 12px #00f0ff;
}

/* Orange */
.btn-orange {
  background: #2a1400;
  color: #ffa500;
  border: 1px solid #ffa500;
}

.btn-orange:hover {
  background: #ffa500;
  color: #000;
  box-shadow: 0 0 12px #ffa500;
}

/* Red */
.btn-red {
  background: #330000;
  color: #ff4d4d;
  border: 1px solid #ff4d4d;
}

.btn-red:hover {
  background: #ff4d4d;
  color: #000;
  box-shadow: 0 0 12px #ff4d4d;
}

/* ================= SWITCH TOGGLE ================= */

.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 30px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  inset: 0;
  background: #05080c;
  border: 1px solid #00f0ff44;
  border-radius: 30px;
  transition: .3s;
}

.slider:before {
  content: "";
  position: absolute;
  height: 20px;
  width: 20px;
  left: 4px;
  top: 3px;
  background: #00f0ff;
  border-radius: 50%;
  transition: .3s;
}

.switch input:checked + .slider {
  background: #002a30;
}

.switch input:checked + .slider:before {
  transform: translateX(28px);
}

/* ================= VOUCHER ================= */

#voucherContainerBox {
  background: #010409;
  border: 1px solid #00f0ff33;
  border-radius: 10px;
  padding: 18px;
}

#voucherForm label {
  font-size: 13px;
  color: #7fffff;
}

#saveVoucherBtn {
  background: #002b00;
  color: #00ff88;
  border: 1px solid #00ff88;
  padding: 8px 14px;
  border-radius: 6px;
  cursor: pointer;
}

#saveVoucherBtn:hover {
  background: #00ff88;
  color: #000;
  box-shadow: 0 0 10px #00ff88;
}

.voucher-card {
  background: #010409;
  border: 1px solid #00f0ff22;
  border-radius: 8px;
  padding: 12px;
  margin-top: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* ================= FIXED BAR ================= */

.fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: #003366;
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 999;
}

.nav-item {
  flex: 1;
  text-align: center;
  cursor: pointer;
  color: #fff;
  font-size: 12px;
}

.nav-item:hover {
  color: #d4af37;
}

/* ================= HIDDEN ================= */

.hidden {
  display: none;
}

</style>
</head>
<body>
<div class="menuva-logo">
  <img src="menuva-logo.png" alt="Logo Menuva">
  <br>
  <p style="color: white;">Digital Solution For Restaurant, Hotel, & Cafe's</p>
</div>

<div class="terminal-panel">
  <h2>BUSINESS IDENTITY</h2>
  <div class="terminal-header">
   
  </div>

  <div class="terminal-body identity-body">

    <div class="identity-inner">

     <label for="logoInput">Your Business Logo</label>
      <input type="file" id="logoInput" name="logoInput" accept="image/*" />

      <img id="previewLogo" src="" alt="Logo Restoran" />

      <label for="namaRestoran">Your Business Name</label>
      <input type="text" id="namaRestoran" name="namaRestoran" placeholder="Your Business Name" />

      <label for="restoAddress">Your Business Address</label>
      <input id="restoAddress" name="restoAddress" type="text" placeholder="Jl. Sudirman No. 10, Jakarta" />

      <label for="restoPhone">Phone Number</label>
      <input id="restoPhone" name="restoPhone" type="text" placeholder="08xx-xxxx-xxxx" />
      
    </div>

  </div>

</div>


<div class="terminal-room">

  <h4 class="menu-categories-title">MENU PROMO</h4>

  <div class="terminal-header">
  <span></span>
  </div>

  <div class="terminal-body">

    <!-- LEFT PANEL -->
    <div class="terminal-left">

      <div class="terminal-card add-category-card" onclick="openAddPromo()">
        <div class="terminal-card-header">
          <span class="terminal-dot"></span>
          <span class="terminal-title">PROMO SYSTEM</span>
        </div>
        <div class="terminal-card-body">
          <h3>+ ADD PROMO</h3>
        </div>
      </div>

      <div id="promoEditorPanel" class="terminal-editor">
        <h3>PROMO EDITOR</h3>

        <input type="text" id="promoNameInput" placeholder="Promo Name" />
        <textarea id="promoDescInput"
          placeholder="Description (Chicken, Mix Vegetable, etc)"
          rows="2"
          style="width:100%;resize:vertical;"></textarea>
        <input type="number" id="promoPriceInput" placeholder="Promo Price" />
        <input type="file"
       id="promoImageInput"
       accept="image/*"
       onchange="uploadPromoImage(event, this)" />
        <img id="promoImagePreview"
        style="width:100%;margin-top:10px;display:none;border:1px solid #00f0ff;" />

        <label>Start Date</label>
       <input type="date" id="promoStartDate" />

        <label>End Date</label>
        <input type="date" id="promoEndDate" />

        <label class="promo-toggle">
        <input type="checkbox" id="promoActiveToggle" checked />
        Promo Active
        </label>


        <button onclick="savePromoItem()">SAVE PROMO</button>
      </div>

    </div>

    <!-- RIGHT PANEL -->
    <div class="terminal-right">
      <div id="promoFilterBar" class="terminal-filter-bar"></div>
      <div id="promoPreviewGrid" class="terminal-grid"></div>
    </div>

  </div>

</div>


<div class="terminal-room">
 <h4 class="menu-categories-title">MENU CATEGORIES</h4>
  <div class="terminal-header">
   
  </div>

  <div class="terminal-body">

    <!-- LEFT PANEL -->
    <div class="terminal-left">

      <div class="terminal-card add-category-card" onclick="openAddCategory()">
        <div class="terminal-card-header">
          <span class="terminal-dot"></span>
          <span class="terminal-title">CATEGORY SYSTEM</span>
        </div>
        <div class="terminal-card-body">
          <h3>+ ADD CATEGORY</h3>
        </div>
      </div>

      <div id="menuEditorPanel" class="terminal-editor">
        <h3>MENU EDITOR</h3>

        <input type="text" id="menuNameInput" placeholder="Menu Name" />
        <input type="number" id="menuPriceInput" placeholder="Price" />
        <input type="file" id="menuImageInput" accept="image/*" />
        <img id="imagePreview" style="width:100%;margin-top:10px;display:none;border:1px solid #00f0ff;" />

        <button onclick="saveMenuItem()">SAVE MENU</button>
      </div>

    </div>

    <!-- RIGHT PANEL -->
    <div class="terminal-right">
      <div id="categoryFilterBar" class="terminal-filter-bar"></div>
      <div id="menuPreviewGrid" class="terminal-grid"></div>
    </div>

  </div>

</div>

  <!-- ADD CATEGORY MODAL -->
<div id="addCategoryModal" class="terminal-modal">
  <div class="terminal-modal-content">
    <h2>ADD CATEGORY</h2>

    <input type="text" id="categoryNameInput" placeholder="Category Name..." />

    <div class="modal-actions">
      <button onclick="saveCategory()">SAVE</button>
      <button onclick="closeAddCategory()">CANCEL</button>
    </div>
  </div>
</div>


<div class="section-box" id="waContainerBox">
  <h3>üì± Admin WhatsApp Number (Order/Reservation Recipient)</h3>
  <div id="nomorWaContainer">
    <label for="waNumber1" class="sr-only">WhatsApp Number</label>
    <input type="text" id="waNumber1" name="waNumber[]" class="nomor-wa" placeholder="Example: 6281234567890">
  </div>
  <button onclick="tambahNomorWa()">+ Add WA Number</button>
</div>

<div class="section">
  <h2>üì∏ Room Gallery</h2>
  <button onclick="tambahGambar('ruangan')">+ Add Room Image</button>
  <input type="file" id="flipbookRuanganUpload" name="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookRuanganPreview"></div>
</div>

<div class="section">
  <h2>üìñ Restaurant Menu</h2>
  <button onclick="tambahGambar('menu')">+ Add Menu Image</button>
  <input type="file" id="flipbookMenuUpload" name="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookMenuPreview"></div>
</div>

<div class="setting-card" id="orderToggleBox">
  <h2>‚öôÔ∏è Reservation & Delivery Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleOrderPage" name="toggleOrderPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Reservation & Delivery Page</span>
</div>

<div class="setting-card" id="roomToggleBox">
  <h2>‚öôÔ∏è Room Page Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleRoomPage" name="toggleRoomPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Room Page.</span>
</div>

<div class="section-box" id="roomContainerBox">
  <h2>üè® Room / Packages</h2>
  <div class="room-section">
    <h3>üõèÔ∏è Room Hotel</h3>
    <button onclick="tambahRoom('hotel')" class="btn-tambah-room">+ Add Hotel Room</button>
    <div id="roomHotelContainer"></div>
  </div>
  <div class="room-section">
    <h3>üíº Meeting Room</h3>
    <button onclick="tambahRoom('meeting')" class="btn-tambah-room">+ Add Meeting Room</button>
    <div id="meetingRoomContainer"></div>
  </div>
  <div class="room-section">
    <h3>üéÅ Packages</h3>
    <button onclick="tambahRoom('package')" class="btn-tambah-room">+ Add Packages</button>
    <div id="packageContainer"></div>
  </div>
</div>

<div class="section-box" id="voucherContainerBox">
  <h2>üéüÔ∏è Voucher Diskon</h2>
  <label class="switch">
    <input type="checkbox" id="toggleVoucherPage" name="toggleVoucherPage">
    <span class="slider round"></span>
  </label>

  <div id="voucherForm" style="margin-top:15px; display:none;">
    <label for="voucherCode">Voucher Code</label>
    <input type="text" id="voucherCode" name="voucherCode" placeholder="Kode Voucher">

    <label for="voucherDiscount">Discount (%)</label>
    <input type="number" id="voucherDiscount" name="voucherDiscount" placeholder="Diskon (%)">

    <label for="voucherExpiry">Expiry Date</label>
    <input type="date" id="voucherExpiry" name="voucherExpiry">

    <button id="saveVoucherBtn" onclick="saveVoucher()">üíæ Save Voucher Code</button>
  </div>

  <div id="voucherPreview"></div>
</div>

<hr>

<div class="section">
<button class="admin-btn admin-save" onclick="simpanData()">üíæ Save All Data</button>

<button id="btnOpenCustomer" class="admin-btn admin-view hidden">
üëÅÔ∏è See Customer Page
</button>

  <div class="qr-section hidden" id="qrSection">
  <h4>Customer Link</h4>

  <div id="customerLinkDisplay" class="link-display"></div>

<button id="btnSalinLink" class="admin-btn admin-copy hidden">
üìã Copy Link
</button>

<button id="btnDownloadQR" class="admin-btn admin-download hidden">
‚¨áÔ∏è Download QR
</button>

<button id="btnPrintQR" class="admin-btn admin-print hidden">
üñ®Ô∏è Print QR
</button>

  
  <div id="qrPreview" class="qr-box"></div>
</div>


  <div class="section">
    <h2>üîÅ Backup & Restore Data</h2>
    <button onclick="downloadBackupJSON()">üì¶ Backup Data</button>
    <div id="backupDownloadLink" style="margin-top:10px;"></div>

    <label for="restoreInput" style="margin-top: 20px; display: block;">üìÇ Select JSON File to Restore:</label>
    <input type="file" id="restoreInput" name="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
  </div>
  
 <div class="admin-guide">
  <strong>Panduan Penggunaan:</strong><br>
  PENTING!!<br>
  üîπ Klik <strong>‚¨áÔ∏è Backup Data</strong> untuk menyimpan semua data restoran ke file <strong>.json</strong>.<br>
  üîπ Simpan file tersebut dengan baik.<br>
  üîπ Klik <strong>üìÇ Pilih File</strong> untuk me-restore data.<br>
  ‚ö†Ô∏è Proses restore menggantikan seluruh data saat ini.<br>
</div>

<div class="admin-guide">
  <strong>User Guide:</strong><br>
  IMPORTANT!!<br>
  üîπ Click <strong>‚¨áÔ∏è Data</strong> to save all data.<br>
  üîπ Keep the file safe.<br>
  üîπ Click <strong>üìÇ Choose File</strong> to restore data.<br>
  ‚ö†Ô∏è The restore process replaces all existing data.<br>
</div>

 <button onclick="resetData()" class="btn-danger" id="btnResetData">
  üóëÔ∏è Reset Data
</button>

</div>

<div class="fixed-bar">

  <div class="nav-item" onclick="markViewedAndGo()">
    <div class="icon-wrapper">
      <ion-icon name="cube-outline" class="icon"></ion-icon>
      <span id="receiveBadge" class="badge">0</span>
    </div>
    <div class="label">Receives</div>
  </div>

 <div
  class="nav-item vertical"
  id="inviteAdminBtn"
  onclick="openInviteAdmin()"
  style="display:none"
>
  <div class="icon-wrapper">
    <ion-icon name="person-add-outline" class="icon"></ion-icon>
  </div>
  <div class="label">Invite Admin</div>
</div>

  <div class="nav-item" onclick="window.location.href='index.html'">
    <div class="icon-wrapper">
      <ion-icon name="log-out-outline" class="icon"></ion-icon>
    </div>
    <div class="label">Logout</div>
  </div>

</div>

<script>
/* ================= SUBSCRIPTION COUNTDOWN ================= */

let subscriptionCountdownTimer = null;

window.initSubscriptionCountdown = function () {
  const user = window.activeUser;
  if (!user || !user.premiumExpire || !user.premiumPlan) return;

  const box = document.getElementById("subscriptionCountdown");
  if (!box) return;

  box.innerHTML = `
    ‚è≥ ${user.premiumPlan.toUpperCase()} plan expires in:
    <span id="countdownText"></span>
  `;
  box.style.display = "block";

  const text = document.getElementById("countdownText");
  const expireTime = new Date(user.premiumExpire).getTime();

  function formatTime(ms) {
    if (ms <= 0) return "Expired";

    const sec = Math.floor(ms / 1000);
    const min = Math.floor(sec / 60);
    const hr = Math.floor(min / 60);
    const day = Math.floor(hr / 24);

    if (day > 0) return `${day} day(s) ${hr % 24}h`;
    if (hr > 0) return `${hr} hour(s) ${min % 60}m`;
    if (min > 0) return `${min} minute(s) ${sec % 60}s`;
    return `${sec} second(s)`;
  }

  function tick() {
    const remaining = expireTime - Date.now();
    text.textContent = formatTime(remaining);

    if (remaining < 24 * 60 * 60 * 1000) {
      box.style.background = "#ffeaea";
      box.style.color = "#a10000";
    }
  }

  if (subscriptionCountdownTimer) {
    clearInterval(subscriptionCountdownTimer);
  }

  tick();
  subscriptionCountdownTimer = setInterval(tick, 1000);
};
</script>
<script>
/* ================= SUBSCRIPTION WATCHER ================= */

let subscriptionWatcherTimer = null;

window.startSubscriptionWatcher = function () {
  const user = window.activeUser;
  if (!user || !user.premiumExpire) return;

  const expireTime = new Date(user.premiumExpire).getTime();

  if (subscriptionWatcherTimer) {
    clearInterval(subscriptionWatcherTimer);
  }

  subscriptionWatcherTimer = setInterval(() => {
    if (Date.now() > expireTime) {
      console.warn("üö® Subscription expired");
      handleSubscriptionExpired();
    }
  }, 10000);
};

window.handleSubscriptionExpired = async function () {
  alert("‚è± Subscription expired. Please renew to continue.");

  await MENUVA_DB.delete("session", "activeUser");
  await MENUVA_DB.delete("session", "isLoggedIn");

  window.activeUser = null;
  location.href = "plans.html";
};

</script>
<script>
/* ================= RESTO ID CORE ================= */

window.hashEmail = function (email) {
  let hash = 0;
  for (let i = 0; i < email.length; i++) {
    hash = (hash << 5) - hash + email.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
};

window.generateRestoIdFromEmail = function (email) {
  if (!email) throw new Error("Email owner wajib ada");
  return "RESTO_" + hashEmail(email.toLowerCase());
};

window.ensureRestoId = async function () {
  let restoId = await MENUVA_DB.get("appMeta", "restoId");
  if (restoId) return restoId;

  const email = window.activeUser?.email;
  if (!email) {
    console.warn("‚õî activeUser belum siap, restoId belum bisa dibuat");
    return null;
  }

  restoId = generateRestoIdFromEmail(email);

  await MENUVA_DB.set("appMeta", {
    id: "restoId",
    value: restoId
  });

  console.log("‚úÖ restoId generated:", restoId);
  return restoId;
};

</script>
<script>

  /* ============================================================
   ADMIN DB BRIDGE (NO MODULE ‚Äì FINAL STABLE)
============================================================ */

console.log("üöÄ Admin DB Bridge ‚Äì FINAL NO MODULE");


/* ====================== GLOBAL DB STATE ====================== */
const DB_NAME = window.MENUVA_DB.NAME;
const STORE_NAME = window.MENUVA_DB.STORE;
const DB_VERSION = window.MENUVA_DB.VERSION;

  /* ====================== MENUVA DATA DB HELPERS ====================== */

// üîê Ambil ID aktif (AMAN)
function getActiveRestoId() {
  if (window.activeUser?.restoID) return window.activeUser.restoID;
  console.warn("‚ö†Ô∏è activeUser.restoID tidak ada");
  return null;
}

/* ====================== DEFAULT DATA ====================== */
function buatDataDefault(restoId = "") {
  return {
    id: restoId,
    restoId,
    ownerId: "",

    namaRestoran: "",
    restoAddress: "",
    restoPhone: "",
    logo: "",

    menu: [],
    menuPromo: [],
    menuVoucher: [],
    rooms: [],
    nomorWaAdmin: [],
    flipbookRuanganImages: [],
    flipbookMenuImages: [],

    updatedAt: Date.now()
  };
}

/* ====================== TEST SUPPORT ====================== */
if (!window.indexedDB) {
  alert("‚ö†Ô∏è Browser tidak mendukung IndexedDB");
} else {
  console.log("‚úÖ IndexedDB supported");
}

let flipbookRuanganImages = [];
let flipbookMenuImages = [];

  function toDateInput(iso) {
  if (!iso) return "";
  return iso.slice(0, 10); // yyyy-MM-dd
}

// GLOBAL STORE
window.menuPromo = [];

// ======================= PROMO UI =========================
function openAddPromo() {
  // show editor panel
  const editor = document.getElementById("promoEditorPanel");
  if (!editor) return;
  editor.style.display = "block";

  // reset form
  document.getElementById("promoNameInput").value = "";
  document.getElementById("promoPriceInput").value = "";
  document.getElementById("promoImageInput").value = "";
  document.getElementById("promoImagePreview").style.display = "none";
  document.getElementById("promoImagePreview").src = "";

  // Hapus assignment ke promo object ‚Üí lakukan di savePromoItem()
}

async function savePromoItem() {
  const name  = document.getElementById("promoNameInput").value.trim();
  const desc  = document.getElementById("promoDescInput").value.trim();
  const price = Number(document.getElementById("promoPriceInput").value);

  const inputEl   = document.getElementById("promoImageInput");
  const previewEl = document.getElementById("promoImagePreview");

  // ================= IMAGE SAFE PICK =================
  let image = "";

  // 1. Ambil dari dataset dulu
  if (inputEl.dataset.image && inputEl.dataset.image.startsWith("data:")) {
    image = inputEl.dataset.image;
  }

  // 2. Kalau dataset kosong, ambil dari preview
  if (!image && previewEl.src && previewEl.src.startsWith("data:")) {
    image = previewEl.src;
  }

  // 3. Kalau masih kosong biarin "", nanti card tanpa image
  // ====================================================

  const startDate = document.getElementById("promoStartDate").value;
  const endDate   = document.getElementById("promoEndDate").value;
  const isActive  = document.getElementById("promoActiveToggle").checked;

  if (!name || price <= 0) {
    alert("‚ö†Ô∏è Please fill in valid promo name and price");
    return;
  }

  const promo = {
    id: crypto.randomUUID(),
    namaPromo: name,
    deskripsi: desc,
    harga: price,
    image: image,   // <- sudah aman HP
    startDate,
    endDate,
    isActive
  };

  // ================= PUSH DATA =================
  window.menuPromo.push(promo);

  // ================= RENDER UI =================
  renderPromoUI();

  await simpanData();

  // ================= RESET FORM =================
  document.getElementById("promoNameInput").value  = "";
  document.getElementById("promoDescInput").value  = "";
  document.getElementById("promoPriceInput").value = "";
  inputEl.value = "";
  document.getElementById("promoStartDate").value = "";
  document.getElementById("promoEndDate").value   = "";
  document.getElementById("promoActiveToggle").checked = true;

  // ================= RESET PREVIEW =================
  previewEl.removeAttribute("src"); // lebih aman dari preview.src=""
  previewEl.style.display = "none";
  previewEl.style.visibility = "hidden";
  previewEl.style.opacity = "0";

  // ================= HAPUS DATASET =================
  inputEl.dataset.image = "";

  // ================= AUTO CLOSE EDITOR =================
  const editor = document.getElementById("promoEditorPanel");
  if (editor) editor.style.display = "none";
}


function renderPromoUI() {
  const grid = document.getElementById("promoPreviewGrid");
  if (!grid) return;

  grid.innerHTML = "";

  const today = new Date().toISOString().split("T")[0];

  const activePromos = window.menuPromo.filter(p => {
    if (!p.isActive) return false;
    if (p.startDate && today < p.startDate) return false;
    if (p.endDate && today > p.endDate) return false;
    return true;
  });

  activePromos.forEach(promo => {
    const div = document.createElement("div");
    div.className = "terminal-card promo-item";
    div.dataset.id = promo.id;

    div.innerHTML = `
      <div class="terminal-card-header">
        <span class="terminal-dot"></span>
        <span class="terminal-title">${promo.namaPromo}</span>
      </div>

      <p class="promo-status">${promo.isActive ? "ACTIVE" : "OFF"}</p>

     <div class="terminal-card-body">
  <p class="promo-price">Price: ${promo.harga}</p>

  <p class="promo-desc">${promo.deskripsi || ""}</p>

  <p class="promo-date">
    ${promo.startDate || "-"} ‚Üí ${promo.endDate || "-"}
  </p>

 <div class="promo-img-wrap" style="display:${promo.image?"block":"none"}">
  <img src="${promo.image}" class="promo-img">
</div>


  <p id="countdown-${promo.id}" class="promo-countdown"></p>

  <button onclick="deletePromo('${promo.id}')">DELETE</button>
</div>

    `;

    grid.appendChild(div);
  });
}

async function deletePromo(id) {
  // hapus dari memory
  window.menuPromo = window.menuPromo.filter(p => p.id !== id);

  // render ulang UI
  renderPromoUI();

  // simpan ulang seluruh data promo
  await simpanData();
}

function updatePromoCountdown() {
  const now = new Date();

  window.menuPromo.forEach(promo => {
    if (!promo.tanggalAkhir) return;

    const countdownEl = document.getElementById(`countdown-${promo.id}`);
    if (!countdownEl) return; // üî• INI KUNCI

    const end = new Date(promo.tanggalAkhir);
    const diff = end - now;

    if (diff <= 0) {
      countdownEl.textContent = "EXPIRED";
    } else {
      const days = Math.floor(diff / (1000*60*60*24));
      const hours = Math.floor((diff / (1000*60*60)) % 24);
      const minutes = Math.floor((diff / (1000*60)) % 60);
      const seconds = Math.floor((diff / 1000) % 60);

      countdownEl.textContent =
        `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }
  });
}

  function initPromoCountdown() {
  if (!document.querySelector("[id^='countdown-']")) return;
  setInterval(updatePromoCountdown, 1000);
}

initPromoCountdown();


// ================== IMAGE UPLOAD =======================
function uploadPromoImage(event, inputEl) {
  const file = (event.target && event.target.files[0]) || 
               (inputEl && inputEl.files[0]);

  if (!file) return;

  const preview = document.getElementById("promoImagePreview");

  // tampilkan loading kecil dulu biar user tau jalan
  preview.style.display = "block";
  preview.src = "";

  resizeIfNeeded(file)
    .then(resized => {
      preview.src = resized;

      // penting buat mobile kadang height collapse
      preview.style.visibility = "visible";
      preview.style.opacity = "1";

      // simpan data image
      inputEl.dataset.image = resized;
    })
    .catch(err => {
      console.error("Upload promo image failed:", err);

      // fallback tanpa resize
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.style.display = "block";
        inputEl.dataset.image = e.target.result;
      };
      reader.readAsDataURL(file);
    });
}

// ================== RESTORE / LOAD ====================
async function loadPromoData(resto) {
  window.menuPromo = Array.isArray(resto.menuPromo) ? resto.menuPromo : [];
  renderPromoUI();
}

let activeCategoryId = null;
let activeCategoryName = null;


async function renderCategoryFilter() {
  const menus = await MENUVA_DB.getAll("menuData");

  const uniqueCategories = [
    ...new Set(
      menus
        .map(m => m.category)
        .filter(c => c && c !== "undefined")
    )
  ];

  const bar = document.getElementById("categoryFilterBar");
  bar.innerHTML = "";

  uniqueCategories.forEach(cat => {
    const btn = document.createElement("div");
    btn.className = "terminal-filter-btn";
    btn.innerText = cat;

    if (cat === activeCategoryName) {
      btn.classList.add("active");
    }

    btn.onclick = () => {
      activeCategoryName = cat;
      renderCategoryFilter();
      renderMenuPreview(cat);
    };

    bar.appendChild(btn);
  });
}

async function renderMenuPreview(categoryName) {
  const menus = await MENUVA_DB.getAll("menuData");

  const filtered = menus.filter(m =>
    m.category === categoryName &&
    m.name &&
    typeof m.price !== "undefined"
  );

  const grid = document.getElementById("menuPreviewGrid");
  grid.innerHTML = "";

  filtered.forEach(menu => {
    const card = document.createElement("div");
    card.className = "terminal-menu-card";

  card.innerHTML = `
 ${menu.image ? `
  <div class="menu-img-wrap">
    <img src="${menu.image}" class="menu-img">
  </div>
` : ""}

  <h4>${menu.name}</h4>
  <p>Rp ${menu.price.toLocaleString()}</p>
  <button onclick="deleteMenu(${menu.id})">DELETE</button>
`;
    grid.appendChild(card);
  });
}

 async function deleteMenu(id) {
  const confirmDelete = confirm("Delete this menu?");
  if (!confirmDelete) return;

  await MENUVA_DB.delete("menuData", id);

  const menus = await MENUVA_DB.getAll("menuData");

  const stillExists = menus.some(
    m => m.category === activeCategoryName
  );

  if (!stillExists) {
    activeCategoryName = null;
  }

  await renderCategoryFilter();

  if (activeCategoryName) {
    await renderMenuPreview(activeCategoryName);
  } else {
    document.getElementById("menuPreviewGrid").innerHTML = "";
  }
}

  let uploadedImageBase64 = null;

document.getElementById("menuImageInput").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function (event) {
    uploadedImageBase64 = event.target.result;

    const preview = document.getElementById("imagePreview");
    preview.src = uploadedImageBase64;
    preview.style.display = "block";
  };

  reader.readAsDataURL(file);
});


async function saveMenuItem() {
  if (!activeCategoryName) {
    alert("Select category first");
    return;
  }

  const name = document.getElementById("menuNameInput").value.trim();
  const price = parseFloat(document.getElementById("menuPriceInput").value);

  if (!name || isNaN(price)) {
    alert("Complete form");
    return;
  }

  const newMenu = {
    name,
    price,
    image: uploadedImageBase64 || null,
    category: activeCategoryName,
    active: true,
    createdAt: Date.now()
  };

  await MENUVA_DB.add("menuData", newMenu);

  // Reset form
  document.getElementById("menuNameInput").value = "";
  document.getElementById("menuPriceInput").value = "";
  document.getElementById("menuImageInput").value = "";
  uploadedImageBase64 = null;

  const preview = document.getElementById("imagePreview");
  if (preview) preview.style.display = "none";

  await renderCategoryFilter();
  await renderMenuPreview(activeCategoryName);
}


let CATEGORY_CACHE = [];
  
function setCategoryCache(categories = []) {
  CATEGORY_CACHE = Array.isArray(categories) ? categories : [];
}

function tambahMenu(categoryId = "", nama = "", harga = "", image = "") {

  if (!CATEGORY_CACHE.length) return;

  if (!categoryId) categoryId = CATEGORY_CACHE[0].id;

  const container = document.getElementById("menuContainer_" + categoryId);

  if (!container) {
    console.warn("Container not found:", categoryId);
    return;
  }

  console.log("Tambah menu dipanggil:", categoryId, nama, harga);
}

  function renderCategoryContainers(categories = []) {

  const root = document.getElementById("menuRoot");

  if (!root) return;

  root.innerHTML = "";

  categories.forEach(cat => {

    const section = document.createElement("div");

    section.innerHTML = `
      <h3>${cat.icon || "üìÅ"} ${cat.name}</h3>

      <div id="menuContainer_${cat.id}" class="menu-container"></div>

      <button onclick="tambahMenu('${cat.id}')">
        + Add ${cat.name}
      </button>

      <hr>
    `;

    root.appendChild(section);

  });

}
function openAddCategory() {
  const modal = document.getElementById("addCategoryModal");
  if (!modal) {
    console.error("‚ùå addCategoryModal not found");
    return;
  }
  modal.style.display = "flex";
}

function closeAddCategory() {
  const modal = document.getElementById("addCategoryModal");
  if (!modal) return;
  modal.style.display = "none";
}


async function saveCategory() {
  const name = document.getElementById("categoryNameInput").value.trim();
  if (!name) return alert("Category name required");

  activeCategoryName = name;

  closeAddCategory();

  renderCategoryFilter();
  renderMenuPreview(name);
}

function uploadMenuImage(event, inputEl) {
  const file = event.target.files[0];
  if (!file) return;

  resizeIfNeeded(file)
    .then(resized => {
      const preview = inputEl.parentElement.querySelector(".menuPreview");
      preview.src = resized;
      preview.style.display = "block";
      inputEl.setAttribute("data-image", resized);
    })
    .catch(err => console.error("Upload menu image failed:", err));
}

function ambilMenu(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return [];

  const result = [];

  container.querySelectorAll(".menu-item").forEach(item => {
    const nama = item.querySelector("input[type=text]")?.value || "";
    const harga = parseInt(item.querySelector("input[type=number]")?.value || "0");
    const categoryId = item.querySelector("select")?.value || "";
    const image = item.querySelector("input[type=file]")?.getAttribute("data-image") || "";

    if (nama && harga > 0) {
      result.push({
        id: "menu_" + Date.now() + Math.floor(Math.random() * 1000),
        nama,
        harga,
        categoryId,
        image
      });
    }
  });

  return result;
}


/* ============================================================
   ROOM
============================================================ */
  function renderRoomUI() {
  try {
    const rooms = Array.isArray(window.rooms) ? window.rooms : [];

    console.log("üõèÔ∏è renderRoomUI called:", rooms.length);

    // =================================================
    // TODO (nanti):
    // - render daftar room
    // - render capacity
    // - render harga
    // =================================================

    // sementara ini NO-OP
  } catch (err) {
    console.warn("‚ö†Ô∏è renderRoomUI error:", err);
  }
}

function tambahRoom(kategori) {
  const containerId = {
    hotel: "roomHotelContainer",
    meeting: "meetingRoomContainer",
    package: "packageContainer"
  }[kategori];
  if (!containerId) return;

  const container = document.getElementById(containerId);
  const uid = `${kategori}_${Date.now()}`;

  const wrapper = document.createElement("div");
  wrapper.className = "room-form";
  wrapper.innerHTML = `
    <input class="room-nama" placeholder="Name">
    <input class="room-harga" type="number" placeholder="Price">
    <input class="room-kapasitas" type="number" placeholder="Capacity">
    <input class="room-luas" type="number" placeholder="Size (m¬≤)">
    <textarea class="room-deskripsi" placeholder="Notes"></textarea>

    <div>
      <img class="gambar-preview" style="display:none; max-width:120px">
      <button type="button" class="hapus-gambar" onclick="hapusGambarRoom(this)" style="display:none">√ó</button>
    </div>

    <button type="button" class="room-image-upload" onclick="uploadGambarRoom(this)">üñº Upload Image</button>
    <button type="button" onclick="hapusFormRoom(this)">üóë Delete</button>
    <hr>
  `;
  container.appendChild(wrapper);
}

function ambilSemuaRoom() {
  const hasil = [];

  const kategoriMap = [
    { id: "roomHotelContainer", type: "room" },
    { id: "meetingRoomContainer", type: "meeting" },
    { id: "packageContainer", type: "package" } // üî• TAMBAH INI
  ];

  kategoriMap.forEach(({ id, type }) => {
    const container = document.getElementById(id);
    if (!container) return;

    container.querySelectorAll(".room-form").forEach(form => {
      const nama = form.querySelector(".room-nama")?.value?.trim() || "";
      const harga = parseInt(form.querySelector(".room-harga")?.value || "0");

      if (!nama || harga <= 0) return;

      hasil.push({
        id: "R" + Date.now() + Math.floor(Math.random() * 1000),
        restoId: window.activeUser?.restoID || "",
        type, // room | meeting | package

        nama,
        harga,
        kapasitas: parseInt(form.querySelector(".room-kapasitas")?.value || "0"),
        luas: parseInt(form.querySelector(".room-luas")?.value || "0"),
        deskripsi: form.querySelector(".room-deskripsi")?.value || "",
        image: form.querySelector(".room-image-upload")?.getAttribute("data-image") || "",

        updatedAt: Date.now()
      });
    });
  });

  return hasil;
}

function restoreRoomFromData(rooms = []) {
  rooms.forEach(room => {
    tambahRoom(room.kategori);
    const containerId = {
      hotel: "roomHotelContainer",
      meeting: "meetingRoomContainer",
      package: "packageContainer"
    }[room.kategori];

    const container = document.getElementById(containerId);
    const form = container.lastElementChild;

    form.querySelector(".room-nama").value = room.nama || "";
    form.querySelector(".room-harga").value = room.harga || "";
    form.querySelector(".room-kapasitas").value = room.kapasitas || "";
    form.querySelector(".room-luas").value = room.luas || "";
    form.querySelector(".room-deskripsi").value = room.deskripsi || "";

    if (room.image) {
      const preview = form.querySelector(".gambar-preview");
      const hapus = form.querySelector(".hapus-gambar");
      preview.src = room.image;
      preview.style.display = "block";
      hapus.style.display = "inline-flex";
      form.querySelector(".room-image-upload").setAttribute("data-image", room.image);
    }
  });
}

function uploadGambarRoom(btn) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const form = btn.closest(".room-form");
      const preview = form.querySelector(".gambar-preview");
      const hapus = form.querySelector(".hapus-gambar");

      preview.src = ev.target.result;
      preview.style.display = "block";
      hapus.style.display = "inline-flex";
      btn.setAttribute("data-image", ev.target.result);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function hapusGambarRoom(btn) {
  const form = btn.closest(".room-form");
  form.querySelector(".gambar-preview").style.display = "none";
  btn.style.display = "none";
  form.querySelector(".room-image-upload").removeAttribute("data-image");
}

function hapusFormRoom(btn) {
  btn.closest(".room-form")?.remove();
}
function renderRoomsFromDB(rooms = []) {
  // üõ°Ô∏è safety guard
  if (!Array.isArray(rooms)) {
    console.warn("‚ö†Ô∏è renderRoomsFromDB: rooms bukan array", rooms);
    return;
  }

  // üßπ clear container (anti duplikat saat reload)
  ["roomHotelContainer", "meetingRoomContainer", "packageContainer"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = "";
  });

  // üö´ tidak ada data
  if (!rooms.length) {
    console.log("‚ÑπÔ∏è renderRoomsFromDB: tidak ada room");
    return;
  }

  // üîÅ restore satu per satu
  rooms.forEach(room => {
    if (!room) return;

    const kategori =
      room.type === "meeting"
        ? "meeting"
        : room.type === "package"
          ? "package"
          : "hotel";

    restoreRoomFromData([{
      ...room,
      kategori
    }]);
  });

  console.log("‚úÖ Rooms rendered from DB:", rooms.length);
}

/* ============================================================
   EXPOSE TO WINDOW (WAJIB UNTUK MODULE)
============================================================ */
window.menuPromo = window.menuPromo || [];
window.promoList = window.menuPromo;

window.tambahMenu = tambahMenu;
window.uploadMenuImage = uploadMenuImage;
window.ambilMenu = ambilMenu;

window.tambahRoom = tambahRoom;
window.ambilSemuaRoom = ambilSemuaRoom;
window.restoreRoomFromData = restoreRoomFromData;
window.uploadGambarRoom = uploadGambarRoom;
window.hapusGambarRoom = hapusGambarRoom;
window.hapusFormRoom = hapusFormRoom;

/* ============================================================
   IMAGE RESIZE HELPER
============================================================ */
async function resizeIfNeeded(file, targetSizeKB = 100, maxWidth = 1280) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        try {
          const scale = Math.min(maxWidth / img.width, 1);
          const canvas = document.createElement("canvas");
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          let quality = 0.9;
          let dataUrl = canvas.toDataURL("image/jpeg", quality);
          let sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);

          while (sizeKB > targetSizeKB && quality > 0.1) {
            quality -= 0.05;
            dataUrl = canvas.toDataURL("image/jpeg", quality);
            sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);
          }

          resolve(dataUrl);
        } catch (err) {
          reject(err);
        }
      };

      img.onerror = () => reject(new Error("Image load error"));
      img.src = e.target.result;
    };

    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ============================================================
   LOGO UPLOAD
============================================================ */
document.getElementById("logoInput")?.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const logoUrl = await resizeIfNeeded(file, 100);
    const preview = document.getElementById("previewLogo");
    if (preview) preview.src = logoUrl;
  } catch (err) {
    console.error("Logo resize error:", err);
    alert("‚ùå Failed to process logo image.");
  }
});

/* ============================================================
   FLIPBOOK IMAGE PREVIEW (SYNC WITH CSS GRID)
============================================================ */
 function renderFlipbookUI() {
  try {
    const ruangan = Array.isArray(window.flipbookRuanganImages)
      ? window.flipbookRuanganImages
      : [];

    const menu = Array.isArray(window.flipbookMenuImages)
      ? window.flipbookMenuImages
      : [];

    const all = Array.isArray(window.flipbookList)
      ? window.flipbookList
      : ruangan.concat(menu);

    console.log("üìñ renderFlipbookUI", {
      ruangan: ruangan.length,
      menu: menu.length,
      total: all.length
    });

    // =================================================
    // TODO (nanti):
    // - sync preview
    // - sync pagination
    // - sync reorder
    // =================================================

    // sementara ini NO-OP (biar warning hilang & flow aman)
  } catch (err) {
    console.warn("‚ö†Ô∏è renderFlipbookUI error:", err);
  }
}

function renderImagePreview(tipe, url) {
  if (!url) return;

  const containerId =
    tipe === "ruangan"
      ? "flipbookRuanganPreview"
      : "flipbookMenuPreview";

  const container = document.getElementById(containerId);
  if (!container) return;

  // üß± WRAPPER (ikut CSS grid)
  const wrapper = document.createElement("div");
  wrapper.className = "flipbook-preview-item";

  // üñºÔ∏è IMAGE (ukuran diatur CSS)
  const img = document.createElement("img");
  img.src = url;
  img.loading = "lazy";

  // ‚ùå BUTTON
  const btnHapus = document.createElement("button");
  btnHapus.className = "btn-hapus-gambar";
  btnHapus.innerHTML = "√ó";

  btnHapus.onclick = () => {
    wrapper.remove();

    if (tipe === "ruangan") {
      window.flipbookRuanganImages =
        window.flipbookRuanganImages.filter(src => src !== url);
    } else {
      window.flipbookMenuImages =
        window.flipbookMenuImages.filter(src => src !== url);
    }
  };

  wrapper.appendChild(img);
  wrapper.appendChild(btnHapus);
  container.appendChild(wrapper);
}


function tambahGambar(type) {
  const inputId =
    type === "ruangan" ? "flipbookRuanganUpload" : "flipbookMenuUpload";

  const input = document.getElementById(inputId);
  if (!input) return;

  // reset value supaya bisa upload file yg sama lagi
  input.value = "";

  input.onchange = async (event) => {
    const files = Array.from(event.target.files || []);
    if (!files.length) return;

    for (const file of files) {
      try {
        const resized = await resizeIfNeeded(file);

        if (type === "ruangan") {
          window.flipbookRuanganImages.push(resized);
          renderImagePreview("ruangan", resized);
        } else {
          window.flipbookMenuImages.push(resized);
          renderImagePreview("menu", resized);
        }
      } catch (err) {
        console.error("‚ùå resize image gagal:", err);
      }
    }
  };

  input.click();
}

/* ============================================================
   STRING HELPER
============================================================ */
function slugify(text = "") {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, "-")
    .replace(/[^\w\-]+/g, "")
    .replace(/\-\-+/g, "-");
}

/* ============================================================
   EXPOSE TO WINDOW (MODULE ‚Üî INLINE BRIDGE)
============================================================ */
window.resizeIfNeeded = resizeIfNeeded;
window.renderImagePreview = renderImagePreview;
window.tambahGambar = tambahGambar;
window.slugify = slugify;

// ====================== GLOBAL SAFE INIT ======================
window.flipbookRuanganImages = window.flipbookRuanganImages || [];
window.flipbookMenuImages = window.flipbookMenuImages || [];
window.menuVoucher = window.menuVoucher || [];

// ====================== SIMPAN (ADMIN ‚Üí RESTOS ONLY) ======================
async function simpanData() {
  try {
    showLoader();

    /* ==================== AUTH SAFETY ==================== */
    if (!window.activeUser || !window.activeUser.restoID) {
      alert("‚ùå Session tidak valid. Silakan login ulang.");
      console.error("‚ùå activeUser missing in simpanData");
      return;
    }

    const ownerId = window.activeUser.email.trim().toLowerCase();
    const restoId = window.activeUser.restoID;

    /* ==================== FORM DATA ==================== */
    const namaRestoran = getVal("namaRestoran");
    const restoAddress = getVal("restoAddress");
    const restoPhone   = getVal("restoPhone");
    const logo         = document.getElementById("previewLogo")?.src || "";
    const nomorWaAdmin = collectWaFromUI();
    
    if (!restoPhone) {
      alert("‚ùå Nomor telepon resto wajib diisi!");
      return;
    }

    /* ==================== COLLECT ADMIN DATA ==================== */
    const menu = Array.isArray(ambilSemuaMenu?.())
      ? ambilSemuaMenu()
      : [];

    const rooms = typeof ambilSemuaRoom === "function"
      ? ambilSemuaRoom()
      : [];

    const promos = window.menuPromo || [];

    const vouchers = Array.isArray(window.menuVoucher)
      ? window.menuVoucher
      : [];

    const flipbookRuanganImages = Array.isArray(window.flipbookRuanganImages)
      ? window.flipbookRuanganImages
      : [];

    const flipbookMenuImages = Array.isArray(window.flipbookMenuImages)
      ? window.flipbookMenuImages
      : [];

  
    /* ==================== VALIDASI ==================== */
    if (highlightInvalidPromo?.()) {
      alert("‚ö†Ô∏è Please complete the data promos.");
      return;
    }

    if (highlightInvalidMenu?.()) {
      alert("‚ö†Ô∏è Please complete the data menus.");
      return;
    }

    /* ==================== BUILD SINGLE RESTO OBJECT ==================== */
  
    const restoPayload = {
      id: restoId,
      ownerId,

      // profile
      namaRestoran,
      restoAddress,
      restoPhone,
      logo,
      nomorWaAdmin,

      // üî• ALL ADMIN DATA HERE
      categories,
      menu,
      rooms,
      menuPromo: promos,
      menuVoucher: vouchers,
      flipbookRuanganImages,
      flipbookMenuImages,

      updatedAt: Date.now()
    };

    /* ==================== SAVE (UPSERT) ==================== */
    await window.MENUVA_DB.add("restos", restoPayload);

    /* ==================== FINALIZE ==================== */
    syncRestoIdHidden?.(restoId);
    prepareCustomerShare?.();

    console.log("üíæ SIMPAN DATA SUCCESS ‚Üí RESTO:", restoId);
    alert("‚úÖ All Data Successfully Saved!");

   showCustomerShareUI?.();

// ================= GENERATE CUSTOMER LINK =================
const customerLink = `${location.origin}/customer.html?id=${restoId}`;

// tampilkan link ke UI
document.getElementById("customerLinkDisplay").textContent = customerLink;

// tampilkan section QR
document.getElementById("qrSection")?.classList.remove("hidden");

// generate QR
generateQRCode(customerLink);

showQRButtons();


    await MENUVA_DB.add("session", {
  id: "customerShareReady",
  value: "1"
});

  } catch (err) {
    console.error("‚ùå simpanData fatal:", err);
    alert("‚ùå Failed to save data");
  } finally {
    hideLoader?.();
  }
}

  function getVal(id) {
  return document.getElementById(id)?.value.trim() || "";
}

  function getNomorWaAdmin() {
  return Array.from(document.querySelectorAll(".nomor-wa"))
    .map(i => i.value.trim())
    .filter(Boolean);
}

 function ambilSemuaMenu() {

  const result = [];

  CATEGORY_CACHE.forEach(cat => {

    const containerId = "menuContainer_" + cat.id;

    result.push(...ambilMenu(containerId));

  });

  return result;
}


  function syncRestoIdHidden(restoId) {
  let el = document.getElementById("restoId");
  if (!el) {
    el = document.createElement("input");
    el.type = "hidden";
    el.id = "restoId";
    document.body.appendChild(el);
  }
  el.value = restoId;
}

  // ====================== VALIDASI PROMO (FINAL) ======================
function highlightInvalidPromo() {
  let invalid = false;

  window.menuPromo.forEach(promo => {
    if (!promo.namaPromo || !promo.harga || promo.harga <= 0) {
      invalid = true;
    }
  });

  return invalid;
}

  function highlightInvalidMenu() {
  let invalid = false;

  document.querySelectorAll(".menu-item").forEach(item => {
    // skip promo
    if (item.classList.contains("promo-item")) return;

    const nama = item.querySelector("input[type=text]");
    const harga = item.querySelector("input[type=number]");

    // reset style
    if (nama) nama.style.border = "";
    if (harga) harga.style.border = "";

    if (!nama || !nama.value.trim()) {
      if (nama) nama.style.border = "2px solid red";
      invalid = true;
    }

    if (!harga || !harga.value || harga.value <= 0) {
      if (harga) harga.style.border = "2px solid red";
      invalid = true;
    }
  });

  return invalid;
}

 /* =========================================================
   WA ADMIN ‚Äî CLEAN ROOM IMPLEMENTATION
   ========================================================= */

/** SINGLE SOURCE OF TRUTH */
window.WA_ADMIN = [];

/** DOM REF */
function waContainer() {
  return document.getElementById("nomorWaContainer");
}

/** CREATE INPUT */
function createWaInput(value = "") {
  const input = document.createElement("input");
  input.type = "text";
  input.name = "waNumber[]";
  input.className = "nomor-wa";
  input.placeholder = "Example: 6281234567890";
  input.value = value;
  return input;
}

/** RENDER (IDEMPOTENT) */
function renderWaAdmin() {
  const box = waContainer();
  if (!box) return;

  // remove only inputs, keep label
  box.querySelectorAll("input.nomor-wa").forEach(i => i.remove());

  if (!Array.isArray(window.WA_ADMIN) || window.WA_ADMIN.length === 0) {
    box.appendChild(createWaInput(""));
    return;
  }

  window.WA_ADMIN.forEach(wa => {
    box.appendChild(createWaInput(wa));
  });

  console.log("üì± WA rendered:", window.WA_ADMIN);
}

/** READ FROM UI */
function collectWaFromUI() {
  const box = waContainer();
  if (!box) return [];

  return Array.from(box.querySelectorAll("input.nomor-wa"))
    .map(i => i.value.trim())
    .filter(Boolean);
}

/** ADD BUTTON */
function initWaAdminUI() {
  const btn = document.getElementById("btnAddWa");
  if (!btn) return;

  btn.onclick = () => {
    window.WA_ADMIN = collectWaFromUI();
    window.WA_ADMIN.push("");
    renderWaAdmin();
  };
}

/** LOAD FROM DATA (CALL THIS!) */
function loadWaAdminFromData(list) {
  window.WA_ADMIN = Array.isArray(list) ? [...list] : [];
  renderWaAdmin();
}

  function waitForActiveUser() {
  return new Promise(resolve => {
    const check = () => {
      if (window.activeUser?.email && window.activeUser?.restoID) {
        resolve(window.activeUser);
      } else {
        setTimeout(check, 100);
      }
    };
    check();
  });
}


let __LOAD_DATA_RUNNING__ = false;

async function loadData() {
  if (__LOAD_DATA_RUNNING__) return;
  __LOAD_DATA_RUNNING__ = true;

  try {
    showLoader?.("Loading data...");

    const restoId = window.activeUser?.restoID;
    console.log("üì¶ loadData start ‚Üí resto:", restoId);

    if (!restoId) {
      console.warn("‚ö†Ô∏è restoId tidak ditemukan");
      return;
    }

    // ================= AMBIL RESTO =================
    const resto = await MENUVA_DB.get("restos", restoId);

    if (!resto) {
      console.warn("‚ö†Ô∏è Resto not found in DB");
      return;
    }

    // ================= CATEGORY SETUP (WAJIB DULU) =================
    const categories = Array.isArray(resto.categories)
      ? resto.categories
      : [];

    // isi cache dulu
    setCategoryCache(categories);
    renderCategoryContainers(categories);

    console.log("üìÇ Categories loaded:", categories.length);

    // ================= RESTO PROFILE =================
    const safeSetVal = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.value = val ?? "";
    };

    safeSetVal("namaRestoran", resto.namaRestoran);
    safeSetVal("restoAddress", resto.restoAddress);
    safeSetVal("restoPhone", resto.restoPhone);

    // ================= WA ADMIN =================
    try {
      loadWaAdminFromData?.(resto.nomorWaAdmin || []);
    } catch (e) {
      console.warn("‚ö†Ô∏è loadWaAdminFromData error:", e);
    }

    // ================= LOGO =================
    if (resto.logo) {
      window.__LOGO_BASE64__ = resto.logo;
      const img = document.getElementById("previewLogo");
      if (img) img.src = resto.logo;
    }

    // ================= MENU =================
    window.menuList = Array.isArray(resto.menu)
      ? resto.menu
      : [];

    console.log("üçΩÔ∏è Menu loaded:", window.menuList.length);

    // clear UI kalau ada
    if (typeof clearMenuUI === "function") {
      clearMenuUI();
    }

    // masukkan menu ke kategori yang benar
    window.menuList.forEach(m => {
      try {
        const categoryId =
          m.categoryId ||
          m.kategori ||
          categories[0]?.id ||
          "";

        tambahMenu?.(
          categoryId,
          m.nama || "",
          m.harga || "",
          m.image || ""
        );
      } catch (e) {
        console.warn("‚ö†Ô∏è tambahMenu error", m, e);
      }
    });

    // ‚ùå renderMenuUI dihapus karena bikin error
    // renderMenuUI?.(resto.menu || []);

    // ================= PROMO & VOUCHER =================
  window.menuPromo = Array.isArray(resto.menuPromo) ? resto.menuPromo : [];
  window.menuVoucher = Array.isArray(resto.menuVoucher) ? resto.menuVoucher : [];
  window.menu = Array.isArray(resto.menu) ? resto.menu : [];
  window.categories = Array.isArray(resto.categories) ? resto.categories : [];

  // render semua UI
  try { renderPromoUI?.(); } 
  catch(e){ console.warn("‚ö†Ô∏è renderPromoUI error:", e); }

  try { renderVoucher?.(window.menuVoucher); } 
  catch(e){ console.warn("‚ö†Ô∏è renderVoucher error:", e); }

 
    // ================= FLIPBOOK =================
    window.flipbookRuanganImages = Array.isArray(resto.flipbookRuanganImages)
      ? resto.flipbookRuanganImages
      : [];

    window.flipbookMenuImages = Array.isArray(resto.flipbookMenuImages)
      ? resto.flipbookMenuImages
      : [];

    window.flipbookList = [
      ...window.flipbookRuanganImages,
      ...window.flipbookMenuImages
    ];

    window.flipbookRuanganImages.forEach(src => {
      try { renderImagePreview?.("ruangan", src); }
      catch(e){ console.warn(e); }
    });

    window.flipbookMenuImages.forEach(src => {
      try { renderImagePreview?.("menu", src); }
      catch(e){ console.warn(e); }
    });

    try { renderFlipbookUI?.(); }
    catch(e){ console.warn("‚ö†Ô∏è renderFlipbookUI error:", e); }

    // ================= ROOMS =================
    window.rooms = Array.isArray(resto.rooms)
      ? resto.rooms
      : [];

    try {
      renderRoomsFromDB?.(window.rooms);
    } catch (e) {
      console.warn("‚ö†Ô∏è renderRoomsFromDB error:", e);
    }

    console.log("‚úÖ loadData FINISHED");

  } catch (err) {
    console.error("‚ùå loadData fatal:", err);
  } finally {
    hideLoader?.();
    __LOAD_DATA_RUNNING__ = false;
  }
}

// ====================== RESET / BACKUP / RESTORE ======================
async function resetData() {
  if (!hasBackupForCurrentUser()) {
    alert("‚ö†Ô∏è Silakan backup data terlebih dahulu sebelum reset.");
    return;
  }

  if (!confirm("Yakin ingin menghapus SEMUA DATA RESTO?\n(Data akun & langganan tetap aman)")) return;

  await clearRestoDataOnly();
  location.reload();
}

async function backupAdminToJSON() {
  if (!window.activeUser?.email || !window.activeUser?.restoID) {
    alert("‚ùå User belum login");
    return;
  }

  const email = window.activeUser.email.trim().toLowerCase();
  const restoId = window.activeUser.restoID;

  try {
    const resto = await MENUVA_DB.get("restos", restoId);
    if (!resto) {
      alert("‚ùå Data resto tidak ditemukan");
      return;
    }

    const backup = {
      app: "Orderine",
      type: "ADMIN_BACKUP",
      version: 3,
      exportedAt: Date.now(),
      owner: { email },
      data: {
        restos: resto
      }
    };

    const blob = new Blob(
      [JSON.stringify(backup, null, 2)],
      { type: "application/json" }
    );

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = `orderine-backup-${email}.json`;
    a.click();

    URL.revokeObjectURL(url);

    /* =========================================
       SAVE LAST BACKUP META INTO USERS STORE
       ========================================= */
    const user = await MENUVA_DB.get("users", email);

    if (user) {
      await MENUVA_DB.add("users", {
        ...user,
        lastBackupAt: Date.now()
      });
    }

    console.log("üì¶ Backup success (DB STORED):", email);

  } catch (err) {
    console.error("‚ùå Backup failed:", err);
    alert("‚ùå Gagal melakukan backup data");
  }
}


 let __BACKUP_RUNNING__ = false;

window.downloadBackupJSON = async function () {
  if (__BACKUP_RUNNING__) return;
  __BACKUP_RUNNING__ = true;

  try {
    await backupAdminToJSON();
    updateResetButtonState();
  } catch (err) {
    console.error("‚ùå Backup failed:", err);
    alert("‚ùå Gagal melakukan backup data");
  } finally {
    __BACKUP_RUNNING__ = false;
  }
};

 async function hasBackupForCurrentUser() {
  const session = await MENUVA_DB.getSession();
  if (!session?.email) return false;

  const backup = await MENUVA_DB.get("flipbookData", "backup_" + session.email);
  return !!backup;
}


async function restoreDataFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  try {
    const json = JSON.parse(await file.text());

    if (json.app !== "Orderine" || json.type !== "ADMIN_BACKUP") {
      alert("‚ùå File bukan backup Orderine");
      return;
    }

    if (!json.owner?.email) {
      alert("‚ùå Backup tidak memiliki email owner");
      return;
    }

    if (!window.activeUser?.email || !window.activeUser?.restoID) {
      alert("‚ùå User belum login dengan benar");
      return;
    }

    const loginEmail = window.activeUser.email.trim().toLowerCase();
    const backupEmail = json.owner.email.trim().toLowerCase();

    if (loginEmail !== backupEmail) {
      alert("‚ùå Backup ini bukan milik akun ini");
      return;
    }

    const restoId = window.activeUser.restoID;

    showLoader("‚ôªÔ∏è Restoring data...");

    // 1Ô∏è‚É£ bersihkan data lama (context resto sekarang)
    await clearRestoDataOnly();

    // 2Ô∏è‚É£ restore resto profile
    if (json.data?.restos) {
  await MENUVA_DB.add("restos", {
    ...json.data.restos,
    id: restoId
  });
}

    // 3Ô∏è‚É£ restore menu
    for (const m of json.data?.menuData || []) {
      await MENUVA_DB.add("menuData", { ...m, restoId });
    }

    // 4Ô∏è‚É£ restore flipbook
    for (const f of json.data?.flipbookData || []) {
      await MENUVA_DB.add("flipbookData", { ...f, restoId });
    }

   // 5Ô∏è‚É£ restore promo ‚Üí tempel ke object resto
if (json.data?.menuPromo) {
  const resto = await MENUVA_DB.get("restos", restoId);

  if (resto) {
    resto.menuPromo = json.data.menuPromo;
    resto.updatedAt = Date.now();
    await MENUVA_DB.add("restos", resto);
  }
}

    console.log("‚ôªÔ∏è Restore SUCCESS for:", loginEmail);

    alert("‚úÖ Data berhasil direstore");
    location.reload(); // biar loadData() + render jalan normal

  } catch (err) {
    console.error("‚ùå Restore failed:", err);
    alert("‚ùå File backup rusak / tidak valid");
  } finally {
    hideLoader();
  }
}

function buildCustomerLink(){
  const restoId = document.getElementById("restoId").value;
  return `${location.origin}/customer.html?id=${restoId}`;
}

// ====================== SHARE & QR ======================
function getCustomerLink() {
  const id = document.getElementById("restoId")?.value;
  if (!id) return null;
  const base = location.pathname.substring(0, location.pathname.lastIndexOf("/"));
  return `${location.origin}${base}/menu.html?resto=${encodeURIComponent(id)}`;
}

 function generateQRCode(text) {
  const container = document.getElementById("qrPreview");

  if (!container) {
    console.warn("QR container tidak ditemukan");
    return;
  }

  container.innerHTML = "";

  new QRCode(container, {
    text: text,
    width: 160,
    height: 160,
  });
}


// ====================== LOADER HANDLER (Modern, Safe, Single Instance) ======================
let __loaderInitialized = false;

function showLoader(text = "Loading data...") {
  let loader = document.getElementById("loader");

  if (!loader) {
    loader = document.createElement("div");
    loader.id = "loader";
    loader.innerHTML = `
      <div class="loader-overlay">
        <div class="loader-content">
          <div class="spinner"></div>
          <p id="loaderText">${text}</p>
        </div>
      </div>
    `;
    document.body.appendChild(loader);
  }

  // inject style ONCE
  if (!__loaderInitialized) {
    __loaderInitialized = true;
    const style = document.createElement("style");
    style.id = "loader-style";
    style.textContent = `
      #loader {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.45);
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition: opacity .25s ease;
      }

      #loader.show {
        opacity: 1;
        pointer-events: auto;
      }

      .loader-content {
        text-align: center;
        color: #fff;
        font-family: system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 1rem;
        animation: fadeUp .4s ease;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid rgba(255,255,255,.25);
        border-top-color: #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 14px;
      }

      @keyframes spin { to { transform: rotate(360deg); } }
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(8px); }
        to   { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(style);
  }

  const txt = document.getElementById("loaderText");
  if (txt) txt.textContent = text;

  loader.style.display = "flex";
  requestAnimationFrame(() => loader.classList.add("show"));
}

function hideLoader() {
  const loader = document.getElementById("loader");
  if (!loader) return;
  loader.classList.remove("show");
  setTimeout(() => {
    loader.style.display = "none";
  }, 250);
}

async function clearRestoDataOnly() {
  try {
    if (!window.activeUser?.restoID) {
      console.warn("‚ö†Ô∏è clearRestoDataOnly aborted: no active resto");
      return;
    }

    const restoId = window.activeUser.restoID;

    // ===============================
    // 1Ô∏è‚É£ HAPUS DATA RESTO PROFILE
    // ===============================
    await MENUVA_DB.delete("restos", restoId);

    // ===============================
    // 2Ô∏è‚É£ STORE YANG TERIKAT RESTO
    // ===============================
    const scopedStores = [
      "menuData",
      "flipbookData",
      "menuPromo",
      "ordersData"
    ];

    for (const store of scopedStores) {
      const rows = await MENUVA_DB.getAll(store);

      for (const item of rows) {
        if (item.restoId === restoId) {
          await MENUVA_DB.delete(store, item.id);
        }
      }
    }

    console.log("üßπ Resto data cleared (ADMIN DATA ONLY):", restoId);

  } catch (err) {
    console.error("‚ùå clearRestoDataOnly fatal:", err);
  }
}

// ====================== GLOBAL SAFETY (OPTIONAL) ======================
window.addEventListener("unhandledrejection", e => {
  console.error("‚ùå Unhandled Promise Rejection:", e.reason);
  hideLoader();
});

window.addEventListener("error", e => {
  console.error("‚ùå Global JS Error:", e.message);
  hideLoader();
});

</script>
<script>
  
  // ================= OWNER UI SAFE PATCH =================
if (typeof initOwnerUI !== "function") {
  function initOwnerUI() {
    console.warn("‚ö†Ô∏è initOwnerUI skipped (legacy / removed)");
  }
}

 // ==================== ADMIN ROOT INIT ====================
async function initAdmin() {
  console.log("üöÄ initAdmin ROOT");

  if (!window.activeUser) {
    console.warn("‚ö†Ô∏è activeUser not found, admin limited");
  }

  initAdminUI();
  bindAdminEvents();

  // üî• tunggu data admin siap
  await loadAdminData();

  // üî• baru sync toggle
  initAllToggles();

  startRealtimeOrderChecker();
  initOwnerUI();

  console.log("‚úÖ initAdmin FINISHED");
}


  function initAdminUI() {
  console.log("üé® initAdminUI");
}

function bindAdminEvents() {
  console.log("üñ±Ô∏è bindAdminEvents");
}
  setTimeout(() => {
  renderWaAdmin(window.__WA_ADMIN_CACHE__);
  console.log("üîÅ WA rendered after init UI");
}, 0);

  function bindCustomerButtons() {
  const btn = document.getElementById("btnOpenCustomer");
  if (!btn) {
    console.warn("‚ö†Ô∏è btnOpenCustomer not found");
    return;
  }

  btn.onclick = openCustomerPage;
  console.log("üîó Customer button bound");
}


async function loadAdminData() {
  console.log("üì¶ loadAdminData");

  const inviteBtn = document.getElementById("inviteAdminBtn");
  if (!inviteBtn) {
    console.warn("‚ö†Ô∏è inviteAdminBtn not found");
    return;
  }

  try {
    // Ambil session dari MENUVA_DB (single source of truth)
    const session = await MENUVA_DB.getSession();

    if (!session) {
      console.warn("‚ö†Ô∏è No active session");
      inviteBtn.style.display = "none";
      return;
    }

    const role = session.role;
    console.log("üë§ Admin role:", role);

    // üîê ROLE GUARD
    if (role === "owner") {
      inviteBtn.style.display = "flex"; // FIX UTAMA
      console.log("‚úÖ Invite Admin button enabled");
    } else {
      inviteBtn.remove(); // lebih bersih
      console.log("üö´ Invite Admin hidden for role:", role);
    }

  } catch (err) {
    console.error("‚ùå loadAdminData error:", err);
    inviteBtn.style.display = "none";
  }
}

  
document.addEventListener("DOMContentLoaded", async () => {
  initWaAdminUI();
  initPageToggles(); // üî• SEMUA TOGGLE DI SINI
  bindCustomerButtons();
  loadAdminData?.();
  startRealtimeOrderChecker();
  await renderCategoryFilter();

  try {
    console.log("üöÄ Admin Init (CORE)");

    if (!window.MENUVA_DB) {
      throw new Error("MENUVA_DB not ready");
    }

    initAdminUI?.();
    bindAdminEvents?.();

    // ===============================
    // TUNGGU activeUser SIAP
    // ===============================
    const waitForActiveUser = () =>
      new Promise(resolve => {
        const check = () => {
          if (window.activeUser?.email && window.activeUser?.restoID) {
            resolve(window.activeUser);
          } else {
            setTimeout(check, 100);
          }
        };
        check();
      });

    const user = await waitForActiveUser();
    console.log("‚úÖ activeUser ready:", user.email);

    await loadData();

    updateResetButtonState();

    console.log("‚úÖ Admin init triggered");
  } catch (err) {
    console.error("‚ùå Error saat init:", err);
    alert("Terjadi error saat init. Silakan refresh halaman.");
  }
});

 async function updateResetButtonState() {
  const hasBackup = await hasBackupForCurrentUser();
  const btn = document.getElementById("btnReset");

  if (!btn) return;
  btn.disabled = !hasBackup;
}

function domReady() {
  return new Promise(resolve => {
    if (document.readyState === "complete") return resolve();
    document.addEventListener("readystatechange", () => {
      if (document.readyState === "complete") resolve();
    });
  });
}

async function getBool(key, defaultVal = true) {
  const data = await MENUVA_DB.get("appMeta", key);

  if (!data) {
    await MENUVA_DB.set("appMeta", {
      id: key,
      value: String(defaultVal)
    });
    return defaultVal;
  }

  return data.value === "true";
}

async function setBool(key, val) {
  await MENUVA_DB.set("appMeta", {
    id: key,
    value: String(val)
  });
}

async function initPageToggles() {
  const dom = {
    order: document.getElementById("toggleOrderPage"),
    room: document.getElementById("toggleRoomPage"),
    voucher: document.getElementById("toggleVoucherPage"),
    voucherForm: document.getElementById("voucherForm")
  };

  const cfg = await getAdminConfig();

  // ORDER PAGE
  if (dom.order) {
    dom.order.checked = cfg.public_order_enabled;
    dom.order.onchange = async e => {
      await setAdminConfig({ public_order_enabled: e.target.checked });
      console.log("üåç order.html =", e.target.checked);
    };
  }

  // ROOM PAGE
  if (dom.room) {
    dom.room.checked = cfg.public_room_enabled;
    dom.room.onchange = async e => {
      await setAdminConfig({ public_room_enabled: e.target.checked });
      console.log("üåç room.html =", e.target.checked);
    };
  }

  // VOUCHER FORM
  if (dom.voucher && dom.voucherForm) {
    dom.voucher.checked = cfg.voucher_form_enabled;
    dom.voucherForm.style.display =
      cfg.voucher_form_enabled ? "block" : "none";

    dom.voucher.onchange = async e => {
      const on = e.target.checked;
      await setAdminConfig({ voucher_form_enabled: on });
      dom.voucherForm.style.display = on ? "block" : "none";
      console.log("üßæ voucher form =", on);
    };
  }
}
  
async function getAdminConfig() {
  let cfg = await MENUVA_DB.get("restos", "config");

  if (!cfg) {
    cfg = {
      id: "config",
      public_order_enabled: true,
      public_room_enabled: true,
      voucher_form_enabled: false
    };
    await MENUVA_DB.add("restos", cfg);
  }

  return cfg;
}

async function setAdminConfig(patch) {
  const cfg = await getAdminConfig();
  await MENUVA_DB.add("restos", { ...cfg, ...patch });
}


/* ===================== VOUCHER CORE (FINAL & SYNC) ===================== */
async function loadVouchers() {
  console.groupCollapsed("üì• Load Vouchers (DB)");

  const restoId = window.activeUser?.restoID;
  if (!restoId) return [];

  const list = (await MENUVA_DB.getAll("voucherData"))
    .filter(v => v.restoId === restoId);

  const today = new Date();
  const active = list.filter(v => new Date(v.expiry) >= today);

  renderVoucher(active);

  console.groupEnd();
  return active;
}

/* ===================== SAVE VOUCHER FINAL ===================== */
window.saveVoucher = async function () {
  try {
    console.log("üíæ saveVoucher triggered");

    const codeEl = document.getElementById("voucherCode");
    const discEl = document.getElementById("voucherDiscount");
    const expEl  = document.getElementById("voucherExpiry");

    const code = codeEl?.value.trim().toUpperCase();
    const discount = Number(discEl?.value);
    const expiry = expEl?.value;

    if (!code || isNaN(discount) || !expiry) {
      alert("‚ö†Ô∏è Data voucher tidak valid");
      return;
    }

    const restoId = window.activeUser?.restoID;
    if (!restoId) {
      alert("‚ùå Session resto tidak valid");
      return;
    }

    // =========================
    // INIT STATE
    // =========================
    window.menuVoucher = Array.isArray(window.menuVoucher)
      ? window.menuVoucher
      : [];

    // =========================
    // CEK DUPLIKAT KODE
    // =========================
    const alreadyExist = window.menuVoucher.some(v => v.code === code);
    if (alreadyExist) {
      alert("‚ö†Ô∏è Voucher code sudah ada");
      return;
    }

    // =========================
    // BUILD OBJECT
    // =========================
    const voucher = {
      id: crypto.randomUUID(),
      restoId,
      code,
      discount,
      expiry,
      createdAt: Date.now()
    };

    // =========================
    // PUSH STATE
    // =========================
    window.menuVoucher.push(voucher);

    // =========================
    // RENDER UI
    // =========================
    renderVoucher(window.menuVoucher);

    // =========================
    // SIMPAN KE DB
    // =========================
    await simpanData(); // <<< INI YANG PENTING

    // =========================
    // RESET FORM
    // =========================
    codeEl.value = "";
    discEl.value = "";
    expEl.value = "";

    alert("‚úÖ Voucher berhasil disimpan");
    console.log("‚úÖ Voucher saved:", voucher);

  } catch (err) {
    console.error("‚ùå saveVoucher error:", err);
    alert("‚ùå Gagal simpan voucher");
  }
};

/* ===================== VOUCHER UI ===================== */
function renderVoucher(vouchers = []) {
  const box = document.getElementById("voucherPreview");
  if (!box) return;

  if (!Array.isArray(vouchers) || vouchers.length === 0) {
    box.innerHTML = "<em style='color:#7fffff'>Belum ada voucher aktif</em>";
    return;
  }

  box.innerHTML = `
    <h3 style="color:#00f0ff; text-shadow:0 0 6px #00f0ff55;">
      Voucher Aktif
    </h3>

    ${vouchers.map(v => `
     <div class="voucher-item">
  <p class="voucher-code-row">
    <strong>Code:</strong> ${v.code}
    <button class="voucher-copy-btn" onclick="copyVoucherCode('${v.code}')">Copy Voucher</button>
  </p>

  <p>Off: ${v.discount}%</p>
  <p>End Date: ${v.expiry}</p>

  <div class="voucher-actions">
    <button 
      class="voucher-delete-btn"
      onclick="deleteVoucher('${v.id}')"
      title="Delete Voucher">
      üóë
    </button>
  </div>
</div>

    `).join("")}
  `;
}

 async function deleteVoucher(id) {
  try {
    // =========================
    // INIT STATE SAFETY
    // =========================
    window.menuVoucher = Array.isArray(window.menuVoucher)
      ? window.menuVoucher
      : [];

    // =========================
    // FILTER DATA
    // =========================
    window.menuVoucher = window.menuVoucher.filter(v => v.id !== id);

    // =========================
    // RENDER UI
    // =========================
    renderVoucher(window.menuVoucher);

    // =========================
    // SIMPAN DB
    // =========================
    await simpanData();

    console.log("üóëÔ∏è Voucher deleted:", id);

  } catch (err) {
    console.error("‚ùå deleteVoucher error:", err);
  }
}


/* ===================== COPY HELPER ===================== */
function copyVoucherCode(code) {
  if (!code) return;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code)
      .then(() => alert(`‚úÖ Kode "${code}" disalin`))
      .catch(() => fallbackCopy(code));
  } else {
    fallbackCopy(code);
  }
}

function fallbackCopy(text) {
  const i = document.createElement("input");
  i.value = text;
  document.body.appendChild(i);
  i.select();
  document.execCommand("copy");
  i.remove();
  alert(`‚úÖ Kode "${text}" disalin`);
}

  function showQRButtons(){
  document.getElementById("btnOpenCustomer")?.classList.remove("hidden");
  document.getElementById("btnSalinLink")?.classList.remove("hidden");
  document.getElementById("btnDownloadQR")?.classList.remove("hidden");
  document.getElementById("btnPrintQR")?.classList.remove("hidden");
}

async function getCustomerUrl() {
  const id = document.getElementById("restoId")?.value;
  if (!id) return null;

  return `menu.html?resto=${encodeURIComponent(id)}`;
}

async function prepareCustomerShare() {
  const url = await getCustomerUrl();
  if (!url) return;

  // ===== COPY LINK =====
  const btnCopy = document.getElementById("btnSalinLink");
  if (btnCopy) {
    btnCopy.style.display = "inline-block";
    btnCopy.onclick = () => {
      navigator.clipboard.writeText(url);
      alert("‚úÖ Link customer berhasil disalin");
    };
  }

  // ===== QR CODE (ONE LIB ONLY) =====
  const qrBox = document.getElementById("qrcodePreview");
  if (!qrBox) return;

  qrBox.innerHTML = "";

  if (typeof QRCode !== "function") {
    console.error("‚ùå QRCode constructor not ready:", QRCode);
    alert("QR Code library belum siap.");
    return;
  }

  new QRCode(qrBox, {
    text: url,
    width: 200,
    height: 200
  });

  // ===== DOWNLOAD =====
  const btnDownload = document.getElementById("btnDownloadQR");
  if (btnDownload) {
    btnDownload.style.display = "inline-block";
    btnDownload.onclick = () => {
      const img = qrBox.querySelector("img");
      if (!img) return alert("QR belum siap");
      const a = document.createElement("a");
      a.href = img.src;
      a.download = "menuva-qr.png";
      a.click();
    };
  }

  // ===== PRINT =====
  const btnPrint = document.getElementById("btnPrintQR");
  if (btnPrint) {
    btnPrint.style.display = "inline-block";
    btnPrint.onclick = () => {
      const img = qrBox.querySelector("img");
      if (!img) return;
      const w = window.open("");
      w.document.write(`<img src="${img.src}" style="width:300px"/>`);
      w.print();
      w.close();
    };
  }
}

async function openCustomerPage() {
  try {
    const url = await getCustomerUrl();
    if (!url) return alert("Resto ID tidak ditemukan.");

    window.open(url, "_blank");

  } catch (e) {
    console.error("‚ùå openCustomerPage error:", e);
    alert("Gagal membuka customer page.");
  }
}


  function showCustomerShareUI() {
  document.getElementById("btnOpenCustomer")?.style.setProperty("display", "inline-block");
  document.getElementById("btnSalinLink")?.style.setProperty("display", "inline-block");
  document.getElementById("qrcodePreview")?.style.setProperty("display", "block");
  document.getElementById("btnDownloadQR")?.style.setProperty("display", "inline-block");
  document.getElementById("btnPrintQR")?.style.setProperty("display", "inline-block");
}

 async function markDirty() {
 await MENUVA_DB.delete("session", "customerShareReady");
}

  let audioUnlocked = false;

function playNotifSound() {
  if (!audioUnlocked) return;

  const audio = new Audio('./beep.mp3');
  audio.volume = 0.6;
  audio.play().catch(() => {});
}


  document.addEventListener("click", () => {
  audioUnlocked = true;
  console.log("üîì Audio unlocked (admin)");
}, { once: true });


/* ============================================================
   3. INDEXEDDB HELPERS (SAFE)
============================================================ */
function idbGetAll(store) {
  return new Promise((resolve, reject) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

function updateReceiveBadge(count) {
  const badge = document.getElementById("receiveBadge");
  if (!badge) return;

  if (count > 0) {
    badge.style.display = "inline-block";
    badge.textContent = count;
  } else {
    badge.style.display = "none";
  }
}

/* ============================================================
   4. REALTIME ORDER CHECKER (ANTI RACE)
============================================================ */
let lastOrderCount = 0;
let checkingOrder = false;

async function cekOrderBaru() {
  if (checkingOrder) return;
  checkingOrder = true;

  try {
    const orders = await MENUVA_DB.getAll("ordersData");
    const newCount = orders.filter(o => o.status === "new").length;

    updateReceiveBadge(newCount);

    if (newCount > lastOrderCount) {
      playNotifSound();
    }

    lastOrderCount = newCount;

  } catch (err) {
    console.error("‚ùå cekOrderBaru error:", err);
  } finally {
    checkingOrder = false;
  }
}


/* ============================================================
   5. REALTIME LOOP (SINGLE INSTANCE)
============================================================ */
let realtimeInterval = null;

function startRealtimeOrderChecker() {
  if (realtimeInterval) return;

  cekOrderBaru();
  realtimeInterval = setInterval(cekOrderBaru, 1000);
}

/* ============================================================
   6. MARK AS READ + NAVIGATION
============================================================ */
async function markOrdersAsRead() {
  try {
    const orders = await MENUVA_DB.getAll("ordersData");

    for (const order of orders) {
      if (order.status === "new") {
        order.status = "read";
        await MENUVA_DB.add("ordersData", order);
      }
    }

    updateReceiveBadge(0);
    lastOrderCount = 0;

  } catch (err) {
    console.error("‚ùå markOrdersAsRead error:", err);
  }
}


function markViewedAndGo() {
  markOrdersAsRead();
  window.location.href = "recieves.html";
}

/* ============================================================
   7. OWNER UI (INVITE ADMIN)
============================================================ */
async function initOwnerUI() {
  const user = await MENUVA_DB.get("session", "activeUser");

  if (!user || user.role !== "owner") return;

  const btn = document.getElementById("inviteAdminBtn");
  if (btn) btn.style.display = "flex";
}


function openInviteAdmin() {
  window.location.href = "invite-admin.html";
}
</script>

</body>
</html>






















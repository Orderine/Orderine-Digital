<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <!-- DB CORE (SINGLE SOURCE OF TRUTH) -->
<script src="./db-core.js"></script>

<!-- AUTH GUARD (NON MODULE) -->
<script src="./auth-guard.js"></script>

<!-- IONICONS -->
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<link rel="icon" href="data:,">

<!-- CDN BIASA -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<audio id="notifAudio" src="./beep.mp3" preload="auto"></audio>
<audio id="clickAudio" src="./click.mp3" preload="auto"></audio>

  <title>Admin Orderine</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      padding-bottom: 80px;
      background: linear-gradient(135deg, #003366, #003366);
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
   /* =====================
   MOBILE-FIRST LOGO & HEADER
   ===================== */
.menuva-logo {
  text-align: center;
  margin-bottom: 10px;
  padding: 0 10px; /* beri sedikit jarak kiri-kanan di HP */
}

.menuva-logo img {
  max-width: 70%;   /* logo menyesuaikan lebar layar HP */
  height: auto;     /* menjaga proporsi asli */
  max-height: 80px; /* batasi tinggi supaya tidak terlalu besar */
  display: block;
  margin: 0 auto;   /* center logo */
}

.menuva-logo p {
  color: white;
  font-size: 13px;  /* ukuran font nyaman di HP */
  margin: 4px 0 0 0;
  line-height: 1.3;
}

/* =====================
   TABLET (min-width: 481px)
   ===================== */
@media (min-width: 481px) {
  .menuva-logo img {
    max-width: 50%;
    max-height: 90px;
  }
  .menuva-logo p {
    font-size: 14px;
  }
}

/* =====================
   DESKTOP (min-width: 769px)
   ===================== */
@media (min-width: 769px) {
  .menuva-logo img {
    max-width: 35%;
    max-height: 100px;
  }
  .menuva-logo p {
    font-size: 16px;
  }
}
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .menu-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .menu-item input {
      flex: 1 1 40%;
    }
    .menu-item button {
      flex: 1 1 auto;
      white-space: nowrap;
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-secondary {
      background-color: #3498db;
      color: white;
    }
    .btn-orange {
      background-color: orange;
      color: white;
      border: none;
    }
    .preview img {
      max-width: 100px;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .menu-item input, .menu-item button {
        width: 100%;
      }
    }
    .room-section > div:nth-child(2) button {
      padding: 6px 14px;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .room-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .room-form {
      padding: 10px;
      border: 1px dashed #ccc;
      margin-bottom: 12px;
      border-radius: 6px;
      background-color: #fff;
    }
    .room-form input[type="text"],
    .room-form input[type="number"],
    .room-form input[type="file"] {
      display: block;
      margin-bottom: 8px;
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    .room-form .room-preview img {
      max-height: 80px;
      margin-top: 4px;
    }
    .gambar-preview-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .gambar-preview {
      height: auto !important;
      width: auto !important;
      max-height: 200px !important;
      max-width: 100% !important;
      display: block;
    }
    .hapus-gambar {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .hapus-gambar:hover { background: #cc0000; }
    .btn-hapus-gambar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: red;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s, transform 0.1s ease;
    }
    .btn-hapus-gambar:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .section-box {
      border: none;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
      background: #fff;
    }
    .section-box h2,
    .section-box h3 { margin-top: 0; }
    .room-section { margin-bottom: 20px; }
    .room-section button {
      margin-bottom: 10px;
      background-color: #17a2b8;
    }
    .btn-simpan {
      background-color: #17a2b8;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-tambah-room {
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(127, 90, 240, 0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-tambah-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(44, 181, 232, 0.5);
    }
    .btn-hapus-room {
      background: linear-gradient(135deg, #ff6b6b, #fbc687);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-hapus-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(251, 198, 135, 0.5);
    }
    .btn-upload-gambar {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    .btn-upload-gambar:hover { opacity: 0.85; }
  
    /* Style umum untuk tombol aksi penting */
.btn-action {
  display: inline-block;
  padding: 10px 16px;
  margin: 6px 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Copy Link ‚Üí biru elegan */
#btnSalinLink.btn-action {
  background: #007BFF;
}
#btnSalinLink.btn-action:hover {
  background: #0056b3;
}

/* Download QR ‚Üí hijau segar */
#btnDownloadQR.btn-action {
  background: #28a745;
}
#btnDownloadQR.btn-action:hover {
  background: #1e7e34;
}

/* Print QR ‚Üí oranye elegan */
#btnPrintQR.btn-action {
  background: #fd7e14;
}
#btnPrintQR.btn-action:hover {
  background: #e8590c;
}

/* Backup Data ‚Üí ungu premium */
#btnBackup.btn-action {
  background: #6f42c1;
}
#btnBackup.btn-action:hover {
  background: #5936a2;
}
/* Blue ‚Äì untuk backup */
.btn-blue {
  background: linear-gradient(135deg, #3b82f6, #1e3a8a);
  color: white;
}
.btn-blue:hover {
  background: linear-gradient(135deg, #1e3a8a, #172554);
  transform: scale(1.05);
}
/* Base style tombol */
button {
  padding: 10px 16px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
}

/* Orange ‚Äì utama */
.btn-orange {
  background: linear-gradient(135deg, #ff914d, #ff6a00);
  color: white;
}
.btn-orange:hover {
  background: linear-gradient(135deg, #ff6a00, #cc5500);
  transform: scale(1.05);
}

/* Teal ‚Äì untuk salin link */
.btn-teal {
  background: linear-gradient(135deg, #20c997, #0f766e);
  color: white;
}
.btn-teal:hover {
  background: linear-gradient(135deg, #0f766e, #0c5f56);
  transform: scale(1.05);
}

/* Purple ‚Äì untuk download */
.btn-purple {
  background: linear-gradient(135deg, #a855f7, #6b21a8);
  color: white;
}
.btn-purple:hover {
  background: linear-gradient(135deg, #6b21a8, #4c1d95);
  transform: scale(1.05);
}

/* Red ‚Äì untuk print */
.btn-red {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  color: white;
}
.btn-red:hover {
  background: linear-gradient(135deg, #b91c1c, #7f1d1d);
  transform: scale(1.05);
}
 .setting-card {
    background: linear-gradient(135deg, #ffffff, #f9fafb);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .setting-card h2 {
    font-size: 18px;
    margin: 0 0 12px;
    color: #1e293b;
  }

  /* Switch toggle elegan */
  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 32px;
    margin-right: 10px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: #cbd5e1;
    transition: .4s;
    border-radius: 32px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background: linear-gradient(135deg, #2563eb, #1e40af);
  }
  input:checked + .slider:before {
    transform: translateX(28px);
  }

  .setting-label {
    font-size: 12px;
    font-weight: 600;
    color: #334155;
    vertical-align: middle;
  }

    /* Tombol simpan voucher */
  #saveVoucherBtn {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  #saveVoucherBtn:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }

  /* Tombol copy voucher */
  #voucherPreview button {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  #voucherPreview button:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }
  .fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: linear-gradient(135deg, #003366, #003366);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 999;
}

  .nav-item {
  flex: 1;
  text-align: center;
  padding: 6px 0;
  cursor: pointer;
  user-select: none;
  transition: 0.2s ease;
}

.nav-item .icon {
  font-size: 24px;
  color: #fff;
  transition: color 0.2s ease;
}

.nav-item .label {
  margin-top: 4px;
  font-size: 12px;
  color: #fff;
  transition: color 0.2s ease;
}

/* üî• Hover / sentuh ‚Üí jadi emas */
.nav-item:hover .icon,
.nav-item:active .icon,
.nav-item:hover .label,
.nav-item:active .label {
  color: #d4af37; /* warna emas */
}
.icon-wrapper {
  position: relative;
  display: inline-block;
}

.badge {
  position: absolute;
  top: -6px;
  right: -10px;
  background: red;
  color: white;
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 12px;
  font-weight: bold;
  display: none; /* awalnya disembunyikan */
}
    .restore-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.restore-modal.hidden {
  display: none;
}

.restore-box {
  background: #111;
  color: #fff;
  padding: 20px;
  border-radius: 12px;
  max-width: 360px;
  text-align: center;
}

.restore-box input {
  width: 100%;
  padding: 10px;
  margin: 12px 0;
  border-radius: 8px;
  border: none;
}

.restore-actions {
  display: flex;
  gap: 10px;
}

.restore-actions button {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: none;
}

.danger-btn {
  background: #d32f2f;
  color: #fff;
}

.danger-text {
  color: #ff5252;
  font-size: 13px;
}

    /* KHUSUS INVITE ADMIN */
.nav-item.vertical {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
}

.nav-item.vertical .icon {
  font-size: 22px;
}

.nav-item.vertical .label {
  font-size: 11px;
  line-height: 1;
  text-align: center;
}

 /* ===== FLIPBOOK PREVIEW GRID ===== */
#flipbookRuanganPreview,
#flipbookMenuPreview {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 14px;
  margin-top: 12px;
}

/* ===== IMAGE WRAPPER ===== */
.flipbook-preview-item {
  width: 100%;
  height: 140px;              /* üî• SEMUA SAMA */
  border-radius: 10px;
  overflow: hidden;
  background: #f2f2f2;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== IMAGE ITSELF ===== */
.flipbook-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: cover;          /* üî• KUNCI UTAMA */
  display: block;
}

  </style>
</head>
<body>
<div class="menuva-logo">
  <img src="menuva-logo.png" alt="Logo Menuva">
  <br>
  <p style="color: white;">Digital Solution For Restaurant, Hotel, & Cafe's</p>
</div>

  <div id="subscriptionCountdown" style="
  background: linear-gradient(135deg, #003366, #003366);
  color: #dc2626;
  padding:10px 14px;
  border-radius:8px;
  font-weight:600;
  font-size:14px;
  display:none;
  margin-bottom:10px;
">
  ‚è≥ Subscription time left: <span id="countdownText"></span>
</div>

<div class="section">

  <h2>üìá Business Identity</h2>
  
  <label for="logoInput">Your Business Logo</label>
  <input type="file" id="logoInput" name="logoInput" accept="image/*" />

  <img id="previewLogo" src="" alt="Logo Restoran" style="max-height: 80px; margin-top: 10px;" />

  <label for="namaRestoran">Your Business Name</label>
  <input type="text" id="namaRestoran" name="namaRestoran" placeholder="Your Business Name" />

  <label for="restoAddress">Your Business Address</label>
  <input id="restoAddress" name="restoAddress" type="text" placeholder="Jl. Sudirman No. 10, Jakarta" />

  <label for="restoPhone">Phone Number</label>
  <input id="restoPhone" name="restoPhone" type="text" placeholder="08xx-xxxx-xxxx" />
</div>

<div class="section">
  <h2>üî• Menu Promo</h2>
  <div id="promoContainer"></div>
  <button class="btn-orange" onclick="tambahPromo()">+ Add Promo Menu</button>
</div>

<div class="section">
  <h2>üìã SPECIAL MENU</h2>
  <div id="menuSpecialContainer"></div>
  <button class="btn-success" onclick="tambahMenu('special')">+ Add Special Menu</button>
</div>

<div class="section">
  <h2>üìã FOOD MENU</h2>
  <div id="menuFoodContainer"></div>
  <button class="btn-success" onclick="tambahMenu('food')">+ Add Menu</button>
</div>

<div class="section">
  <h2>üìã SNACK & DESSERT</h2>
  <div id="menuSnackContainer"></div>
  <button class="btn-success" onclick="tambahMenu('snack')">+ Add Menu</button>
</div>

<div class="section">
  <h2>üìã DRINK</h2>
  <div id="menuDrinkContainer"></div>
  <button class="btn-success" onclick="tambahMenu('drink')">+ Add Menu</button>
</div>

<div class="section-box" id="waContainerBox">
  <h3>üì± Admin WhatsApp Number (Order/Reservation Recipient)</h3>
  <div id="nomorWaContainer">
    <label for="waNumber1" class="sr-only">WhatsApp Number</label>
    <input type="text" id="waNumber1" name="waNumber[]" class="nomor-wa" placeholder="Example: 6281234567890">
  </div>
  <button onclick="tambahNomorWa()">+ Add WA Number</button>
</div>

<div class="section">
  <h2>üì∏ Room Gallery</h2>
  <button onclick="tambahGambar('ruangan')">+ Add Room Image</button>
  <input type="file" id="flipbookRuanganUpload" name="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookRuanganPreview"></div>
</div>

<div class="section">
  <h2>üìñ Restaurant Menu</h2>
  <button onclick="tambahGambar('menu')">+ Add Menu Image</button>
  <input type="file" id="flipbookMenuUpload" name="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookMenuPreview"></div>
</div>

<div class="setting-card" id="orderToggleBox">
  <h2>‚öôÔ∏è Reservation & Delivery Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleOrderPage" name="toggleOrderPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Reservation & Delivery Page</span>
</div>

<div class="setting-card" id="roomToggleBox">
  <h2>‚öôÔ∏è Room Page Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleRoomPage" name="toggleRoomPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Room Page.</span>
</div>

<div class="section-box" id="roomContainerBox">
  <h2>üè® Room / Packages</h2>
  <div class="room-section">
    <h3>üõèÔ∏è Room Hotel</h3>
    <button onclick="tambahRoom('hotel')" class="btn-tambah-room">+ Add Hotel Room</button>
    <div id="roomHotelContainer"></div>
  </div>
  <div class="room-section">
    <h3>üíº Meeting Room</h3>
    <button onclick="tambahRoom('meeting')" class="btn-tambah-room">+ Add Meeting Room</button>
    <div id="meetingRoomContainer"></div>
  </div>
  <div class="room-section">
    <h3>üéÅ Packages</h3>
    <button onclick="tambahRoom('package')" class="btn-tambah-room">+ Add Packages</button>
    <div id="packageContainer"></div>
  </div>
</div>

<div class="section-box" id="voucherContainerBox">
  <h2>üéüÔ∏è Voucher Diskon</h2>
  <label class="switch">
    <input type="checkbox" id="toggleVoucherPage" name="toggleVoucherPage">
    <span class="slider round"></span>
  </label>

  <div id="voucherForm" style="margin-top:15px; display:none;">
    <label for="voucherCode">Voucher Code</label>
    <input type="text" id="voucherCode" name="voucherCode" placeholder="Kode Voucher">

    <label for="voucherDiscount">Discount (%)</label>
    <input type="number" id="voucherDiscount" name="voucherDiscount" placeholder="Diskon (%)">

    <label for="voucherExpiry">Expiry Date</label>
    <input type="date" id="voucherExpiry" name="voucherExpiry">

    <button id="saveVoucherBtn" onclick="saveVoucher()">üíæ Save Voucher Code</button>
  </div>

  <div id="voucherPreview"></div>
</div>

<hr>

<div class="section">
  <button class="btn-simpan" onclick="simpanData()">üíæ Save All</button>
  <input type="hidden" id="restoId" name="restoId" />

  <button id="btnOpenCustomer" class="btn-orange" style="display:none;">üëÅÔ∏è See Customer Page</button>
  <button id="btnSalinLink" class="btn-teal" style="display:none;">üìã Copy Link to Share with Customers</button>

  <div id="qrcodePreview" style="margin-top:10px;"></div>

  <button id="btnDownloadQR" class="btn-purple" style="margin-top:10px; display:none;">‚¨áÔ∏è Download QR Code</button>
  <button id="btnPrintQR" class="btn-red" style="margin-top:5px; display:none;">üñ®Ô∏è Print QR Code</button>

  <div class="section">
    <h2>üîÅ Backup & Restore Data</h2>
    <button onclick="downloadBackupJSON()">üì¶ Backup Data</button>
    <div id="backupDownloadLink" style="margin-top:10px;"></div>

    <label for="restoreInput" style="margin-top: 20px; display: block;">üìÇ Select JSON File to Restore:</label>
    <input type="file" id="restoreInput" name="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
  </div>
  
  <!-- Panduan -->
  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>Panduan Penggunaan:</strong><br>
    PENTING!!<br>
    üîπ Klik <strong>‚¨áÔ∏è Backup Data</strong> untuk menyimpan semua data restoran ke file <strong>.json</strong>.<br>
    üîπ Simpan file tersebut dengan baik.<br>
    üîπ Klik <strong>üìÇ Pilih File</strong> untuk me-restore data.<br>
    ‚ö†Ô∏è Proses restore menggantikan seluruh data saat ini.<br>
  </div>

  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>User Guide:</strong><br>
    IMPORTANT!!<br>
    üîπ Click <strong>‚¨áÔ∏è  Data</strong> to save all data.<br>
    üîπ Keep the file safe.<br>
    üîπ Click <strong>üìÇ Choose File</strong> to restore data.<br>
    ‚ö†Ô∏è The restore process replaces all existing data.<br>
  </div>

  <button onclick="resetData()" class="btn-danger">üóëÔ∏è Reset Data</button>
</div>

<div class="fixed-bar">

  <div class="nav-item" onclick="markViewedAndGo()">
    <div class="icon-wrapper">
      <ion-icon name="cube-outline" class="icon"></ion-icon>
      <span id="receiveBadge" class="badge">0</span>
    </div>
    <div class="label">Receives</div>
  </div>

  <div class="nav-item danger" onclick="openRestorePopup()">
    <div class="icon-wrapper">
      <ion-icon name="cloud-download-outline" class="icon"></ion-icon>
    </div>
    <div class="label">Restore</div>
  </div>

 <div
  class="nav-item vertical"
  id="inviteAdminBtn"
  onclick="openInviteAdmin()"
  style="display:none"
>
  <div class="icon-wrapper">
    <ion-icon name="person-add-outline" class="icon"></ion-icon>
  </div>
  <div class="label">Invite Admin</div>
</div>

  <div class="nav-item" onclick="window.location.href='index.html'">
    <div class="icon-wrapper">
      <ion-icon name="log-out-outline" class="icon"></ion-icon>
    </div>
    <div class="label">Logout</div>
  </div>

</div>

<script>
function initSubscriptionCountdown(user) {
  if (!user || !user.premiumExpire || !user.premiumPlan) return;

  const box = document.getElementById("subscriptionCountdown");
  if (!box) return;

  box.innerHTML = `
    ‚è≥ ${user.premiumPlan.toUpperCase()} plan expires in:
    <span id="countdownText"></span>
  `;

  const text = document.getElementById("countdownText");
  box.style.display = "block";

  const expireTime = new Date(user.premiumExpire).getTime();

  function formatTime(ms) {
    if (ms <= 0) return "Expired";

    const sec = Math.floor(ms / 1000);
    const min = Math.floor(sec / 60);
    const hr = Math.floor(min / 60);
    const day = Math.floor(hr / 24);

    if (day > 0) return `${day} day(s) ${hr % 24}h`;
    if (hr > 0) return `${hr} hour(s) ${min % 60}m`;
    if (min > 0) return `${min} minute(s) ${sec % 60}s`;
    return `${sec} second(s)`;
  }

  function tick() {
    const remaining = expireTime - Date.now();
    text.textContent = formatTime(remaining);

    if (remaining < 24 * 60 * 60 * 1000) {
      box.style.background = "#ffeaea";
      box.style.color = "#a10000";
    }
  }

  tick();
  setInterval(tick, 1000);
}
</script>

<script>
function startSubscriptionWatcher(subscription) {
  if (!subscription || !subscription.expire_at) return;

  const expireTime = new Date(subscription.expire_at).getTime();

  setInterval(() => {
    if (Date.now() > expireTime) {
      console.warn("üö® Subscription expired (validated)");
      handleSubscriptionExpired();
    }
  }, 10000); // cukup 10 detik
}

function handleSubscriptionExpired() {
  alert("‚è± Subscription expired. Please renew to continue.");

  localStorage.removeItem("activeUser");
  localStorage.removeItem("isLoggedIn");

  location.href = "plans.html";
}
</script>

<script>
/* ================= RESTO ID CORE ================= */

function hashEmail(email) {
  let hash = 0;
  for (let i = 0; i < email.length; i++) {
    hash = (hash << 5) - hash + email.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

function generateRestoIdFromEmail(email) {
  if (!email) throw new Error("Email owner wajib ada");
  return "RESTO_" + hashEmail(email.toLowerCase());
}

function ensureRestoId() {
  let restoId = localStorage.getItem("restoId");
  if (restoId) return restoId;

  const email = window.currentUser?.email;
  if (!email) {
    console.warn("‚õî Email owner belum siap, restoId belum bisa dibuat");
    return null;
  }

  restoId = generateRestoIdFromEmail(email);
  localStorage.setItem("restoId", restoId);
  console.log("‚úÖ restoId generated:", restoId);
  return restoId;
}
</script>

<script>

  /* ============================================================
   ADMIN DB BRIDGE (NO MODULE ‚Äì FINAL STABLE)
============================================================ */

console.log("üöÄ Admin DB Bridge ‚Äì FINAL NO MODULE");


/* ====================== GLOBAL DB STATE ====================== */
const DB_NAME = window.MENUVA_DB.NAME;
const STORE_NAME = window.MENUVA_DB.STORE;
const DB_VERSION = window.MENUVA_DB.VERSION;

  /* ====================== MENUVA DATA DB HELPERS ====================== */

// üîê Ambil ID aktif (AMAN)
function getActiveRestoId() {
  if (window.activeUser?.restoId) return window.activeUser.restoId;
  console.warn("‚ö†Ô∏è activeUser.restoId tidak ada, pakai id=1");
  return 1;
}

/* ====================== DEFAULT DATA ====================== */
function buatDataDefault(restoId = "") {
  return {
    id: restoId,
    restoId,
    ownerId: "",

    namaRestoran: "",
    restoAddress: "",
    restoPhone: "",
    logo: "",

    menu: [],
    promoData: [],
    menuVoucher: [],
    rooms: [],
    nomorWaAdmin: [],
    flipbookRuanganImages: [],
    flipbookMenuImages: [],

    updatedAt: Date.now()
  };
}

/* ====================== TEST SUPPORT ====================== */
if (!window.indexedDB) {
  alert("‚ö†Ô∏è Browser tidak mendukung IndexedDB");
} else {
  console.log("‚úÖ IndexedDB supported");
}

let flipbookRuanganImages = [];
let flipbookMenuImages = [];

  function renderPromoUI() {
  // PROMO SEKARANG DOM-BASED
  // fungsi ini cuma bridge supaya admin init tidak error
  if (typeof loadPromoFromDB === "function") {
    loadPromoFromDB();
  }
}

function tambahPromo(promo = {}) {
  const container = document.getElementById("promoContainer");
  if (!container) return;

  const {
    namaPromo = "",
    harga = "",
    deskripsi = "",
    tanggalAkhir = "",
    image = ""
  } = promo;

  const div = document.createElement("div");
  div.className = "menu-item promo-item";

  div.innerHTML = `
    <input type="text" placeholder="Promo Name" value="${namaPromo}">
    <input type="number" placeholder="Price" value="${harga}">
    <textarea placeholder="Description">${deskripsi}</textarea>
    <input type="date" value="${tanggalAkhir}">

    <input type="file"
      accept="image/*"
      onchange="uploadPromoImage(event, this)"
      data-image="${image}"
    >

    <img class="promoPreview"
      src="${image}"
      style="max-height:80px;margin:5px 0;${image ? "" : "display:none"}">

    <button class="btn-danger" onclick="this.parentElement.remove()">Delete</button>
  `;

  container.appendChild(div);
}

  function uploadPromoImage(event, inputEl) {
  const file = event.target.files[0];
  if (!file) return;

  resizeIfNeeded(file)
    .then(resized => {
      const preview = inputEl.parentElement.querySelector(".promoPreview");
      preview.src = resized;
      preview.style.display = "block";
      inputEl.setAttribute("data-image", resized);
    })
    .catch(err => console.error("Upload promo image failed:", err));
}

  function ambilPromo() {
  const container = document.getElementById("promoContainer");
  if (!container) return [];

  const promos = [];

  container.querySelectorAll(".promo-item").forEach(item => {
    promos.push({
      id: crypto.randomUUID(),
      namaPromo: item.querySelector("input[type=text]")?.value || "",
      harga: Number(item.querySelector("input[type=number]")?.value || 0),
      deskripsi: item.querySelector("textarea")?.value || "",
      tanggalAkhir: item.querySelector("input[type=date]")?.value || "",
      image: item.querySelector("input[type=file]")?.getAttribute("data-image") || "",
      kategori: "PROMO"
    });
  });

  return promos;
}

/* ============================================================
   MENU
============================================================ */
function tambahMenu(kategori = "food", nama = "", harga = "", image = "") {
  const containerId = {
    food: "menuFoodContainer",
    snack: "menuSnackContainer",
    drink: "menuDrinkContainer",
    special: "menuSpecialContainer"
  }[kategori] || "menuFoodContainer";

  const container = document.getElementById(containerId);
  if (!container) return;

  const uid = "menu_" + Date.now();

  const div = document.createElement("div");
  div.className = "menu-item";
  div.innerHTML = `
    <input type="text" id="${uid}_name" placeholder="Menu Name" value="${nama}">
    <input type="number" id="${uid}_price" placeholder="Price" value="${harga}">
    <select id="${uid}_cat">
      <option value="food" ${kategori === "food" ? "selected" : ""}>Food</option>
      <option value="snack" ${kategori === "snack" ? "selected" : ""}>Snack</option>
      <option value="drink" ${kategori === "drink" ? "selected" : ""}>Drink</option>
      <option value="special" ${kategori === "special" ? "selected" : ""}>Special</option>
    </select>

    <input type="file" accept="image/*" onchange="uploadMenuImage(event, this)" data-image="${image}">
    <img class="menuPreview" src="${image}" style="max-height:80px; margin:5px 0; ${image ? "" : "display:none"}">

    <button class="btn-danger" onclick="this.parentElement.remove()">Delete</button>
  `;
  container.appendChild(div);
}

function uploadMenuImage(event, inputEl) {
  const file = event.target.files[0];
  if (!file) return;

  resizeIfNeeded(file)
    .then(resized => {
      const preview = inputEl.parentElement.querySelector(".menuPreview");
      preview.src = resized;
      preview.style.display = "block";
      inputEl.setAttribute("data-image", resized);
    })
    .catch(err => console.error("Upload menu image failed:", err));
}

function ambilMenu(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return [];

  const result = [];
  container.querySelectorAll(".menu-item").forEach(item => {
    const nama = item.querySelector("input[type=text]")?.value || "";
    const harga = parseInt(item.querySelector("input[type=number]")?.value || "0");
    const kategori = item.querySelector("select")?.value || "food";
    const image = item.querySelector("input[type=file]")?.getAttribute("data-image") || "";

    if (nama && harga > 0) {
      result.push({ nama, harga, kategori, image });
    }
  });

  return result;
}

/* ============================================================
   ROOM
============================================================ */
function tambahRoom(kategori) {
  const containerId = {
    hotel: "roomHotelContainer",
    meeting: "meetingRoomContainer",
    package: "packageContainer"
  }[kategori];
  if (!containerId) return;

  const container = document.getElementById(containerId);
  const uid = `${kategori}_${Date.now()}`;

  const wrapper = document.createElement("div");
  wrapper.className = "room-form";
  wrapper.innerHTML = `
    <input class="room-nama" placeholder="Name">
    <input class="room-harga" type="number" placeholder="Price">
    <input class="room-kapasitas" type="number" placeholder="Capacity">
    <input class="room-luas" type="number" placeholder="Size (m¬≤)">
    <textarea class="room-deskripsi" placeholder="Notes"></textarea>

    <div>
      <img class="gambar-preview" style="display:none; max-width:120px">
      <button type="button" class="hapus-gambar" onclick="hapusGambarRoom(this)" style="display:none">√ó</button>
    </div>

    <button type="button" class="room-image-upload" onclick="uploadGambarRoom(this)">üñº Upload Image</button>
    <button type="button" onclick="hapusFormRoom(this)">üóë Delete</button>
    <hr>
  `;
  container.appendChild(wrapper);
}

function ambilSemuaRoom() {
  const hasil = [];

  // üî• ROOM & MEETING ONLY (PACKAGE BUKAN DI SINI)
  const kategoriMap = [
    { id: "roomHotelContainer", type: "room" },
    { id: "meetingRoomContainer", type: "meeting" }
  ];

  kategoriMap.forEach(({ id, type }) => {
    const container = document.getElementById(id);
    if (!container) return;

    container.querySelectorAll(".room-form").forEach(form => {
      const nama = form.querySelector(".room-nama")?.value?.trim() || "";
      const harga = parseInt(form.querySelector(".room-harga")?.value || "0");

      // ‚õî skip data kosong
      if (!nama || harga <= 0) return;

      hasil.push({
        // üîë DB IDENTITAS
        id: "R" + Date.now() + Math.floor(Math.random() * 1000),
        restoId: window.activeUser?.restoID || "",
        type, // "room" | "meeting"

        // üì¶ DATA INTI
        nama,
        harga,
        kapasitas: parseInt(form.querySelector(".room-kapasitas")?.value || "0"),
        luas: parseInt(form.querySelector(".room-luas")?.value || "0"),
        deskripsi: form.querySelector(".room-deskripsi")?.value || "",
        image: form.querySelector(".room-image-upload")?.getAttribute("data-image") || "",

        // üïí META
        updatedAt: Date.now()
      });
    });
  });

  return hasil;
}

function restoreRoomFromData(rooms = []) {
  rooms.forEach(room => {
    tambahRoom(room.kategori);
    const containerId = {
      hotel: "roomHotelContainer",
      meeting: "meetingRoomContainer",
      package: "packageContainer"
    }[room.kategori];

    const container = document.getElementById(containerId);
    const form = container.lastElementChild;

    form.querySelector(".room-nama").value = room.nama || "";
    form.querySelector(".room-harga").value = room.harga || "";
    form.querySelector(".room-kapasitas").value = room.kapasitas || "";
    form.querySelector(".room-luas").value = room.luas || "";
    form.querySelector(".room-deskripsi").value = room.deskripsi || "";

    if (room.image) {
      const preview = form.querySelector(".gambar-preview");
      const hapus = form.querySelector(".hapus-gambar");
      preview.src = room.image;
      preview.style.display = "block";
      hapus.style.display = "inline-flex";
      form.querySelector(".room-image-upload").setAttribute("data-image", room.image);
    }
  });
}

function uploadGambarRoom(btn) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const form = btn.closest(".room-form");
      const preview = form.querySelector(".gambar-preview");
      const hapus = form.querySelector(".hapus-gambar");

      preview.src = ev.target.result;
      preview.style.display = "block";
      hapus.style.display = "inline-flex";
      btn.setAttribute("data-image", ev.target.result);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function hapusGambarRoom(btn) {
  const form = btn.closest(".room-form");
  form.querySelector(".gambar-preview").style.display = "none";
  btn.style.display = "none";
  form.querySelector(".room-image-upload").removeAttribute("data-image");
}

function hapusFormRoom(btn) {
  btn.closest(".room-form")?.remove();
}

  function renderRoomsFromDB(rooms) {
  // clear dulu
  ["roomHotelContainer", "meetingRoomContainer"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = "";
  });

  rooms.forEach(room => {
    restoreRoomFromData([{
      ...room,
      kategori: room.type === "meeting" ? "meeting" : "hotel"
    }]);
  });
}


/* ============================================================
   EXPOSE TO WINDOW (WAJIB UNTUK MODULE)
============================================================ */
window.menuPromo = window.menuPromo || [];
window.promoList = window.menuPromo;

window.tambahMenu = tambahMenu;
window.uploadMenuImage = uploadMenuImage;
window.ambilMenu = ambilMenu;

window.tambahRoom = tambahRoom;
window.ambilSemuaRoom = ambilSemuaRoom;
window.restoreRoomFromData = restoreRoomFromData;
window.uploadGambarRoom = uploadGambarRoom;
window.hapusGambarRoom = hapusGambarRoom;
window.hapusFormRoom = hapusFormRoom;

/* ============================================================
   IMAGE RESIZE HELPER
============================================================ */
async function resizeIfNeeded(file, targetSizeKB = 100, maxWidth = 1280) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        try {
          const scale = Math.min(maxWidth / img.width, 1);
          const canvas = document.createElement("canvas");
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;

          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          let quality = 0.9;
          let dataUrl = canvas.toDataURL("image/jpeg", quality);
          let sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);

          while (sizeKB > targetSizeKB && quality > 0.1) {
            quality -= 0.05;
            dataUrl = canvas.toDataURL("image/jpeg", quality);
            sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);
          }

          resolve(dataUrl);
        } catch (err) {
          reject(err);
        }
      };

      img.onerror = () => reject(new Error("Image load error"));
      img.src = e.target.result;
    };

    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* ============================================================
   LOGO UPLOAD
============================================================ */
document.getElementById("logoInput")?.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const logoUrl = await resizeIfNeeded(file, 100);
    const preview = document.getElementById("previewLogo");
    if (preview) preview.src = logoUrl;
  } catch (err) {
    console.error("Logo resize error:", err);
    alert("‚ùå Failed to process logo image.");
  }
});

/* ============================================================
   FLIPBOOK IMAGE PREVIEW (SYNC WITH CSS GRID)
============================================================ */
function renderImagePreview(tipe, url) {
  if (!url) return;

  const containerId =
    tipe === "ruangan"
      ? "flipbookRuanganPreview"
      : "flipbookMenuPreview";

  const container = document.getElementById(containerId);
  if (!container) return;

  // üß± WRAPPER (ikut CSS grid)
  const wrapper = document.createElement("div");
  wrapper.className = "flipbook-preview-item";

  // üñºÔ∏è IMAGE (ukuran diatur CSS)
  const img = document.createElement("img");
  img.src = url;
  img.loading = "lazy";

  // ‚ùå BUTTON
  const btnHapus = document.createElement("button");
  btnHapus.className = "btn-hapus-gambar";
  btnHapus.innerHTML = "√ó";

  btnHapus.onclick = () => {
    wrapper.remove();

    if (tipe === "ruangan") {
      window.flipbookRuanganImages =
        window.flipbookRuanganImages.filter(src => src !== url);
    } else {
      window.flipbookMenuImages =
        window.flipbookMenuImages.filter(src => src !== url);
    }
  };

  wrapper.appendChild(img);
  wrapper.appendChild(btnHapus);
  container.appendChild(wrapper);
}


function tambahGambar(type) {
  const inputId =
    type === "ruangan" ? "flipbookRuanganUpload" : "flipbookMenuUpload";

  const input = document.getElementById(inputId);
  if (!input) return;

  // reset value supaya bisa upload file yg sama lagi
  input.value = "";

  input.onchange = async (event) => {
    const files = Array.from(event.target.files || []);
    if (!files.length) return;

    for (const file of files) {
      try {
        const resized = await resizeIfNeeded(file);

        if (type === "ruangan") {
          window.flipbookRuanganImages.push(resized);
          renderImagePreview("ruangan", resized);
        } else {
          window.flipbookMenuImages.push(resized);
          renderImagePreview("menu", resized);
        }
      } catch (err) {
        console.error("‚ùå resize image gagal:", err);
      }
    }
  };

  input.click();
}

/* ============================================================
   STRING HELPER
============================================================ */
function slugify(text = "") {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, "-")
    .replace(/[^\w\-]+/g, "")
    .replace(/\-\-+/g, "-");
}

/* ============================================================
   EXPOSE TO WINDOW (MODULE ‚Üî INLINE BRIDGE)
============================================================ */
window.resizeIfNeeded = resizeIfNeeded;
window.renderImagePreview = renderImagePreview;
window.tambahGambar = tambahGambar;
window.slugify = slugify;

// ====================== GLOBAL SAFE INIT ======================
window.flipbookRuanganImages = window.flipbookRuanganImages || [];
window.flipbookMenuImages = window.flipbookMenuImages || [];
window.menuVoucher = window.menuVoucher || [];

// ====================== SIMPAN (ADMIN ‚Üí MENUVA DATA) ======================
async function simpanData() {
  try {
    showLoader();

    /* ==================== AUTH SAFETY ==================== */
    if (!window.activeUser || !window.activeUser.restoID) {
      alert("‚ùå Session tidak valid. Silakan login ulang.");
      console.error("‚ùå activeUser missing in simpanData");
      return;
    }

    const ownerId = window.activeUser.email;
    const restoId = window.activeUser.restoID;

    /* ==================== FORM DATA ==================== */
    const namaRestoran  = getVal("namaRestoran");
    const restoAddress  = getVal("restoAddress");
    const restoPhone    = getVal("restoPhone");
    const logo          = document.getElementById("previewLogo")?.src || "";
    const nomorWaAdmin  = getNomorWaAdmin();

    if (!restoPhone) {
      alert("‚ùå Nomor telepon resto wajib diisi!");
      return;
    }

    /* ==================== MENU ==================== */
    const menuData = Array.isArray(ambilSemuaMenu?.()) ? ambilSemuaMenu() : [];

    /* ==================== VALIDASI ==================== */
    if (highlightInvalidPromo()) {
      alert("‚ö†Ô∏è Please complete the data promos.\nLengkapi dulu sebelum Save.");
      return;
    }

    if (highlightInvalidMenu()) {
      alert("‚ö†Ô∏è Please complete the data menus.\nLengkapi dulu sebelum Save.");
      return;
    }

    /* ====================================================
       1Ô∏è‚É£ SIMPAN / UPDATE RESTO PROFILE
    ==================================================== */
    await window.MENUVA_DB.add("restos", {
      id: restoId,
      ownerId,
      namaRestoran,
      restoAddress,
      restoPhone,
      logo,
      nomorWaAdmin,
      updatedAt: Date.now()
    });

    /* ====================================================
       2Ô∏è‚É£ SIMPAN MENU (menuData store)
    ==================================================== */
    for (const menu of menuData) {
      await window.MENUVA_DB.add("menuData", {
        ...menu,
        restoId,
        active: menu.active !== false
      });
    }

    /* ====================================================
       3Ô∏è‚É£ SIMPAN ROOM & MEETING ROOM (flipbookData)
    ==================================================== */
    const rooms = typeof ambilSemuaRoom === "function"
      ? ambilSemuaRoom()
      : [];

    for (const room of rooms) {
      await window.MENUVA_DB.add("flipbookData", {
        ...room,
        type: room.type || "room", // room | meeting
        restoId
      });
    }

    /* ====================================================
       4Ô∏è‚É£ SIMPAN IMAGE FLIPBOOK (BACKWARD COMPAT)
    ==================================================== */
    const ruanganImages = window.flipbookRuanganImages || [];
    const menuImages    = window.flipbookMenuImages || [];

    for (const img of ruanganImages) {
      await window.MENUVA_DB.add("flipbookData", {
        ...img,
        type: "room-image",
        restoId
      });
    }

    for (const img of menuImages) {
      await window.MENUVA_DB.add("flipbookData", {
        ...img,
        type: "menu-image",
        restoId
      });
    }

    /* ====================================================
       5Ô∏è‚É£ SIMPAN PACKAGE & VOUCHER (promoData)
    ==================================================== */
    const promos = typeof ambilPromo === "function"
      ? ambilPromo()
      : [];

    for (const promo of promos) {
      await window.MENUVA_DB.add("promoData", {
        ...promo,
        restoId,
        active: promo.active !== false
      });
    }

    // backward compat: voucher lama
    if (Array.isArray(window.menuVoucher)) {
      for (const voucher of window.menuVoucher) {
        await window.MENUVA_DB.add("promoData", {
          ...voucher,
          type: "voucher",
          restoId,
          active: true
        });
      }
    }

    /* ==================== FINALIZE ==================== */
    syncRestoIdHidden(restoId);
    prepareCustomerShare?.();

    console.log("üíæ SIMPAN DATA SUCCESS ‚Üí RESTO:", restoId);
    alert("‚úÖ All Data Successfully Saved!");

    showCustomerShareUI();
    localStorage.setItem("customerShareReady", "1");

  } catch (err) {
    console.error("‚ùå simpanData fatal:", err);
    alert("‚ùå Failed to save data");
  } finally {
    hideLoader();
  }
}


  function getVal(id) {
  return document.getElementById(id)?.value.trim() || "";
}

  function getNomorWaAdmin() {
  return Array.from(document.querySelectorAll(".nomor-wa"))
    .map(i => i.value.trim())
    .filter(Boolean);
}

  function ambilSemuaMenu() {
  return [
    ...(typeof ambilMenu === "function" ? ambilMenu("menuFoodContainer") : []),
    ...(typeof ambilMenu === "function" ? ambilMenu("menuSnackContainer") : []),
    ...(typeof ambilMenu === "function" ? ambilMenu("menuDrinkContainer") : []),
    ...(typeof ambilMenu === "function" ? ambilMenu("menuSpecialContainer") : [])
  ];
}

  function syncRestoIdHidden(restoId) {
  let el = document.getElementById("restoId");
  if (!el) {
    el = document.createElement("input");
    el.type = "hidden";
    el.id = "restoId";
    document.body.appendChild(el);
  }
  el.value = restoId;
}

  // ====================== VALIDASI PROMO (FINAL) ======================
function highlightInvalidPromo() {
  let invalid = false;

  document.querySelectorAll(".promo-item").forEach(item => {
    const harga = item.querySelector("input[type=number]");

    if (!harga || !harga.value || Number(harga.value) <= 0) {
      if (harga) harga.style.border = "2px solid red";
      invalid = true;
    } else {
      harga.style.border = "";
    }
  });

  return invalid;
}


  function highlightInvalidMenu() {
  let invalid = false;

  document.querySelectorAll(".menu-item").forEach(item => {
    // skip promo
    if (item.classList.contains("promo-item")) return;

    const nama = item.querySelector("input[type=text]");
    const harga = item.querySelector("input[type=number]");

    // reset style
    if (nama) nama.style.border = "";
    if (harga) harga.style.border = "";

    if (!nama || !nama.value.trim()) {
      if (nama) nama.style.border = "2px solid red";
      invalid = true;
    }

    if (!harga || !harga.value || harga.value <= 0) {
      if (harga) harga.style.border = "2px solid red";
      invalid = true;
    }
  });

  return invalid;
}

  // ====================== WA ADMIN HANDLER ======================
function tambahNomorWa(value = "") {
  const container = document.getElementById("nomorWaContainer");
  if (!container) return;

  const wrapper = document.createElement("div");
  wrapper.className = "wa-item";

  const input = document.createElement("input");
  input.type = "text";
  input.className = "nomor-wa"; // üî• FIX DISINI
  input.placeholder = "Nomor WhatsApp Admin";
  input.value = value;

  const btn = document.createElement("button");
  btn.type = "button";
  btn.textContent = "‚ùå";
  btn.onclick = () => wrapper.remove();

  wrapper.appendChild(input);
  wrapper.appendChild(btn);
  container.appendChild(wrapper);
}

  let sudahLoadData = false;

async function loadData() {
  try {
    /* ================= AUTH SAFETY ================= */
    if (!window.activeUser || !window.activeUser.restoID) {
      console.warn("‚ö†Ô∏è loadData aborted: no activeUser");
      return;
    }

    const restoId = window.activeUser.restoID;
    showLoader?.();

    // ================= RESET FLAG =================
    if (window.__lastLoadedResto !== restoId) {
      sudahLoadData = false;
    }
    window.__lastLoadedResto = restoId;
    sudahLoadData = true;

    /* =================================================
       1Ô∏è‚É£ LOAD FULL RESTO PAYLOAD (menuData store)
    ================================================= */
    const restoData = await window.MENUVA_DB.get("menuData", restoId);
    if (!restoData) {
      console.warn("‚ö†Ô∏è Tidak ada restoData di menuData store");
      return;
    }

    // ================= RESTO PROFILE =================
    const safeSet = (id, val) => {
      const el = document.getElementById(id);
      if (el) el.value = val || "";
    };

    safeSet("namaRestoran", restoData.namaRestoran);
    safeSet("restoAddress", restoData.restoAddress);
    safeSet("restoPhone", restoData.restoPhone);

    if (restoData.logo) {
      const img = document.getElementById("previewLogo");
      if (img) img.src = restoData.logo;
    }

    // ================= NOMOR WA =================
    const waContainer = document.getElementById("nomorWaContainer");
    if (waContainer) {
      waContainer.innerHTML = "";
      const waList = Array.isArray(restoData.nomorWaAdmin) ? restoData.nomorWaAdmin : [];
      waList.forEach(num => {
        try { tambahNomorWa?.(num); }
        catch (e) { console.warn("‚ö†Ô∏è render WA gagal:", e); }
      });
    }

    // ================= MENU =================
    if (Array.isArray(restoData.menu)) {
      ["menuFoodContainer","menuSnackContainer","menuDrinkContainer","menuSpecialContainer"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = "";
        });

      restoData.menu.forEach(m => {
        try {
          tambahMenu?.(
            m.kategori || "food",
            m.nama || "",
            m.harga || "",
            m.image || ""
          );
        } catch (e) {
          console.warn("‚ö†Ô∏è tambahMenu gagal:", m, e);
        }
      });
    }

    // ================= ROOM / MEETING / PACKAGE =================
    if (Array.isArray(restoData.rooms)) {
      ["roomHotelContainer","meetingRoomContainer","packageContainer"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = "";
        });

      try {
        restoreRoomFromData?.(restoData.rooms);
      } catch (e) {
        console.warn("‚ö†Ô∏è restoreRoomFromData gagal:", e);
      }
    }

    // ================= FLIPBOOK IMAGES =================
    window.flipbookRuanganImages = Array.isArray(restoData.flipbookRuanganImages)
      ? restoData.flipbookRuanganImages
      : [];
    window.flipbookMenuImages = Array.isArray(restoData.flipbookMenuImages)
      ? restoData.flipbookMenuImages
      : [];

    if (typeof renderImagePreview === "function") {
      setTimeout(() => {
        window.flipbookRuanganImages.forEach(src => renderImagePreview("ruangan", src));
        window.flipbookMenuImages.forEach(src => renderImagePreview("menu", src));
      }, 50);
    }

    // ================= VOUCHER =================
    let vouchers = Array.isArray(restoData.menuVoucher) ? restoData.menuVoucher : [];

    // fallback: load voucher dari promoData jika menuVoucher kosong
    if (vouchers.length === 0) {
      try {
        const allPromo = await window.MENUVA_DB.getAll("promoData");
        vouchers = allPromo.filter(p => p.restoId === restoId && p.type === "voucher");
        window.menuVoucher = vouchers;
      } catch (e) {
        console.warn("‚ö†Ô∏è load vouchers dari promoData gagal:", e);
      }
    }

    if (vouchers.length) {
      if (typeof renderVoucher === "function") {
        renderVoucher(vouchers);
      }
      const voucherContainer = document.getElementById("voucherContainer");
      if (voucherContainer) {
        voucherContainer.style.display = "block";
      }
    } else {
      const box = document.getElementById("voucherPreview");
      if (box) box.innerHTML = "<em>Belum ada voucher aktif</em>";
    }

    // ================= PROMO =================
    if (Array.isArray(restoData.menuPromo)) {
      const promoContainer = document.getElementById("promoContainer");
      if (promoContainer) {
        promoContainer.innerHTML = "";
        window.menuPromo = [];
        restoData.menuPromo.forEach(promo => {
          try { tambahPromo?.(promo); }
          catch (e) { console.warn("‚ö†Ô∏è tambahPromo gagal:", promo, e); }
        });
      }
    }

    console.log("‚úÖ loadData SUCCESS ‚Üí resto:", restoId);

  } catch (err) {
    console.error("‚ùå loadData fatal:", err);
    sudahLoadData = false;
  } finally {
    hideLoader?.();
  }
}

  async function loadMenuAndFlipbook() {
  try {
    if (!window.activeUser?.restoID) return;
    const restoId = window.activeUser.restoID;

    console.log("üîÑ loadMenuAndFlipbook (DB driven)");

  // ================= MENU =================
const menuRows = await MENUVA_DB.getAll("menuData");
const menuByResto = menuRows.filter(m => m.restoId === restoId);

// üßπ CLEAR MENU UI (DEFENSIVE)
if (typeof clearMenuUI === "function") {
  try {
    clearMenuUI();
  } catch (e) {
    console.warn("‚ö†Ô∏è clearMenuUI error, lanjut render menu:", e);
  }
} else {
  console.warn("‚ö†Ô∏è clearMenuUI tidak ditemukan, skip clear");
}

// üçΩÔ∏è RENDER MENU
menuByResto.forEach(m => {
  try {
    tambahMenu?.(
      m.kategori || "food",
      m.nama || "",
      m.harga || "",
      m.image || ""
    );
  } catch (e) {
    console.warn("‚ö†Ô∏è tambahMenu gagal:", m, e);
  }
});

    // ================= FLIPBOOK =================
    const flipbookRows = await MENUVA_DB.getAll("flipbookData");
    const fbByResto = flipbookRows.filter(f => f.restoId === restoId);

    const ruangan = fbByResto.filter(f => f.type === "room-image");
    const menuImg = fbByResto.filter(f => f.type === "menu-image");

    window.flipbookRuanganImages = [];
    window.flipbookMenuImages = [];

    ruangan.forEach(f => {
      if (f.src) {
        window.flipbookRuanganImages.push(f.src);
        renderImagePreview?.("ruangan", f.src);
      }
    });

    menuImg.forEach(f => {
      if (f.src) {
        window.flipbookMenuImages.push(f.src);
        renderImagePreview?.("menu", f.src);
      }
    });

    console.log("‚úÖ Menu & Flipbook loaded (DB OK)");

  } catch (err) {
    console.error("‚ùå loadMenuAndFlipbook fatal:", err);
  }
}

// ====================== RESET / BACKUP / RESTORE ======================
async function resetData() {
  if (!confirm("Yakin ingin menghapus SEMUA DATA RESTO?\n(Akun & langganan TIDAK akan terhapus)")) return;

  await clearRestoDataOnly();
  location.reload();
}

async function backupAdminToJSON() {
  const payload = {
    resto: {
      namaRestoran: getVal("namaRestoran"),
      restoAddress: getVal("restoAddress"),
      restoPhone: getVal("restoPhone"),
      logo: window.__LOGO_BASE64__ || null
    },
    menus: window.menuList || [],
    promos: window.promoList || [],
    flipbooks: window.flipbookList || [],
    orders: window.ordersList || []
  };

  const backup = {
    app: "Orderine",
    type: "ADMIN_BACKUP",
    version: 1,
    exportedAt: Date.now(),
    payload
  };

  const blob = new Blob(
    [JSON.stringify(backup, null, 2)],
    { type: "application/json" }
  );

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `orderine-backup-${Date.now()}.json`;
  a.click();
}

  async function restoreDataFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  try {
    const json = JSON.parse(await file.text());

    if (
      json.app !== "Orderine" ||
      json.type !== "ADMIN_BACKUP"
    ) {
      alert("‚ùå File bukan backup Orderine");
      return;
    }

    const p = json.payload;

    /* =====================
       RESTORE FORM
    ===================== */
    setVal("namaRestoran", p.resto?.namaRestoran || "");
    setVal("restoAddress", p.resto?.restoAddress || "");
    setVal("restoPhone", p.resto?.restoPhone || "");

    if (p.resto?.logo) {
      window.__LOGO_BASE64__ = p.resto.logo;
      document.getElementById("previewLogo").src = p.resto.logo;
    }

    /* =====================
       RESTORE MEMORY STATE
    ===================== */
    window.menuList = p.menus || [];
    window.promoList = p.promos || [];
    window.flipbookList = p.flipbooks || [];
    window.ordersList = p.orders || [];

    /* =====================
       RENDER ULANG
    ===================== */
    renderMenuUI?.();
    renderPromoUI?.();
    renderFlipbookUI?.();
    renderOrdersUI?.();

    alert("‚úÖ Data berhasil direstore & ditampilkan");

  } catch (err) {
    console.error("Restore failed:", err);
    alert("‚ùå File backup rusak");
  }
}

// ====================== SHARE & QR ======================
function getCustomerLink() {
  const id = document.getElementById("restoId")?.value;
  if (!id) return null;
  const base = location.pathname.substring(0, location.pathname.lastIndexOf("/"));
  return `${location.origin}${base}/menu.html?resto=${encodeURIComponent(id)}`;
}

// ====================== LOADER HANDLER (Modern, Safe, Single Instance) ======================
let __loaderInitialized = false;

function showLoader(text = "Loading data...") {
  let loader = document.getElementById("loader");

  if (!loader) {
    loader = document.createElement("div");
    loader.id = "loader";
    loader.innerHTML = `
      <div class="loader-overlay">
        <div class="loader-content">
          <div class="spinner"></div>
          <p id="loaderText">${text}</p>
        </div>
      </div>
    `;
    document.body.appendChild(loader);
  }

  // inject style ONCE
  if (!__loaderInitialized) {
    __loaderInitialized = true;
    const style = document.createElement("style");
    style.id = "loader-style";
    style.textContent = `
      #loader {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.45);
        z-index: 9999;
        opacity: 0;
        pointer-events: none;
        transition: opacity .25s ease;
      }

      #loader.show {
        opacity: 1;
        pointer-events: auto;
      }

      .loader-content {
        text-align: center;
        color: #fff;
        font-family: system-ui, -apple-system, Segoe UI, sans-serif;
        font-size: 1rem;
        animation: fadeUp .4s ease;
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 6px solid rgba(255,255,255,.25);
        border-top-color: #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 14px;
      }

      @keyframes spin { to { transform: rotate(360deg); } }
      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(8px); }
        to   { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(style);
  }

  const txt = document.getElementById("loaderText");
  if (txt) txt.textContent = text;

  loader.style.display = "flex";
  requestAnimationFrame(() => loader.classList.add("show"));
}

function hideLoader() {
  const loader = document.getElementById("loader");
  if (!loader) return;
  loader.classList.remove("show");
  setTimeout(() => {
    loader.style.display = "none";
  }, 250);
}

async function clearRestoDataOnly() {
  try {
    if (!window.activeUser || !window.activeUser.restoID) {
      console.warn("‚ö†Ô∏è clearRestoDataOnly aborted: no activeUser");
      return;
    }

    const restoId = window.activeUser.restoID;

    // STORE YANG AMAN DIRESET
    const scopedStores = [
      "menuData",
      "flipbookData",
      "promoData",
      "ordersData"
    ];

    for (const store of scopedStores) {
      const rows = await MENUVA_DB.getAll(store);
      for (const item of rows) {
        // hanya hapus milik resto aktif
        if (item.restoId === restoId || item.id === restoId) {
          const key =
            item.id ??
            item.restoId ??
            item.orderId;

          if (key !== undefined) {
            await MENUVA_DB.delete(store, key);
          }
        }
      }
    }

    console.log("üßπ Resto data cleared (SAFE MODE):", restoId);

  } catch (err) {
    console.error("‚ùå clearRestoDataOnly fatal:", err);
  }
}

// ====================== GLOBAL SAFETY (OPTIONAL) ======================
window.addEventListener("unhandledrejection", e => {
  console.error("‚ùå Unhandled Promise Rejection:", e.reason);
  hideLoader();
});

window.addEventListener("error", e => {
  console.error("‚ùå Global JS Error:", e.message);
  hideLoader();
});

</script>
<script>
  
function startRealtimeOrderChecker() {
  setInterval(async () => {
    cekOrderBaru();
  }, 5000);
}

  // ================= OWNER UI SAFE PATCH =================
if (typeof initOwnerUI !== "function") {
  function initOwnerUI() {
    console.warn("‚ö†Ô∏è initOwnerUI skipped (legacy / removed)");
  }
}

/* ===================== ADMIN INIT (UI MODE) ===================== */
document.addEventListener("DOMContentLoaded", async () => {
  console.log("üöÄ Admin Init (UI MODE)");
  showLoader();

  try {
    // ================= 1. WAIT AUTH =================
    let wait = 0;
    while (!window.activeUser && wait < 20) {
      await new Promise(r => setTimeout(r, 100));
      wait++;
    }

    if (!window.activeUser) {
      throw new Error("activeUser not ready");
    }

    // ================= 2. SAFE GLOBAL STATE =================
    window.menuList = window.menuList || [];
    window.promoList = window.promoList || [];
    window.flipbookList = window.flipbookList || [];
    window.ordersList = window.ordersList || [];

    // ================= 3. RENDER EMPTY UI =================
    renderPromoUI?.();

    // ================= AUDIO SYSTEM =================
    if (!window.notifAudio) {
      window.notifAudio = new Audio("./beep.mp3");
      window.notifAudio.preload = "auto";
    }

    if (!window.clickAudio) {
      window.clickAudio = new Audio("./click.mp3");
      window.clickAudio.preload = "auto";
    }

    window.audioUnlocked = false;
    document.body.addEventListener(
      "click",
      () => {
        if (window.audioUnlocked) return;
        window.notifAudio.play().then(() => {
          window.notifAudio.pause();
          window.notifAudio.currentTime = 0;
          window.audioUnlocked = true;
          console.log("üîä Audio unlocked");
        }).catch(() => {});
      },
      { once: true }
    );

    window.playNotif = function () {
      if (!window.audioUnlocked) return;
      window.notifAudio.currentTime = 0;
      window.notifAudio.play().catch(() => {});
    };

    // ================= OWNER UI =================
    initOwnerUI?.();

    // ================= REALTIME =================
    startRealtimeOrderChecker?.();

    // ================= TOGGLES =================
    await initAllToggles?.();

    // ================= EVENTS =================
    const btnCustomer = document.getElementById("btnOpenCustomer");
    if (btnCustomer && !btnCustomer.dataset.bound) {
      btnCustomer.onclick = openCustomerPage;
      btnCustomer.dataset.bound = "1";
    }

    // ================= FIXED BAR =================
    const fixbar = document.querySelector(".fixed-bar");
    if (fixbar) {
      document.body.style.paddingBottom = fixbar.offsetHeight + "px";
    }

    console.log("‚úÖ Admin siap digunakan (UI MODE)");

  } catch (err) {
    console.error("‚ùå Admin Init fatal:", err);
    alert("‚ùå Failed loading admin panel.");
  } finally {
    hideLoader();
  }
});


  async function loadCoreAndRender() {
  console.log("‚ö†Ô∏è CORE LOAD DISABLED (UI MODE)");
}


/* ===================== TOGGLE MASTER ===================== */
async function initAllToggles() {
  await domReady();
  initOrderToggle();
  initRoomToggle();
  await initVoucherToggle();
}

function domReady() {
  return new Promise(resolve => {
    if (document.readyState === "complete") return resolve();
    document.addEventListener("readystatechange", () => {
      if (document.readyState === "complete") resolve();
    });
  });
}

/* ===================== ORDER TOGGLE (PATCHED) ===================== */
function initOrderToggle() {
  const toggle = document.getElementById("toggleOrderPage");
  const box = document.getElementById("orderToggleBox");

  if (!toggle || !box) return;

  // üî• ADMIN SETTING HARUS SELALU TAMPIL
  box.style.display = "block";

  const enabled = localStorage.getItem("page_order") === "true";
  toggle.checked = enabled;

  toggle.onchange = e => {
    localStorage.setItem("page_order", e.target.checked);
  };
}

/* ===================== ROOM TOGGLE ===================== */
function initRoomToggle() {
  const toggle = document.getElementById("toggleRoomPage");
  const box = document.getElementById("roomContainerBox");

  if (!toggle || !box) return;

  const saved = localStorage.getItem("page_room") === "true";
  toggle.checked = saved;
  box.style.display = saved ? "block" : "none";

  toggle.onchange = e => {
    localStorage.setItem("page_room", e.target.checked);
    box.style.display = e.target.checked ? "block" : "none";
  };
}

/* ===================== VOUCHER TOGGLE (PATCHED & SAFE) ===================== */
async function initVoucherToggle() {
  try {
    const toggle = document.getElementById("toggleVoucherPage");
    const form = document.getElementById("voucherForm");
    const box = document.getElementById("voucherContainerBox");

    if (!toggle || !form || !box) {
      console.warn("‚ö†Ô∏è Voucher toggle element tidak lengkap, skip");
      return;
    }

    const user = JSON.parse(localStorage.getItem("activeUser") || "null");
    const plan = user?.premiumPlan || localStorage.getItem("user_plan");

    // üö´ Monthly plan tidak boleh voucher
    if (plan === "monthly") {
      box.style.display = "none";
      toggle.checked = false;
      localStorage.setItem("page_voucher", "false");
      return;
    }

    const enabled = localStorage.getItem("page_voucher") === "true";
    toggle.checked = enabled;
    form.style.display = enabled ? "block" : "none";

    // ================= SAFE CHANGE HANDLER =================
    toggle.onchange = async e => {
      const isOn = !!e.target.checked;
      localStorage.setItem("page_voucher", String(isOn));
      form.style.display = isOn ? "block" : "none";

      if (isOn) {
        try {
          if (typeof loadVouchers === "function") {
            await loadVouchers();
          } else {
            console.warn("‚ö†Ô∏è loadVouchers tidak tersedia");
          }
        } catch (err) {
          console.warn("‚ö†Ô∏è loadVouchers error (toggle):", err);
        }
      }
    };

    // ================= SAFE INIT LOAD =================
    if (enabled) {
      try {
        if (typeof loadVouchers === "function") {
          await loadVouchers();
        } else {
          console.warn("‚ö†Ô∏è loadVouchers tidak tersedia");
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è loadVouchers error (init):", err);
      }
    }

  } catch (fatal) {
    // üî• ABSOLUTE FIREWALL
    console.error("‚ùå initVoucherToggle fatal error (DI-SHIELD):", fatal);
  }
}

/* ===================== VOUCHER CORE (FINAL & SYNC) ===================== */
function loadVouchers() {
  console.groupCollapsed("üì• Load Vouchers");

  // ================= SOURCE OF TRUTH =================
  let list = Array.isArray(window.menuVoucher)
    ? [...window.menuVoucher]
    : [];

  const today = new Date();

  // ================= FILTER EXPIRED =================
  const active = list.filter(v => {
    const exp = new Date(v.expiry);
    return isFinite(exp) && exp >= today;
  });

  // ================= AUTO CLEANUP (IN-MEMORY) =================
  if (active.length !== list.length) {
    console.log("üßπ Voucher expired dibersihkan:", list.length - active.length);
    window.menuVoucher = active;
  }

  // ================= RENDER =================
  if (typeof renderVoucher === "function") {
    renderVoucher(active);
  } else {
    console.warn("‚ö†Ô∏è renderVoucher tidak tersedia");
  }

  console.groupEnd();
  return active;
}


/* ===================== SAVE VOUCHER (FINAL - SYNC WITH simpanData) ===================== */
window.saveVoucher = function () {
  try {
    console.log("üíæ saveVoucher clicked");

    const codeEl = document.getElementById("voucherCode");
    const discEl = document.getElementById("voucherDiscount");
    const expEl  = document.getElementById("voucherExpiry");

    if (!codeEl || !discEl || !expEl) {
      alert("‚ùå Form voucher tidak lengkap");
      return;
    }

    const code     = codeEl.value.trim().toUpperCase();
    const discount = parseFloat(discEl.value);
    const expiry   = expEl.value;

    if (!code || isNaN(discount) || !expiry) {
      alert("‚ö†Ô∏è Lengkapi data voucher");
      return;
    }

    const expiryDate = new Date(expiry);
    if (!isFinite(expiryDate) || expiryDate < new Date()) {
      alert("‚ö†Ô∏è Tanggal kadaluarsa tidak valid");
      return;
    }

    // ==================== SOURCE OF TRUTH ====================
    window.menuVoucher = Array.isArray(window.menuVoucher)
      ? window.menuVoucher
      : [];

    const now = new Date().toISOString();
    const existing = window.menuVoucher.find(v => v.code === code);

    if (existing) {
      existing.discount  = discount;
      existing.expiry    = expiry;
      existing.updatedAt = now;
    } else {
      window.menuVoucher.push({
        id: crypto.randomUUID(),
        code,
        discount,
        expiry,
        createdAt: now
      });
    }

    // ==================== RENDER ONLY ====================
    if (typeof renderVoucher === "function") {
      renderVoucher(window.menuVoucher);
    }

    // ==================== RESET FORM ====================
    codeEl.value = "";
    discEl.value = "";
    expEl.value  = "";

    alert("‚úÖ Voucher disimpan (klik SAVE ALL untuk permanen)");

  } catch (err) {
    console.error("‚ùå saveVoucher fatal:", err);
    alert("‚ùå Gagal menyimpan voucher");
  }
};

  /* ===================== VOUCHER UI ===================== */
function renderVoucher(vouchers = []) {
  const box = document.getElementById("voucherPreview");
  if (!box) return;

  if (!Array.isArray(vouchers) || vouchers.length === 0) {
    box.innerHTML = "<em>Belum ada voucher aktif</em>";
    return;
  }

  box.innerHTML = `
    <h3>Voucher Aktif</h3>
    ${vouchers.map(v => `
      <div class="voucher-item">
        <p>
          <strong>Kode:</strong> ${v.code}
          <button type="button" onclick="copyVoucherCode('${v.code}')">üìã</button>
        </p>
        <p>Diskon: ${v.discount}%</p>
        <p>Berlaku sampai: ${v.expiry}</p>
      </div>
    `).join("")}
  `;
}

/* ===================== COPY HELPER ===================== */
function copyVoucherCode(code) {
  if (!code) return;
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code)
      .then(() => alert(`‚úÖ Kode "${code}" disalin`))
      .catch(() => fallbackCopy(code));
  } else {
    fallbackCopy(code);
  }
}

function fallbackCopy(text) {
  const i = document.createElement("input");
  i.value = text;
  document.body.appendChild(i);
  i.select();
  document.execCommand("copy");
  i.remove();
  alert(`‚úÖ Kode "${text}" disalin`);
}

  function getCustomerUrl() {
  const restoId =
    document.getElementById("restoId")?.value ||
    localStorage.getItem("restoId");

  if (!restoId) return null;

  const base = location.pathname.substring(
    0,
    location.pathname.lastIndexOf("/")
  );

  return `${location.origin}${base}/menu.html?resto=${encodeURIComponent(restoId)}`;
}

function prepareCustomerShare() {
  const url = getCustomerUrl();
  if (!url) return;

  // ===== COPY LINK =====
  const btnCopy = document.getElementById("btnSalinLink");
  if (btnCopy) {
    btnCopy.style.display = "inline-block";
    btnCopy.onclick = () => {
      navigator.clipboard.writeText(url);
      alert("‚úÖ Link customer berhasil disalin");
    };
  }

  // ===== QR CODE (ONE LIB ONLY) =====
  const qrBox = document.getElementById("qrcodePreview");
  if (!qrBox) return;

  qrBox.innerHTML = "";

  if (typeof QRCode !== "function") {
    console.error("‚ùå QRCode constructor not ready:", QRCode);
    alert("QR Code library belum siap.");
    return;
  }

  new QRCode(qrBox, {
    text: url,
    width: 200,
    height: 200
  });

  // ===== DOWNLOAD =====
  const btnDownload = document.getElementById("btnDownloadQR");
  if (btnDownload) {
    btnDownload.style.display = "inline-block";
    btnDownload.onclick = () => {
      const img = qrBox.querySelector("img");
      if (!img) return alert("QR belum siap");
      const a = document.createElement("a");
      a.href = img.src;
      a.download = "menuva-qr.png";
      a.click();
    };
  }

  // ===== PRINT =====
  const btnPrint = document.getElementById("btnPrintQR");
  if (btnPrint) {
    btnPrint.style.display = "inline-block";
    btnPrint.onclick = () => {
      const img = qrBox.querySelector("img");
      if (!img) return;
      const w = window.open("");
      w.document.write(`<img src="${img.src}" style="width:300px"/>`);
      w.print();
      w.close();
    };
  }
}

 function openCustomerPage() {
  try {
    prepareCustomerShare();
    window.open(getCustomerUrl(), "_blank");
  } catch (e) {
    console.error("‚ùå openCustomerPage error:", e);
    alert("Gagal membuka customer page.");
  }
}

  function showCustomerShareUI() {
  document.getElementById("btnOpenCustomer")?.style.setProperty("display", "inline-block");
  document.getElementById("btnSalinLink")?.style.setProperty("display", "inline-block");
  document.getElementById("qrcodePreview")?.style.setProperty("display", "block");
  document.getElementById("btnDownloadQR")?.style.setProperty("display", "inline-block");
  document.getElementById("btnPrintQR")?.style.setProperty("display", "inline-block");
}

  function markDirty() {
  localStorage.removeItem("customerShareReady");
}

function playNotifSound() {
  if (!notifAudio || !audioUnlocked) return;
  notifAudio.currentTime = 0;
  notifAudio.play().catch(() => {});
}

/* ============================================================
   3. INDEXEDDB HELPERS (SAFE)
============================================================ */
function idbGetAll(store) {
  return new Promise((resolve, reject) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

function updateReceiveBadge(count) {
  const badge = document.getElementById("receiveBadge");
  if (!badge) return;

  if (count > 0) {
    badge.style.display = "inline-block";
    badge.textContent = count;
  } else {
    badge.style.display = "none";
  }
}

/* ============================================================
   4. REALTIME ORDER CHECKER (ANTI RACE)
============================================================ */
let lastOrderCount = 0;
let checkingOrder = false;

async function cekOrderBaru() {
  if (checkingOrder) return;
  checkingOrder = true;

  try {
    const orders = await MENUVA_DB.getAll("ordersData");
    const newCount = orders.filter(o => o.status === "new").length;

    updateReceiveBadge(newCount);

    if (newCount > lastOrderCount) {
      playNotifSound();
    }

    lastOrderCount = newCount;

  } catch (err) {
    console.error("‚ùå cekOrderBaru error:", err);
  } finally {
    checkingOrder = false;
  }
}


/* ============================================================
   5. REALTIME LOOP (SINGLE INSTANCE)
============================================================ */
let realtimeInterval = null;

function startRealtimeOrderChecker() {
  if (realtimeInterval) return;

  cekOrderBaru();
  realtimeInterval = setInterval(cekOrderBaru, 1000);
}

/* ============================================================
   6. MARK AS READ + NAVIGATION
============================================================ */
async function markOrdersAsRead() {
  try {
    const orders = await MENUVA_DB.getAll("ordersData");

    for (const order of orders) {
      if (order.status === "new") {
        order.status = "read";
        await MENUVA_DB.add("ordersData", order);
      }
    }

    updateReceiveBadge(0);
    lastOrderCount = 0;

  } catch (err) {
    console.error("‚ùå markOrdersAsRead error:", err);
  }
}


function markViewedAndGo() {
  markOrdersAsRead();
  window.location.href = "recieves.html";
}

/* ============================================================
   7. OWNER UI (INVITE ADMIN)
============================================================ */
function initOwnerUI() {
  const user = JSON.parse(localStorage.getItem("activeUser") || "null");
  if (!user || user.role !== "owner") return;

  const btn = document.getElementById("inviteAdminBtn");
  if (btn) btn.style.display = "flex";
}

function openInviteAdmin() {
  window.location.href = "invite-admin.html";
}
</script>

</body>
</html>





































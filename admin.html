<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
  const SUPABASE_URL = "https://yscjjisqvlbedtuomrmf.supabase.co";
  const SUPABASE_KEY = "sb_publishable_L69H0-PapAm3jMWrTyYayQ_4kOd2MMD";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
</script>

  <title>Admin Orderine</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      padding-bottom: 80px;
      background: linear-gradient(135deg, #003366, #003366);
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
   /* =====================
   MOBILE-FIRST LOGO & HEADER
   ===================== */
.menuva-logo {
  text-align: center;
  margin-bottom: 10px;
  padding: 0 10px; /* beri sedikit jarak kiri-kanan di HP */
}

.menuva-logo img {
  max-width: 70%;   /* logo menyesuaikan lebar layar HP */
  height: auto;     /* menjaga proporsi asli */
  max-height: 80px; /* batasi tinggi supaya tidak terlalu besar */
  display: block;
  margin: 0 auto;   /* center logo */
}

.menuva-logo p {
  color: white;
  font-size: 13px;  /* ukuran font nyaman di HP */
  margin: 4px 0 0 0;
  line-height: 1.3;
}

/* =====================
   TABLET (min-width: 481px)
   ===================== */
@media (min-width: 481px) {
  .menuva-logo img {
    max-width: 50%;
    max-height: 90px;
  }
  .menuva-logo p {
    font-size: 14px;
  }
}

/* =====================
   DESKTOP (min-width: 769px)
   ===================== */
@media (min-width: 769px) {
  .menuva-logo img {
    max-width: 35%;
    max-height: 100px;
  }
  .menuva-logo p {
    font-size: 16px;
  }
}
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .menu-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .menu-item input {
      flex: 1 1 40%;
    }
    .menu-item button {
      flex: 1 1 auto;
      white-space: nowrap;
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-secondary {
      background-color: #3498db;
      color: white;
    }
    .btn-orange {
      background-color: orange;
      color: white;
      border: none;
    }
    .preview img {
      max-width: 100px;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .menu-item input, .menu-item button {
        width: 100%;
      }
    }
    .room-section > div:nth-child(2) button {
      padding: 6px 14px;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .room-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .room-form {
      padding: 10px;
      border: 1px dashed #ccc;
      margin-bottom: 12px;
      border-radius: 6px;
      background-color: #fff;
    }
    .room-form input[type="text"],
    .room-form input[type="number"],
    .room-form input[type="file"] {
      display: block;
      margin-bottom: 8px;
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    .room-form .room-preview img {
      max-height: 80px;
      margin-top: 4px;
    }
    .gambar-preview-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .gambar-preview {
      height: auto !important;
      width: auto !important;
      max-height: 200px !important;
      max-width: 100% !important;
      display: block;
    }
    .hapus-gambar {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .hapus-gambar:hover { background: #cc0000; }
    .btn-hapus-gambar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: red;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s, transform 0.1s ease;
    }
    .btn-hapus-gambar:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .section-box {
      border: none;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
      background: #fff;
    }
    .section-box h2,
    .section-box h3 { margin-top: 0; }
    .room-section { margin-bottom: 20px; }
    .room-section button {
      margin-bottom: 10px;
      background-color: #17a2b8;
    }
    .btn-simpan {
      background-color: #17a2b8;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-tambah-room {
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(127, 90, 240, 0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-tambah-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(44, 181, 232, 0.5);
    }
    .btn-hapus-room {
      background: linear-gradient(135deg, #ff6b6b, #fbc687);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-hapus-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(251, 198, 135, 0.5);
    }
    .btn-upload-gambar {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    .btn-upload-gambar:hover { opacity: 0.85; }
  
    /* Style umum untuk tombol aksi penting */
.btn-action {
  display: inline-block;
  padding: 10px 16px;
  margin: 6px 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Copy Link â†’ biru elegan */
#btnSalinLink.btn-action {
  background: #007BFF;
}
#btnSalinLink.btn-action:hover {
  background: #0056b3;
}

/* Download QR â†’ hijau segar */
#btnDownloadQR.btn-action {
  background: #28a745;
}
#btnDownloadQR.btn-action:hover {
  background: #1e7e34;
}

/* Print QR â†’ oranye elegan */
#btnPrintQR.btn-action {
  background: #fd7e14;
}
#btnPrintQR.btn-action:hover {
  background: #e8590c;
}

/* Backup Data â†’ ungu premium */
#btnBackup.btn-action {
  background: #6f42c1;
}
#btnBackup.btn-action:hover {
  background: #5936a2;
}
/* Blue â€“ untuk backup */
.btn-blue {
  background: linear-gradient(135deg, #3b82f6, #1e3a8a);
  color: white;
}
.btn-blue:hover {
  background: linear-gradient(135deg, #1e3a8a, #172554);
  transform: scale(1.05);
}
/* Base style tombol */
button {
  padding: 10px 16px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
}

/* Orange â€“ utama */
.btn-orange {
  background: linear-gradient(135deg, #ff914d, #ff6a00);
  color: white;
}
.btn-orange:hover {
  background: linear-gradient(135deg, #ff6a00, #cc5500);
  transform: scale(1.05);
}

/* Teal â€“ untuk salin link */
.btn-teal {
  background: linear-gradient(135deg, #20c997, #0f766e);
  color: white;
}
.btn-teal:hover {
  background: linear-gradient(135deg, #0f766e, #0c5f56);
  transform: scale(1.05);
}

/* Purple â€“ untuk download */
.btn-purple {
  background: linear-gradient(135deg, #a855f7, #6b21a8);
  color: white;
}
.btn-purple:hover {
  background: linear-gradient(135deg, #6b21a8, #4c1d95);
  transform: scale(1.05);
}

/* Red â€“ untuk print */
.btn-red {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  color: white;
}
.btn-red:hover {
  background: linear-gradient(135deg, #b91c1c, #7f1d1d);
  transform: scale(1.05);
}
 .setting-card {
    background: linear-gradient(135deg, #ffffff, #f9fafb);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .setting-card h2 {
    font-size: 18px;
    margin: 0 0 12px;
    color: #1e293b;
  }

  /* Switch toggle elegan */
  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 32px;
    margin-right: 10px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: #cbd5e1;
    transition: .4s;
    border-radius: 32px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background: linear-gradient(135deg, #2563eb, #1e40af);
  }
  input:checked + .slider:before {
    transform: translateX(28px);
  }

  .setting-label {
    font-size: 12px;
    font-weight: 600;
    color: #334155;
    vertical-align: middle;
  }

    /* Tombol simpan voucher */
  #saveVoucherBtn {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  #saveVoucherBtn:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }

  /* Tombol copy voucher */
  #voucherPreview button {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  #voucherPreview button:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }
  .fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: linear-gradient(135deg, #003366, #003366);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 999;
}

  .nav-item {
  flex: 1;
  text-align: center;
  padding: 6px 0;
  cursor: pointer;
  user-select: none;
  transition: 0.2s ease;
}

.nav-item .icon {
  font-size: 24px;
  color: #fff;
  transition: color 0.2s ease;
}

.nav-item .label {
  margin-top: 4px;
  font-size: 12px;
  color: #fff;
  transition: color 0.2s ease;
}

/* ğŸ”¥ Hover / sentuh â†’ jadi emas */
.nav-item:hover .icon,
.nav-item:active .icon,
.nav-item:hover .label,
.nav-item:active .label {
  color: #d4af37; /* warna emas */
}
.icon-wrapper {
  position: relative;
  display: inline-block;
}

.badge {
  position: absolute;
  top: -6px;
  right: -10px;
  background: red;
  color: white;
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 12px;
  font-weight: bold;
  display: none; /* awalnya disembunyikan */
}

  </style>
</head>
<body>
<div class="menuva-logo">
  <img src="menuva-logo.png" alt="Logo Menuva">
  <br>
  <p style="color: white;">Digital Solution For Restaurant, Hotel, & Cafe's</p>
</div>

<div class="section">
  <h2>ğŸ“‡ Business Identity</h2>
  
  <label for="logoInput">Your Business Logo</label>
  <input type="file" id="logoInput" name="logoInput" accept="image/*" />

  <img id="previewLogo" src="" alt="Logo Restoran" style="max-height: 80px; margin-top: 10px;" />

  <label for="namaRestoran">Your Business Name</label>
  <input type="text" id="namaRestoran" name="namaRestoran" placeholder="Your Business Name" />

  <label for="restoAddress">Your Business Address</label>
  <input id="restoAddress" name="restoAddress" type="text" placeholder="Jl. Sudirman No. 10, Jakarta" />

  <label for="restoPhone">Phone Number</label>
  <input id="restoPhone" name="restoPhone" type="text" placeholder="08xx-xxxx-xxxx" />
</div>

<div class="section">
  <h2>ğŸ”¥ Menu Promo</h2>
  <div id="promoContainer"></div>
  <button class="btn-orange" onclick="tambahPromo()">+ Add Promo Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ SPECIAL MENU</h2>
  <div id="menuSpecialContainer"></div>
  <button class="btn-success" onclick="tambahMenu('special')">+ Add Special Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ FOOD MENU</h2>
  <div id="menuFoodContainer"></div>
  <button class="btn-success" onclick="tambahMenu('food')">+ Add Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ SNACK & DESSERT</h2>
  <div id="menuSnackContainer"></div>
  <button class="btn-success" onclick="tambahMenu('snack')">+ Add Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ DRINK</h2>
  <div id="menuDrinkContainer"></div>
  <button class="btn-success" onclick="tambahMenu('drink')">+ Add Menu</button>
</div>

<div class="section-box" id="waContainerBox">
  <h3>ğŸ“± Admin WhatsApp Number (Order/Reservation Recipient)</h3>
  <div id="nomorWaContainer">
    <label for="waNumber1" class="sr-only">WhatsApp Number</label>
    <input type="text" id="waNumber1" name="waNumber[]" class="nomor-wa" placeholder="Example: 6281234567890">
  </div>
  <button onclick="tambahNomorWa()">+ Add WA Number</button>
</div>

<div class="section">
  <h2>ğŸ“¸ Room Gallery</h2>
  <button onclick="tambahGambar('ruangan')">+ Add Room Image</button>
  <input type="file" id="flipbookRuanganUpload" name="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookRuanganPreview"></div>
</div>

<div class="section">
  <h2>ğŸ“– Restaurant Menu</h2>
  <button onclick="tambahGambar('menu')">+ Add Menu Image</button>
  <input type="file" id="flipbookMenuUpload" name="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookMenuPreview"></div>
</div>

<div class="setting-card" id="orderToggleBox">
  <h2>âš™ï¸ Reservation & Delivery Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleOrderPage" name="toggleOrderPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Reservation & Delivery Page</span>
</div>

<div class="setting-card" id="roomToggleBox">
  <h2>âš™ï¸ Room Page Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleRoomPage" name="toggleRoomPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Room Page.</span>
</div>

<div class="section-box" id="roomContainerBox">
  <h2>ğŸ¨ Room / Packages</h2>
  <div class="room-section">
    <h3>ğŸ›ï¸ Room Hotel</h3>
    <button onclick="tambahRoom('hotel')" class="btn-tambah-room">+ Add Hotel Room</button>
    <div id="roomHotelContainer"></div>
  </div>
  <div class="room-section">
    <h3>ğŸ’¼ Meeting Room</h3>
    <button onclick="tambahRoom('meeting')" class="btn-tambah-room">+ Add Meeting Room</button>
    <div id="meetingRoomContainer"></div>
  </div>
  <div class="room-section">
    <h3>ğŸ Packages</h3>
    <button onclick="tambahRoom('package')" class="btn-tambah-room">+ Add Packages</button>
    <div id="packageContainer"></div>
  </div>
</div>

<div class="section-box" id="voucherContainerBox">
  <h2>ğŸŸï¸ Voucher Diskon</h2>
  <label class="switch">
    <input type="checkbox" id="toggleVoucherPage" name="toggleVoucherPage">
    <span class="slider round"></span>
  </label>

  <div id="voucherForm" style="margin-top:15px; display:none;">
    <label for="voucherCode">Voucher Code</label>
    <input type="text" id="voucherCode" name="voucherCode" placeholder="Kode Voucher">

    <label for="voucherDiscount">Discount (%)</label>
    <input type="number" id="voucherDiscount" name="voucherDiscount" placeholder="Diskon (%)">

    <label for="voucherExpiry">Expiry Date</label>
    <input type="date" id="voucherExpiry" name="voucherExpiry">

    <button id="saveVoucherBtn" onclick="saveVoucher()">ğŸ’¾ Save Voucher Code</button>
  </div>

  <div id="voucherPreview"></div>
</div>

<hr>

<div class="section">
  <button class="btn-simpan" onclick="simpanData()">ğŸ’¾ Save All</button>
  <input type="hidden" id="restoId" name="restoId" />

  <button id="btnOpenCustomer" class="btn-orange" onclick="openCustomerPage()">ğŸ‘ï¸ See Customer Page</button>
  <button id="btnSalinLink" class="btn-teal" style="display:none;">ğŸ“‹ Copy Link to Share with Customers</button>

  <div id="qrcodePreview" style="margin-top:10px;"></div>

  <button id="btnDownloadQR" class="btn-purple" style="margin-top:10px; display:none;">â¬‡ï¸ Download QR Code</button>
  <button id="btnPrintQR" class="btn-red" style="margin-top:5px; display:none;">ğŸ–¨ï¸ Print QR Code</button>

  <div class="section">
    <h2>ğŸ” Backup & Restore Data</h2>
    <button id="btnBackup" class="btn-blue" onclick="backupData()">ğŸ“¦ Backup Data</button>
    <div id="backupDownloadLink" style="margin-top:10px;"></div>

    <label for="restoreInput" style="margin-top: 20px; display: block;">ğŸ“‚ Select JSON File to Restore:</label>
    <input type="file" id="restoreInput" name="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
  </div>
  
  <!-- Panduan -->
  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>Panduan Penggunaan:</strong><br>
    PENTING!!<br>
    ğŸ”¹ Klik <strong>â¬‡ï¸ Backup Data</strong> untuk menyimpan semua data restoran ke file <strong>.json</strong>.<br>
    ğŸ”¹ Simpan file tersebut dengan baik.<br>
    ğŸ”¹ Klik <strong>ğŸ“‚ Pilih File</strong> untuk me-restore data.<br>
    âš ï¸ Proses restore menggantikan seluruh data saat ini.<br>
  </div>

  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>User Guide:</strong><br>
    IMPORTANT!!<br>
    ğŸ”¹ Click <strong>â¬‡ï¸ Backup Data</strong> to save all data.<br>
    ğŸ”¹ Keep the file safe.<br>
    ğŸ”¹ Click <strong>ğŸ“‚ Choose File</strong> to restore data.<br>
    âš ï¸ The restore process replaces all existing data.<br>
  </div>

  <button onclick="resetData()" class="btn-danger">ğŸ—‘ï¸ Reset Data</button>
</div>

<div class="fixed-bar">
<div class="nav-item" onclick="markViewedAndGo()">
    <div class="icon-wrapper">
        <ion-icon name="cube-outline" class="icon"></ion-icon>
        <span id="receiveBadge" class="badge">0</span>
    </div>
    <div class="label">Receives</div>
</div>

   <div class="nav-item" onclick="window.location.href='index.html'">
    <ion-icon name="log-out-outline" class="icon"></ion-icon>
    <div class="label">Logout</div>
  </div>
</div>
  
 <script>
console.log("Admin Script Version: 2025-11-07-STABLE");

// ====================== GLOBAL DB HANDLER ======================
let dbReady = null;
const DB_NAME = "MenuvaDB";
const STORE_NAME = "menuvaData";
const DB_VERSION = 10;

let dbInstance = null;

  // Tes sederhana: apakah IndexedDB berfungsi di HP?
if (!window.indexedDB) {
  alert("âš ï¸ Browser ini tidak mendukung IndexedDB!");
} else {
  const test = indexedDB.open("TestDB_Check");
  test.onerror = (e) => {
    console.error("âŒ IndexedDB gagal dibuka:", e.target.error);
    alert("IndexedDB gagal dibuka di HP! Kemungkinan masalah izin browser.");
  };
  test.onsuccess = () => {
    console.log("âœ… IndexedDB bisa dibuka di perangkat ini");
    test.result.close();
    indexedDB.deleteDatabase("TestDB_Check");
  };
}

let dbPromise = null;

async function initDB() {
  if (dbInstance) return dbInstance;
  if (dbPromise) return dbPromise;

  dbPromise = new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onupgradeneeded = (e) => {
      const db = e.target.result;

      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "id" });
      }

      if (!db.objectStoreNames.contains("ordersData")) {
        db.createObjectStore("ordersData", {
          keyPath: "id",
          autoIncrement: true
        });
      }
    };

    request.onsuccess = (e) => {
      dbInstance = e.target.result;
      dbPromise = null;
      resolve(dbInstance);
    };

    request.onerror = (e) => {
      dbPromise = null;
      reject(e.target.error);
    };
  });

  return dbPromise;
}

async function getDB() {
  if (dbInstance) return dbInstance;
  return await initDB();
}

   async function saveDataToDB(id, newData) {
  console.groupCollapsed("ğŸ’¾ [TRACE] saveDataToDB()");

  id = Number(id) || 1;

  const db = await getDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  const store = tx.objectStore(STORE_NAME);

  return new Promise((resolve, reject) => {
    const req = store.get(id);

    req.onsuccess = () => {
      let oldData = req.result || buatDataDefault(id);

    
     // MERGE TANPA HILANG FIELD (VERSI FIX)
const finalData = {
  ...oldData,
  ...newData,
};

// Pastikan menuVoucher tidak corrupt
if (!Array.isArray(finalData.menuVoucher)) {
  finalData.menuVoucher = Array.isArray(oldData.menuVoucher)
    ? oldData.menuVoucher
    : [];
}

      const saveReq = store.put(finalData);

      saveReq.onsuccess = () => {
        console.log("âœ… Data tersimpan:", finalData);
        console.groupEnd();
        resolve(finalData);
      };

      saveReq.onerror = (e) => {
        console.error("âŒ Gagal simpan DB:", e.target.error);
        console.groupEnd();
        reject(e.target.error);
      };
    };

    req.onerror = (e) => {
      console.error("âŒ Gagal membaca DB:", e.target.error);
      console.groupEnd();
      reject(e.target.error);
    };
  });
}

 async function loadDataFromDB(id = 1) {
  console.groupCollapsed("ğŸ“¥ [TRACE] loadDataFromDB()");
  const db = await getDB();
  const tx = db.transaction(STORE_NAME, "readonly");
  const store = tx.objectStore(STORE_NAME);

  return new Promise((resolve, reject) => {
    const req = store.get(id);

    req.onsuccess = () => {
      let r = req.result;

      console.log("ğŸ“¦ Data dari DB (raw):", r);

      // ======== DATA DEFAULT JIKA KOSONG ========
      // Jika data ada tapi field rooms hilang â†’ tambahkan
if (r && !Array.isArray(r.rooms)) {
  console.warn("âš ï¸ Field ROOMS hilang â†’ tambahkan default");
  r.rooms = [];
}

// Jika data sama sekali tidak ada â†’ buat default penuh
if (!r) {
  console.warn("âš ï¸ DB kosong â†’ create default");
  r = buatDataDefault(id);
}

      // ======== FORCE STRUCTURE (ANTI HILANG) ========
      const safe = {
        id,
        restoId: r.restoId || "",
        namaRestoran: r.namaRestoran || "",
        restoAddress: r.restoAddress || "",
        restoPhone: r.restoPhone || "",
        logo: r.logo || "",
        menu: Array.isArray(r.menu) ? r.menu : [],
        menuPromo: Array.isArray(r.menuPromo) ? r.menuPromo : [],
        menuVoucher: Array.isArray(r.menuVoucher) ? r.menuVoucher : [],
        rooms: Array.isArray(r.rooms) ? r.rooms : [],
        nomorWaAdmin: Array.isArray(r.nomorWaAdmin) ? r.nomorWaAdmin : [],
        flipbookRuanganImages: Array.isArray(r.flipbookRuanganImages) ? r.flipbookRuanganImages : [],
        flipbookMenuImages: Array.isArray(r.flipbookMenuImages) ? r.flipbookMenuImages : []
      };

      console.log("ğŸ“¦ Data setelah SAFE-FIX:", safe);
      console.groupEnd();
      resolve(safe);
    };

    req.onerror = (e) => {
      console.error("âŒ Gagal load DB:", e.target.error);
      console.groupEnd();
      reject(e.target.error);
    };
  });
}

// ===== Helper internal: bikin struktur default =====
function buatDataDefault(id = 1) {
  return {
    id,
    restoId: "",
    namaRestoran: "",
    restoAddress: "",
    restoPhone: "",
    menuData: [],
    menuVoucher: [],   // ğŸ”¥ WAJIB ADA
    menuPromo: [],
    menu: [],
    rooms: [],
    nomorWaAdmin: [],
    flipbookRuanganImages: [],
    flipbookMenuImages: [],
  };
}

// ====================== Variabel Global ======================
let menuPromo = [];
let flipbookRuanganImages = [];
let flipbookMenuImages = [];

// ====================== PROMO ======================
function renderPromoUI() {
  const container = document.getElementById("promoContainer");
  if (!container) return;
  container.innerHTML = "";

  // daftar kategori promo (bisa disesuaikan)
  const promoCategories = ["PROMO", "DISKON", "SPECIAL", "EVENT"];

  menuPromo.forEach((promo, index) => {
    const div = document.createElement("div");
    div.className = "menu-item";

    const optionsHTML = promoCategories
      .map(cat => `<option value="${cat}" ${promo.kategori === cat ? "selected" : ""}>${cat}</option>`)
      .join("");

    div.innerHTML = `
      <input type="text" id="promoName_${index}" name="promoName[]" placeholder="Promo Name"
        value="${promo.namaPromo || ""}" onchange="updatePromo(${index}, 'namaPromo', this.value)">
      
      <input type="file" id="promoImage_${index}" name="promoImage[]" accept="image/*"
        onchange="uploadPromoImage(event, ${index})">
      <img id="promoImgPreview${index}" src="${promo.image || ""}" style="max-height:80px; margin:5px 0">
      
      <input type="text" id="promoDesc_${index}" name="promoDesc[]" placeholder="Description Promo"
        value="${promo.deskripsi || ""}" onchange="updatePromo(${index}, 'deskripsi', this.value)">
      
      <input type="number" id="promoPrice_${index}" name="promoPrice[]" placeholder="Promo Price"
        value="${promo.harga || ""}" onchange="updatePromo(${index}, 'harga', this.value)">
      
      <select id="promoCat_${index}" name="promoCat[]" onchange="updatePromo(${index}, 'kategori', this.value)">
        ${optionsHTML}
      </select>
      
      <input type="date" id="promoDate_${index}" name="promoDate[]"
        value="${promo.tanggalAkhir || ""}" onchange="updatePromo(${index}, 'tanggalAkhir', this.value)">
      
      <button class="btn-danger" onclick="hapusPromo(${index})">Delete Promo List</button>
    `;

    container.appendChild(div);
  });
}

  function tambahPromo(promo = {}) {
  menuPromo.push({
    namaPromo: promo.namaPromo || "",
    image: promo.image || "",
    deskripsi: promo.deskripsi || "",
    harga: promo.harga || "",
    kategori: promo.kategori || "PROMO", // default category
    tanggalAkhir: promo.tanggalAkhir || ""
  });
  renderPromoUI();
}

function updatePromo(index, key, value) {
  if (!menuPromo[index]) return;
  menuPromo[index][key] = value;
}

function hapusPromo(index) {
  menuPromo.splice(index, 1);
  renderPromoUI();
  if (window._saveTimeout) clearTimeout(window._saveTimeout);
  window._saveTimeout = setTimeout(() => { simpanData().catch(e=>console.error(e)); }, 300);
}

function uploadPromoImage(event, index) {
  const file = event.target.files[0];
  if (!file) return;
  resizeIfNeeded(file)
    .then((resized) => {
      const el = document.getElementById(`promoImgPreview${index}`);
      if (el) el.src = resized;
      updatePromo(index, "image", resized);
    })
    .catch(err => console.error("Failed upload promo:", err));
}

// ====================== MENU ======================
function tambahMenu(kategori = "food", nama = "", harga = "", image = "") {
  const containerId = {
    food: "menuFoodContainer",
    snack: "menuSnackContainer",
    drink: "menuDrinkContainer",
    special: "menuSpecialContainer"
  }[kategori] || "menuFoodContainer";

  const container = document.getElementById(containerId);
  if (!container) return;

  const div = document.createElement("div");
  div.className = "menu-item";
  div.innerHTML = `
  <input type="text" id="menuName_${Date.now()}" name="menuName[]" placeholder="Menu Name" value="${nama}" />
  <input type="number" id="menuPrice_${Date.now()}" name="menuPrice[]" placeholder="Price" value="${harga}" />
  <select id="menuCat_${Date.now()}" name="menuCat[]">
    <option value="food" ${kategori === "food" ? "selected" : ""}>Food</option>
    <option value="snack" ${kategori === "snack" ? "selected" : ""}>Snack</option>
    <option value="drink" ${kategori === "drink" ? "selected" : ""}>Drink</option>
    <option value="special" ${kategori === "special" ? "selected" : ""}>Special</option>
  </select>
  <input type="file" id="menuImage_${Date.now()}" name="menuImage[]" accept="image/*" onchange="uploadMenuImage(event, this)" data-image="${image}">
  <img class="menuPreview" src="${image}" style="max-height:80px; margin:5px 0; ${image ? "" : "display:none"}">
  <button class="btn-danger" onclick="this.parentElement.remove()">Delete</button>
`;
  container.appendChild(div);
}

function uploadMenuImage(event, inputEl) {
  const file = event.target.files[0];
  if (!file) return;
  resizeIfNeeded(file)
    .then((resized) => {
      const preview = inputEl.parentElement.querySelector(".menuPreview");
      preview.src = resized;
      preview.style.display = "block";
      inputEl.setAttribute("data-image", resized);
    })
    .catch(err => console.error("Upload menu image failed:", err));
}

function ambilMenu(containerId) {
  const container = document.getElementById(containerId);
  const items = container ? container.querySelectorAll(".menu-item") : [];
  const result = [];

  items.forEach(item => {
    const inputs = item.querySelectorAll("input, select");
    const nama = inputs[0]?.value || "";
    const harga = parseInt(inputs[1]?.value || "0");
    const kategori = inputs[2]?.value || "food";
    const image = inputs[3]?.getAttribute("data-image") || "";

    if (nama && harga) {
      result.push({ nama, harga, kategori, image });
    }
  });

  return result;
}

// ====================== ROOM ======================
function tambahRoom(kategori) {
  const containerId = {
    hotel: "roomHotelContainer",
    meeting: "meetingRoomContainer",
    package: "packageContainer"
  }[kategori];

  if (!containerId) return;

  const container = document.getElementById(containerId);
  const wrapper = document.createElement("div");
  wrapper.className = "room-form";

  // Buat ID unik supaya tidak bentrok antar form
  const uid = `${kategori}_${Date.now()}`;

  wrapper.innerHTML = `
    <input 
      type="text" 
      id="${uid}_nama" 
      name="roomName[]" 
      class="room-nama" 
      placeholder="Name" 
      autocomplete="off"
    />

    <input 
      type="number" 
      id="${uid}_harga" 
      name="roomPrice[]" 
      class="room-harga" 
      placeholder="Price" 
      min="0"
      step="1000"
      autocomplete="off"
    />

    <input 
      type="number" 
      id="${uid}_kapasitas" 
      name="roomCapacity[]" 
      class="room-kapasitas" 
      placeholder="Capacity (Person)" 
      min="1"
      autocomplete="off"
    />

    <input 
      type="number" 
      id="${uid}_luas" 
      name="roomSize[]" 
      class="room-luas" 
      placeholder="Room size (mÂ²)" 
      min="1"
      autocomplete="off"
    />

    <textarea 
      id="${uid}_deskripsi" 
      name="roomDesc[]" 
      class="room-deskripsi" 
      placeholder="Notes"
      rows="2"
      autocomplete="off"
    ></textarea>

    <div class="gambar-preview-wrapper">
      <img 
        id="${uid}_preview" 
        class="gambar-preview" 
        alt="Room Preview"
        style="display:none; max-width:120px; margin-top:6px; border-radius:6px;"
      />
      <button 
        type="button"
        class="hapus-gambar" 
        onclick="hapusGambarRoom(this)" 
        style="display:none;"
      >Ã—</button>
    </div>

    <button 
      type="button"
      id="${uid}_uploadBtn"
      class="btn-upload-gambar room-image-upload" 
      onclick="uploadGambarRoom(this)"
    >ğŸ–¼ï¸ Upload Image</button>

    <button 
      type="button"
      id="${uid}_hapusBtn"
      class="btn-hapus-room" 
      onclick="hapusFormRoom(this)"
    >ğŸ—‘ï¸ Delete</button>

    <hr>
  `;

  container.appendChild(wrapper);
}


function ambilSemuaRoom() {
  const kategoriIds = [
    { id: "roomHotelContainer", kategori: "hotel" },
    { id: "meetingRoomContainer", kategori: "meeting" },
    { id: "packageContainer", kategori: "package" }
  ];
  const hasil = [];
  kategoriIds.forEach(({ id, kategori }) => {
    const container = document.getElementById(id);
    if (!container) return;
    const forms = container.querySelectorAll(".room-form");
    forms.forEach(form => {
      const nama = form.querySelector(".room-nama")?.value || "";
      const harga = parseInt(form.querySelector(".room-harga")?.value || "0");
      const kapasitas = parseInt(form.querySelector(".room-kapasitas")?.value || "0");
      const luas = parseInt(form.querySelector(".room-luas")?.value || "0");
      const deskripsi = form.querySelector(".room-deskripsi")?.value || "";
      const image = form.querySelector(".room-image-upload")?.getAttribute("data-image") || "";

      if (nama && harga) {
        hasil.push({
          id: "R" + Date.now() + Math.floor(Math.random() * 1000),
          nama,
          harga,
          kapasitas,
          luas,
          deskripsi,
          image,
          kategori
        });
      }
    });
  });
  return hasil;
}

function restoreRoomFromData(rooms = []) {
  rooms.forEach(room => {
    tambahRoom(room.kategori);
    const containerId = {
      hotel: "roomHotelContainer",
      meeting: "meetingRoomContainer",
      package: "packageContainer"
    }[room.kategori];
    const container = document.getElementById(containerId);
    const forms = container.querySelectorAll(".room-form");
    const lastForm = forms[forms.length - 1];
    lastForm.querySelector(".room-nama").value = room.nama || "";
    lastForm.querySelector(".room-harga").value = room.harga || "";
    lastForm.querySelector(".room-kapasitas").value = room.kapasitas || "";
    lastForm.querySelector(".room-luas").value = room.luas || "";
    lastForm.querySelector(".room-deskripsi").value = room.deskripsi || "";
    const preview = lastForm.querySelector(".gambar-preview");
    const hapusBtn = lastForm.querySelector(".hapus-gambar");
    const uploadBtn = lastForm.querySelector(".room-image-upload");
    if (room.image) {
      preview.src = room.image;
      preview.style.display = "block";
      hapusBtn.style.display = "flex";
      uploadBtn.setAttribute("data-image", room.image);
    }
  });
}

function uploadGambarRoom(button) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.style.display = "none";
  input.onchange = function (e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (event) {
      const wrapper = button.closest(".room-form");
      const preview = wrapper.querySelector(".gambar-preview");
      const hapusBtn = wrapper.querySelector(".hapus-gambar");
      const imageUrl = event.target.result;
      preview.src = imageUrl;
      preview.style.display = "block";
      hapusBtn.style.display = "flex";
      button.setAttribute("data-image", imageUrl);
    };
    reader.readAsDataURL(file);
  };
  document.body.appendChild(input);
  input.click();
  document.body.removeChild(input);
}

function hapusGambarRoom(button) {
  const wrapper = button.closest(".room-form");
  const preview = wrapper.querySelector(".gambar-preview");
  const uploadBtn = wrapper.querySelector(".room-image-upload");
  preview.src = "";
  preview.style.display = "none";
  button.style.display = "none";
  if (uploadBtn) uploadBtn.removeAttribute("data-image");
}

function hapusFormRoom(button) {
  const form = button.closest(".room-form");
  if (form) {
    form.remove();
    if (window._saveTimeout) clearTimeout(window._saveTimeout);
    window._saveTimeout = setTimeout(() => { simpanData().catch(e=>console.error(e)); }, 300);
  }
}

// ====================== UI: tampilkan list room (terpisah) ======================
async function tampilkanListRoom() {
  try {
    const restoId = document.getElementById("restoId")?.value || document.getElementById("restoPhone")?.value || null;
    const data = await loadDataFromDB(restoId);
    const listContainer = document.getElementById("listRuangan");
    if (!listContainer) return;

    listContainer.innerHTML = "";

    if (!data || !Array.isArray(data.rooms) || data.rooms.length === 0) {
      listContainer.innerHTML = "<p>Tidak ada ruangan yang tersedia.</p>";
      return;
    }

    data.rooms.forEach((room, index) => {
      const item = document.createElement("div");
      item.classList.add("room-card");
      item.innerHTML = `
        <strong>Ruangan ${index + 1}</strong><br>
        ğŸ·ï¸ Nama: ${room.nama}<br>
        ğŸ’¼ Kategori: ${room.kategori}<br>
        ğŸ’° Harga: Rp${room.harga}<br>
        ğŸ‘¥ Kapasitas: ${room.kapasitas || "-"} orang<br>
        ğŸ“ Luas: ${room.luas || "-"} mÂ²<br>
        ğŸ“ Catatan: ${room.deskripsi || "-"}
        <hr>
      `;
      listContainer.appendChild(item);
    });
  } catch (err) {
    console.error("Failed to display room list:", err);
  }
}

function tambahNomorWa(value = "") {
  const container = document.getElementById("nomorWaContainer");
  if (!container) return;

  const count = container.querySelectorAll(".nomor-wa").length;
  const uniqueId = `nomorWa${count + 1}`;

  const input = document.createElement("input");
  input.type = "text";
  input.id = uniqueId;
  input.name = uniqueId;
  input.className = "nomor-wa";
  input.placeholder = "Example: 6281234567890";
  input.inputMode = "numeric";
  input.autocomplete = "off";
  input.pattern = "62[0-9]{8,}";
  input.title = "Gunakan format: 6281234567890";

  input.value = value || "";

  input.addEventListener("input", () => {
    input.value = input.value.replace(/[^0-9]/g, "");
  });

  container.appendChild(input);
}

// ====================== IMAGE helper (resize) ======================
async function resizeIfNeeded(file, targetSizeKB = 100, maxWidth = 1280) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = async () => {
        try {
          const scale = Math.min(maxWidth / img.width, 1);
          const canvas = document.createElement("canvas");
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          let quality = 0.9;
          let dataUrl = canvas.toDataURL("image/jpeg", quality);
          let sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);

          while(sizeKB > targetSizeKB && quality > 0.1) {
            quality -= 0.05;
            dataUrl = canvas.toDataURL("image/jpeg", quality);
            sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);
          }

          resolve(dataUrl);
        } catch(err) {
          reject(err);
        }
      };
      img.onerror = () => reject(new Error("Image load error"));
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// logo input listener
document.getElementById("logoInput")?.addEventListener("change", async function (e) {
  const file = e.target.files[0];
  if (!file) return;
  try {
    const logoUrl = await resizeIfNeeded(file, 100);
    const preview = document.getElementById("previewLogo");
    if (preview) preview.src = logoUrl;
  } catch (err) {
    console.error("Logo error:", err);
    alert("âŒ Failed to process logo image.");
  }
});

// ====================== flipbook / preview helpers ======================
function renderImagePreview(tipe, url) {
  const img = document.createElement("img");
  img.src = url;
  img.style.maxWidth = "100px";
  img.style.margin = "5px";
  img.style.borderRadius = "5px";
  img.style.boxShadow = "0 1px 4px rgba(0,0,0,0.1)";

  const wrapper = document.createElement("div");
  wrapper.style.display = "inline-block";
  wrapper.style.position = "relative";
  wrapper.style.margin = "5px";

  const btnHapus = document.createElement("button");
  btnHapus.className = "btn-hapus-gambar";
  btnHapus.setAttribute("aria-label", "Hapus Gambar");
  btnHapus.innerHTML = "Ã—";
  btnHapus.style.position = "absolute";
  btnHapus.style.top = "2px";
  btnHapus.style.right = "2px";
  btnHapus.onclick = () => {
    wrapper.remove();
    if (tipe === "ruangan") flipbookRuanganImages = flipbookRuanganImages.filter(s => s !== url);
    else flipbookMenuImages = flipbookMenuImages.filter(s => s !== url);
  };

  wrapper.appendChild(img);
  wrapper.appendChild(btnHapus);

  const container = document.getElementById(tipe === "ruangan" ? "flipbookRuanganPreview" : "flipbookMenuPreview");
  if (container) container.appendChild(wrapper);
}

function tambahGambar(tipe) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.style.display = "none";
  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const url = await resizeIfNeeded(file);
      renderImagePreview(tipe, url);
      if (tipe === "ruangan") flipbookRuanganImages.push(url);
      else flipbookMenuImages.push(url);
    } catch (err) {
      console.error(err);
      alert("âŒ Gagal memproses gambar.");
    }
  };
  document.body.appendChild(input);
  input.click();
  document.body.removeChild(input);
}

// ====================== slugify ======================
function slugify(text) {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
}

// ====================== Supabase helpers & upload ======================
// expects `sb` (supabase client) available in global scope
const BUCKET = 'restoasset';

function nowTs() { return new Date().toISOString(); }

// ensure sb exists
const supa = (typeof sb !== 'undefined') ? sb : (window.sb || null);
if (!supa) {
  console.error('Supabase client not found. Make sure patch1 created `sb` client before this script.');
}

// safe slug helper
function slugifyFileName(text) {
  return String(text || '').toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-\.]/g,'');
}

// detect mime and convert base64 -> Blob
function detectMime(b64) {
  const m = (b64||'').match(/^data:([^;]+);base64,/);
  return m ? m[1] : null;
}
function base64ToBlob(b64) {
  const raw = b64.replace(/^data:[^;]+;base64,/, '');
  const binary = atob(raw);
  const len = binary.length;
  const u8 = new Uint8Array(len);
  for (let i = 0; i < len; i++) u8[i] = binary.charCodeAt(i);
  const mime = detectMime(b64) || 'application/octet-stream';
  return new Blob([u8], { type: mime });
}

// upload helper: accepts either an existing http(s) URL (returns as-is) or a data:... base64 string
async function uploadBase64ToBucket(b64OrUrl, restoId, type = 'misc', filenameHint = 'file') {
  if (!supa) throw new Error('Supabase client (sb) not initialized');
  if (!b64OrUrl) return null;
  if (typeof b64OrUrl === 'string' && (b64OrUrl.startsWith('http://') || b64OrUrl.startsWith('https://'))) {
    return b64OrUrl;
  }
  if (typeof b64OrUrl !== 'string' || !b64OrUrl.startsWith('data:')) {
    // not a valid base64 -> skip
    return null;
  }

  const mime = detectMime(b64OrUrl) || 'image/jpeg';
  const ext = mime.split('/')[1] || 'jpg';
  const safeName = slugifyFileName(filenameHint).slice(0,40) || 'img';
  const timestamp = Date.now();
  const path = `${encodeURIComponent(String(restoId))}/${type}/${safeName}_${timestamp}.${ext}`;

  // convert blob
  const blob = base64ToBlob(b64OrUrl);

  // upload
  const { error } = await supa.storage.from(BUCKET).upload(path, blob, { upsert: true });
  if (error) {
    console.error('Upload error', error);
    throw error;
  }
  // public URL
  const base = SUPABASE_URL ? SUPABASE_URL.replace(/\/$/,'') : (window.SUPABASE_URL || '');
  return `${base}/storage/v1/object/public/${BUCKET}/${encodeURIComponent(path)}`;
}

// ====================== Data mapping helpers ======================

// map UI menu entry -> DB payload
function mapMenuItemForInsert(item, restoId) {
  // expected item keys from UI: { nama, harga, kategori, image, ... }
  return {
    resto_id: String(restoId),
    name: item.nama || item.name || '',
    price: Number(item.harga || item.price || 0) || 0,
    category: item.kategori || item.cat || item.category || 'food',
    description: item.deskripsi || item.description || item.desc || '',
    image_url: item.image || item.image_url || null,
    created_at: nowTs(),
    is_available: true
  };
}

function mapPromoForInsert(p, restoId) {
  return {
    resto_id: String(restoId),
    title: p.namaPromo || p.title || '',
    description: p.deskripsi || p.description || '',
    discount: p.harga ? Number(p.harga) : null,
    is_active: true,
    expires_at: p.tanggalAkhir || null,
    banner_url: p.image || p.banner_url || null,
    created_at: nowTs()
  };
}

// ====================== SIMPAN (form -> Supabase) ======================
async function simpanData() {
  if (!supa) {
    alert('Supabase client belum di-inisialisasi. Cek konfigurasi.');
    return;
  }

  try {
    showLoader();

    // read UI fields
    const namaRestoran = document.getElementById("namaRestoran")?.value.trim() || "";
    const restoAddress = document.getElementById("restoAddress")?.value.trim() || "";
    const restoPhone = document.getElementById("restoPhone")?.value.trim() || "";
    if (!restoPhone) {
      alert("âŒ Please input the restaurant phone number before saving!");
      hideLoader();
      return;
    }
    const restoId = String(restoPhone); // multi-resto key: use phone number
    const logoSrc = document.getElementById("previewLogo")?.src || "";
    const backgroundSrc = document.getElementById("previewBackground")?.src || ""; // if exists

    // nomor wa
    const nomorWaAdmin = Array.from(document.querySelectorAll(".nomor-wa")).map(i => i.value).filter(Boolean);

    // menu arrays from UI
    const menuData = [
      ...ambilMenu("menuFoodContainer"),
      ...ambilMenu("menuSnackContainer"),
      ...ambilMenu("menuDrinkContainer"),
      ...ambilMenu("menuSpecialContainer")
    ];

    const promo = Array.isArray(menuPromo) ? menuPromo.slice() : [];
    const flipRuangan = Array.isArray(flipbookRuanganImages) ? flipbookRuanganImages.slice() : [];
    const flipMenu = Array.isArray(flipbookMenuImages) ? flipbookMenuImages.slice() : [];
    const rooms = typeof ambilSemuaRoom === 'function' ? ambilSemuaRoom() : [];

    // =========== Upload logo & background (if base64) ===========
    let logo_url = logoSrc;
    let background_url = backgroundSrc;
    try {
      if (logoSrc && logoSrc.startsWith && logoSrc.startsWith("data:")) {
        logo_url = await uploadBase64ToBucket(logoSrc, restoId, 'logo', 'logo');
      }
    } catch (err) {
      console.warn('Logo upload failed:', err);
      // continue without blocking
    }
    try {
      if (backgroundSrc && backgroundSrc.startsWith && backgroundSrc.startsWith("data:")) {
        background_url = await uploadBase64ToBucket(backgroundSrc, restoId, 'background', 'background');
      }
    } catch (err) {
      console.warn('Background upload failed:', err);
    }

    // =========== Upsert restosettings ===========
    const settingsPayload = {
      resto_id: String(restoId),
      nama_restoran: namaRestoran || null,
      resto_address: restoAddress || null,
      resto_phone: restoPhone || null,
      nomor_wa_admin: nomorWaAdmin.length ? nomorWaAdmin : [],
      rooms: rooms.length ? rooms : [],
      flipbook_ruangan_images: flipRuangan.length ? flipRuangan : [],
      flipbook_menu_images: flipMenu.length ? flipMenu : [],
      logo_url: logo_url || null,
      background_url: background_url || null,
      created_at: nowTs()
    };

    // upsert: use insert with onConflict via upsert (requires unique constraint on resto_id OR use RPC)
    const { error: upsertErr } = await supa
      .from('restosettings')
      .upsert(settingsPayload, { onConflict: ['resto_id'] });

    if (upsertErr) {
      console.error('Failed upsert restosettings:', upsertErr);
      alert('âŒ Gagal menyimpan resto settings: ' + upsertErr.message);
      hideLoader();
      return;
    }

    // =========== Replace menuitems for this resto ===========
    // Delete existing menuitems for resto
    const { error: delMenuErr } = await supa.from('menuitems').delete().eq('resto_id', String(restoId));
    if (delMenuErr) {
      console.warn('Warning: failed to delete old menuitems (non-fatal):', delMenuErr);
    }

    // Prepare and insert new menuitems (upload images sequentially)
    const insertMenuBatch = [];
    for (const m of menuData) {
      const mapped = mapMenuItemForInsert(m, restoId);
      try {
        if (mapped.image_url && mapped.image_url.startsWith && mapped.image_url.startsWith('data:')) {
          const uploaded = await uploadBase64ToBucket(mapped.image_url, restoId, 'menu', mapped.name || 'menu');
          mapped.image_url = uploaded || null;
        }
      } catch (err) {
        console.warn('Menu image upload failed for', mapped.name, err);
        mapped.image_url = null;
      }
      insertMenuBatch.push(mapped);
    }

    if (insertMenuBatch.length > 0) {
      const { error: insErr } = await supa.from('menuitems').insert(insertMenuBatch);
      if (insErr) {
        console.error('Failed insert menuitems:', insErr);
        alert('âŒ Gagal menyimpan menu items: ' + insErr.message);
        hideLoader();
        return;
      }
    }

    // =========== Replace promos for this resto ===========
    const { error: delPromoErr } = await supa.from('promos').delete().eq('resto_id', String(restoId));
    if (delPromoErr) {
      console.warn('Warning: failed to delete old promos (non-fatal):', delPromoErr);
    }

    const insertPromos = [];
    for (const p of promo) {
      const mapped = mapPromoForInsert(p, restoId);
      try {
        if (p.image && p.image.startsWith && p.image.startsWith('data:')) {
          const up = await uploadBase64ToBucket(p.image, restoId, 'promo', mapped.title || 'promo');
          mapped.banner_url = up || null;
        } else if (p.image && (p.image.startsWith('http') || p.image.startsWith('/'))) {
          mapped.banner_url = p.image;
        }
      } catch (err) {
        console.warn('Promo banner upload failed:', err);
        mapped.banner_url = null;
      }
      insertPromos.push(mapped);
    }

    if (insertPromos.length > 0) {
      const { error: insPromoErr } = await supa.from('promos').insert(insertPromos);
      if (insPromoErr) {
        console.error('Failed insert promos:', insPromoErr);
        alert('âŒ Gagal menyimpan promos: ' + insPromoErr.message);
        hideLoader();
        return;
      }
    }

    // =========== Success ===========
    hideLoader();
    // set hidden restoId input for UI
    let restoIdEl = document.getElementById("restoId");
    if (!restoIdEl) {
      restoIdEl = document.createElement("input");
      restoIdEl.type = "hidden";
      restoIdEl.id = "restoId";
      document.body.appendChild(restoIdEl);
    }
    restoIdEl.value = restoId;

    updateShareUI?.();
    alert(`âœ… All data saved successfully for resto_id: ${restoId}`);
    return true;
  } catch (err) {
    console.error('simpanData failed:', err);
    hideLoader();
    alert('âŒ Failed to save data: ' + (err.message || err));
    return false;
  }
}

// ====================== LOAD (DB -> form) ======================
async function loadData(restoPhoneOrObj) {
  // If argument is object (existing combined data), use old behavior.
  if (restoPhoneOrObj && typeof restoPhoneOrObj === 'object') {
    // original UI-populating logic preserved:
    try {
      // reuse original loadData implementation (the UI setter block)
      // We assume the existing loadData implementation (from your patch) follows below.
      // To avoid duplicating, call a helper that sets UI from combinedData
      await setUIFromCombinedData(restoPhoneOrObj);
      return;
    } catch (err) {
      console.error('loadData (from object) failed:', err);
      return;
    }
  }

  // Otherwise treat the argument as restoPhone (string) or read from input
  const restoPhone = (typeof restoPhoneOrObj === 'string' && restoPhoneOrObj.trim()) ? restoPhoneOrObj.trim()
    : (document.getElementById('restoPhone')?.value || '').trim();

  if (!restoPhone) {
    console.warn('No restoPhone provided to loadData(); skipping.');
    return;
  }

  if (!supa) {
    console.error('Supabase client not initialized; cannot load data.');
    return;
  }

  try {
    showLoader();

    const restoId = String(restoPhone);

    // fetch restosettings
    const { data: rsData, error: rsErr } = await supa
      .from('restosettings')
      .select('*')
      .eq('resto_id', restoId)
      .maybeSingle();

    if (rsErr) {
      console.error('Failed fetch restosettings:', rsErr);
    }

    // fetch menuitems
    const { data: menusData, error: menusErr } = await supa
      .from('menuitems')
      .select('*')
      .eq('resto_id', restoId)
      .order('id', { ascending: true });

    if (menusErr) {
      console.error('Failed fetch menuitems:', menusErr);
    }

    // fetch promos
    const { data: promosData, error: promosErr } = await supa
      .from('promos')
      .select('*')
      .eq('resto_id', restoId)
      .order('id', { ascending: true });

    if (promosErr) {
      console.error('Failed fetch promos:', promosErr);
    }

    // Build combined object similar to old IndexedDB structure so existing UI code works
    const combined = {
      restoId: restoId,
      namaRestoran: rsData?.nama_restoran || '',
      restoAddress: rsData?.resto_address || '',
      restoPhone: rsData?.resto_phone || restoId,
      logo: rsData?.logo_url || rsData?.logo_base64 || '',
      background: rsData?.background_url || rsData?.background_base64 || '',
      nomorWaAdmin: Array.isArray(rsData?.nomor_wa_admin) ? rsData.nomor_wa_admin : [],
      menuPromo: Array.isArray(promosData) ? promosData.map(p => ({
        namaPromo: p.title || '',
        image: p.banner_url || p.banner_base64 || '',
        deskripsi: p.description || '',
        harga: p.discount || null,
        kategori: null,
        tanggalAkhir: p.expires_at || null
      })) : [],
      menuVoucher: [], // keep empty unless you sync vouchers table
      flipbookRuanganImages: Array.isArray(rsData?.flipbook_ruangan_images) ? rsData.flipbook_ruangan_images : [],
      flipbookMenuImages: Array.isArray(rsData?.flipbook_menu_images) ? rsData.flipbook_menu_images : [],
      menu: Array.isArray(menusData) ? menusData.map(m => ({
        nama: m.name || '',
        harga: m.price || 0,
        kategori: m.category || '',
        image: m.image_url || m.image_base64 || '',
        description: m.description || ''
      })) : [],
      rooms: Array.isArray(rsData?.rooms) ? rsData.rooms : []
    };

    // call UI setter (the original function body that populates DOM)
    await setUIFromCombinedData(combined);

    hideLoader();
    console.log('âœ… loadData from Supabase complete for resto_id', restoId);
    return combined;
  } catch (err) {
    console.error('loadData failed:', err);
    hideLoader();
    return null;
  }
}

// ====================== UI setter helper (extract from original loadData) ======================
// This reuses your original DOM-filling logic (keeps UI behavior unchanged).
// It expects the combined object shape used previously.
// If you already have the original loadData implementation, paste it here as function body.
// We'll implement it by reusing the code you provided earlier (kept concise).

async function setUIFromCombinedData(data) {
  // Use the original loadData() DOM mapping block from your patch 3 and adapt it slightly.
  // This function replaces the original loadData content that populates form fields and UI.
  try {
    // copy-paste the body of your original loadData (UI mapping)
    // For safety, we call the same code you provided earlier:

    // If your original loadData implementation exists in file, call it:
    if (typeof window.__original_loadData_impl === 'function') {
      // If you saved original implementation to a function, call it.
      return window.__original_loadData_impl(data);
    }

    // Otherwise, fallback: manual mapping similar to previous logic:
    // (re-implement minimal UI mapping based on fields present)
    const safeSet = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.value = value || "";
    };

    safeSet("namaRestoran", data.namaRestoran);
    safeSet("restoAddress", data.restoAddress);
    safeSet("restoPhone", data.restoPhone);

    if (data.logo && document.getElementById("previewLogo")) {
      document.getElementById("previewLogo").src = data.logo;
    }
    // nomor WA
    const waContainer = document.getElementById("nomorWaContainer");
    if (waContainer) {
      waContainer.innerHTML = "";
      (data.nomorWaAdmin || []).forEach(num => tambahNomorWa(num));
    }

    // promo
    menuPromo = Array.isArray(data.menuPromo) ? data.menuPromo.slice() : [];
    if (typeof renderPromoUI === "function") renderPromoUI();

    // voucher
    window.menuVoucher = Array.isArray(data.menuVoucher) ? data.menuVoucher.slice() : [];
    if (typeof renderVoucher === "function") renderVoucher(window.menuVoucher);

    // menu containers
    ["food", "snack", "drink", "special"].forEach(kat => {
      const old = document.getElementById(
        {
          food: "menuFoodContainer",
          snack: "menuSnackContainer",
          drink: "menuDrinkContainer",
          special: "menuSpecialContainer"
        }[kat]
      );
      if (old) old.innerHTML = "";
    });

    const menuList = Array.isArray(data.menu) ? data.menu : [];
    menuList.forEach(m => {
      const kategori = m.kategori || m.cat || m.category || "food";
      const nama = m.nama || m.name || "";
      const harga = m.harga || m.price || "";
      const image = m.image || m.gambar || "";
      tambahMenu(kategori, nama, harga, image);
    });

    // flipbooks
    flipbookRuanganImages = Array.isArray(data.flipbookRuanganImages) ? data.flipbookRuanganImages.slice() : [];
    flipbookMenuImages = Array.isArray(data.flipbookMenuImages) ? data.flipbookMenuImages.slice() : [];

    const ruanganPreview = document.getElementById("flipbookRuanganPreview");
    const menuPreview = document.getElementById("flipbookMenuPreview");
    if (ruanganPreview) ruanganPreview.innerHTML = "";
    if (menuPreview) menuPreview.innerHTML = "";

    setTimeout(() => {
      if (typeof renderImagePreview === "function") {
        flipbookRuanganImages.forEach(src => {
          if (src) renderImagePreview("ruangan", src);
        });
        flipbookMenuImages.forEach(src => {
          if (src) renderImagePreview("menu", src);
        });
      }
    }, 200);

    // rooms
    if (Array.isArray(data.rooms)) {
      restoreRoomFromData(data.rooms);
    }

    // hidden restoId
    let restoIdEl = document.getElementById("restoId");
    if (!restoIdEl) {
      restoIdEl = document.createElement("input");
      restoIdEl.type = "hidden";
      restoIdEl.id = "restoId";
      document.body.appendChild(restoIdEl);
    }
    restoIdEl.value = data.restoId || data.restoPhone || "";

    // done
    console.log("âœ… setUIFromCombinedData complete.");
    return;
  } catch (err) {
    console.error('setUIFromCombinedData error:', err);
    throw err;
  }
}

// ====================== RESET & BACKUP (Supabase) ======================
// expects `supa` (supabase client) available in global scope
if (typeof supa === 'undefined' && typeof sb !== 'undefined') supa = sb;
const BACKUP_FILENAME_PREFIX = 'menuva-backup';

function getActiveRestoId() {
  // prefer explicit hidden restoId, else take from restoPhone input
  return (document.getElementById("restoId")?.value
       || document.getElementById("restoPhone")?.value
       || "").toString().trim();
}

async function clearSupabaseDataForResto(restoId) {
  if (!supa) throw new Error('Supabase client not initialized');
  if (!restoId) throw new Error('restoId required to clear data');

  // Do deletes in safe order (children first)
  const tables = [
    'order_items',
    'orders',
    'menuitems',
    'promos',
    'vouchers',
    'activity_log',
    // optionally other tables referencing resto
  ];

  for (const t of tables) {
    try {
      const { error } = await supa.from(t).delete().eq('resto_id', String(restoId));
      if (error) console.warn(`Warning: failed to delete from ${t}:`, error);
    } catch (err) {
      console.warn(`Exception deleting ${t}:`, err);
    }
  }

  // Finally delete restosettings row
  try {
    const { error } = await supa.from('restosettings').delete().eq('resto_id', String(restoId));
    if (error) console.warn('Warning: failed to delete restosettings:', error);
  } catch (err) {
    console.warn('Exception deleting restosettings:', err);
  }
}

// Reset triggered by admin
async function resetData() {
  if (!confirm("Are you sure you want to DELETE ALL data for this resto? This cannot be undone.")) return;
  const restoId = getActiveRestoId();
  if (!restoId) return alert('âŒ Cannot reset: resto id (phone) not set.');

  showLoader();
  try {
    await clearSupabaseDataForResto(restoId);
    hideLoader();
    alert(`âœ… All data for resto_id="${restoId}" deleted from Supabase.`);
    location.reload();
  } catch (err) {
    hideLoader();
    console.error('Reset failed:', err);
    alert('âŒ Failed to delete data: ' + (err.message || err));
  }
}

// Backup: query Supabase for current resto and download combined JSON
async function backupData() {
  const restoId = getActiveRestoId();
  if (!restoId) return alert('âŒ Please set resto phone/id before backup.');

  if (!supa) return alert('Supabase client not initialized.');

  try {
    showLoader();

    // fetch restosettings
    const { data: rsData, error: rsErr } = await supa.from('restosettings').select('*').eq('resto_id', restoId).maybeSingle();
    if (rsErr) console.error('restosettings fetch error:', rsErr);

    // fetch menuitems
    const { data: menuData, error: menuErr } = await supa.from('menuitems').select('*').eq('resto_id', restoId).order('id', { ascending: true });
    if (menuErr) console.error('menuitems fetch error:', menuErr);

    // fetch promos
    const { data: promosData, error: promosErr } = await supa.from('promos').select('*').eq('resto_id', restoId).order('id', { ascending: true });
    if (promosErr) console.error('promos fetch error:', promosErr);

    // fetch vouchers (optional)
    const { data: vouchersData } = await supa.from('vouchers').select('*').eq('resto_id', restoId).order('id', { ascending: true });

    // fetch orders & order_items (optional)
    const { data: ordersData } = await supa.from('orders').select('*').eq('resto_id', restoId).order('id', { ascending: true });
    const { data: orderItemsData } = await supa.from('order_items').select('*').in('order_id', (ordersData||[]).map(o=>o.id)).order('id');

    // fetch activity_log
    const { data: activityData } = await supa.from('activity_log').select('*').eq('resto_id', restoId).order('id', { ascending: true });

    // build combined object similar to old IndexedDB structure
    const combined = {
      restoId,
      namaRestoran: rsData?.nama_restoran || '',
      restoAddress: rsData?.resto_address || '',
      restoPhone: rsData?.resto_phone || restoId,
      logo: rsData?.logo_url || rsData?.logo_base64 || '',
      background: rsData?.background_url || rsData?.background_base64 || '',
      nomorWaAdmin: Array.isArray(rsData?.nomor_wa_admin) ? rsData.nomor_wa_admin : [],
      menuPromo: Array.isArray(promosData) ? promosData.map(p => ({
        namaPromo: p.title || '',
        image: p.banner_url || p.banner_base64 || '',
        deskripsi: p.description || '',
        harga: p.discount || null,
        kategori: null,
        tanggalAkhir: p.expires_at || null
      })) : [],
      menuVoucher: Array.isArray(vouchersData) ? vouchersData : [],
      flipbookRuanganImages: Array.isArray(rsData?.flipbook_ruangan_images) ? rsData.flipbook_ruangan_images : [],
      flipbookMenuImages: Array.isArray(rsData?.flipbook_menu_images) ? rsData.flipbook_menu_images : [],
      menu: Array.isArray(menuData) ? menuData.map(m => ({
        nama: m.name || '',
        harga: m.price || 0,
        kategori: m.category || '',
        image: m.image_url || m.image_base64 || '',
        description: m.description || ''
      })) : [],
      rooms: Array.isArray(rsData?.rooms) ? rsData.rooms : [],
      orders: Array.isArray(ordersData) ? ordersData : [],
      order_items: Array.isArray(orderItemsData) ? orderItemsData : [],
      activity_log: Array.isArray(activityData) ? activityData : []
    };

    const filename = `${BACKUP_FILENAME_PREFIX}-${restoId}-${Date.now()}.json`;
    const blob = new Blob([JSON.stringify(combined, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    hideLoader();
    alert(`âœ… Backup siap diunduh: ${filename}`);
  } catch (err) {
    hideLoader();
    console.error('Backup failed:', err);
    alert('âŒ Backup gagal: ' + (err.message || err));
  }
}

// ====================== Restore from file (Supabase) ======================
// This will: parse file, map to combined structure, call setUIFromCombinedData to populate UI,
// then call simpanData() which already handles uploads + upsert to Supabase.
async function restoreDataFromFile(event) {
  const file = event.target?.files?.[0];
  if (!file) return;
  try {
    showLoader();
    const text = await file.text();
    let json = JSON.parse(text);

    // unwrap wrappers common in exports
    if (json.profile && typeof json.profile === 'object') json = json.profile;
    else if (json.data && typeof json.data === 'object') json = json.data;

    // if array -> pick first
    if (Array.isArray(json)) {
      if (json.length === 0) throw new Error('File kosong');
      json = json[0];
    }

    // ensure restoId exists (prefer restoPhone)
    if (!json.restoId) {
      json.restoId = json.restoPhone || (json.namaRestoran ? slugify(json.namaRestoran) : ("resto" + Date.now()));
    }
    if (!json.restoPhone) json.restoPhone = json.restoId;

    // Populate UI with data
    await setUIFromCombinedData(json);

    // Auto-save to Supabase (this will upload images where base64 present)
    const ok = await simpanData();
    hideLoader();
    if (ok) {
      alert('âœ… Restore & sync to Supabase successful.');
      location.reload();
    } else {
      alert('âš ï¸ Restore completed but some operations failed. Check console.');
    }
  } catch (err) {
    hideLoader();
    console.error('Restore failed:', err);
    alert('âŒ Failed to restore JSON file. Lihat console untuk detail.');
  } finally {
    // clear file input value if any
    if (event && event.target) event.target.value = '';
  }
}

// ====================== Links / QR helpers (update) ======================
function generateDynamicLink(baseUrl, data) {
  try {
    const jsonData = JSON.stringify(data);
    const encoded = encodeURIComponent(jsonData);
    return `${baseUrl}?data=${encoded}`;
  } catch (err) {
    console.error("Gagal generate link:", err);
    return null;
  }
}

async function createMenuvaLink() {
  try {
    const restoId = getActiveRestoId();
    if (!restoId) return alert('Set resto ID first.');

    // load combined data from Supabase via loadData()
    const combined = await loadData(restoId);
    const link = generateDynamicLink("https://orderine.github.io/menu.html", combined || {});
    console.log("Dynamic Link:", link);
    return link;
  } catch (err) {
    console.error("Error createMenuvaLink:", err);
  }
}

function getCustomerLink() {
  const restoId = getActiveRestoId();
  if (!restoId) return null;
  // assume menu.html is at same root path
  const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
  return `${window.location.origin}${basePath}/menu.html?resto=${encodeURIComponent(restoId)}`;
}

function openCustomerPage() {
  const link = getCustomerLink();
  if (!link) return alert("âŒ Please click Save All first");
  window.open(link, "_blank");
}

// update share UI + QR generation (uses qrcode library)
function updateShareUI() {
  const link = getCustomerLink();
  if (!link) return;

  const btnCopy = document.getElementById("btnSalinLink");
  if (btnCopy) {
    btnCopy.style.display = "inline-block";
    btnCopy.onclick = () => {
      navigator.clipboard.writeText(link)
        .then(() => alert("âœ… Link copied to clipboard"))
        .catch(err => alert("âŒ Failed to copy link: " + err));
    };
  }

  const btnSee = document.getElementById("btnOpenCustomer");
  if (btnSee) {
    btnSee.style.display = "inline-block";
    btnSee.onclick = () => window.open(link, "_blank");
  }

  const qrContainer = document.getElementById("qrcodePreview");
  if (!qrContainer) return;
  qrContainer.innerHTML = "";
  if (typeof QRCode !== "undefined") {
    // QRCode.toCanvas may exist in different libs; support both lib interfaces
    try {
      if (QRCode.toCanvas) {
        QRCode.toCanvas(link, { width: 128 }, function (error, canvas) {
          if (error) { console.error(error); qrContainer.textContent = "âŒ Failed to generate QR"; return; }
          qrContainer.appendChild(canvas);
        });
      } else {
        // fallback assume QRCode is constructor that builds DOM element
        const q = new QRCode(qrContainer, { text: link, width: 128, height: 128 });
      }
    } catch (err) {
      console.error('QR generation error:', err);
      qrContainer.textContent = link;
    }

    // download & print buttons handlers
    const canvas = qrContainer.querySelector('canvas');
    const btnDownload = document.getElementById("btnDownloadQR");
    if (btnDownload && canvas) {
      btnDownload.style.display = "inline-block";
      btnDownload.onclick = () => {
        const a = document.createElement('a');
        a.href = canvas.toDataURL('image/png');
        a.download = `Resto-${getActiveRestoId() || Date.now()}-QRCode.png`;
        a.click();
      };
    }
    const btnPrint = document.getElementById("btnPrintQR");
    if (btnPrint && canvas) {
      btnPrint.style.display = "inline-block";
      btnPrint.onclick = () => {
        const dataUrl = canvas.toDataURL("image/png");
        const w = window.open("");
        w.document.write(`<img src="${dataUrl}" style="width:250px;height:250px;">`);
        w.document.close();
        w.print();
      };
    }
  } else {
    // fallback: show link text
    qrContainer.textContent = link;
  }
}

// ====================== LOADER HANDLER (Modern & Center) ======================
function showLoader() {
  let loader = document.getElementById("loader");
  if (!loader) {
    loader = document.createElement("div");
    loader.id = "loader";
    loader.innerHTML = `
      <div class="loader-overlay">
        <div class="loader-content">
          <div class="spinner"></div>
          <p>Loading data...</p>
        </div>
      </div>
    `;
    document.body.appendChild(loader);

    // Tambahkan gaya modern (langsung di JS biar portable)
    if (!document.getElementById('loader-style')) {
      const style = document.createElement("style");
      style.id = "loader-style";
      style.textContent = `
        #loader {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: rgba(0,0,0,0.45);
          z-index: 9999;
          opacity: 0;
          transition: opacity 0.3s ease;
        }
        #loader.show { opacity: 1; }
        .loader-content { text-align: center; color: #fff; font-family: 'Segoe UI', sans-serif; font-size: 1.1rem; animation: fadeUp 0.6s ease; }
        .spinner { width: 64px; height: 64px; border: 6px solid rgba(255,255,255,0.3); border-top-color: #00d4ff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      `;
      document.head.appendChild(style);
    }
  }
  loader.style.display = "flex";
  requestAnimationFrame(() => loader.classList.add("show"));
}

function hideLoader() {
  const loader = document.getElementById("loader");
  if (loader) {
    loader.classList.remove("show");
    setTimeout(() => { loader.style.display = "none"; }, 300);
  }
}

// ====================== CLEAR DB (Supabase) ======================
async function clearDataDB() {
  const restoId = getActiveRestoId();
  if (!restoId) throw new Error('resto id not set');
  return clearSupabaseDataForResto(restoId);
}
</script>
<script>
let isLoadingFromDB = false;
let voucherLoaded = false;

document.addEventListener("DOMContentLoaded", async () => {
  console.log("ğŸš€ Init mulai...");
  showLoader();

  const timeout = setTimeout(() => {
    console.warn("âš ï¸ Init terlalu lama, sembunyikan loader paksa.");
    hideLoader();
  }, 8000);

  try {
    // ===================== INIT DB =====================
    const db = await initDB();
    console.log("âœ… IndexedDB siap");

    // ===================== LOAD DATA UTAMA =====================
    const data = await safeLoadDataFromDB();
    if (data) {
      await safeLoadData(data);
      console.log("ğŸ“¦ Data diambil:", data);
    } else {
      console.warn("âš ï¸ Tidak ada data ditemukan di DB");
    }

    // ===================== TOGGLE SECTION =====================
    await initAllToggles();

    // ===================== FIXED BAR =====================
    const fixbar = document.querySelector(".fixed-bar");
    if (fixbar) {
      const fixbarHeight = fixbar.offsetHeight;
      document.body.style.paddingBottom = fixbarHeight + "px";
    }

    console.log("âœ… Admin siap digunakan");
  } catch (err) {
    console.error("âŒ Error saat init:", err);
    alert("Terjadi kesalahan saat memuat data. Coba refresh halaman.");
  } finally {
    clearTimeout(timeout);
    hideLoader();
  }
});


// ===================== SAFE LOAD WRAPPER =====================
async function safeLoadDataFromDB(id = 1) {
  if (isLoadingFromDB) {
    console.warn("âš ï¸ loadDataFromDB() di-skip, masih jalan");
    return null;
  }
  isLoadingFromDB = true;
  const data = await loadDataFromDB(id);
  isLoadingFromDB = false;
  return data;
}

async function safeLoadData(data) {
  if (window.sudahLoadData) {
    console.warn("âš ï¸ loadData() sudah pernah jalan, skip render ulang");
    return;
  }
  window.sudahLoadData = true;
  await loadData(data);
}


// ===================== TOGGLES MASTER =====================
async function initAllToggles() {
  await new Promise((resolve) => {
    if (document.readyState === "complete") return resolve();
    document.addEventListener("readystatechange", () => {
      if (document.readyState === "complete") resolve();
    });
  });

  initOrderToggle();
  initRoomToggle();
  await initVoucherToggle();
}


// ===================== ORDER TOGGLE =====================
function initOrderToggle() {
  const toggleOrderPage = document.getElementById("toggleOrderPage");
  // FIXED: disinkronkan dengan HTML (id="orderToggleBox")
  const orderContainerBox =
    document.getElementById("orderContainerBox") ||
    document.getElementById("orderToggleBox");

  if (!toggleOrderPage) {
    console.warn("âš ï¸ Elemen toggleOrderPage tidak ditemukan.");
    return;
  }
  if (!orderContainerBox) {
    console.warn("âš ï¸ Elemen orderContainerBox/orderToggleBox belum ada, coba lagi 300ms...");
    return setTimeout(initOrderToggle, 300);
  }

  const saved = localStorage.getItem("page_order");
  toggleOrderPage.checked = saved === "true";
  orderContainerBox.style.display = toggleOrderPage.checked ? "block" : "none";

  toggleOrderPage.addEventListener("change", (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_order", enabled);
    orderContainerBox.style.display = enabled ? "block" : "none";
  });
}


// ===================== ROOM TOGGLE =====================
function initRoomToggle() {
  const toggleRoomPage = document.getElementById("toggleRoomPage");
  const roomContainerBox = document.getElementById("roomContainerBox");

  if (!toggleRoomPage || !roomContainerBox) {
    console.warn("âš ï¸ Elemen toggleRoomPage atau roomContainerBox tidak ditemukan.");
    return;
  }

  const saved = localStorage.getItem("page_room");
  toggleRoomPage.checked = saved === "true";
  roomContainerBox.style.display = toggleRoomPage.checked ? "block" : "none";

  toggleRoomPage.addEventListener("change", (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_room", enabled);
    roomContainerBox.style.display = enabled ? "block" : "none";
  });
}


// ===================== VOUCHER TOGGLE =====================
async function initVoucherToggle() {
  const toggleVoucherPage = document.getElementById("toggleVoucherPage");
  const voucherForm = document.getElementById("voucherForm");
  const voucherContainerBox = document.getElementById("voucherContainerBox");

  if (!toggleVoucherPage || !voucherForm || !voucherContainerBox) {
    console.warn("âš ï¸ Elemen voucher toggle/form/container tidak lengkap, skip initVoucherToggle()");
    return;
  }

  const plan = localStorage.getItem("user_plan");
  if (plan === "monthly") {
    voucherContainerBox.style.display = "none";
    return;
  }

  const enabled = localStorage.getItem("page_voucher") === "true";
  toggleVoucherPage.checked = enabled;
  voucherForm.style.display = enabled ? "block" : "none";

  toggleVoucherPage.addEventListener("change", async (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_voucher", enabled);
    voucherForm.style.display = enabled ? "block" : "none";

    if (!enabled) {
      renderVoucher([]);
    } else {
      await loadVouchers(); // <<===== fungsi baru
    }
  });

  // <<<==== PENTING! panggil fungsi baru
  await loadVouchers();
}


 async function loadVouchers() {
  console.groupCollapsed("ğŸ“¥ Load Vouchers");

  const data = await loadDataFromDB(1);

  if (!Array.isArray(data.menuVoucher)) {
    console.warn("âš ï¸ menuVoucher hilang â†’ reset array");
    data.menuVoucher = [];
  }

  // Auto remove expired
  const today = new Date();
  const cleaned = data.menuVoucher.filter(v => {
    const exp = new Date(v.expiry);
    return isFinite(exp) && exp >= today;
  });

  if (cleaned.length !== data.menuVoucher.length) {
    console.warn("ğŸ§¹ Membersihkan voucher expired...");
    data.menuVoucher = cleaned;
    await saveDataToDB(1, data);
  }

  console.log("ğŸ“¦ Voucher aktif:", cleaned);
  console.groupEnd();

  renderVoucher(cleaned);  
  return cleaned;
}

  // Compatibility wrapper â€” biar onclick lama tetap work
function saveVoucher() {
  // return promise in case caller expects it
  return saveVoucherNew && typeof saveVoucherNew === 'function'
    ? saveVoucherNew()
    : (alert("Function saveVoucherNew() tidak ditemukan."), Promise.reject(new Error("saveVoucherNew not defined")));
}


  async function saveVoucherNew() {
  const code = document.getElementById("voucherCode").value.trim();
  const discount = parseFloat(document.getElementById("voucherDiscount").value);
  const expiry = document.getElementById("voucherExpiry").value;

  if (!code || isNaN(discount) || !expiry) {
    alert("âš ï¸ Harap isi semua form!");
    return;
  }

  const data = await loadDataFromDB(1);

  if (!Array.isArray(data.menuVoucher)) data.menuVoucher = [];

  const codeUpper = code.toUpperCase();

  // Cek apakah voucher dengan code yang sama sudah ada
  const existing = data.menuVoucher.find(v => v.code === codeUpper);

  if (existing) {
    // Update
    existing.discount = discount;
    existing.expiry = expiry;
    existing.updatedAt = new Date().toISOString();

    console.log("âœï¸ Voucher updated:", existing);
  } else {
    // Tambah baru
    const newVoucher = {
      id: crypto.randomUUID(),
      code: codeUpper,
      discount,
      expiry,
      createdAt: new Date().toISOString()
    };

    data.menuVoucher.push(newVoucher);
    console.log("â• Voucher ditambahkan:", newVoucher);
  }

  await saveDataToDB(1, data);

  renderVoucher(data.menuVoucher);

  alert("âœ… Voucher berhasil disimpan!");
}

  function renderVoucher(vouchers = []) {
  const box = document.getElementById("voucherPreview");
  if (!box) return;

  if (!Array.isArray(vouchers)) vouchers = [];

  const today = new Date();
  vouchers = vouchers.filter(v => new Date(v.expiry) >= today);

  if (vouchers.length === 0) {
    box.innerHTML = "<em>Belum ada voucher aktif</em>";
    return;
  }

  box.innerHTML = `
    <h3>Voucher Aktif</h3>
    ${vouchers.map(v => `
      <div class="voucher-item" style="border:1px solid #ccc; padding:8px; margin:8px 0; border-radius:8px;">
        <p><strong>Kode Voucher:</strong>
          <span class="voucher-code">${v.code}</span>
          <button onclick="copyVoucherCode('${v.code}')">ğŸ“‹ Copy</button>
        </p>
        <p><strong>Diskon:</strong> ${v.discount}%</p>
        <p><strong>Berlaku sampai:</strong> ${v.expiry}</p>
      </div>
    `).join("")}
  `;
}

  function copyVoucherCode(code) {
  if (!code) return;

  // Method modern
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(code)
      .then(() => {
        alert(`Kode voucher "${code}" berhasil disalin!`);
      })
      .catch(err => {
        console.error("Clipboard error:", err);
        fallbackCopy(code);
      });
  } else {
    // Fallback lama
    fallbackCopy(code);
  }
}

function fallbackCopy(text) {
  const tempInput = document.createElement("input");
  tempInput.value = text;
  document.body.appendChild(tempInput);
  tempInput.select();
  document.execCommand("copy");
  tempInput.remove();
  alert(`Kode voucher "${text}" berhasil disalin!`);
}

</script>
<script>
/* ============================================================
   1. PRELOAD + UNLOCK AUDIO
============================================================ */
let notifAudio;

document.addEventListener("DOMContentLoaded", () => {
  initVoucherToggle(); // <<<<<<<<<< ini yang benar
  notifAudio = new Audio("beep.mp3");
  notifAudio.load();

  const unlock = () => {
    notifAudio.play().then(() => {
      notifAudio.pause();
      notifAudio.currentTime = 0;
    }).catch(()=>{});
    document.body.removeEventListener("click", unlock);
  };
  document.body.addEventListener("click", unlock);

  startRealtimeOrderChecker();
});

/* ============================================================
   2. MAIN SOUND
============================================================ */
function playNotifSound() {
  if (!notifAudio) return;
  notifAudio.currentTime = 0;
  notifAudio.play().catch(()=>{});
}

/* ============================================================
   3. Helpers
============================================================ */
function idbGetAll(store) {
  return new Promise((resolve, reject) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

function updateReceiveBadge(count) {
  const badge = document.getElementById("receiveBadge");
  if (!badge) return;

  if (count > 0) {
    badge.style.display = "inline-block";
    badge.textContent = count;
  } else {
    badge.style.display = "none";
  }
}

/* ============================================================
   4. REALTIME CHECK ORDERS
============================================================ */
let lastCount = 0;

async function cekOrderBaru() {
  try {
    const db = await initDB();
    const tx = db.transaction("ordersData", "readonly");
    const store = tx.objectStore("ordersData");

    const all = await idbGetAll(store);
    const newCount = all.filter(o => o.status === "new").length;

    updateReceiveBadge(newCount);

    // Bunyi hanya ketika jumlah new bertambah
    if (newCount > lastCount) {
      playNotifSound();
    }

    lastCount = newCount;

  } catch (err) {
    console.error("âŒ cekOrderBaru error:", err);
  }
}

/* ============================================================
   5. LOOP REALTIME (1 detik)
============================================================ */
let intervalStarted = false;

function startRealtimeOrderChecker() {
  if (intervalStarted) return;  // jaga jangan double
  intervalStarted = true;

  // Jalan tiap 1 detik (super ringan)
  cekOrderBaru(); 
  setInterval(cekOrderBaru, 1000);
}

/* ============================================================
   6. Mark as read + go
============================================================ */
async function markOrdersAsRead() {
  try {
    const db = await initDB();
    const tx = db.transaction("ordersData", "readwrite");
    const store = tx.objectStore("ordersData");

    const all = await idbGetAll(store);

    for (const o of all) {
      if (o.status === "new") {
        o.status = "read";
        store.put(o);
      }
    }

    updateReceiveBadge(0);
    lastCount = 0;

  } catch (err) {
    console.error("âŒ markOrdersAsRead error:", err);
  }
}

function markViewedAndGo() {
  markOrdersAsRead();
  window.location.href = "recieves.html";
}
</script>

</body>
</html>

















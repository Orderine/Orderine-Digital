<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>Admin Orderine</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      padding-bottom: 80px;
      background: linear-gradient(135deg, #003366, #003366);
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
   /* =====================
   MOBILE-FIRST LOGO & HEADER
   ===================== */
.menuva-logo {
  text-align: center;
  margin-bottom: 10px;
  padding: 0 10px; /* beri sedikit jarak kiri-kanan di HP */
}

.menuva-logo img {
  max-width: 70%;   /* logo menyesuaikan lebar layar HP */
  height: auto;     /* menjaga proporsi asli */
  max-height: 80px; /* batasi tinggi supaya tidak terlalu besar */
  display: block;
  margin: 0 auto;   /* center logo */
}

.menuva-logo p {
  color: white;
  font-size: 13px;  /* ukuran font nyaman di HP */
  margin: 4px 0 0 0;
  line-height: 1.3;
}

/* =====================
   TABLET (min-width: 481px)
   ===================== */
@media (min-width: 481px) {
  .menuva-logo img {
    max-width: 50%;
    max-height: 90px;
  }
  .menuva-logo p {
    font-size: 14px;
  }
}

/* =====================
   DESKTOP (min-width: 769px)
   ===================== */
@media (min-width: 769px) {
  .menuva-logo img {
    max-width: 35%;
    max-height: 100px;
  }
  .menuva-logo p {
    font-size: 16px;
  }
}
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .menu-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .menu-item input {
      flex: 1 1 40%;
    }
    .menu-item button {
      flex: 1 1 auto;
      white-space: nowrap;
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-secondary {
      background-color: #3498db;
      color: white;
    }
    .btn-orange {
      background-color: orange;
      color: white;
      border: none;
    }
    .preview img {
      max-width: 100px;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .menu-item input, .menu-item button {
        width: 100%;
      }
    }
    .room-section > div:nth-child(2) button {
      padding: 6px 14px;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .room-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .room-form {
      padding: 10px;
      border: 1px dashed #ccc;
      margin-bottom: 12px;
      border-radius: 6px;
      background-color: #fff;
    }
    .room-form input[type="text"],
    .room-form input[type="number"],
    .room-form input[type="file"] {
      display: block;
      margin-bottom: 8px;
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    .room-form .room-preview img {
      max-height: 80px;
      margin-top: 4px;
    }
    .gambar-preview-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .gambar-preview {
      height: auto !important;
      width: auto !important;
      max-height: 200px !important;
      max-width: 100% !important;
      display: block;
    }
    .hapus-gambar {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .hapus-gambar:hover { background: #cc0000; }
    .btn-hapus-gambar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: red;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s, transform 0.1s ease;
    }
    .btn-hapus-gambar:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .section-box {
      border: none;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
      background: #fff;
    }
    .section-box h2,
    .section-box h3 { margin-top: 0; }
    .room-section { margin-bottom: 20px; }
    .room-section button {
      margin-bottom: 10px;
      background-color: #17a2b8;
    }
    .btn-simpan {
      background-color: #17a2b8;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-tambah-room {
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(127, 90, 240, 0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-tambah-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(44, 181, 232, 0.5);
    }
    .btn-hapus-room {
      background: linear-gradient(135deg, #ff6b6b, #fbc687);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-hapus-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(251, 198, 135, 0.5);
    }
    .btn-upload-gambar {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    .btn-upload-gambar:hover { opacity: 0.85; }
  
    /* Style umum untuk tombol aksi penting */
.btn-action {
  display: inline-block;
  padding: 10px 16px;
  margin: 6px 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Copy Link ‚Üí biru elegan */
#btnSalinLink.btn-action {
  background: #007BFF;
}
#btnSalinLink.btn-action:hover {
  background: #0056b3;
}

/* Download QR ‚Üí hijau segar */
#btnDownloadQR.btn-action {
  background: #28a745;
}
#btnDownloadQR.btn-action:hover {
  background: #1e7e34;
}

/* Print QR ‚Üí oranye elegan */
#btnPrintQR.btn-action {
  background: #fd7e14;
}
#btnPrintQR.btn-action:hover {
  background: #e8590c;
}

/* Backup Data ‚Üí ungu premium */
#btnBackup.btn-action {
  background: #6f42c1;
}
#btnBackup.btn-action:hover {
  background: #5936a2;
}
/* Blue ‚Äì untuk backup */
.btn-blue {
  background: linear-gradient(135deg, #3b82f6, #1e3a8a);
  color: white;
}
.btn-blue:hover {
  background: linear-gradient(135deg, #1e3a8a, #172554);
  transform: scale(1.05);
}
/* Base style tombol */
button {
  padding: 10px 16px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
}

/* Orange ‚Äì utama */
.btn-orange {
  background: linear-gradient(135deg, #ff914d, #ff6a00);
  color: white;
}
.btn-orange:hover {
  background: linear-gradient(135deg, #ff6a00, #cc5500);
  transform: scale(1.05);
}

/* Teal ‚Äì untuk salin link */
.btn-teal {
  background: linear-gradient(135deg, #20c997, #0f766e);
  color: white;
}
.btn-teal:hover {
  background: linear-gradient(135deg, #0f766e, #0c5f56);
  transform: scale(1.05);
}

/* Purple ‚Äì untuk download */
.btn-purple {
  background: linear-gradient(135deg, #a855f7, #6b21a8);
  color: white;
}
.btn-purple:hover {
  background: linear-gradient(135deg, #6b21a8, #4c1d95);
  transform: scale(1.05);
}

/* Red ‚Äì untuk print */
.btn-red {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  color: white;
}
.btn-red:hover {
  background: linear-gradient(135deg, #b91c1c, #7f1d1d);
  transform: scale(1.05);
}
 .setting-card {
    background: linear-gradient(135deg, #ffffff, #f9fafb);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .setting-card h2 {
    font-size: 18px;
    margin: 0 0 12px;
    color: #1e293b;
  }

  /* Switch toggle elegan */
  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 32px;
    margin-right: 10px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: #cbd5e1;
    transition: .4s;
    border-radius: 32px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background: linear-gradient(135deg, #2563eb, #1e40af);
  }
  input:checked + .slider:before {
    transform: translateX(28px);
  }

  .setting-label {
    font-size: 12px;
    font-weight: 600;
    color: #334155;
    vertical-align: middle;
  }

    /* Tombol simpan voucher */
  #saveVoucherBtn {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  #saveVoucherBtn:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }

  /* Tombol copy voucher */
  #voucherPreview button {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  #voucherPreview button:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }
  .fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: linear-gradient(135deg, #003366, #003366);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 999;
}

  .nav-item {
  flex: 1;
  text-align: center;
  padding: 6px 0;
  cursor: pointer;
  user-select: none;
  transition: 0.2s ease;
}

.nav-item .icon {
  font-size: 24px;
  color: #fff;
  transition: color 0.2s ease;
}

.nav-item .label {
  margin-top: 4px;
  font-size: 12px;
  color: #fff;
  transition: color 0.2s ease;
}

/* üî• Hover / sentuh ‚Üí jadi emas */
.nav-item:hover .icon,
.nav-item:active .icon,
.nav-item:hover .label,
.nav-item:active .label {
  color: #d4af37; /* warna emas */
}
.icon-wrapper {
  position: relative;
  display: inline-block;
}

.badge {
  position: absolute;
  top: -6px;
  right: -10px;
  background: red;
  color: white;
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 12px;
  font-weight: bold;
  display: none; /* awalnya disembunyikan */
}

  </style>
</head>
<body>
<div class="menuva-logo">
  <img src="menuva-logo.png" alt="Logo Menuva">
  <br>
  <p style="color: white;">Digital Solution For Restaurant, Hotel, & Cafe's</p>
</div>

<div class="section">
  <h2>üìá Business Identity</h2>
  
  <label for="logoInput">Your Business Logo</label>
  <input type="file" id="logoInput" name="logoInput" accept="image/*" />

  <img id="previewLogo" src="" alt="Logo Restoran" style="max-height: 80px; margin-top: 10px;" />

  <label for="namaRestoran">Your Business Name</label>
  <input type="text" id="namaRestoran" name="namaRestoran" placeholder="Your Business Name" />

  <label for="restoAddress">Your Business Address</label>
  <input id="restoAddress" name="restoAddress" type="text" placeholder="Jl. Sudirman No. 10, Jakarta" />

  <label for="restoPhone">Phone Number</label>
  <input id="restoPhone" name="restoPhone" type="text" placeholder="08xx-xxxx-xxxx" />
</div>

<div class="section">
  <h2>üî• Menu Promo</h2>
  <div id="promoContainer"></div>
  <button class="btn-orange" onclick="tambahPromo()">+ Add Promo Menu</button>
</div>

<div class="section">
  <h2>üìã SPECIAL MENU</h2>
  <div id="menuSpecialContainer"></div>
  <button class="btn-success" onclick="tambahMenu('special')">+ Add Special Menu</button>
</div>

<div class="section">
  <h2>üìã FOOD MENU</h2>
  <div id="menuFoodContainer"></div>
  <button class="btn-success" onclick="tambahMenu('food')">+ Add Menu</button>
</div>

<div class="section">
  <h2>üìã SNACK & DESSERT</h2>
  <div id="menuSnackContainer"></div>
  <button class="btn-success" onclick="tambahMenu('snack')">+ Add Menu</button>
</div>

<div class="section">
  <h2>üìã DRINK</h2>
  <div id="menuDrinkContainer"></div>
  <button class="btn-success" onclick="tambahMenu('drink')">+ Add Menu</button>
</div>

<div class="section-box" id="waContainerBox">
  <h3>üì± Admin WhatsApp Number (Order/Reservation Recipient)</h3>
  <div id="nomorWaContainer">
    <label for="waNumber1" class="sr-only">WhatsApp Number</label>
    <input type="text" id="waNumber1" name="waNumber[]" class="nomor-wa" placeholder="Example: 6281234567890">
  </div>
  <button onclick="tambahNomorWa()">+ Add WA Number</button>
</div>

<div class="section">
  <h2>üì∏ Room Gallery</h2>
  <button onclick="tambahGambar('ruangan')">+ Add Room Image</button>
  <input type="file" id="flipbookRuanganUpload" name="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookRuanganPreview"></div>
</div>

<div class="section">
  <h2>üìñ Restaurant Menu</h2>
  <button onclick="tambahGambar('menu')">+ Add Menu Image</button>
  <input type="file" id="flipbookMenuUpload" name="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookMenuPreview"></div>
</div>

<div class="setting-card" id="orderToggleBox">
  <h2>‚öôÔ∏è Reservation & Delivery Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleOrderPage" name="toggleOrderPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Reservation & Delivery Page</span>
</div>

<div class="setting-card" id="roomToggleBox">
  <h2>‚öôÔ∏è Room Page Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleRoomPage" name="toggleRoomPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Room Page.</span>
</div>

<div class="section-box" id="roomContainerBox">
  <h2>üè® Room / Packages</h2>
  <div class="room-section">
    <h3>üõèÔ∏è Room Hotel</h3>
    <button onclick="tambahRoom('hotel')" class="btn-tambah-room">+ Add Hotel Room</button>
    <div id="roomHotelContainer"></div>
  </div>
  <div class="room-section">
    <h3>üíº Meeting Room</h3>
    <button onclick="tambahRoom('meeting')" class="btn-tambah-room">+ Add Meeting Room</button>
    <div id="meetingRoomContainer"></div>
  </div>
  <div class="room-section">
    <h3>üéÅ Packages</h3>
    <button onclick="tambahRoom('package')" class="btn-tambah-room">+ Add Packages</button>
    <div id="packageContainer"></div>
  </div>
</div>

<div class="section-box" id="voucherContainerBox">
  <h2>üéüÔ∏è Voucher Diskon</h2>
  <label class="switch">
    <input type="checkbox" id="toggleVoucherPage" name="toggleVoucherPage">
    <span class="slider round"></span>
  </label>

  <div id="voucherForm" style="margin-top:15px; display:none;">
    <label for="voucherCode">Voucher Code</label>
    <input type="text" id="voucherCode" name="voucherCode" placeholder="Kode Voucher">

    <label for="voucherDiscount">Discount (%)</label>
    <input type="number" id="voucherDiscount" name="voucherDiscount" placeholder="Diskon (%)">

    <label for="voucherExpiry">Expiry Date</label>
    <input type="date" id="voucherExpiry" name="voucherExpiry">

    <button id="saveVoucherBtn" onclick="saveVoucher()">üíæ Save Voucher Code</button>
  </div>

  <div id="voucherPreview"></div>
</div>

<hr>

<div class="section">
  <button class="btn-simpan" onclick="simpanData()">üíæ Save All</button>
  <input type="hidden" id="restoId" name="restoId" />

  <button id="btnOpenCustomer" class="btn-orange" onclick="openCustomerPage()">üëÅÔ∏è See Customer Page</button>
  <button id="btnSalinLink" class="btn-teal" style="display:none;">üìã Copy Link to Share with Customers</button>

  <div id="qrcodePreview" style="margin-top:10px;"></div>

  <button id="btnDownloadQR" class="btn-purple" style="margin-top:10px; display:none;">‚¨áÔ∏è Download QR Code</button>
  <button id="btnPrintQR" class="btn-red" style="margin-top:5px; display:none;">üñ®Ô∏è Print QR Code</button>

  <div class="section">
    <h2>üîÅ Backup & Restore Data</h2>
    <button id="btnBackup" class="btn-blue" onclick="backupData()">üì¶ Backup Data</button>
    <div id="backupDownloadLink" style="margin-top:10px;"></div>

    <label for="restoreInput" style="margin-top: 20px; display: block;">üìÇ Select JSON File to Restore:</label>
    <input type="file" id="restoreInput" name="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
  </div>
  
  <!-- Panduan -->
  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>Panduan Penggunaan:</strong><br>
    PENTING!!<br>
    üîπ Klik <strong>‚¨áÔ∏è Backup Data</strong> untuk menyimpan semua data restoran ke file <strong>.json</strong>.<br>
    üîπ Simpan file tersebut dengan baik.<br>
    üîπ Klik <strong>üìÇ Pilih File</strong> untuk me-restore data.<br>
    ‚ö†Ô∏è Proses restore menggantikan seluruh data saat ini.<br>
  </div>

  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>User Guide:</strong><br>
    IMPORTANT!!<br>
    üîπ Click <strong>‚¨áÔ∏è Backup Data</strong> to save all data.<br>
    üîπ Keep the file safe.<br>
    üîπ Click <strong>üìÇ Choose File</strong> to restore data.<br>
    ‚ö†Ô∏è The restore process replaces all existing data.<br>
  </div>

  <button onclick="resetData()" class="btn-danger">üóëÔ∏è Reset Data</button>
</div>

<div class="fixed-bar">
<div class="nav-item" onclick="markViewedAndGo()">
    <div class="icon-wrapper">
        <ion-icon name="cube-outline" class="icon"></ion-icon>
        <span id="receiveBadge" class="badge">0</span>
    </div>
    <div class="label">Receives</div>
</div>

   <div class="nav-item" onclick="window.location.href='index.html'">
    <ion-icon name="log-out-outline" class="icon"></ion-icon>
    <div class="label">Logout</div>
  </div>
</div>

 <script>
console.log("Admin Script Version: 2025-11-07-HYBRID-1");

// ====================== SUPABASE CLIENT ======================
const supabaseUrl = "https://yscjjisqvlbedtuomrmf.supabase.co"; 
const supabaseAnonKey = "sb_publishable_L69H0-PapAm3jMWrTyYayQ_4kOd2MMD";   
const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

let ONLINE_MODE = true; // akan otomatis jadi false jika supabase gagal
// ============================================================


// ====================== GLOBAL DB HANDLER =====================
let dbReady = null;
const DB_NAME = "MenuvaDB";
const STORE_NAME = "menuvaData";
const DB_VERSION = 10;

let dbInstance = null;


// ====================== CHECK INDEXEDDB AVAILABLE =============
if (!window.indexedDB) {
  alert("‚ö†Ô∏è Browser ini tidak mendukung IndexedDB!");
} else {
  const test = indexedDB.open("TestDB_Check");
  test.onerror = (e) => {
    console.error("‚ùå IndexedDB gagal dibuka:", e.target.error);
    alert("IndexedDB gagal dibuka di HP! Kemungkinan masalah izin browser.");
  };
  test.onsuccess = () => {
    console.log("‚úÖ IndexedDB bisa dibuka di perangkat ini");
    test.result.close();
    indexedDB.deleteDatabase("TestDB_Check");
  };
}

let dbPromise = null;


// ====================== INIT DB (IndexedDB) ====================
async function initDB() {
  if (dbInstance) return dbInstance;
  if (dbPromise) return dbPromise;

  dbPromise = new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onupgradeneeded = (e) => {
      const db = e.target.result;

      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "id" });
      }

      if (!db.objectStoreNames.contains("ordersData")) {
        db.createObjectStore("ordersData", {
          keyPath: "id",
          autoIncrement: true
        });
      }
    };

    request.onsuccess = (e) => {
      dbInstance = e.target.result;
      dbPromise = null;
      resolve(dbInstance);
    };

    request.onerror = (e) => {
      dbPromise = null;
      reject(e.target.error);
    };
  });

  return dbPromise;
}


// ====================== GET DB INSTANCE ========================
async function getDB() {
  if (dbInstance) return dbInstance;
  return await initDB();
}


// ====================== TEST SUPABASE CONNECTION ===============
(async () => {
  try {
    const { data, error } = await supabase.from("admin_healthcheck").select("id").limit(1);

    if (error) throw error;

    console.log("üåê Supabase Online Mode ‚Üí ACTIVE");
    ONLINE_MODE = true;

  } catch (err) {
    console.warn("‚ö† Supabase tidak dapat diakses, fallback ke Offline Mode");
    ONLINE_MODE = false;
  }
})();

async function saveDataToDB(id, newData) {
  console.groupCollapsed("üíæ [HYBRID SAVE] saveDataToDB()");

  // >>> LOG
  console.log("üü¶ NEW DATA MASUK:", JSON.parse(JSON.stringify(newData)));
  console.log("üü¶ newData.menuVoucher:", newData.menuVoucher);
  console.log("üü¶ newData.voucher (legacy):", newData.voucher);

  id = Number(id) || 1;

  const db = await getDB();
  const tx = db.transaction(STORE_NAME, "readwrite");
  const store = tx.objectStore(STORE_NAME);

  return new Promise((resolve, reject) => {
    const req = store.get(id);

    req.onsuccess = async () => {
      let oldData = req.result || buatDataDefault(id);

      // >>> LOG
      console.log("üü® OLD DATA SEBELUM MERGE:", JSON.parse(JSON.stringify(oldData)));
      console.log("üü® oldData.menuVoucher:", oldData.menuVoucher);

      // ==========================================================
      // üî• FIX MERGE UTAMA:
      // Jangan pernah timpa menuVoucher jika newData tidak punya.
      // ==========================================================
      let finalData = {
        ...oldData,
        ...newData,

        menuVoucher:
          Array.isArray(newData.menuVoucher)
            ? newData.menuVoucher            // newData punya ‚Üí pakai
            : Array.isArray(oldData.menuVoucher)
              ? oldData.menuVoucher          // newData ga punya ‚Üí pakai data lama
              : [],                          // kalau dua2nya ga ada ‚Üí default []
      };

      // >>> LOG
      console.log("üüß SETELAH MERGE (FIXED):", JSON.parse(JSON.stringify(finalData)));
      console.log("üüß finalData.menuVoucher (before legacy fix):", finalData.menuVoucher);

      // ==========================================================
      // üî• FIX LEGACY FIELD "voucher"
      // ==========================================================
      if (newData.voucher !== undefined && Array.isArray(newData.voucher)) {
        finalData.menuVoucher = newData.voucher.slice();

        console.log("üü£ AUTO-MAP legacy voucher ‚Üí menuVoucher:", finalData.menuVoucher);
      }

      // ==========================================================
      // Safety: menuVoucher harus selalu array
      // ==========================================================
      if (!Array.isArray(finalData.menuVoucher)) {
        console.warn("‚ö† menuVoucher corrupt ‚Üí reset []");
        finalData.menuVoucher = [];
        console.log("‚ùó menuVoucher CORRUPT, RESET ‚Üí []");
      }

      // Hapus field legacy supaya tidak bentrok
      delete finalData.voucher;

      // >>> LOG
      console.log("üü© FINAL DATA SIAP DISIMPAN:", JSON.parse(JSON.stringify(finalData)));
      console.log("üü© FINAL menuVoucher:", finalData.menuVoucher);

      // ===================== SAVE OFFLINE =====================
      const saveReq = store.put(finalData);

      saveReq.onsuccess = async () => {
        console.log("üíæ IndexedDB ‚Üí OK");

        // >>> LOG verifikasi
        const verify = store.get(id);
        verify.onsuccess = () => {
          console.log("üîÅ DATA TERSIMPAN DI INDEXEDDB:", JSON.parse(JSON.stringify(verify.result)));
          console.log("üîÅ IndexedDB.menuVoucher:", verify.result?.menuVoucher);
        };

        // ===================== SYNC ONLINE ======================
        if (ONLINE_MODE) {
          try {
            console.log("üåê Sync ke Supabase...");

            const { error } = await supabase
              .from("menuva_data")
              .update({
                data: finalData,
                updated_at: new Date().toISOString(),
              })
              .eq("id", id);

            if (error) throw error;

            console.log("üåê Supabase sync ‚Üí OK");

            // >>> LOG
            console.log("üåê DATA TERKIRIM KE SUPABASE:", JSON.parse(JSON.stringify(finalData)));
          } catch (err) {
            console.warn("‚ö† Supabase sync gagal:", err.message);
          }
        }

        console.groupEnd();
        resolve(finalData);
      };

      saveReq.onerror = (e) => {
        console.error("‚ùå IndexedDB save error:", e.target.error);
        console.groupEnd();
        reject(e.target.error);
      };
    };

    req.onerror = (e) => {
      console.error("‚ùå IndexedDB read error:", e.target.error);
      console.groupEnd();
      reject(e.target.error);
    };
  });
}

// ====================== FUNGSI 2 (LOAD) + LOG DETECTOR ======================
async function loadDataFromDB(id = 1) {
  console.groupCollapsed("üì• [HYBRID LOAD] loadDataFromDB()");

  // ============================================================
  // 1Ô∏è‚É£ LOAD DARI SUPABASE
  // ============================================================
  if (ONLINE_MODE) {
    try {
      console.log("üåê Mencoba load dari Supabase...");

      const { data, error } = await supabase
        .from("menuva_data")
        .select("data")
        .eq("id", id)
        .maybeSingle();

      if (error) console.warn("‚ö† Supabase error:", error.message);

      if (data && data.data) {
        const r = data.data;

        console.log("üß™ [CHECK] Supabase.r.voucher:", r.voucher);
        console.log("üß™ [CHECK] Supabase.r.menuVoucher:", r.menuVoucher);

        const safe = {
          id,
          restoId: r.restoId || "",
          namaRestoran: r.namaRestoran || "",
          restoAddress: r.restoAddress || "",
          restoPhone: r.restoPhone || "",
          logo: r.logo || "",

          categories: Array.isArray(r.categories) ? r.categories : [],

          menu: Array.isArray(r.menu) ? r.menu : [],
          menuPromo: Array.isArray(r.menuPromo) ? r.menuPromo : [],

          // ========== FIX WAJIB ==========
          menuVoucher:
            Array.isArray(r.menuVoucher)
              ? r.menuVoucher
              : (Array.isArray(r.voucher) ? r.voucher : []),

          rooms: Array.isArray(r.rooms) ? r.rooms : [],
          nomorWaAdmin: Array.isArray(r.nomorWaAdmin) ? r.nomorWaAdmin : [],

          flipbookRuanganImages: Array.isArray(r.flipbookRuanganImages)
            ? r.flipbookRuanganImages
            : [],

          flipbookMenuImages: Array.isArray(r.flipbookMenuImages)
            ? r.flipbookMenuImages
            : []
        };

        console.log("üåê Supabase SAFE-FIX:", safe);
        console.groupEnd();
        return safe;
      }
    } catch (err) {
      console.warn("‚ö† Supabase load error:", err);
    }
  }

  // ============================================================
  // 2Ô∏è‚É£ Fallback IndexedDB
  // ============================================================
  try {
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);

    const data = await new Promise((resolve, reject) => {
      const req = store.get(id);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error);
    });

    if (data) {
      console.log("üì¶ IndexedDB raw:", data);
      console.log("üß™ IndexedDB.voucher:", data.voucher);
      console.log("üß™ IndexedDB.menuVoucher:", data.menuVoucher);

      // ====== DETEKSI BUG ======
      if (Array.isArray(data.voucher) && data.voucher.length > 0 &&
          Array.isArray(data.menuVoucher) && data.menuVoucher.length === 0) {
        console.error("üî• FOUND ROOT CAUSE: FIELD voucher ADA TAPI menuVoucher KOSONG ‚Üí patch membunuh voucher!");
      }

      // patch official
      if (!Array.isArray(data.menuVoucher)) {
        data.menuVoucher = Array.isArray(data.voucher) ? data.voucher : [];
      }
      delete data.voucher;

      console.log("üì¶ IndexedDB setelah patch:", data);
      console.groupEnd();
      return data;
    }
  } catch (err) {
    console.warn("‚ö† IndexedDB load error:", err);
  }

  // ============================================================
  // 3Ô∏è‚É£ Default data
  // ============================================================
  console.warn("‚ö† Tidak ada data ‚Üí default");
  const def = buatDataDefault(id);
  console.groupEnd();
  return def;
}

function buatDataDefault(id = 1) {
  return {
    id: Number(id) || 1,

    // ======================
    // DATA RESTORAN
    // ======================
    restoId: "",
    namaRestoran: "",
    restoAddress: "",
    restoPhone: "",
    logo: "",
    background: "",

    // ======================
    // DATA MENU
    // ======================
    menu: [],              // menu utama
    menuData: [],          // kompatibilitas script lama
    menuPromo: [],         // promosi

    // ======================
    // VOUCHER (WAJIB SINKRON OPSI A)
    // ======================
    voucher: [],           // ‚Üê field utama yang dipakai Supabase + UI
    menuVoucher: [],       // ‚Üê backup agar script lama tidak error, nanti di-sync otomatis

    // ======================
    // ROOM / FLIPBOOK
    // ======================
    rooms: [],
    flipbookRuanganImages: [],
    flipbookMenuImages: [],

    // ======================
    // NOMOR WA ADMIN
    // ======================
    nomorWaAdmin: []
  };
}

   // ====================== GLOBAL ======================
let menuPromo = [];
let flipbookRuanganImages = [];
let flipbookMenuImages = [];

// ====================== PROMO UI RENDERER ======================
function renderPromoUI() {
  const container = document.getElementById("promoContainer");
  if (!container) return;

  container.innerHTML = "";
  const promoCategories = ["PROMO", "DISKON", "SPECIAL", "EVENT"];

  menuPromo.forEach((promo, index) => {
    const div = document.createElement("div");
    div.className = "menu-item";

    const optionsHTML = promoCategories
      .map(cat => `<option value="${cat}" ${promo.kategori === cat ? "selected" : ""}>${cat}</option>`)
      .join("");

    div.innerHTML = `
      <input type="text" id="promoName_${index}" value="${promo.namaPromo || ""}"
        onchange="updatePromo(${index}, 'namaPromo', this.value)">
      
      <input type="file" accept="image/*" onchange="uploadPromoImage(event, ${index})">
      <img id="promoImgPreview${index}" src="${promo.image || ""}" style="max-height:80px;margin:5px 0">
      
      <input type="text" placeholder="Description Promo"
        value="${promo.deskripsi || ""}" onchange="updatePromo(${index}, 'deskripsi', this.value)">
      
      <input type="number" placeholder="Promo Price"
        value="${promo.harga || ""}" onchange="updatePromo(${index}, 'harga', this.value)">
      
      <select onchange="updatePromo(${index}, 'kategori', this.value)">
        ${optionsHTML}
      </select>
      
      <input type="date" value="${promo.tanggalAkhir || ""}"
        onchange="updatePromo(${index}, 'tanggalAkhir', this.value)">
      
      <button class="btn-danger" onclick="hapusPromo(${index})">Delete Promo List</button>
    `;

    container.appendChild(div);
  });
}

// ====================== ADD PROMO ======================
function tambahPromo(promo = {}) {
  menuPromo.push({
    namaPromo: promo.namaPromo || "",
    image: promo.image || "",
    deskripsi: promo.deskripsi || "",
    harga: promo.harga || "",
    kategori: promo.kategori || "PROMO",
    tanggalAkhir: promo.tanggalAkhir || ""
  });

  renderPromoUI();
  scheduleHybridSave();
}

// ====================== UPDATE PROMO ======================
function updatePromo(index, key, value) {
  if (!menuPromo[index]) return;
  menuPromo[index][key] = value;
  scheduleHybridSave();
}

// ====================== DELETE PROMO ======================
function hapusPromo(index) {
  menuPromo.splice(index, 1);
  renderPromoUI();
  scheduleHybridSave();
}

// ====================== IMAGE UPLOAD ======================
function uploadPromoImage(event, index) {
  const file = event.target.files[0];
  if (!file) return;

  resizeIfNeeded(file)
    .then((resized) => {
      const el = document.getElementById(`promoImgPreview${index}`);
      if (el) el.src = resized;

      updatePromo(index, "image", resized);
    })
    .catch(err => console.error("Failed upload promo:", err));
}

// ====================== HYBRID SAVE SCHEDULER ======================
function scheduleHybridSave() {
  if (window._saveTimeout) clearTimeout(window._saveTimeout);
  window._saveTimeout = setTimeout(() => simpanDataHybrid(), 300);
}

// ====================== HYBRID SAVE CORE ======================
async function simpanDataHybrid() {

 // Voucher UI selalu pakai menuVoucher
// Voucher lama (voucher) biasanya kosong ‚Üí jangan dipakai
const syncedVoucher = Array.isArray(menuVoucher) ? menuVoucher : [];

  const finalData = {
    // ======================
    // DATA RESTORAN
    // ======================
    restoId,
    namaRestoran,
    restoAddress,
    restoPhone,
    logo,
    background,

    // ======================
    // KATEGORI
    // ======================
    categories,

    // ======================
    // MENU
    // ======================
    menu,
    menuPromo,

    // ======================
    // VOUCHER (OPSI A WAJIB)
    // ======================
    voucher: syncedVoucher,        // field utama (Supabase)
    menuVoucher: syncedVoucher,    // field lama (UI)

    // ======================
    // ROOM / FLIPBOOK
    // ======================
    rooms,
    flipbookRuanganImages,
    flipbookMenuImages,

    // ======================
    // NOMOR WA ADMIN
    // ======================
    nomorWaAdmin
  };

  try {
    await saveDataToDB(1, finalData);   // IndexedDB + auto sync Supabase
    console.log("üçΩÔ∏è Hybrid Save OK (IndexedDB + Supabase)");
  } catch (err) {
    console.error("‚ùå Hybrid save failed:", err);
  }
}

// ====================== SUPABASE SAVE (OPSI A FINAL) ======================
// Catatan:
// - Supabase sudah di-sync melalui saveDataToDB()
// - Fungsi ini tetap ada agar tidak merusak script yang masih memanggilnya
// - Tidak melakukan upsert lagi (mencegah double save & error 400)

async function saveDataToSupabase(id, data) {
  console.log("‚ÑπÔ∏è [OPSI A] saveDataToSupabase() dipanggil");

  try {
    // Tidak usah simpan ke Supabase lagi
    console.log("‚òÅÔ∏è Skip Supabase sync (karena OPSI A pakai saveDataToDB untuk sync utama)");
  } catch (err) {
    console.error("‚ùå saveDataToSupabase wrapper error:", err.message);
  }
}

// ====================== MENU ======================
// Tambah menu ke kategori (UI)
function tambahMenu(kategori = "food", nama = "", harga = "", image = "") {
  const containerId = {
    food: "menuFoodContainer",
    snack: "menuSnackContainer",
    drink: "menuDrinkContainer",
    special: "menuSpecialContainer"
  }[kategori] || "menuFoodContainer";

  const container = document.getElementById(containerId);
  if (!container) return;

  const uid = Date.now(); // ID unik untuk tiap field

  const div = document.createElement("div");
  div.className = "menu-item";
  div.innerHTML = `
    <input type="text" id="menuName_${uid}" placeholder="Menu Name" value="${nama}"
      onchange="scheduleMenuSave()">
    
    <input type="number" id="menuPrice_${uid}" placeholder="Price" value="${harga}"
      onchange="scheduleMenuSave()">
    
    <select id="menuCat_${uid}" onchange="scheduleMenuSave()">
      <option value="food" ${kategori === "food" ? "selected" : ""}>Food</option>
      <option value="snack" ${kategori === "snack" ? "selected" : ""}>Snack</option>
      <option value="drink" ${kategori === "drink" ? "selected" : ""}>Drink</option>
      <option value="special" ${kategori === "special" ? "selected" : ""}>Special</option>
    </select>

    <input type="file" id="menuImage_${uid}" accept="image/*"
      onchange="uploadMenuImage(event, this)">

    <img class="menuPreview" src="${image}" 
      style="max-height:80px;margin:5px 0; ${image ? "" : "display:none"}">

    <button class="btn-danger" onclick="hapusMenuItem(this)">Delete</button>
  `;
  
  container.appendChild(div);

  // ======================= FIX PENTING !!! =======================
  const fileInput = div.querySelector(`#menuImage_${uid}`);
  if (image && fileInput) {
    fileInput.setAttribute("data-image", image); // ‚ûú memastikan image tidak hilang
  }

  scheduleMenuSave();
}

// ====================== UPLOAD GAMBAR ======================
function uploadMenuImage(event, inputEl) {
  const file = event.target.files[0];
  if (!file) return;

  resizeIfNeeded(file)
    .then((resized) => {
      const preview = inputEl.parentElement.querySelector(".menuPreview");
      preview.src = resized;
      preview.style.display = "block";
      inputEl.setAttribute("data-image", resized);

      scheduleMenuSave();
    })
    .catch(err => console.error("Upload menu image failed:", err));
}

// ====================== HAPUS MENU ITEM ======================
function hapusMenuItem(btn) {
  btn.parentElement.remove();
  scheduleMenuSave();
}

// ====================== BACA MENU DARI UI ======================
function ambilMenu(containerId) {
  const container = document.getElementById(containerId);
  const items = container ? container.querySelectorAll(".menu-item") : [];
  const result = [];

  items.forEach(item => {
    const nama = item.querySelector("input[type='text']")?.value || "";
    const harga = parseInt(item.querySelector("input[type='number']")?.value || "0");
    const kategori = item.querySelector("select")?.value || "food";
    const image = item.querySelector("input[type='file']")?.getAttribute("data-image") || "";

    if (nama && harga) {
      result.push({ nama, harga, kategori, image });
    }
  });

  return result;
}

// ====================== AUTO HYBRID SAVE ======================
function scheduleMenuSave() {
  if (window._menuSaveTimeout) clearTimeout(window._menuSaveTimeout);
  window._menuSaveTimeout = setTimeout(() => simpanMenuHybrid(), 300);
}

// ====================== HYBRID SAVE CORE ======================
async function simpanMenuHybrid() {
  const finalMenu = [
    ...ambilMenu("menuFoodContainer"),
    ...ambilMenu("menuSnackContainer"),
    ...ambilMenu("menuDrinkContainer"),
    ...ambilMenu("menuSpecialContainer")
  ];

  const finalData = { menu: finalMenu };

  try {
    await saveDataToDB(1, finalData);        // IndexedDB
    await saveDataToSupabase(1, finalData);  // Supabase
    console.log("üçΩÔ∏è Menu hybrid save OK");
  } catch (err) {
    console.error("‚ùå Gagal hybrid save menu:", err);
  }
}

// ====================== ROOM ======================
function tambahRoom(kategori) {
  const containerId = {
    hotel: "roomHotelContainer",
    meeting: "meetingRoomContainer",
    package: "packageContainer"
  }[kategori];

  if (!containerId) return;

  const container = document.getElementById(containerId);
  const wrapper = document.createElement("div");
  wrapper.className = "room-form";

  const uid = `${kategori}_${Date.now()}`;

  wrapper.innerHTML = `
    <input type="text" id="${uid}_nama" class="room-nama" placeholder="Name" autocomplete="off"/>
    <input type="number" id="${uid}_harga" class="room-harga" placeholder="Price" min="0" step="1000"/>
    <input type="number" id="${uid}_kapasitas" class="room-kapasitas" placeholder="Capacity (Person)" min="1"/>
    <input type="number" id="${uid}_luas" class="room-luas" placeholder="Room size (m¬≤)" min="1"/>
    <textarea id="${uid}_deskripsi" class="room-deskripsi" placeholder="Notes" rows="2"></textarea>

    <div class="gambar-preview-wrapper">
      <img id="${uid}_preview" class="gambar-preview" style="display:none; max-width:120px; margin-top:6px; border-radius:6px;" />
      <button type="button" class="hapus-gambar" onclick="hapusGambarRoom(this)" style="display:none;">√ó</button>
    </div>

    <button type="button" id="${uid}_uploadBtn" class="btn-upload-gambar room-image-upload" onclick="uploadGambarRoom(this)">üñºÔ∏è Upload Image</button>
    <button type="button" id="${uid}_hapusBtn" class="btn-hapus-room" onclick="hapusFormRoom(this)">üóëÔ∏è Delete</button>
    <hr>
  `;

  container.appendChild(wrapper);
}

function ambilSemuaRoom() {
  const kategoriIds = [
    { id: "roomHotelContainer", kategori: "hotel" },
    { id: "meetingRoomContainer", kategori: "meeting" },
    { id: "packageContainer", kategori: "package" }
  ];

  const hasil = [];

  kategoriIds.forEach(({ id, kategori }) => {
    const container = document.getElementById(id);
    if (!container) return;

    const forms = container.querySelectorAll(".room-form");
    forms.forEach(form => {
      const nama = form.querySelector(".room-nama")?.value || "";
      const harga = parseInt(form.querySelector(".room-harga")?.value || "0");
      const kapasitas = parseInt(form.querySelector(".room-kapasitas")?.value || "0");
      const luas = parseInt(form.querySelector(".room-luas")?.value || "0");
      const deskripsi = form.querySelector(".room-deskripsi")?.value || "";
      const image = form.querySelector(".room-image-upload")?.getAttribute("data-image") || "";

      if (nama && harga) {
        hasil.push({
          id: "R" + Date.now() + Math.floor(Math.random() * 1000),
          nama,
          harga,
          kapasitas,
          luas,
          deskripsi,
          image,
          kategori
        });
      }
    });
  });

  return hasil;
}

function restoreRoomFromData(rooms = []) {
  rooms.forEach(room => {
    tambahRoom(room.kategori);

    const containerId = {
      hotel: "roomHotelContainer",
      meeting: "meetingRoomContainer",
      package: "packageContainer"
    }[room.kategori];

    const container = document.getElementById(containerId);
    const forms = container.querySelectorAll(".room-form");
    const lastForm = forms[forms.length - 1];

    lastForm.querySelector(".room-nama").value = room.nama || "";
    lastForm.querySelector(".room-harga").value = room.harga || "";
    lastForm.querySelector(".room-kapasitas").value = room.kapasitas || "";
    lastForm.querySelector(".room-luas").value = room.luas || "";
    lastForm.querySelector(".room-deskripsi").value = room.deskripsi || "";

    const preview = lastForm.querySelector(".gambar-preview");
    const hapusBtn = lastForm.querySelector(".hapus-gambar");
    const uploadBtn = lastForm.querySelector(".room-image-upload");

    if (room.image) {
      preview.src = room.image;
      preview.style.display = "block";
      hapusBtn.style.display = "flex";
      uploadBtn.setAttribute("data-image", room.image);
    }
  });
}

function uploadGambarRoom(button) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = event => {
      const wrapper = button.closest(".room-form");
      const preview = wrapper.querySelector(".gambar-preview");
      const hapusBtn = wrapper.querySelector(".hapus-gambar");
      const imageUrl = event.target.result;

      preview.src = imageUrl;
      preview.style.display = "block";
      hapusBtn.style.display = "flex";
      button.setAttribute("data-image", imageUrl);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function hapusGambarRoom(button) {
  const wrapper = button.closest(".room-form");
  wrapper.querySelector(".gambar-preview").style.display = "none";
  wrapper.querySelector(".gambar-preview").src = "";
  wrapper.querySelector(".room-image-upload").removeAttribute("data-image");
  button.style.display = "none";
}

function hapusFormRoom(button) {
  const form = button.closest(".room-form");
  if (form) {
    form.remove();
    if (window._saveTimeout) clearTimeout(window._saveTimeout);
    window._saveTimeout = setTimeout(() => { simpanData().catch(console.error); }, 300);
  }
}

// ====================== UI: Tampilkan List Room ======================
async function tampilkanListRoom() {
  try {
    const restoId =
      document.getElementById("restoId")?.value ||
      document.getElementById("restoPhone")?.value ||
      null;

    const rooms = await loadRoomsHybrid(restoId);
    const listContainer = document.getElementById("listRuangan");
    if (!listContainer) return;

    listContainer.innerHTML = "";

    if (!rooms || rooms.length === 0) {
      listContainer.innerHTML = "<p>Tidak ada ruangan yang tersedia.</p>";
      return;
    }

    rooms.forEach((room, index) => {
      const item = document.createElement("div");
      item.classList.add("room-card");
      item.innerHTML = `
        <strong>Ruangan ${index + 1}</strong><br>
        üè∑Ô∏è Nama: ${room.nama}<br>
        üíº Kategori: ${room.kategori}<br>
        üí∞ Harga: Rp${room.harga}<br>
        üë• Kapasitas: ${room.kapasitas}<br>
        üìê Luas: ${room.luas} m¬≤<br>
        üìù Catatan: ${room.deskripsi}
        <hr>
      `;
      listContainer.appendChild(item);
    });
  } catch (err) {
    console.error("Failed to display room list:", err);
  }
}

// ====================== HYBRID SAVE: Rooms ======================
async function simpanRoomsHybrid(restoId) {
  try {
    console.groupCollapsed("üíæ [HYBRID] Simpan Rooms");

    const rooms = ambilSemuaRoom();

    // --- IndexedDB ---
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);

    const existing = (await store.get(Number(restoId))) || buatDataDefault(restoId);
    existing.rooms = rooms;
    await store.put(existing);

    console.log("IndexedDB rooms OK");

    // --- Supabase ---
    const { error } = await supabase
      .from("menuva_master")
      .update({ rooms })
      .eq("id", restoId);

    if (error) {
      console.warn("‚ö†Ô∏è Supabase gagal update rooms:", error.message);
    } else {
      console.log("Supabase rooms OK");
    }

    console.groupEnd();
    return true;
  } catch (err) {
    console.error("‚ùå Error Hybrid Save Rooms:", err);
    return false;
  }
}

// ====================== HYBRID LOAD: Rooms ======================
async function loadRoomsHybrid(restoId) {
  console.groupCollapsed("üì• [HYBRID] Load Rooms");

  let rooms = [];

  // --- Supabase ---
  try {
    const { data, error } = await supabase
      .from("menuva_master")
      .select("rooms")
      .eq("id", restoId)
      .maybeSingle();

    if (!error && data?.rooms) rooms = data.rooms;
  } catch (err) {
    console.warn("Supabase load failed:", err);
  }

  // --- Fallback to IndexedDB ---
  if (!rooms.length) {
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const local = await store.get(Number(restoId));
    rooms = local?.rooms || [];
  }

  console.groupEnd();
  return rooms;
}

// ====================== NOMOR WHATSAPP ======================
function tambahNomorWa(value = "") {
  const container = document.getElementById("nomorWaContainer");
  if (!container) return;

  const count = container.querySelectorAll(".nomor-wa").length;
  const uniqueId = `nomorWa${count + 1}`;

  const input = document.createElement("input");
  input.type = "text";
  input.id = uniqueId;
  input.name = uniqueId;
  input.className = "nomor-wa";
  input.placeholder = "Example: 6281234567890";
  input.inputMode = "numeric";
  input.autocomplete = "off";
  input.pattern = "62[0-9]{8,}";
  input.title = "Gunakan format: 6281234567890";

  input.value = value || "";

  input.addEventListener("input", () => {
    input.value = input.value.replace(/[^0-9]/g, "");
  });

  container.appendChild(input);
}

// Ambil seluruh nomor WA dari form
function ambilNomorWa() {
  const container = document.getElementById("nomorWaContainer");
  if (!container) return [];
  const inputs = container.querySelectorAll(".nomor-wa");
  const list = [];

  inputs.forEach(i => {
    const val = i.value.trim();
    if (val.startsWith("62") && val.length >= 10) list.push(val);
  });

  return list;
}

// Restore dari database ‚Üí render ulang input
function restoreNomorWa(list = []) {
  const container = document.getElementById("nomorWaContainer");
  if (!container) return;

  container.innerHTML = ""; // bersihkan

  if (!Array.isArray(list) || list.length === 0) {
    tambahNomorWa(""); // tambahkan 1 kosong
    return;
  }

  list.forEach(no => tambahNomorWa(no));
}


// ====================== HYBRID SAVE: NOMOR WA ======================
async function simpanNomorWaHybrid(restoId) {
  try {
    console.groupCollapsed("üíæ [HYBRID] Simpan Nomor WA");

    const nomorWa = ambilNomorWa();

    // === IndexedDB ===
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);

    const existing = (await store.get(Number(restoId))) || buatDataDefault(restoId);
    existing.nomorWa = nomorWa;
    await store.put(existing);

    console.log("IndexedDB nomorWa OK");

    // === Supabase ===
    const { error } = await supabase
      .from("menuva_master")
      .update({ nomor_wa: nomorWa })
      .eq("id", restoId);

    if (error) {
      console.warn("‚ö†Ô∏è Supabase gagal update WA:", error.message);
    } else {
      console.log("Supabase nomorWa OK");
    }

    console.groupEnd();
    return true;
  } catch (err) {
    console.error("‚ùå Error Hybrid Save WA:", err);
    return false;
  }
}


// ====================== HYBRID LOAD: NOMOR WA ======================
async function loadNomorWaHybrid(restoId) {
  console.groupCollapsed("üì• [HYBRID] Load Nomor WA");

  let nomor = [];

  // === Supabase ===
  try {
    const { data, error } = await supabase
      .from("menuva_master")
      .select("nomor_wa")
      .eq("id", restoId)
      .maybeSingle();

    if (!error && data?.nomor_wa) {
      nomor = data.nomor_wa;
      console.log("Supabase nomor WA loaded");
    }
  } catch (e) {
    console.warn("Supabase WA gagal:", e);
  }

  // === IndexedDB fallback ===
  if (!nomor.length) {
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);

    const local = await store.get(Number(restoId));
    nomor = local?.nomorWa || [];
    console.log("IndexedDB nomor WA fallback");
  }

  console.groupEnd();
  return nomor;
}


// ====================== IMAGE helper (resize) ======================
async function resizeIfNeeded(file, targetSizeKB = 100, maxWidth = 1280) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = async () => {
        try {
          const scale = Math.min(maxWidth / img.width, 1);
          const canvas = document.createElement("canvas");
          canvas.width = img.width * scale;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          let quality = 0.9;
          let dataUrl = canvas.toDataURL("image/jpeg", quality);
          let sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);

          while (sizeKB > targetSizeKB && quality > 0.1) {
            quality -= 0.05;
            dataUrl = canvas.toDataURL("image/jpeg", quality);
            sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);
          }

          resolve(dataUrl);
        } catch (err) {
          reject(err);
        }
      };
      img.onerror = () => reject(new Error("Image load error"));
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}


// ====================== LOGO LISTENER ======================
document.getElementById("logoInput")?.addEventListener("change", async function (e) {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const logoUrl = await resizeIfNeeded(file, 100);
    const preview = document.getElementById("previewLogo");
    if (preview) preview.src = logoUrl;
  } catch (err) {
    console.error("Logo error:", err);
    alert("‚ùå Failed to process logo image.");
  }
});

// ====================== flipbook / preview helpers ======================
function renderImagePreview(tipe, url) {
  const img = document.createElement("img");
  img.src = url;
  img.style.maxWidth = "100px";
  img.style.margin = "5px";
  img.style.borderRadius = "5px";
  img.style.boxShadow = "0 1px 4px rgba(0,0,0,0.1)";

  const wrapper = document.createElement("div");
  wrapper.style.display = "inline-block";
  wrapper.style.position = "relative";
  wrapper.style.margin = "5px";

  const btnHapus = document.createElement("button");
  btnHapus.className = "btn-hapus-gambar";
  btnHapus.setAttribute("aria-label", "Hapus Gambar");
  btnHapus.innerHTML = "√ó";
  btnHapus.style.position = "absolute";
  btnHapus.style.top = "2px";
  btnHapus.style.right = "2px";
  btnHapus.onclick = () => {
    wrapper.remove();

    // üî• Sync array global agar tidak corrupt
    if (tipe === "ruangan") {
      flipbookRuanganImages = flipbookRuanganImages.filter(s => s !== url);
    } else {
      flipbookMenuImages = flipbookMenuImages.filter(s => s !== url);
    }
  };

  wrapper.appendChild(img);
  wrapper.appendChild(btnHapus);

  const container = document.getElementById(
    tipe === "ruangan"
      ? "flipbookRuanganPreview"
      : "flipbookMenuPreview"
  );

  if (container) container.appendChild(wrapper);
}

function tambahGambar(tipe) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.style.display = "none";

  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      // üî• resize helper versi terbaru
      const url = await resizeIfNeeded(file);

      renderImagePreview(tipe, url);

      // üî• Pastikan array global tetap valid
      if (tipe === "ruangan") {
        flipbookRuanganImages.push(url);
      } else {
        flipbookMenuImages.push(url);
      }
    } catch (err) {
      console.error(err);
      alert("‚ùå Gagal memproses gambar.");
    }
  };

  document.body.appendChild(input);
  input.click();
  document.body.removeChild(input);
}

// ====================== slugify ======================
function slugify(text) {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
}

// ====================== SIMPAN (form -> DB) ======================
async function simpanData() {
  try {
    showLoader();

    // ================= VALIDASI INPUT ==================
    const namaRestoran = document.getElementById("namaRestoran")?.value.trim() || "";
    const restoAddress = document.getElementById("restoAddress")?.value.trim() || "";
    const restoPhone = document.getElementById("restoPhone")?.value.trim() || "";
    const logo = document.getElementById("previewLogo")?.src || "";

    const nomorWaAdmin = Array
      .from(document.querySelectorAll(".nomor-wa"))
      .map(i => i.value.trim())
      .filter(v => v !== "");

    if (!restoPhone) {
      alert("‚ùå Please input the restaurant phone number before saving!");
      hideLoader();
      return;
    }

    let restoId = document.getElementById("restoId")?.value?.trim();
    if (!restoId || restoId === "") {
      restoId = "resto-" + restoPhone.replace(/\D/g, "");
    }

    // ================= AMBIL DATA MENU ==================
    const menuData = [
      ...ambilMenu("menuFoodContainer"),
      ...ambilMenu("menuSnackContainer"),
      ...ambilMenu("menuDrinkContainer"),
      ...ambilMenu("menuSpecialContainer")
    ];

    // ================= DATA LAIN ==================
    const promo = Array.isArray(menuPromo) ? menuPromo : [];
    const flipRuangan = Array.isArray(flipbookRuanganImages) ? flipbookRuanganImages : [];
    const flipMenu = Array.isArray(flipbookMenuImages) ? flipbookMenuImages : [];
    const rooms = ambilSemuaRoom() || [];

    // ================= VOUCHER SYNC ==================
    const voucherUI = Array.isArray(window.menuVoucher) ? window.menuVoucher : [];
    const voucherFinal = voucherUI.length ? voucherUI : [];

    // ================= FINAL DATA ==================
    const data = {
      restoId,
      namaRestoran,
      restoAddress,
      restoPhone,
      logo,
      nomorWaAdmin,

      menu: menuData,
      menuPromo: promo,

      // OPSI A ‚Äî WAJIB KONSISTEN
      voucher: voucherFinal,
      menuVoucher: voucherFinal,

      flipbookRuanganImages: flipRuangan,
      flipbookMenuImages: flipMenu,

      rooms
    };

    console.log("üíæ FINAL SAVE DATA:", data);

    // ================= SIMPAN KE IndexedDB + Supabase (HYBRID) ==================
    await saveDataToDB(1, data);

    // ‚ùå OPSI A TIDAK BOLEH pakai saveDataToSupabase()
    // (karena akan overwrite struktur dan menghapus voucher)
    // if (window.supabase) {
    //   await saveDataToSupabase(1, data);
    // }

    // ================= SYNC restoId hidden ==================
    let restoIdEl = document.getElementById("restoId");
    if (!restoIdEl) {
      restoIdEl = document.createElement("input");
      restoIdEl.type = "hidden";
      restoIdEl.id = "restoId";
      document.body.appendChild(restoIdEl);
    }
    restoIdEl.value = restoId;

    updateShareUI();

    alert(`‚úÖ All data saved successfully!\nRESTO ID: ${restoId}`);

  } catch (err) {
    console.error("‚ùå simpanData() ERROR:", err);
    alert("‚ùå Failed to save data.");
  } finally {
    hideLoader();
  }
}

let sudahLoadData = false;

async function loadData(data) {
  if (sudahLoadData) {
    console.warn("‚ö†Ô∏è loadData sudah pernah jalan.");
    return;
  }
  sudahLoadData = true;

  try {
    showLoader();

    // ================= VALIDASI ROOT =================
    if (!data || typeof data !== "object") {
      console.warn("‚ö†Ô∏è data invalid -> pakai default");
      data = buatDataDefault(1);
    }

    // ================= HARDENING ARRAY =================
    data.menu                    = Array.isArray(data.menu) ? data.menu : [];
    data.menuPromo               = Array.isArray(data.menuPromo) ? data.menuPromo : [];
    data.menuVoucher             = Array.isArray(data.menuVoucher) ? data.menuVoucher : [];
    data.flipbookRuanganImages   = Array.isArray(data.flipbookRuanganImages) ? data.flipbookRuanganImages : [];
    data.flipbookMenuImages      = Array.isArray(data.flipbookMenuImages) ? data.flipbookMenuImages : [];
    data.rooms                   = Array.isArray(data.rooms) ? data.rooms : [];
    data.nomorWaAdmin            = Array.isArray(data.nomorWaAdmin) ? data.nomorWaAdmin : [];

    console.log("üì¶ FINAL loadData():", data);

    const safeSet = (id, value) => {
      const el = document.getElementById(id);
      if (el) el.value = value || "";
    };

    // ================= FORM =================
    safeSet("namaRestoran", data.namaRestoran);
    safeSet("restoAddress", data.restoAddress);
    safeSet("restoPhone", data.restoPhone);

    // ================= LOGO =================
    if (data.logo && document.getElementById("previewLogo")) {
      document.getElementById("previewLogo").src = data.logo;
    }

    // ================= NOMOR WA =================
    const waContainer = document.getElementById("nomorWaContainer");
    if (waContainer) {
      waContainer.innerHTML = "";
      data.nomorWaAdmin.forEach(num => tambahNomorWa(num));
    }

    // ================= PROMO =================
    menuPromo = data.menuPromo.slice();
    if (typeof renderPromoUI === "function") {
      renderPromoUI();
    }

    // ================= VOUCHER (MULTI DEVICE SAFE) =================
    window.menuVoucher = data.menuVoucher.slice();
    if (typeof renderVoucher === "function") {
      renderVoucher(window.menuVoucher);
    }

    // ================= RESET KATEGORI UI =================
    const containerMap = {
      food: "menuFoodContainer",
      snack: "menuSnackContainer",
      drink: "menuDrinkContainer",
      special: "menuSpecialContainer"
    };

    Object.values(containerMap).forEach(cid => {
      const c = document.getElementById(cid);
      if (c) c.innerHTML = "";
    });

    // ================= MENU =================
    const menuList = Array.isArray(data.menu)
      ? data.menu
      : (Array.isArray(data.menuData) ? data.menuData : []);

    menuList.forEach(m => {
      const kategori = m.kategori || m.cat || m.category || "food";
      const nama = m.nama || m.name || "";
      const harga = m.harga || m.price || "";
      const image = m.image || m.gambar || "";

      tambahMenu(kategori.toLowerCase(), nama, harga, image);
    });

    // ================= FLIPBOOK =================
    flipbookRuanganImages = data.flipbookRuanganImages.slice();
    flipbookMenuImages = data.flipbookMenuImages.slice();

    const ruanganPreview = document.getElementById("flipbookRuanganPreview");
    const menuPreview = document.getElementById("flipbookMenuPreview");

    if (ruanganPreview) ruanganPreview.innerHTML = "";
    if (menuPreview) menuPreview.innerHTML = "";

    setTimeout(() => {
      if (typeof renderImagePreview === "function") {
        flipbookRuanganImages.forEach(src => src && renderImagePreview("ruangan", src));
        flipbookMenuImages.forEach(src => src && renderImagePreview("menu", src));
      }
    }, 150);

    // ================= ROOMS =================
    if (typeof restoreRoomFromData === "function") {
      restoreRoomFromData(data.rooms);
    } else {
      console.warn("‚ö†Ô∏è restoreRoomFromData() tidak ditemukan.");
    }

    // ================= RESTO ID SAFE =================
    let restoIdEl = document.getElementById("restoId");
    if (!restoIdEl) {
      restoIdEl = document.createElement("input");
      restoIdEl.type = "hidden";
      restoIdEl.id = "restoId";
      document.body.appendChild(restoIdEl);
    }

    restoIdEl.value =
      data.restoId ||
      (data.restoPhone ? "resto-" + data.restoPhone.replace(/\D/g, "") : "resto-main");

    console.log("‚úÖ FINAL loadData COMPLETE tanpa kehilangan data.");

  } catch (err) {
    console.error("‚ùå loadData gagal:", err);
  } finally {
    hideLoader();
  }
}

// ====================== RESET & BACKUP ======================
async function resetData() {
  if (!confirm("Are you sure you want to delete all data?")) return;

  try {
    showLoader();

    // --- 1) CLEAR INDEXEDDB ---
    await clearDataDB();

    // --- 2) CLEAR SUPABASE ---
    try {
      const restoIdEl = document.getElementById("restoId");
      const restoId = restoIdEl?.value || "resto-main";

      const { error } = await supabase
        .from("profile")
        .delete()
        .eq("restoId", restoId);

      if (error) console.warn("‚ö† Supabase delete error (diabaikan):", error);

    } catch (err) {
      console.warn("‚ö† Tidak bisa delete Supabase:", err.message);
    }

    alert("‚úÖ All data cleared successfully!");
    location.reload();

  } catch (err) {
    console.error("‚ùå Reset error:", err);
    alert("‚ùå Failed to delete data: " + err.message);
  } finally {
    hideLoader();
  }
}


// üî• BACKUP HYBRID (IndexedDB ‚Üí File JSON)
async function backupData() {
  try {
    showLoader();

    if (!window.db) {
      window.db = await initDB();
    }

    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.getAll();

    req.onsuccess = () => {
      let allData = req.result || [];

      if (allData.length === 0) {
        alert("‚ö†Ô∏è Tidak ada data di database untuk di-backup!");
        hideLoader();
        return;
      }

      // Pastikan struktur valid
      allData = allData.map(d => ({
        ...buatDataDefault(d.id),
        ...d
      }));

      const filename = `menuva-backup-${Date.now()}.json`;
      const blob = new Blob([JSON.stringify(allData, null, 2)], {
        type: "application/json"
      });

      // Download
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      alert(`‚úÖ Backup berhasil!\nFile: ${filename}`);
      hideLoader();
    };

    req.onerror = (e) => {
      hideLoader();
      console.error("‚ùå Gagal membaca IndexedDB:", e);
      alert("‚ùå Backup gagal: tidak bisa membaca data.");
    };

  } catch (err) {
    hideLoader();
    console.error("‚ùå Backup fatal error:", err);
    alert("‚ùå Terjadi kesalahan: " + err.message);
  }
}

// ====================== RESTORE FROM FILE (HYBRID) ======================
function restoreDataFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = async (e) => {
    try {
      showLoader();

      let json = JSON.parse(e.target.result);

      // ========== AUTO UNWRAP BACKUP VARIAN ==========
      if (json.profile && typeof json.profile === "object") {
        json = json.profile;
      } else if (json.data && typeof json.data === "object") {
        json = json.data;
      }

      // Backup lama bentuk array ‚Üí pakai index 0
      if (Array.isArray(json)) {
        if (json.length === 0) throw new Error("File JSON kosong.");
        json = json[0];
      }

      if (!json || typeof json !== "object") {
        throw new Error("Format JSON tidak valid.");
      }

      // ========== PERBAIKAN STRUKTUR WAJIB ==========
      json.menu              = Array.isArray(json.menu) ? json.menu : [];
      json.menuPromo         = Array.isArray(json.menuPromo) ? json.menuPromo : [];
      json.menuVoucher       = Array.isArray(json.menuVoucher) ? json.menuVoucher : [];
      json.flipbookRuanganImages = Array.isArray(json.flipbookRuanganImages) ? json.flipbookRuanganImages : [];
      json.flipbookMenuImages    = Array.isArray(json.flipbookMenuImages) ? json.flipbookMenuImages : [];
      json.rooms             = Array.isArray(json.rooms) ? json.rooms : [];
      json.nomorWaAdmin      = Array.isArray(json.nomorWaAdmin) ? json.nomorWaAdmin : [];

      // ========== PERBAIKAN RESTO ID (ULTRA SAFE) ==========
      if (!json.restoId || typeof json.restoId !== "string") {
        json.restoId =
          json.restoPhone ||
          (json.namaRestoran ? slugify(json.namaRestoran) : ("resto" + Date.now()));
      }

      if (!json.restoPhone) {
        json.restoPhone = json.restoId; // fallback aman
      }

      // ========== ID NUMBER (LOCAL INDEXEDDB) ==========
      let idResto = 1;
      if (typeof json.id === "number") idResto = json.id;
      idResto = Number(idResto) || 1;

      // ========== HYBRID RESTORE: IndexedDB + Supabase =============
      
      // LOCAL
      await saveDataToDB(idResto, json);

      // REMOTE
      await saveDataToSupabase(json.restoId, json);

      // ========== AUTO OK ==========
      alert("‚úÖ Data restored successfully! Page will reload.");
      location.reload();

    } catch (err) {
      hideLoader();
      console.error("‚ùå Restore failed:", err);
      alert("‚ùå Failed to restore JSON file.\nCek console untuk detail.");
    }
  };

  reader.readAsText(file);
}

// ====================== Links / QR helpers ======================
function generateDynamicLink(baseUrl, data) {
  try {
    const jsonData = JSON.stringify(data);
    const encoded = encodeURIComponent(jsonData);
    return `${baseUrl}?data=${encoded}`;
  } catch (err) {
    console.error("Gagal generate link:", err);
    return null;
  }
}

async function createMenuvaLink() {
  try {
    // ambil restoId dari hidden input
    const restoId =
      document.getElementById("restoId")?.value ||
      document.getElementById("restoPhone")?.value ||
      null;

    if (!restoId) {
      console.warn("‚ö†Ô∏è Tidak ada restoId, link tidak bisa dibuat.");
      return null;
    }

    // üî• HYBRID: ambil data dari IndexedDB ‚Üí fallback Supabase
    const data = await loadDataFromDB(restoId);

    if (!data) {
      console.error("‚ùå Tidak bisa load data untuk generate link");
      return null;
    }

    const link = generateDynamicLink("https://menuva.github.io/view.html", data);
    console.log("Dynamic Link:", link);
    return link;
  } catch (err) {
    console.error("Error createMenuvaLink:", err);
  }
}

// Link customer final
function getCustomerLink() {
  const restoId = document.getElementById("restoId")?.value;
  if (!restoId) return null;

  const basePath = window.location.pathname.substring(
    0,
    window.location.pathname.lastIndexOf("/")
  );

  return `${window.location.origin}${basePath}/menu.html?resto=${encodeURIComponent(restoId)}`;
}

function openCustomerPage() {
  const link = getCustomerLink();
  if (!link) return alert("‚ùå Please click Save All first");
  window.open(link, "_blank");
}

// update UI & QR
function updateShareUI() {
  const link = getCustomerLink();
  if (!link) return;

  const btnCopy = document.getElementById("btnSalinLink");
  if (btnCopy) {
    btnCopy.style.display = "inline-block";
    btnCopy.onclick = () => {
      navigator.clipboard
        .writeText(link)
        .then(() => alert("‚úÖ Link copied to clipboard"))
        .catch(err => alert("‚ùå Failed to copy link: " + err));
    };
  }

  const btnSee = document.getElementById("btnOpenCustomer");
  if (btnSee) {
    btnSee.style.display = "inline-block";
    btnSee.onclick = () => window.open(link, "_blank");
  }

  const qrContainer = document.getElementById("qrcodePreview");
  if (!qrContainer) return;
  qrContainer.innerHTML = "";

  // Jika library QRCode tersedia
  if (typeof QRCode !== "undefined") {
    QRCode.toCanvas(link, { width: 128 }, function (error, canvas) {
      if (error) {
        console.error(error);
        qrContainer.textContent = "‚ùå Failed to generate QR";
        return;
      }
      qrContainer.appendChild(canvas);

      const btnDownload = document.getElementById("btnDownloadQR");
      if (btnDownload) {
        btnDownload.style.display = "inline-block";
        btnDownload.onclick = () => {
          const a = document.createElement("a");
          a.href = canvas.toDataURL("image/png");
          a.download = `Resto-${Date.now()}-QRCode.png`;
          a.click();
        };
      }

      const btnPrint = document.getElementById("btnPrintQR");
      if (btnPrint) {
        btnPrint.style.display = "inline-block";
        btnPrint.onclick = () => {
          const dataUrl = canvas.toDataURL("image/png");
          const w = window.open("");
          w.document.write(
            `<img src="${dataUrl}" style="width:250px;height:250px;">`
          );
          w.document.close();
          w.print();
        };
      }
    });
  } else {
    // fallback
    qrContainer.textContent = link;
  }
}

// ====================== LOADER HANDLER (Modern & Center) ======================
function showLoader() {
  let loader = document.getElementById("loader");
  if (!loader) {
    loader = document.createElement("div");
    loader.id = "loader";
    loader.innerHTML = `
      <div class="loader-overlay">
        <div class="loader-content">
          <div class="spinner"></div>
          <p>Loading data...</p>
        </div>
      </div>
    `;
    document.body.appendChild(loader);

    // Inline style - portable
    const style = document.createElement("style");
    style.id = "loader-style";
    style.textContent = `
      #loader {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.45);
        z-index: 9999;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      #loader.show {
        opacity: 1;
      }

      .loader-content {
        text-align: center;
        color: #fff;
        font-family: 'Segoe UI', sans-serif;
        font-size: 1.1rem;
        animation: fadeUp 0.6s ease;
      }

      .spinner {
        width: 64px;
        height: 64px;
        border: 6px solid rgba(255,255,255,0.3);
        border-top-color: #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px auto;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      @keyframes fadeUp {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(style);
  }

  loader.style.display = "flex";
  requestAnimationFrame(() => loader.classList.add("show"));
}

function hideLoader() {
  const loader = document.getElementById("loader");
  if (loader) {
    loader.classList.remove("show");
    setTimeout(() => {
      loader.style.display = "none";
    }, 300);
  }
}


// ====================== CLEAR DB (HYBRID) ======================
async function clearDataDB() {
  try {
    const db = await initDB();

    // 1. CLEAR INDEXEDDB
    await new Promise((resolve, reject) => {
      const tx = db.transaction(STORE_NAME, "readwrite");
      const store = tx.objectStore(STORE_NAME);
      const req = store.clear();
      req.onsuccess = () => {
        console.log("üßπ IndexedDB cleared");
        resolve();
      };
      req.onerror = () => reject(req.error);
    });

    // 2. CLEAR SUPABASE (jika restoId ada)
    const restoId =
      document.getElementById("restoId")?.value ||
      document.getElementById("restoPhone")?.value;

    if (restoId && window.supabase) {
      const { error } = await supabase
        .from("menuva")
        .delete()
        .eq("restoId", restoId);

      if (error) {
        console.warn("‚ö†Ô∏è Supabase clear gagal (offline atau error):", error);
      } else {
        console.log("üßπ Supabase data cleared for restoId:", restoId);
      }
    } else {
      console.warn("‚ö†Ô∏è Supabase tidak dihapus (restoId tidak ada / supabase null)");
    }

    return true;
  } catch (err) {
    console.error("‚ùå clearDataDB HYBRID error:", err);
    throw err;
  }
}
</script>
<script>
let isLoadingFromDB = false;
let voucherLoaded = false;

// ====================== SAFE LOAD DATA (OPSI A) ======================
async function safeLoadDataFromDB() {
  try {
    let cached = null;

    // ===================== 1. LOAD DARI INDEXEDDB =====================
    try {
      cached = await loadDataFromDB(1);
      if (cached) console.log("üì¶ Cached IndexedDB:", cached);
    } catch (e) {
      console.warn("‚ö† IndexedDB gagal dibaca:", e);
    }

    // Ambil restoKey terbaik
    const restoKey =
      cached?.restoId?.trim() ||
      cached?.restoPhone?.trim() ||
      null;

    console.log("üÜî restoKey:", restoKey || "(null)");

    // IndexedDB kosong ‚Üí bikin default
    let finalData = cached || buatDataDefault(1);

    // ===================== 2. LOAD DARI SUPABASE =====================
    if (window.supabase && restoKey) {
      try {
        // ========== RESTO SETTINGS ==========
        const { data: setting, error: settingErr } = await supabase
          .from("restosettings")
          .select("*")
          .eq("resto_id", restoKey)
          .maybeSingle();

        if (!settingErr && setting) {
          finalData = { ...finalData, ...setting };
          console.log("üåê resto settings:", setting);
        }

        // ========== CATEGORIES ==========
        const { data: ct, error: ctErr } = await supabase
          .from("categories")
          .select("*")
          .eq("resto_id", restoKey);

        if (!ctErr && Array.isArray(ct)) {
          finalData.categories = ct.map(fixCategory);
          console.log("üìÇ Categories:", finalData.categories);
        } else {
          console.warn("‚ö† Categories fetch fail, gunakan cached jika ada.");
        }

        // ========== VOUCHERS (OPS A: TABLE VOUCHERS) ==========
        try {
          const { data: vc, error: vcErr } = await supabase
            .from("vouchers")
            .select("*")
            .eq("resto_id", restoKey);

          if (!vcErr && Array.isArray(vc)) {
            finalData.menuVoucher = vc.map(fixVoucher);
            voucherLoaded = true;
            console.log("üéüÔ∏è Voucher dari Supabase:", finalData.menuVoucher);

          } else {
            console.warn("‚ö† Voucher fetch error:", vcErr);

            // fallback ke IndexedDB jika ada
            if (Array.isArray(finalData.menuVoucher)) {
              console.log("üéüÔ∏è Fallback ke IndexedDB voucher.");
            } else if (Array.isArray(finalData.vouchers)) {
              finalData.menuVoucher = finalData.vouchers;
            } else {
              finalData.menuVoucher = [];
            }
          }
        } catch (e) {
          console.warn("‚ö† Exception saat ambil voucher:", e);
          if (!Array.isArray(finalData.menuVoucher)) {
            finalData.menuVoucher = finalData.vouchers || [];
          }
        }

      } catch (err) {
        console.warn("‚ö† Supabase fetch error utama:", err);
      }
    }

    // ===================== CLEANUP FIELD BENTROK =====================
    // Hapus field lama supaya tidak overwrite
    delete finalData.vouchers;
    delete finalData.voucher; 
    delete finalData.voucherList;

    // pastikan aman
    if (!Array.isArray(finalData.menuVoucher)) finalData.menuVoucher = [];

    // FIX JSON lama yang masih pakai menuData
    if (!Array.isArray(finalData.menu) && Array.isArray(finalData.menuData)) {
      finalData.menu = finalData.menuData;
    }

    console.log("üéâ FINAL SAFE LOAD:", finalData);
    return finalData;

  } catch (err) {
    console.error("‚ùå safeLoadDataFromDB ERROR:", err);
    return buatDataDefault(1);
  }
}

  function fixCategory(cat) {
  return {
    id: cat.id,
    name: cat.name,
    resto_id: cat.resto_id,
    created_at: cat.created_at,
    image: cat.image || "assets/default-category.png" // default gambar
  };
}

 /* ======================================================
    FIX VOUCHER (SUPABASE ‚Üí LOCAL OBJECT)
======================================================*/
function fixVoucher(v) {
  if (!v || typeof v !== "object") return null;

  return {
    id: v.id,
    code: v.code,
    discount: v.value || v.discount || 0,
    expiry: v.expires_at || v.expiry || null,
    createdAt: v.created_at,
    type: v.type || "percentage",
    minOrder: v.min_order || 0,
    isActive: v.is_active ?? true,
    description: v.description || ""
  };
}

/* ======================================================
    SAFE LOAD DATA (FINAL MERGE ‚Üí UI)
======================================================*/
async function safeLoadData(data) {
  try {
    // Kalau tidak ada ‚Üí default
    const finalData = data || buatDataDefault(1);

    // Proteksi field minimal
    finalData.categories = Array.isArray(finalData.categories)
      ? finalData.categories
      : [];

    finalData.menu = Array.isArray(finalData.menu)
      ? finalData.menu
      : (Array.isArray(finalData.menuData) ? finalData.menuData : []);

    // ===================== MASTER VOUCHER FIELD =====================
    // hanya pakai menuVoucher (Ops A)
    finalData.menuVoucher = Array.isArray(finalData.menuVoucher)
      ? finalData.menuVoucher
      : Array.isArray(finalData.vouchers)
        ? finalData.vouchers
        : [];

    // Hapus field bentrok lama
    delete finalData.vouchers;
    delete finalData.voucher;
    delete finalData.voucherList;

    // ===================== LOAD UI =====================
    await loadData(finalData);

    console.log("üì≤ UI data loaded:", finalData);

  } catch (err) {
    console.error("‚ùå safeLoadData() error:", err);
  }
}


/* ======================================================
    INIT UTAMA ‚Äî HYBRID SYSTEM
======================================================*/
document.addEventListener("DOMContentLoaded", async () => {
  console.log("üöÄ Init mulai...");
  showLoader();

  const timeout = setTimeout(() => {
    console.warn("‚ö† Init lama ‚Üí hide loader paksa");
    hideLoader();
  }, 8000);

  try {
    // --- INIT IndexedDB ---
    await initDB();
    console.log("‚úÖ IndexedDB siap");

    // --- Ambil data dari DB hybrid ---
    const data = await safeLoadDataFromDB();
    console.log("üì¶ Hybrid data (before UI):", data);

    // --- Render ke UI ---
    await safeLoadData(data);

    // --- INIT toggle UI ---
    await initAllToggles();

    // --- Fix padding bar bawah ---
    const fixbar = document.querySelector(".fixed-bar");
    if (fixbar) {
      document.body.style.paddingBottom = fixbar.offsetHeight + "px";
    }

    console.log("‚úÖ Admin siap (Hybrid Ready, Voucher Multi Device OK)");

  } catch (err) {
    console.error("‚ùå Error saat init:", err);
    alert("Terjadi error saat init. Silakan refresh halaman.");
  } finally {
    clearTimeout(timeout);
    hideLoader();
  }
});

// ===================== TOGGLES MASTER =====================
async function initAllToggles() {
  // Pastikan seluruh DOM sudah complete
  await new Promise((resolve) => {
    if (document.readyState === "complete") return resolve();
    document.addEventListener("readystatechange", () => {
      if (document.readyState === "complete") resolve();
    });
  });

  initOrderToggle();
  initRoomToggle();
  await initVoucherToggle(); // ini async
}


// ===================== ORDER TOGGLE =====================
function initOrderToggle() {
  const toggleOrderPage = document.getElementById("toggleOrderPage");

  // FIX: menyesuaikan HTML terbaru
  const orderContainerBox =
    document.getElementById("orderContainerBox") ||
    document.getElementById("orderToggleBox");

  if (!toggleOrderPage) {
    console.warn("‚ö†Ô∏è toggleOrderPage tidak ditemukan");
    return;
  }

  if (!orderContainerBox) {
    console.warn("‚ö†Ô∏è orderContainerBox belum ada, retry 300ms");
    return setTimeout(initOrderToggle, 300);
  }

  const saved = localStorage.getItem("page_order");
  toggleOrderPage.checked = saved === "true";
  orderContainerBox.style.display = toggleOrderPage.checked ? "block" : "none";

  toggleOrderPage.addEventListener("change", (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_order", enabled);
    orderContainerBox.style.display = enabled ? "block" : "none";
  });
}


// ===================== ROOM TOGGLE =====================
function initRoomToggle() {
  const toggleRoomPage = document.getElementById("toggleRoomPage");
  const roomContainerBox = document.getElementById("roomContainerBox");

  if (!toggleRoomPage || !roomContainerBox) {
    console.warn("‚ö†Ô∏è Elemen toggleRoomPage atau roomContainerBox tidak ditemukan");
    return;
  }

  const saved = localStorage.getItem("page_room");
  toggleRoomPage.checked = saved === "true";
  roomContainerBox.style.display = toggleRoomPage.checked ? "block" : "none";

  toggleRoomPage.addEventListener("change", (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_room", enabled);
    roomContainerBox.style.display = enabled ? "block" : "none";
  });
}

  // ===================== VOUCHER TOGGLE =====================
async function initVoucherToggle() {
  const toggleVoucherPage = document.getElementById("toggleVoucherPage");
  const voucherForm = document.getElementById("voucherForm");
  const voucherContainerBox = document.getElementById("voucherContainerBox");

  if (!toggleVoucherPage || !voucherForm || !voucherContainerBox) {
    console.warn("‚ö†Ô∏è Elemen toggle/form/container voucher tidak lengkap ‚Üí skip initVoucherToggle()");
    return;
  }

  // ===================== PLAN CHECK =====================
  const plan = localStorage.getItem("user_plan");
  if (plan === "monthly") {
    voucherContainerBox.style.display = "none";
    return;
  }

  // ===================== RESTORE STATE =====================
  const enabled = localStorage.getItem("page_voucher") === "true";
  toggleVoucherPage.checked = enabled;
  voucherForm.style.display = enabled ? "block" : "none";

  // ===================== EVENT HANDLER =====================
  toggleVoucherPage.addEventListener("change", async (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_voucher", enabled);
    voucherForm.style.display = enabled ? "block" : "none";

    if (!enabled) {
      renderVoucher([]);
    } else {
      await loadVouchers(); // reload semua voucher
    }
  });

  // ===================== FIRST LOAD =====================
  await loadVouchers();
}



// ===================== LOAD VOUCHERS =====================
async function loadVouchers() {
  console.groupCollapsed("üì• Load Vouchers");

  let data = await loadDataFromDB(1);

  // Proteksi struktur agar tidak error saat diakses
  if (!data || typeof data !== "object") {
    console.warn("‚ö† Data DB invalid ‚Üí reset object kosong");
    data = { menuVoucher: [] };
  }

  if (!Array.isArray(data.menuVoucher)) {
    console.warn("‚ö† menuVoucher hilang ‚Üí set array kosong");
    data.menuVoucher = [];
  }

  const today = new Date();

  // ===================== AUTO REMOVE EXPIRED =====================
  const cleaned = data.menuVoucher.filter(v => {
    const exp = new Date(v.expiry);
    return isFinite(exp) && exp >= today;
  });

  if (cleaned.length !== data.menuVoucher.length) {
    console.warn("üßπ Cleaning voucher expired...");
    data.menuVoucher = cleaned;

    // Hybrid-safe ‚Üí save to IndexedDB only (Supabase sync lewat saveVoucherNew)
    await saveDataToDB(1, data);
  }

  console.log("üì¶ Voucher aktif:", cleaned);
  console.groupEnd();

  renderVoucher(cleaned);
  return cleaned;
}

// ===================== SAVE VOUCHER WRAPPER =====================
function saveVoucher() {
  return (typeof saveVoucherNew === "function")
    ? saveVoucherNew()
    : (alert("Function saveVoucherNew() tidak ditemukan."), Promise.reject("saveVoucherNew missing"));
}

  // ===================== SAVE VOUCHER BARU (HYBRID SAFE) =====================
async function saveVoucherNew() {
  const code = document.getElementById("voucherCode").value.trim();
  const discount = parseFloat(document.getElementById("voucherDiscount").value);
  const expiry = document.getElementById("voucherExpiry").value;

  const type = document.getElementById("voucherType")?.value || "percent";
  const minOrder = parseFloat(document.getElementById("voucherMinOrder")?.value) || 0;
  const description = document.getElementById("voucherDescription")?.value || "";
  const active = document.getElementById("voucherActive")?.checked ?? true;

  if (!code || isNaN(discount) || !expiry) {
    alert("‚ö†Ô∏è Harap isi semua form voucher!");
    return;
  }

  // Load existing data
  const data = await loadDataFromDB(1);
  if (!Array.isArray(data.menuVoucher)) data.menuVoucher = [];

  const codeUpper = code.toUpperCase();
  const now = new Date().toISOString();

  // Check existing voucher
  let existing = data.menuVoucher.find(v => v.code === codeUpper);

  if (existing) {
    // ====================== UPDATE ======================
    existing.discount = discount;
    existing.expiry = expiry;
    existing.type = type;
    existing.minOrder = minOrder;
    existing.description = description;
    existing.isActive = active;
    existing.updatedAt = now;

    console.log("‚úèÔ∏è Voucher updated:", existing);

    // Sync Supabase
    if (typeof saveVoucherToSupabase === "function") {
      await saveVoucherToSupabase(existing);
    }

  } else {
    // ====================== CREATE NEW ======================
    const newVoucher = {
      id: crypto.randomUUID(),
      code: codeUpper,
      discount,
      expiry,
      type,
      minOrder,
      description,
      isActive: active,
      createdAt: now
    };

    data.menuVoucher.push(newVoucher);

    console.log("‚ûï Voucher baru:", newVoucher);

    // Sync Supabase
    if (typeof saveVoucherToSupabase === "function") {
      await saveVoucherToSupabase(newVoucher);
    }
  }

  // Save ke IndexedDB
  await saveDataToDB(1, data);

  // Refresh UI
  renderVoucher(data.menuVoucher);

  alert("‚úÖ Voucher berhasil disimpan!");
}

  // ===================== RENDER VOUCHER (HYBRID NEW) =====================
function renderVoucher(vouchers = []) {
  const box = document.getElementById("voucherPreview");
  if (!box) return;

  if (!Array.isArray(vouchers)) vouchers = [];

  const today = new Date();

  // Filter voucher aktif & valid
  vouchers = vouchers.filter(v => {
    const exp = new Date(v.expiry);
    return (
      v &&
      v.isActive !== false &&        // default aktif
      isFinite(exp) &&
      exp >= today
    );
  });

  if (vouchers.length === 0) {
    box.innerHTML = "<em>Belum ada voucher aktif</em>";
    return;
  }

  box.innerHTML = `
    <h3 style="margin-bottom:10px;">Voucher Aktif</h3>
    ${vouchers
      .map(
        v => `
      <div class="voucher-item"
        style="border:1px solid #ccc; padding:10px; margin:8px 0; border-radius:10px; background:#fafafa;">
        
        <p><strong>Kode Voucher:</strong>
          <span class="voucher-code">${v.code}</span>
          <button onclick="copyVoucherCode('${v.code}')">üìã Copy</button>
        </p>

        <p><strong>Diskon:</strong> 
          ${v.type === "percent" ? v.discount + "%" : "Rp " + v.discount.toLocaleString()}
        </p>

        <p><strong>Minimal Order:</strong> 
          Rp ${Number(v.minOrder || 0).toLocaleString()}
        </p>

        ${v.description ? `<p><strong>Deskripsi:</strong> ${v.description}</p>` : ""}

        <p><strong>Berlaku sampai:</strong> ${v.expiry}</p>
      </div>
    `
      )
      .join("")}
  `;
}



// ===================== CLIPBOARD =====================
function copyVoucherCode(code) {
  if (!code) return;

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard
      .writeText(code)
      .then(() => alert(`Kode voucher "${code}" berhasil disalin!`))
      .catch(err => {
        console.error("Clipboard error:", err);
        fallbackCopy(code);
      });
  } else {
    fallbackCopy(code);
  }
}

function fallbackCopy(text) {
  const tempInput = document.createElement("input");
  tempInput.value = text;
  document.body.appendChild(tempInput);
  tempInput.select();
  document.execCommand("copy");
  tempInput.remove();
  alert(`Kode voucher "${text}" berhasil disalin!`);
}

  /* ======================================================
    SAVE VOUCHER KE SUPABASE
======================================================*/
async function saveVoucherToOnline(restoKey, vouchers) {
  if (!window.supabase || !restoKey) return;

  try {
    // 1. HAPUS semua voucher lama
    await supabase.from("vouchers")
      .delete()
      .eq("resto_id", restoKey);

    // 2. MASUKKAN voucher baru
    const rows = vouchers.map(v => ({
      resto_id: restoKey,
      code: v.code,
      value: v.discount,
      expires_at: v.expiry,
      type: v.type || "percentage",
      min_order: v.minOrder || 0,
      is_active: v.isActive ?? true,
      description: v.description || ""
    }));

    const { error } = await supabase.from("vouchers").insert(rows);

    if (error) throw error;

    console.log("‚úÖ Voucher berhasil disimpan online");
  } catch (err) {
    console.error("‚ùå Gagal simpan voucher:", err);
  }
}

</script>
<script>
/* ============================================================
   1. PRELOAD + UNLOCK AUDIO
============================================================ */
let notifAudio;

document.addEventListener("DOMContentLoaded", () => {
  // Voucher toggle jalan dulu, sesuai struktur admin
  initVoucherToggle();

  // Preload audio
  notifAudio = new Audio("beep.mp3");
  notifAudio.load();

  // Unlock audio untuk mobile browser
  const unlock = () => {
    notifAudio.play()
      .then(() => {
        notifAudio.pause();
        notifAudio.currentTime = 0;
      })
      .catch(() => {});
    document.body.removeEventListener("click", unlock);
  };

  document.body.addEventListener("click", unlock);

  // Start realtime order checker
  startRealtimeOrderChecker();
});


/* ============================================================
   2. MAIN SOUND
============================================================ */
function playNotifSound() {
  if (!notifAudio) return;
  notifAudio.currentTime = 0;
  notifAudio.play().catch(() => {});
}


/* ============================================================
   3. Helpers
============================================================ */
function idbGetAll(store) {
  return new Promise((resolve, reject) => {
    const req = store.getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

function updateReceiveBadge(count) {
  const badge = document.getElementById("receiveBadge");
  if (!badge) return;

  if (count > 0) {
    badge.style.display = "inline-block";
    badge.textContent = count;
  } else {
    badge.style.display = "none";
  }
}


/* ============================================================
   4. REALTIME CHECK ORDERS
============================================================ */
let lastCount = 0;

async function cekOrderBaru() {
  try {
    const db = await initDB();
    const tx = db.transaction("ordersData", "readonly");
    const store = tx.objectStore("ordersData");

    const all = await idbGetAll(store);
    const newCount = all.filter(o => o.status === "new").length;

    updateReceiveBadge(newCount);

    // Bunyi hanya ketika jumlah "new" bertambah
    if (newCount > lastCount) {
      playNotifSound();
    }

    lastCount = newCount;

  } catch (err) {
    console.error("‚ùå cekOrderBaru error:", err);
  }
}


/* ============================================================
   5. LOOP REALTIME (1 detik)
============================================================ */
let intervalStarted = false;

function startRealtimeOrderChecker() {
  if (intervalStarted) return; // Hindari double interval
  intervalStarted = true;

  cekOrderBaru(); // Run awal
  setInterval(cekOrderBaru, 1000); // Jalan per detik
}


/* ============================================================
   6. Mark as read + go
============================================================ */
async function markOrdersAsRead() {
  try {
    const db = await initDB();
    const tx = db.transaction("ordersData", "readwrite");
    const store = tx.objectStore("ordersData");

    const all = await idbGetAll(store);

    for (const o of all) {
      if (o.status === "new") {
        o.status = "read";
        store.put(o);
      }
    }

    updateReceiveBadge(0);
    lastCount = 0;

  } catch (err) {
    console.error("‚ùå markOrdersAsRead error:", err);
  }
}

function markViewedAndGo() {
  markOrdersAsRead();
  window.location.href = "recieves.html";
}

</script>
</body>
</html>



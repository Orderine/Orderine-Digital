<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <title>Admin Orderine</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      padding-bottom: 80px;
      background: linear-gradient(135deg, #003366, #003366);
      margin: 0;
      position: relative;
      overflow-x: hidden;
    }
   /* =====================
   MOBILE-FIRST LOGO & HEADER
   ===================== */
.menuva-logo {
  text-align: center;
  margin-bottom: 10px;
  padding: 0 10px; /* beri sedikit jarak kiri-kanan di HP */
}

.menuva-logo img {
  max-width: 70%;   /* logo menyesuaikan lebar layar HP */
  height: auto;     /* menjaga proporsi asli */
  max-height: 80px; /* batasi tinggi supaya tidak terlalu besar */
  display: block;
  margin: 0 auto;   /* center logo */
}

.menuva-logo p {
  color: white;
  font-size: 13px;  /* ukuran font nyaman di HP */
  margin: 4px 0 0 0;
  line-height: 1.3;
}

/* =====================
   TABLET (min-width: 481px)
   ===================== */
@media (min-width: 481px) {
  .menuva-logo img {
    max-width: 50%;
    max-height: 90px;
  }
  .menuva-logo p {
    font-size: 14px;
  }
}

/* =====================
   DESKTOP (min-width: 769px)
   ===================== */
@media (min-width: 769px) {
  .menuva-logo img {
    max-width: 35%;
    max-height: 100px;
  }
  .menuva-logo p {
    font-size: 16px;
  }
}
    h1, h2, h3 {
      text-align: center;
      margin: 10px 0;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
    }
    input, button, textarea {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 100%;
      font-size: 1rem;
    }
    .menu-item {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }
    .menu-item input {
      flex: 1 1 40%;
    }
    .menu-item button {
      flex: 1 1 auto;
      white-space: nowrap;
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
    }
    .btn-danger {
      background-color: #e74c3c;
      color: white;
    }
    .btn-success {
      background-color: #2ecc71;
      color: white;
    }
    .btn-secondary {
      background-color: #3498db;
      color: white;
    }
    .btn-orange {
      background-color: orange;
      color: white;
      border: none;
    }
    .preview img {
      max-width: 100px;
      margin: 5px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    @media (max-width: 600px) {
      .menu-item input, .menu-item button {
        width: 100%;
      }
    }
    .room-section > div:nth-child(2) button {
      padding: 6px 14px;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    .room-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .room-form {
      padding: 10px;
      border: 1px dashed #ccc;
      margin-bottom: 12px;
      border-radius: 6px;
      background-color: #fff;
    }
    .room-form input[type="text"],
    .room-form input[type="number"],
    .room-form input[type="file"] {
      display: block;
      margin-bottom: 8px;
      width: 100%;
      padding: 6px;
      font-size: 14px;
    }
    .room-form .room-preview img {
      max-height: 80px;
      margin-top: 4px;
    }
    .gambar-preview-wrapper {
      position: relative;
      display: inline-block;
      margin-top: 10px;
    }
    .gambar-preview {
      height: auto !important;
      width: auto !important;
      max-height: 200px !important;
      max-width: 100% !important;
      display: block;
    }
    .hapus-gambar {
      position: absolute;
      top: -8px;
      right: -8px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 14px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s;
    }
    .hapus-gambar:hover { background: #cc0000; }
    .btn-hapus-gambar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: red;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: background 0.2s, transform 0.1s ease;
    }
    .btn-hapus-gambar:hover {
      background: #cc0000;
      transform: scale(1.05);
    }
    .section-box {
      border: none;
      padding: 16px;
      margin-bottom: 24px;
      border-radius: 8px;
      background: #fff;
    }
    .section-box h2,
    .section-box h3 { margin-top: 0; }
    .room-section { margin-bottom: 20px; }
    .room-section button {
      margin-bottom: 10px;
      background-color: #17a2b8;
    }
    .btn-simpan {
      background-color: #17a2b8;
      color: white;
      font-weight: bold;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn-tambah-room {
      background: linear-gradient(135deg, #7f5af0, #2cb5e8);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(127, 90, 240, 0.3);
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-tambah-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(44, 181, 232, 0.5);
    }
    .btn-hapus-room {
      background: linear-gradient(135deg, #ff6b6b, #fbc687);
      color: #fff;
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3);
      margin-top: 10px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .btn-hapus-room:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(251, 198, 135, 0.5);
    }
    .btn-upload-gambar {
      background: linear-gradient(135deg, #00c6ff, #0072ff);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      margin-top: 6px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }
    .btn-upload-gambar:hover { opacity: 0.85; }
  
    /* Style umum untuk tombol aksi penting */
.btn-action {
  display: inline-block;
  padding: 10px 16px;
  margin: 6px 4px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  color: #fff;
  transition: all 0.3s ease;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Copy Link â†’ biru elegan */
#btnSalinLink.btn-action {
  background: #007BFF;
}
#btnSalinLink.btn-action:hover {
  background: #0056b3;
}

/* Download QR â†’ hijau segar */
#btnDownloadQR.btn-action {
  background: #28a745;
}
#btnDownloadQR.btn-action:hover {
  background: #1e7e34;
}

/* Print QR â†’ oranye elegan */
#btnPrintQR.btn-action {
  background: #fd7e14;
}
#btnPrintQR.btn-action:hover {
  background: #e8590c;
}

/* Backup Data â†’ ungu premium */
#btnBackup.btn-action {
  background: #6f42c1;
}
#btnBackup.btn-action:hover {
  background: #5936a2;
}
/* Blue â€“ untuk backup */
.btn-blue {
  background: linear-gradient(135deg, #3b82f6, #1e3a8a);
  color: white;
}
.btn-blue:hover {
  background: linear-gradient(135deg, #1e3a8a, #172554);
  transform: scale(1.05);
}
/* Base style tombol */
button {
  padding: 10px 16px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
}

/* Orange â€“ utama */
.btn-orange {
  background: linear-gradient(135deg, #ff914d, #ff6a00);
  color: white;
}
.btn-orange:hover {
  background: linear-gradient(135deg, #ff6a00, #cc5500);
  transform: scale(1.05);
}

/* Teal â€“ untuk salin link */
.btn-teal {
  background: linear-gradient(135deg, #20c997, #0f766e);
  color: white;
}
.btn-teal:hover {
  background: linear-gradient(135deg, #0f766e, #0c5f56);
  transform: scale(1.05);
}

/* Purple â€“ untuk download */
.btn-purple {
  background: linear-gradient(135deg, #a855f7, #6b21a8);
  color: white;
}
.btn-purple:hover {
  background: linear-gradient(135deg, #6b21a8, #4c1d95);
  transform: scale(1.05);
}

/* Red â€“ untuk print */
.btn-red {
  background: linear-gradient(135deg, #ef4444, #b91c1c);
  color: white;
}
.btn-red:hover {
  background: linear-gradient(135deg, #b91c1c, #7f1d1d);
  transform: scale(1.05);
}
 .setting-card {
    background: linear-gradient(135deg, #ffffff, #f9fafb);
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .setting-card h2 {
    font-size: 18px;
    margin: 0 0 12px;
    color: #1e293b;
  }

  /* Switch toggle elegan */
  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 32px;
    margin-right: 10px;
  }
  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background-color: #cbd5e1;
    transition: .4s;
    border-radius: 32px;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 24px;
    width: 24px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }
  input:checked + .slider {
    background: linear-gradient(135deg, #2563eb, #1e40af);
  }
  input:checked + .slider:before {
    transform: translateX(28px);
  }

  .setting-label {
    font-size: 12px;
    font-weight: 600;
    color: #334155;
    vertical-align: middle;
  }

    /* Tombol simpan voucher */
  #saveVoucherBtn {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    box-shadow: 0 3px 6px rgba(0,0,0,0.2);
  }
  #saveVoucherBtn:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }

  /* Tombol copy voucher */
  #voucherPreview button {
    background: linear-gradient(135deg, #b8860b, #ffd700);
    color: #1a1a1a;
    font-size: 14px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
  #voucherPreview button:hover {
    background: linear-gradient(135deg, #ffd700, #ffcc33);
    transform: translateY(-2px);
  }
  .fixed-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 70px;
  background: linear-gradient(135deg, #003366, #003366);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 999;
}

  .nav-item {
  flex: 1;
  text-align: center;
  padding: 6px 0;
  cursor: pointer;
  user-select: none;
  transition: 0.2s ease;
}

.nav-item .icon {
  font-size: 24px;
  color: #fff;
  transition: color 0.2s ease;
}

.nav-item .label {
  margin-top: 4px;
  font-size: 12px;
  color: #fff;
  transition: color 0.2s ease;
}

/* ğŸ”¥ Hover / sentuh â†’ jadi emas */
.nav-item:hover .icon,
.nav-item:active .icon,
.nav-item:hover .label,
.nav-item:active .label {
  color: #d4af37; /* warna emas */
}
.icon-wrapper {
  position: relative;
  display: inline-block;
}

.badge {
  position: absolute;
  top: -6px;
  right: -10px;
  background: red;
  color: white;
  padding: 2px 6px;
  font-size: 10px;
  border-radius: 12px;
  font-weight: bold;
  display: none; /* awalnya disembunyikan */
}

  </style>
</head>
<body>
<div class="menuva-logo">
  <img src="menuva-logo.png" alt="Logo Menuva">
  <br>
  <p style="color: white;">Digital Solution For Restaurant, Hotel, & Cafe's</p>
</div>

<div class="section">
  <h2>ğŸ“‡ Business Identity</h2>
  
  <label for="logoInput">Your Business Logo</label>
  <input type="file" id="logoInput" name="logoInput" accept="image/*" />

  <img id="previewLogo" src="" alt="Logo Restoran" style="max-height: 80px; margin-top: 10px;" />

  <label for="namaRestoran">Your Business Name</label>
  <input type="text" id="namaRestoran" name="namaRestoran" placeholder="Your Business Name" />

  <label for="restoAddress">Your Business Address</label>
  <input id="restoAddress" name="restoAddress" type="text" placeholder="Jl. Sudirman No. 10, Jakarta" />

  <label for="restoPhone">Phone Number</label>
  <input id="restoPhone" name="restoPhone" type="text" placeholder="08xx-xxxx-xxxx" />
</div>

<div class="section">
  <h2>ğŸ”¥ Menu Promo</h2>
  <div id="promoContainer"></div>
  <button class="btn-orange" onclick="tambahPromo()">+ Add Promo Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ SPECIAL MENU</h2>
  <div id="menuSpecialContainer"></div>
  <button class="btn-success" onclick="tambahMenu('special')">+ Add Special Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ FOOD MENU</h2>
  <div id="menuFoodContainer"></div>
  <button class="btn-success" onclick="tambahMenu('food')">+ Add Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ SNACK & DESSERT</h2>
  <div id="menuSnackContainer"></div>
  <button class="btn-success" onclick="tambahMenu('snack')">+ Add Menu</button>
</div>

<div class="section">
  <h2>ğŸ“‹ DRINK</h2>
  <div id="menuDrinkContainer"></div>
  <button class="btn-success" onclick="tambahMenu('drink')">+ Add Menu</button>
</div>

<div class="section-box" id="waContainerBox">
  <h3>ğŸ“± Admin WhatsApp Number (Order/Reservation Recipient)</h3>
  <div id="nomorWaContainer">
    <label for="waNumber1" class="sr-only">WhatsApp Number</label>
    <input type="text" id="waNumber1" name="waNumber[]" class="nomor-wa" placeholder="Example: 6281234567890">
  </div>
  <button onclick="tambahNomorWa()">+ Add WA Number</button>
</div>

<div class="section">
  <h2>ğŸ“¸ Room Gallery</h2>
  <button onclick="tambahGambar('ruangan')">+ Add Room Image</button>
  <input type="file" id="flipbookRuanganUpload" name="flipbookRuanganUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookRuanganPreview"></div>
</div>

<div class="section">
  <h2>ğŸ“– Restaurant Menu</h2>
  <button onclick="tambahGambar('menu')">+ Add Menu Image</button>
  <input type="file" id="flipbookMenuUpload" name="flipbookMenuUpload" accept="image/*" multiple style="display:none;" />
  <div id="flipbookMenuPreview"></div>
</div>

<div class="setting-card" id="orderToggleBox">
  <h2>âš™ï¸ Reservation & Delivery Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleOrderPage" name="toggleOrderPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Reservation & Delivery Page</span>
</div>

<div class="setting-card" id="roomToggleBox">
  <h2>âš™ï¸ Room Page Setting</h2>
  <label class="switch">
    <input type="checkbox" id="toggleRoomPage" name="toggleRoomPage">
    <span class="slider"></span>
  </label>
  <span class="setting-label">Enable/Disable Room Page.</span>
</div>

<div class="section-box" id="roomContainerBox">
  <h2>ğŸ¨ Room / Packages</h2>
  <div class="room-section">
    <h3>ğŸ›ï¸ Room Hotel</h3>
    <button onclick="tambahRoom('hotel')" class="btn-tambah-room">+ Add Hotel Room</button>
    <div id="roomHotelContainer"></div>
  </div>
  <div class="room-section">
    <h3>ğŸ’¼ Meeting Room</h3>
    <button onclick="tambahRoom('meeting')" class="btn-tambah-room">+ Add Meeting Room</button>
    <div id="meetingRoomContainer"></div>
  </div>
  <div class="room-section">
    <h3>ğŸ Packages</h3>
    <button onclick="tambahRoom('package')" class="btn-tambah-room">+ Add Packages</button>
    <div id="packageContainer"></div>
  </div>
</div>

<div class="section-box" id="voucherContainerBox">
  <h2>ğŸŸï¸ Voucher Diskon</h2>
  <label class="switch">
    <input type="checkbox" id="toggleVoucherPage" name="toggleVoucherPage">
    <span class="slider round"></span>
  </label>

  <div id="voucherForm" style="margin-top:15px; display:none;">
    <label for="voucherCode">Voucher Code</label>
    <input type="text" id="voucherCode" name="voucherCode" placeholder="Kode Voucher">

    <label for="voucherDiscount">Discount (%)</label>
    <input type="number" id="voucherDiscount" name="voucherDiscount" placeholder="Diskon (%)">

    <label for="voucherExpiry">Expiry Date</label>
    <input type="date" id="voucherExpiry" name="voucherExpiry">

    <button id="saveVoucherBtn" onclick="saveVoucher()">ğŸ’¾ Save Voucher Code</button>
  </div>

  <div id="voucherPreview"></div>
</div>

<hr>

<div class="section">
  <button class="btn-simpan" onclick="simpanData()">ğŸ’¾ Save All</button>
  <input type="hidden" id="restoId" name="restoId" />

  <button id="btnOpenCustomer" class="btn-orange" onclick="openCustomerPage()">ğŸ‘ï¸ See Customer Page</button>
  <button id="btnSalinLink" class="btn-teal" style="display:none;">ğŸ“‹ Copy Link to Share with Customers</button>

  <div id="qrcodePreview" style="margin-top:10px;"></div>

  <button id="btnDownloadQR" class="btn-purple" style="margin-top:10px; display:none;">â¬‡ï¸ Download QR Code</button>
  <button id="btnPrintQR" class="btn-red" style="margin-top:5px; display:none;">ğŸ–¨ï¸ Print QR Code</button>

  <div class="section">
    <h2>ğŸ” Backup & Restore Data</h2>
    <button id="btnBackup" class="btn-blue" onclick="backupData()">ğŸ“¦ Backup Data</button>
    <div id="backupDownloadLink" style="margin-top:10px;"></div>

    <label for="restoreInput" style="margin-top: 20px; display: block;">ğŸ“‚ Select JSON File to Restore:</label>
    <input type="file" id="restoreInput" name="restoreInput" accept=".json" onchange="restoreDataFromFile(event)" />
  </div>
  
  <!-- Panduan -->
  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>Panduan Penggunaan:</strong><br>
    PENTING!!<br>
    ğŸ”¹ Klik <strong>â¬‡ï¸ Backup Data</strong> untuk menyimpan semua data restoran ke file <strong>.json</strong>.<br>
    ğŸ”¹ Simpan file tersebut dengan baik.<br>
    ğŸ”¹ Klik <strong>ğŸ“‚ Pilih File</strong> untuk me-restore data.<br>
    âš ï¸ Proses restore menggantikan seluruh data saat ini.<br>
  </div>

  <div style="background: #fef9e7; padding: 10px; border-left: 5px solid #f1c40f; margin-top: 10px; font-size: 14px;">
    <strong>User Guide:</strong><br>
    IMPORTANT!!<br>
    ğŸ”¹ Click <strong>â¬‡ï¸ Backup Data</strong> to save all data.<br>
    ğŸ”¹ Keep the file safe.<br>
    ğŸ”¹ Click <strong>ğŸ“‚ Choose File</strong> to restore data.<br>
    âš ï¸ The restore process replaces all existing data.<br>
  </div>

  <button onclick="resetData()" class="btn-danger">ğŸ—‘ï¸ Reset Data</button>
</div>

<div class="fixed-bar">
<div class="nav-item" onclick="markViewedAndGo()">
    <div class="icon-wrapper">
        <ion-icon name="cube-outline" class="icon"></ion-icon>
        <span id="receiveBadge" class="badge">0</span>
    </div>
    <div class="label">Receives</div>
</div>

   <div class="nav-item" onclick="window.location.href='index.html'">
    <ion-icon name="log-out-outline" class="icon"></ion-icon>
    <div class="label">Logout</div>
  </div>
</div>

<script>
console.log("Admin Script Version: 2025-11-07-STABLE");

// ====================== GLOBAL DB HANDLER ======================
let dbReady = null;
const DB_NAME = "MenuvaDB";
const STORE_NAME = "menuvaData";
const DB_VERSION = 10;

let dbInstance = null;

  // Tes sederhana: apakah IndexedDB berfungsi di HP?
if (!window.indexedDB) {
  alert("âš ï¸ Browser ini tidak mendukung IndexedDB!");
} else {
  const test = indexedDB.open("TestDB_Check");
  test.onerror = (e) => {
    console.error("âŒ IndexedDB gagal dibuka:", e.target.error);
    alert("IndexedDB gagal dibuka di HP! Kemungkinan masalah izin browser.");
  };
  test.onsuccess = () => {
    console.log("âœ… IndexedDB bisa dibuka di perangkat ini");
    test.result.close();
    indexedDB.deleteDatabase("TestDB_Check");
  };
}

let dbPromise = null;

/* =========================
   Supabase init + migration helpers
   ========================= */

/**
 * IMPORTANT: set SUPABASE_URL to your Supabase project URL (https://xxxx.supabase.co)
 * The publishable key below was provided in your message; if you want to use service_role
 * or different key for admin tasks, replace accordingly (be careful with security).
 */
const SUPABASE_URL = ""; // <-- <-- <--  PUT YOUR SUPABASE PROJECT URL HERE
const SUPABASE_ANON_KEY = "sb_publishable_L69H0-PapAm3jMWrTyYayQ_4kOd2MMD"; // from your message

// lazy supabase client (only created if SUPABASE_URL is set)
let supabase = null;
function getSupabaseClient() {
  if (!SUPABASE_URL) return null;
  if (supabase) return supabase;
  if (!window.supabaseLib && window.createClient) {
    // If using newer bundle exposing createClient (some CDNs)
    supabase = window.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } else if (window.supabaseLib && supabaseLib.createClient) {
    supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } else if (window.supabase) {
    // e.g. supabase global
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } else {
    // If user included CDN <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"> then:
    if (window.supabaseJs && supabaseJs.createClient) {
      supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } else if (window.createClient) {
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }
  }
  return supabase;
}

const MIGRATION_FLAG = "migrated_to_supabase_v1";

/** small logger helpers */
function logInfo(...args){ console.log('[DB]', ...args); }
function logWarn(...args){ console.warn('[DB]', ...args); }
function logError(...args){ console.error('[DB]', ...args); }

/** wrapper to check if we should use online DB */
function shouldUseOnlineDB() {
  // Prefer online only when:
  // - migration flag is set, AND
  // - supabase client is available (SUPABASE_URL provided)
  return !!(localStorage.getItem(MIGRATION_FLAG) && SUPABASE_URL && getSupabaseClient());
}

/* =========================
   IndexedDB core (unchanged, minimal adjustments)
   ========================= */
async function initDB() {
  if (dbInstance) return dbInstance;
  if (dbPromise) return dbPromise;

  dbPromise = new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);

    request.onupgradeneeded = (e) => {
      const db = e.target.result;

      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "id" });
      }

      if (!db.objectStoreNames.contains("ordersData")) {
        db.createObjectStore("ordersData", {
          keyPath: "id",
          autoIncrement: true
        });
      }
    };

    request.onsuccess = (e) => {
      dbInstance = e.target.result;
      dbPromise = null;
      resolve(dbInstance);
    };

    request.onerror = (e) => {
      dbPromise = null;
      reject(e.target.error);
    };
  });

  return dbPromise;
}

async function getDB() {
  if (dbInstance) return dbInstance;
  return await initDB();
}

/* =========================
   Supabase helpers for app-level config (optional single-row storage)
   NOTE: admin.html originally stores everything as one object in IDB.
   To be minimally invasive we will store that object in a table named "app_config"
   with columns: id (int PK), resto_id (text), payload (jsonb), created_at
   If your Supabase does not have this table, you can create it, or keep using IDB.
   ========================= */

async function supaSaveConfig(id = 1, payload = {}) {
  const client = getSupabaseClient();
  if (!client) throw new Error("Supabase client not configured (SUPABASE_URL empty).");

  // upsert into app_config (assumes table exists)
  const row = {
    id,
    resto_id: payload.restoId || null,
    payload, // jsonb column
    created_at: payload.created_at || new Date().toISOString()
  };

  // using upsert so it will insert or update
  const { error } = await client.from("app_config").upsert(row);
  if (error) throw error;
  return row;
}

async function supaLoadConfig(id = 1) {
  const client = getSupabaseClient();
  if (!client) throw new Error("Supabase client not configured (SUPABASE_URL empty).");

  const { data, error } = await client.from("app_config").select("payload").eq("id", id).limit(1);
  if (error) throw error;
  if (!data || data.length === 0) return null;
  return data[0].payload;
}

/* =========================
   Save / Load functions (hybrid)
   - If migrated & supabase configured -> use Supabase app_config table
   - Fallback -> old IndexedDB store
   ========================= */

async function saveDataToDB(id, newData) {
  console.groupCollapsed("ğŸ’¾ [TRACE] saveDataToDB()");
  try {
    id = Number(id) || 1;

    // If online mode (migration done + supabase configured) -> try supabase
    if (shouldUseOnlineDB()) {
      try {
        logInfo("Using Supabase to save config (app_config).");
        const saved = await supaSaveConfig(id, newData);
        console.log("âœ… Saved to Supabase:", saved);
        console.groupEnd();
        return saved;
      } catch (supaErr) {
        logError("Supabase save failed, falling back to IndexedDB:", supaErr);
        // continue to write into IDB as fallback
      }
    }

    // ==== IndexedDB write (original behavior) ====
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);

    return new Promise((resolve, reject) => {
      const req = store.get(id);

      req.onsuccess = () => {
        let oldData = req.result || buatDataDefault(id);

        // MERGE TANPA HILANG FIELD (VERSI FIX)
        const finalData = {
          ...oldData,
          ...newData,
        };

        // Pastikan menuVoucher tidak corrupt
        if (!Array.isArray(finalData.menuVoucher)) {
          finalData.menuVoucher = Array.isArray(oldData.menuVoucher)
            ? oldData.menuVoucher
            : [];
        }

        const saveReq = store.put(finalData);

        saveReq.onsuccess = () => {
          console.log("âœ… Data tersimpan (IndexedDB):", finalData);
          console.groupEnd();
          resolve(finalData);
        };

        saveReq.onerror = (e) => {
          console.error("âŒ Gagal simpan DB:", e.target.error);
          console.groupEnd();
          reject(e.target.error);
        };
      };

      req.onerror = (e) => {
        console.error("âŒ Gagal membaca DB:", e.target.error);
        console.groupEnd();
        reject(e.target.error);
      };
    });
  } catch (err) {
    console.groupEnd();
    throw err;
  }
}

async function loadDataFromDB(id = 1) {
  console.groupCollapsed("ğŸ“¥ [TRACE] loadDataFromDB()");
  try {
    // If online mode (migration done + supabase configured) -> try supabase first
    if (shouldUseOnlineDB()) {
      try {
        logInfo("Attempting to load config from Supabase (app_config).");
        const payload = await supaLoadConfig(id);
        if (payload) {
          // apply safe-fixes like prior logic
          const r = payload;
          const safe = {
            id,
            restoId: r.restoId || "",
            namaRestoran: r.namaRestoran || "",
            restoAddress: r.restoAddress || "",
            restoPhone: r.restoPhone || "",
            logo: r.logo || "",
            menu: Array.isArray(r.menu) ? r.menu : [],
            menuPromo: Array.isArray(r.menuPromo) ? r.menuPromo : [],
            menuVoucher: Array.isArray(r.menuVoucher) ? r.menuVoucher : [],
            rooms: Array.isArray(r.rooms) ? r.rooms : [],
            nomorWaAdmin: Array.isArray(r.nomorWaAdmin) ? r.nomorWaAdmin : [],
            flipbookRuanganImages: Array.isArray(r.flipbookRuanganImages) ? r.flipbookRuanganImages : [],
            flipbookMenuImages: Array.isArray(r.flipbookMenuImages) ? r.flipbookMenuImages : []
          };
          console.log("ğŸ“¦ Data dari Supabase (safe):", safe);
          console.groupEnd();
          return safe;
        } else {
          logWarn("No config row found in Supabase for id:", id, " -> falling back to IndexedDB");
        }
      } catch (supaErr) {
        logError("Supabase load failed (falling back to IndexedDB):", supaErr);
      }
    }

    // ==== IndexedDB read (original behavior) ====
    const db = await getDB();
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);

    return new Promise((resolve, reject) => {
      const req = store.get(id);

      req.onsuccess = () => {
        let r = req.result;

        console.log("ğŸ“¦ Data dari DB (raw):", r);

        // ======== DATA DEFAULT JIKA KOSONG ========
        // Jika data ada tapi field rooms hilang â†’ tambahkan
        if (r && !Array.isArray(r.rooms)) {
          console.warn("âš ï¸ Field ROOMS hilang â†’ tambahkan default");
          r.rooms = [];
        }

        // Jika data sama sekali tidak ada â†’ buat default penuh
        if (!r) {
          console.warn("âš ï¸ DB kosong â†’ create default");
          r = buatDataDefault(id);
        }

        // ======== FORCE STRUCTURE (ANTI HILANG) ========
        const safe = {
          id,
          restoId: r.restoId || "",
          namaRestoran: r.namaRestoran || "",
          restoAddress: r.restoAddress || "",
          restoPhone: r.restoPhone || "",
          logo: r.logo || "",
          menu: Array.isArray(r.menu) ? r.menu : [],
          menuPromo: Array.isArray(r.menuPromo) ? r.menuPromo : [],
          menuVoucher: Array.isArray(r.menuVoucher) ? r.menuVoucher : [],
          rooms: Array.isArray(r.rooms) ? r.rooms : [],
          nomorWaAdmin: Array.isArray(r.nomorWaAdmin) ? r.nomorWaAdmin : [],
          flipbookRuanganImages: Array.isArray(r.flipbookRuanganImages) ? r.flipbookRuanganImages : [],
          flipbookMenuImages: Array.isArray(r.flipbookMenuImages) ? r.flipbookMenuImages : []
        };

        console.log("ğŸ“¦ Data setelah SAFE-FIX:", safe);
        console.groupEnd();
        resolve(safe);
      };

      req.onerror = (e) => {
        console.error("âŒ Gagal load DB:", e.target.error);
        console.groupEnd();
        reject(e.target.error);
      };
    });
  } catch (e) {
    console.groupEnd();
    throw e;
  }
}

// ===== Helper internal: bikin struktur default =====
function buatDataDefault(id = 1) {
  return {
    id,
    restoId: "",
    namaRestoran: "",
    restoAddress: "",
    restoPhone: "",
    menuData: [],
    menuVoucher: [],   // ğŸ”¥ WAJIB ADA
    menuPromo: [],
    menu: [],
    rooms: [],
    nomorWaAdmin: [],
    flipbookRuanganImages: [],
    flipbookMenuImages: [],
  };
}

/* =========================
   Migration starter: non-destructive helper that can be triggered
   - copies the single IDB config object into Supabase app_config (id=1)
   - sets MIGRATION_FLAG on success
   ========================= */

async function migrateConfigToSupabase(force = false) {
  if (!SUPABASE_URL) {
    logWarn("SUPABASE_URL not configured â€” cannot migrate to Supabase. Set SUPABASE_URL and try again.");
    return { ok: false, reason: "no_supabase_url" };
  }

  // if already migrated and not forced, skip
  if (localStorage.getItem(MIGRATION_FLAG) && !force) {
    logInfo("Already migrated (flag present). Use force=true to re-run.");
    return { ok: false, reason: "already_migrated" };
  }

  try {
    const local = await loadDataFromDB(1);
    // try saving to supabase
    const client = getSupabaseClient();
    if (!client) throw new Error("Supabase client unavailable");

    // upsert to app_config
    const row = {
      id: 1,
      resto_id: local.restoId || null,
      payload: local,
      created_at: new Date().toISOString()
    };

    const { error } = await client.from("app_config").upsert(row);
    if (error) throw error;

    localStorage.setItem(MIGRATION_FLAG, new Date().toISOString());
    logInfo("Config migrated to Supabase and flag set.");
    return { ok: true };
  } catch (e) {
    logError("Migration to Supabase failed:", e);
    return { ok: false, error: e };
  }
}

/* Auto-run note:
   We intentionally DO NOT auto-run migrate here.
   Use `migrateConfigToSupabase()` manually from console or UI control to avoid accidental overwrites.
*/

 // ====================== Supabase Init ======================
const SUPABASE_URL = "https://orderine.github.io/Orderine-Digital/Admin-migration.html"; 
const SUPABASE_ANON_KEY = "sb_publishable_L69H0-PapAm3jMWrTyYayQ_4kOd2MMD";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ====================== Variabel Global ======================
let menuPromo = [];
let flipbookRuanganImages = [];
let flipbookMenuImages = [];
let sudahLoadData = false;

// ====================== SAVE ke SUPABASE ======================
async function saveDataToDB(userId, data) {
  const { error } = await supabase
    .from("resto_data")
    .upsert(
      { restoId: data.restoId, data },
      { onConflict: "restoId" }
    );

  if (error) throw error;
}

// ====================== LOAD dari SUPABASE ======================
async function loadDataFromDB(restoId) {
  if (!restoId) return null;

  const { data, error } = await supabase
    .from("resto_data")
    .select("data")
    .eq("restoId", restoId)
    .maybeSingle();

  if (error) throw error;
  return data?.data || null;
}

// ====================== CLEAR DB ======================
async function clearDataDB() {
  const restoId = document.getElementById("restoId")?.value || null;
  if (!restoId) throw new Error("restoId missing");

  const { error } = await supabase
    .from("resto_data")
    .delete()
    .eq("restoId", restoId);

  if (error) throw error;
}

// ====================== PROMO ======================
function renderPromoUI() {
  const container = document.getElementById("promoContainer");
  if (!container) return;
  container.innerHTML = "";

  const promoCategories = ["PROMO", "DISKON", "SPECIAL", "EVENT"];

  menuPromo.forEach((promo, index) => {
    const div = document.createElement("div");
    div.className = "menu-item";

    const optionsHTML = promoCategories.map(
      cat => `<option value="${cat}" ${promo.kategori === cat ? "selected" : ""}>${cat}</option>`
    ).join("");

    div.innerHTML = `
      <input type="text" id="promoName_${index}" value="${promo.namaPromo || ""}"
        placeholder="Promo Name" onchange="updatePromo(${index}, 'namaPromo', this.value)">

      <input type="file" id="promoImage_${index}" accept="image/*" onchange="uploadPromoImage(event, ${index})">
      <img id="promoImgPreview${index}" src="${promo.image || ""}" style="max-height:80px;margin:5px 0">

      <input type="text" id="promoDesc_${index}" placeholder="Description"
        value="${promo.deskripsi || ""}" onchange="updatePromo(${index}, 'deskripsi', this.value)">

      <input type="number" id="promoPrice_${index}" placeholder="Price"
        value="${promo.harga || ""}" onchange="updatePromo(${index}, 'harga', this.value)">

      <select id="promoCat_${index}" onchange="updatePromo(${index}, 'kategori', this.value)">
        ${optionsHTML}
      </select>

      <input type="date" id="promoDate_${index}" value="${promo.tanggalAkhir || ""}"
        onchange="updatePromo(${index}, 'tanggalAkhir', this.value)">

      <button class="btn-danger" onclick="hapusPromo(${index})">Delete Promo List</button>
    `;

    container.appendChild(div);
  });
}

function tambahPromo(promo = {}) {
  menuPromo.push({
    namaPromo: promo.namaPromo || "",
    image: promo.image || "",
    deskripsi: promo.deskripsi || "",
    harga: promo.harga || "",
    kategori: promo.kategori || "PROMO",
    tanggalAkhir: promo.tanggalAkhir || ""
  });
  renderPromoUI();
}

function updatePromo(index, key, value) {
  if (!menuPromo[index]) return;
  menuPromo[index][key] = value;
}

function hapusPromo(index) {
  menuPromo.splice(index, 1);
  renderPromoUI();
  autosave();
}

function uploadPromoImage(event, index) {
  const file = event.target.files[0];
  if (!file) return;
  resizeIfNeeded(file)
    .then(resized => {
      document.getElementById(`promoImgPreview${index}`).src = resized;
      updatePromo(index, "image", resized);
    })
    .catch(err => console.error(err));
}

// =========================== MENU ===========================
function tambahMenu(kategori = "food", nama = "", harga = "", image = "") {
  const map = {
    food: "menuFoodContainer",
    snack: "menuSnackContainer",
    drink: "menuDrinkContainer",
    special: "menuSpecialContainer"
  };
  const container = document.getElementById(map[kategori]);
  if (!container) return;

  const id = Date.now();
  const div = document.createElement("div");
  div.className = "menu-item";

  div.innerHTML = `
    <input type="text" placeholder="Menu Name" value="${nama}">
    <input type="number" placeholder="Price" value="${harga}">
    <select>
      <option value="food" ${kategori === "food" ? "selected" : ""}>Food</option>
      <option value="snack" ${kategori === "snack" ? "selected" : ""}>Snack</option>
      <option value="drink" ${kategori === "drink" ? "selected" : ""}>Drink</option>
      <option value="special" ${kategori === "special" ? "selected" : ""}>Special</option>
    </select>
    <input type="file" accept="image/*" onchange="uploadMenuImage(event, this)" data-image="${image}">
    <img class="menuPreview" src="${image}" style="max-height:80px;margin:5px 0;${image ? "" : "display:none"}">
    <button class="btn-danger" onclick="this.parentElement.remove();autosave()">Delete</button>
  `;
  container.appendChild(div);
}


// ====================== AUTOSAVE ======================
function autosave() {
  if (window._saveTimeout) clearTimeout(window._saveTimeout);
  window._saveTimeout = setTimeout(() => simpanData().catch(e => console.error(e)), 600);
}

// ====================== SIMPAN KE DB ======================
async function simpanData() {
  try {
    showLoader();
    const restoId = document.getElementById("restoId")?.value || document.getElementById("restoPhone")?.value;

    const data = {
      restoId,
      namaRestoran: document.getElementById("namaRestoran")?.value.trim(),
      restoAddress: document.getElementById("restoAddress")?.value.trim(),
      restoPhone: restoId,
      logo: document.getElementById("previewLogo")?.src || "",
      nomorWaAdmin: Array.from(document.querySelectorAll(".nomor-wa")).map(i => i.value),
      menuPromo,
      menuVoucher: Array.isArray(window.menuVoucher) ? window.menuVoucher : [],
      flipbookRuanganImages,
      flipbookMenuImages,
      menu: [
        ...ambilMenu("menuFoodContainer"),
        ...ambilMenu("menuSnackContainer"),
        ...ambilMenu("menuDrinkContainer"),
        ...ambilMenu("menuSpecialContainer")
      ],
      rooms: ambilSemuaRoom()
    };

    await saveDataToDB(1, data);
    alert("âœ… Saved!");
  } catch (err) {
    alert("âŒ Save failed");
    console.error(err);
  } finally {
    hideLoader();
  }
}

// ====================== LOAD DATA ======================
async function loadData() {
  if (sudahLoadData) return;
  sudahLoadData = true;

  try {
    showLoader();
    const restoId = document.getElementById("restoPhone")?.value;
    const data = await loadDataFromDB(restoId);

    if (!data) {
      console.warn("No data in DB");
      return;
    }

    // restore UI
    document.getElementById("previewLogo").src = data.logo;
    document.getElementById("namaRestoran").value = data.namaRestoran;
    document.getElementById("restoAddress").value = data.restoAddress;
    document.getElementById("restoPhone").value = data.restoPhone;

    menuPromo = data.menuPromo || [];
    renderPromoUI();

    flipbookRuanganImages = data.flipbookRuanganImages || [];
    flipbookMenuImages = data.flipbookMenuImages || [];

    restoreRoomFromData(data.rooms);
  } finally {
    hideLoader();
  }
}

// ====================== RESET DB ======================
async function resetData() {
  if (!confirm("Delete ALL data?")) return;
  await clearDataDB();
  location.reload();
}

  let isLoadingFromDB = false;
let voucherLoaded = false;

document.addEventListener("DOMContentLoaded", async () => {
  console.log("ğŸš€ Init mulai...");
  showLoader();

  const timeout = setTimeout(() => {
    console.warn("âš ï¸ Init terlalu lama, sembunyikan loader paksa.");
    hideLoader();
  }, 8000);

  try {
    // ===================== LOAD DATA UTAMA =====================
    const data = await safeLoadFromSupabase();
    if (data) {
      await safeLoadData(data);
      console.log("ğŸ“¦ Data berhasil diambil dari Supabase:", data);
    } else {
      console.warn("âš ï¸ Tidak ada data ditemukan di Supabase");
    }

    // ===================== TOGGLE SECTION =====================
    await initAllToggles();

    // ===================== FIXED BAR EXTRA BOTTOM PADDING =====================
    const fixbar = document.querySelector(".fixed-bar");
    if (fixbar) {
      const fixbarHeight = fixbar.offsetHeight;
      document.body.style.paddingBottom = fixbarHeight + "px";
    }

    console.log("âœ… Admin siap digunakan");
  } catch (err) {
    console.error("âŒ Error saat init:", err);
    alert("Terjadi kesalahan saat memuat data. Coba refresh halaman.");
  } finally {
    clearTimeout(timeout);
    hideLoader();
  }
});

// ===================== SAFE LOAD WRAPPER =====================
async function safeLoadFromSupabase() {
  if (isLoadingFromDB) {
    console.warn("âš ï¸ safeLoadFromSupabase() di-skip, masih berjalan");
    return null;
  }
  isLoadingFromDB = true;

  const restoId =
    document.getElementById("restoPhone")?.value ||
    document.getElementById("restoId")?.value;

  const data = await loadDataFromDB(restoId);

  isLoadingFromDB = false;
  return data;
}

async function safeLoadData(data) {
  if (window.sudahLoadData) {
    console.warn("âš ï¸ loadData() sudah pernah jalan, skip");
    return;
  }
  window.sudahLoadData = true;

  await loadData(data);
}

// ===================== TOGGLES MASTER =====================
async function initAllToggles() {
  await new Promise((resolve) => {
    if (document.readyState === "complete") return resolve();
    document.addEventListener("readystatechange", () => {
      if (document.readyState === "complete") resolve();
    });
  });

  initOrderToggle();
  initRoomToggle();
  await initVoucherToggle();
}

// ===================== ORDER TOGGLE =====================
function initOrderToggle() {
  const toggleOrderPage = document.getElementById("toggleOrderPage");
  const orderContainerBox =
    document.getElementById("orderContainerBox") ||
    document.getElementById("orderToggleBox");

  if (!toggleOrderPage || !orderContainerBox) return;

  const saved = localStorage.getItem("page_order");
  toggleOrderPage.checked = saved === "true";
  orderContainerBox.style.display = toggleOrderPage.checked ? "block" : "none";

  toggleOrderPage.addEventListener("change", (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_order", enabled);
    orderContainerBox.style.display = enabled ? "block" : "none";
  });
}

// ===================== ROOM TOGGLE =====================
function initRoomToggle() {
  const toggleRoomPage = document.getElementById("toggleRoomPage");
  const roomContainerBox = document.getElementById("roomContainerBox");

  if (!toggleRoomPage || !roomContainerBox) return;

  const saved = localStorage.getItem("page_room");
  toggleRoomPage.checked = saved === "true";
  roomContainerBox.style.display = toggleRoomPage.checked ? "block" : "none";

  toggleRoomPage.addEventListener("change", (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_room", enabled);
    roomContainerBox.style.display = enabled ? "block" : "none";
  });
}

// ===================== VOUCHER TOGGLE =====================
async function initVoucherToggle() {
  const toggleVoucherPage = document.getElementById("toggleVoucherPage");
  const voucherForm = document.getElementById("voucherForm");
  const voucherContainerBox = document.getElementById("voucherContainerBox");

  if (!toggleVoucherPage || !voucherForm || !voucherContainerBox) {
    console.warn("âš ï¸ elemen voucher tidak lengkap â€” skip initVoucherToggle()");
    return;
  }

  const plan = localStorage.getItem("user_plan");
  if (plan === "monthly") {
    voucherContainerBox.style.display = "none";
    return;
  }

  const enabled = localStorage.getItem("page_voucher") === "true";
  toggleVoucherPage.checked = enabled;
  voucherForm.style.display = enabled ? "block" : "none";

  toggleVoucherPage.addEventListener("change", async (e) => {
    const enabled = e.target.checked;
    localStorage.setItem("page_voucher", enabled);
    voucherForm.style.display = enabled ? "block" : "none";

    if (!enabled) {
      renderVoucher([]);
    } else {
      await loadVouchers();
    }
  });

  await loadVouchers();
}

// ===================== LOAD VOUCHERS =====================
async function loadVouchers() {
  console.groupCollapsed("ğŸ“¥ Load Vouchers");

  const restoId =
    document.getElementById("restoPhone")?.value ||
    document.getElementById("restoId")?.value;

  const data = await loadDataFromDB(restoId);

  if (!Array.isArray(data.menuVoucher)) data.menuVoucher = [];

  // auto remove expired
  const today = new Date();
  const cleaned = data.menuVoucher.filter(v => {
    const exp = new Date(v.expiry);
    return isFinite(exp) && exp >= today;
  });

  if (cleaned.length !== data.menuVoucher.length) {
    console.warn("ğŸ§¹ Remove voucher expired...");
    data.menuVoucher = cleaned;
    await saveDataToDB(restoId, data);
  }

  console.log("ğŸ“¦ Voucher aktif:", cleaned);
  console.groupEnd();

  renderVoucher(cleaned);
  return cleaned;
}

// Compatibility wrapper
function saveVoucher() {
  return typeof saveVoucherNew === "function"
    ? saveVoucherNew()
    : (alert("Function saveVoucherNew() tidak ditemukan."), Promise.reject());
}

// ===================== SAVE / UPDATE VOUCHER =====================
async function saveVoucherNew() {
  const code = document.getElementById("voucherCode").value.trim();
  const discount = parseFloat(document.getElementById("voucherDiscount").value);
  const expiry = document.getElementById("voucherExpiry").value;

  if (!code || isNaN(discount) || !expiry) {
    alert("âš ï¸ Harap isi semua form!");
    return;
  }

  const restoId =
    document.getElementById("restoPhone")?.value ||
    document.getElementById("restoId")?.value;

  const data = await loadDataFromDB(restoId);
  if (!Array.isArray(data.menuVoucher)) data.menuVoucher = [];

  const codeUpper = code.toUpperCase();
  const existing = data.menuVoucher.find(v => v.code === codeUpper);

  if (existing) {
    existing.discount = discount;
    existing.expiry = expiry;
    existing.updatedAt = new Date().toISOString();
  } else {
    data.menuVoucher.push({
      id: crypto.randomUUID(),
      code: codeUpper,
      discount,
      expiry,
      createdAt: new Date().toISOString()
    });
  }

  await saveDataToDB(restoId, data);
  renderVoucher(data.menuVoucher);
  alert("âœ… Voucher berhasil disimpan!");
}

// ===================== RENDERING =====================
function renderVoucher(vouchers = []) {
  const box = document.getElementById("voucherPreview");
  if (!box) return;

  const today = new Date();
  vouchers = vouchers.filter(v => new Date(v.expiry) >= today);

  if (!vouchers.length) {
    box.innerHTML = "<em>Belum ada voucher aktif</em>";
    return;
  }

  box.innerHTML = `
    <h3>Voucher Aktif</h3>
    ${vouchers.map(v => `
      <div class="voucher-item" style="border:1px solid #ccc; padding:8px; margin:8px 0; border-radius:8px;">
        <p><strong>Kode Voucher:</strong>
          <span class="voucher-code">${v.code}</span>
          <button onclick="copyVoucherCode('${v.code}')">ğŸ“‹ Copy</button>
        </p>
        <p><strong>Diskon:</strong> ${v.discount}%</p>
        <p><strong>Berlaku sampai:</strong> ${v.expiry}</p>
      </div>
    `).join("")}
  `;
}

// ===================== COPY =====================
function copyVoucherCode(code) {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(code).then(() => {
      alert(`Kode voucher "${code}" berhasil disalin!`);
    }).catch(() => fallbackCopy(code));
  } else {
    fallbackCopy(code);
  }
}

function fallbackCopy(text) {
  const temp = document.createElement("input");
  temp.value = text;
  document.body.appendChild(temp);
  temp.select();
  document.execCommand("copy");
  temp.remove();
  alert(`Kode voucher "${text}" berhasil disalin!`);
}

/* ============================================================
   1. PRELOAD + UNLOCK AUDIO
============================================================ */
let notifAudio;

document.addEventListener("DOMContentLoaded", () => {
  initVoucherToggle(); 
  notifAudio = new Audio("beep.mp3");
  notifAudio.load();

  const unlock = () => {
    notifAudio.play().then(() => {
      notifAudio.pause();
      notifAudio.currentTime = 0;
    }).catch(()=>{});
    document.body.removeEventListener("click", unlock);
  };
  document.body.addEventListener("click", unlock);

  startRealtimeOrderChecker();
});

/* ============================================================
   2. MAIN SOUND
============================================================ */
function playNotifSound() {
  if (!notifAudio) return;
  notifAudio.currentTime = 0;
  notifAudio.play().catch(()=>{});
}

/* ============================================================
   3. Helpers
============================================================ */
function updateReceiveBadge(count) {
  const badge = document.getElementById("receiveBadge");
  if (!badge) return;

  if (count > 0) {
    badge.style.display = "inline-block";
    badge.textContent = count;
  } else {
    badge.style.display = "none";
  }
}

/* ============================================================
   4. REALTIME CHECK ORDERS - SUPABASE
============================================================ */
let lastCount = 0;

async function cekOrderBaru() {
  try {
    // Ambil semua order yang status_internal "new"
    const { data, error } = await supabase
      .from("Orders")
      .select("id")
      .eq("status_internal", "new");

    if (error) throw error;

    const newCount = Array.isArray(data) ? data.length : 0;

    updateReceiveBadge(newCount);

    if (newCount > lastCount) {
      playNotifSound();
    }

    lastCount = newCount;

  } catch (err) {
    console.error("âŒ cekOrderBaru error:", err);
  }
}

/* ============================================================
   5. LOOP REALTIME (1 detik)
============================================================ */
let intervalStarted = false;

function startRealtimeOrderChecker() {
  if (intervalStarted) return;
  intervalStarted = true;

  cekOrderBaru();
  setInterval(cekOrderBaru, 1000);
}

/* ============================================================
   6. Mark as read + go
============================================================ */
async function markOrdersAsRead() {
  try {
    const { error } = await supabase
      .from("Orders")
      .update({ status_internal: "read" })
      .eq("status_internal", "new");

    if (error) throw error;

    updateReceiveBadge(0);
    lastCount = 0;

  } catch (err) {
    console.error("âŒ markOrdersAsRead error:", err);
  }
}

function markViewedAndGo() {
  markOrdersAsRead();
  window.location.href = "recieves.html";
}

</script>
</body>
</html>


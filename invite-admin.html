<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Invite Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- QR CODE LIB -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1 {
      margin-bottom: 10px;
    }

    .card {
      background: #020617;
      padding: 16px;
      border-radius: 10px;
      max-width: 420px;
      margin: auto;
      box-shadow: 0 0 20px rgba(0,0,0,.4);
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
    }

    input {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1e293b;
    }

    button {
      background: #22c55e;
      color: #022c22;
      cursor: pointer;
    }

    button.secondary {
      background: #334155;
      color: #e5e7eb;
    }

    .success {
      color: #22c55e;
      margin-top: 10px;
    }

    .error {
      color: #ef4444;
      margin-top: 10px;
    }

    #inviteBox {
      display: none;
      margin-top: 20px;
      border-top: 1px solid #1e293b;
      padding-top: 15px;
    }

    #inviteLink {
      font-size: 12px;
    }

    #qrBox {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
    #inviteBox {
  display: none;
}

  </style>
</head>

<body>

  <div class="card">
    <h1>üë§ Invite Admin</h1>

    <form id="inviteForm">
      <input
        type="email"
        id="email"
        placeholder="Email admin"
        required
      />

     <label for="adminType">Role Admin</label>

   <select id="adminType" required>

  <!-- FRONT OFFICE -->
  <optgroup label="Front Office">
    <option value="cashier">Cashier</option>
    <option value="front_office_supervisor">Front Office Supervisor</option>
    <option value="front_office_manager">Front Office Manager</option>
  </optgroup>

  <!-- KITCHEN -->
  <optgroup label="Kitchen">
    <option value="kitchen_admin">Kitchen Admin</option>
    <option value="kitchen_supervisor">Kitchen Supervisor</option>
    <option value="kitchen_manager">Kitchen Manager</option>
  </optgroup>

  <!-- BAR -->
  <optgroup label="Bar">
    <option value="bar_admin">Bar Admin</option>
    <option value="bar_supervisor">Bar Supervisor</option>
    <option value="bar_manager">Bar Manager</option>
  </optgroup>

  <!-- ROOM / HOUSEKEEPING -->
  <optgroup label="Room / Housekeeping">
    <option value="room_admin">Room Admin</option>
    <option value="housekeeping_supervisor">Housekeeping Supervisor</option>
    <option value="housekeeping_manager">Housekeeping Manager</option>
  </optgroup>

  <!-- PURCHASING -->
  <optgroup label="Purchasing">
    <option value="purchasing_admin">Purchasing Admin</option>
    <option value="purchasing_supervisor">Purchasing Supervisor</option>
    <option value="purchasing_manager">Purchasing Manager</option>
  </optgroup>

  <!-- INVENTORY -->
  <optgroup label="Inventory">
    <option value="inventory_admin">Inventory Admin</option>
    <option value="inventory_supervisor">Inventory Supervisor</option>
    <option value="inventory_manager">Inventory Manager</option>
  </optgroup>

  <!-- FINANCE -->
  <optgroup label="Finance">
    <option value="finance_admin">Finance Admin</option>
    <option value="finance_supervisor">Finance Supervisor</option>
    <option value="finance_manager">Finance Manager</option>
  </optgroup>

  <!-- HRD -->
  <optgroup label="HRD">
    <option value="hrd_admin">HRD Admin</option>
    <option value="hrd_manager">HRD Manager</option>
  </optgroup>

  <!-- TOP LEVEL -->
  <optgroup label="Top Management">
    <option value="general_manager">General Manager</option>
  </optgroup>
</select>


      <button type="submit">Generate Invite</button>
    </form>

    <div id="result"></div>

    <!-- INVITE RESULT -->
    <div id="inviteBox">
      <label>Invite Link</label>
      <input type="text" id="inviteLink" readonly />

      <button onclick="copyInviteLink()" class="secondary">
        üìã Copy Link
      </button>

      <div id="qrBox"></div>

      <button onclick="downloadQRCode()" class="secondary">
     ‚¨á Download QR Code
     </button>

    </div>

    <button onclick="goBack()" class="secondary" style="margin-top:20px;">
      ‚¨Ö Back to Admin
    </button>
  </div>

<script src="./db-core.js"></script>
<script>
  
 if (!window.MENUVA_DB) {
  throw new Error("MENUVA_DB not loaded");
}

/* ======================================================
   OWNER ONLY GUARD
====================================================== */
async function getActiveOwner() {
  const session = await MENUVA_DB.getSession();

  if (!session || session.role !== "owner" || !session.restoID) {
    alert("Session expired. Please login again.");
    location.replace("login.html");
    throw new Error("Invalid owner context");
  }

  return session;
}

function getActiveOwner() {
  const user = JSON.parse(localStorage.getItem("activeUser") || "null");
  if (!user || user.role !== "owner" || !user.restoID) {
    throw new Error("Owner context missing");
  }
  return user;
}

/* ======================================================
   ROLE CONFIG (FINAL ‚Äì HOTEL 5‚òÖ)
====================================================== */
const ADMIN_ROLES = {
  /* ===== FRONT OFFICE ===== */
  cashier: "Cashier",
  front_office_supervisor: "Front Office Supervisor",
  front_office_manager: "Front Office Manager",

  /* ===== KITCHEN ===== */
  kitchen_admin: "Kitchen Admin",
  kitchen_supervisor: "Kitchen Supervisor",
  kitchen_manager: "Kitchen Manager",

  /* ===== BAR ===== */
  bar_admin: "Bar Admin",
  bar_supervisor: "Bar Supervisor",
  bar_manager: "Bar Manager",

  /* ===== ROOM / HOUSEKEEPING ===== */
  room_admin: "Room Admin",
  housekeeping_supervisor: "Housekeeping Supervisor",
  housekeeping_manager: "Housekeeping Manager",

  /* ===== PURCHASING ===== */
  purchasing_admin: "Purchasing Admin",
  purchasing_supervisor: "Purchasing Supervisor",
  purchasing_manager: "Purchasing Manager",

  /* ===== INVENTORY / WAREHOUSE ===== */
  inventory_admin: "Inventory Admin",
  inventory_supervisor: "Inventory Supervisor",
  inventory_manager: "Inventory Manager",

  /* ===== FINANCE ===== */
  finance_admin: "Finance Admin",
  finance_supervisor: "Finance Supervisor",
  finance_manager: "Finance Manager",

  /* ===== HRD ===== */
  hrd_admin: "HRD Admin",
  hrd_manager: "HRD Manager",

  /* ===== IT / SYSTEM ===== */
  system_admin: "System Admin",

  /* ===== TOP LEVEL ===== */
  general_manager: "General Manager"
};


/* ======================================================
   DOM
====================================================== */
const form = document.getElementById("inviteForm");
const result = document.getElementById("result");

/* ======================================================
   TOKEN
====================================================== */
function generateToken(len = 32) {
  const chars =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from({ length: len }, () =>
    chars[Math.floor(Math.random() * chars.length)]
  ).join("");
}

/* ======================================================
   SUBMIT INVITE (DB-CORE)
====================================================== */
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  result.innerHTML = "";

  let owner;
  try {
    owner = await getActiveOwner();
  } catch {
    return;
  }

  const email = document.getElementById("email").value.trim().toLowerCase();
  const role = document.getElementById("adminType").value;

  if (!email) {
    result.innerHTML = "<div class='error'>‚ùå Email wajib diisi</div>";
    return;
  }

  if (!ADMIN_ROLES[role]) {
    result.innerHTML = "<div class='error'>‚ùå Role tidak valid</div>";
    return;
  }

  const allInvites = await MENUVA_DB.getAll("admin_invites");

  const activeInvite = allInvites.find(
    i =>
      i.restoID === owner.restoID &&
      i.email === email &&
      i.status === "pending"
  );

  if (activeInvite) {
    showInvite(activeInvite);
    result.innerHTML = `
      <div class="success">
        ‚ÑπÔ∏è Invite pending untuk <b>${email}</b> sudah ada
      </div>`;
    return;
  }

  const invite = {
    id: "INV-" + crypto.randomUUID(),
    restoID: owner.restoID,
    email,
    role,
    invitedBy: owner.userID,
    token: generateToken(),
    status: "pending",
    createdAt: Date.now()
  };

  await MENUVA_DB.add("admin_invites", invite);

  showInvite(invite);

  result.innerHTML = `
    <div class="success">
      ‚úÖ Invite <b>${ADMIN_ROLES[role]}</b> berhasil dibuat
    </div>`;

  form.reset();
});

/* ======================================================
   SHOW INVITE
====================================================== */
function showInvite(invite) {
  const basePath = location.pathname.replace("invite-admin.html", "");
  const inviteURL =
    location.origin + basePath + "accept-invite.html?token=" + invite.token;

  document.getElementById("inviteLink").value = inviteURL;
  document.getElementById("inviteBox").style.display = "block";

  generateQRCode(inviteURL);
}

/* ======================================================
   QR + COPY
====================================================== */
function copyInviteLink() {
  navigator.clipboard.writeText(
    document.getElementById("inviteLink").value
  );
  alert("‚úÖ Invite link copied");
}

function generateQRCode(url) {
  const qrBox = document.getElementById("qrBox");
  qrBox.innerHTML = "";
  new QRCode(qrBox, { text: url, width: 180, height: 180 });
}

/* ======================================================
   BACK
====================================================== */
function goBack() {
  location.replace("admin.html");
}
</script>

</body>
</html>

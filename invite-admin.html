<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Invite Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- QR CODE LIB -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      padding: 20px;
    }

    h1 {
      margin-bottom: 10px;
    }

    .card {
      background: #020617;
      padding: 16px;
      border-radius: 10px;
      max-width: 420px;
      margin: auto;
      box-shadow: 0 0 20px rgba(0,0,0,.4);
    }

    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
    }

    input {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1e293b;
    }

    button {
      background: #22c55e;
      color: #022c22;
      cursor: pointer;
    }

    button.secondary {
      background: #334155;
      color: #e5e7eb;
    }

    .success {
      color: #22c55e;
      margin-top: 10px;
    }

    .error {
      color: #ef4444;
      margin-top: 10px;
    }

    #inviteBox {
      display: none;
      margin-top: 20px;
      border-top: 1px solid #1e293b;
      padding-top: 15px;
    }

    #inviteLink {
      font-size: 12px;
    }

    #qrBox {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
  </style>
</head>

<body>

  <div class="card">
    <h1>üë§ Invite Admin</h1>

    <form id="inviteForm">
      <input
        type="email"
        id="email"
        placeholder="Email admin"
        required
      />
      <select id="adminType" required>
  <option value="">-- Pilih Tipe Admin --</option>
  <option value="cashier">üßæ Admin Cashier</option>
  <option value="menu">üçΩÔ∏è Admin Menu</option>
  <option value="room">üè® Admin Room</option>
</select>

      <button type="submit">Generate Invite</button>
    </form>

    <div id="result"></div>

    <!-- INVITE RESULT -->
    <div id="inviteBox">
      <label>Invite Link</label>
      <input type="text" id="inviteLink" readonly />

      <button onclick="copyInviteLink()" class="secondary">
        üìã Copy Link
      </button>

      <div id="qrBox"></div>

      <button onclick="downloadQRCode()" class="secondary">
     ‚¨á Download QR Code
     </button>

    </div>

    <button onclick="goBack()" class="secondary" style="margin-top:20px;">
      ‚¨Ö Back to Admin
    </button>
  </div>

<script>
/* ======================================================
   OWNER ONLY GUARD (HARD)
====================================================== */
(function ownerGuard() {
  const activeUser = JSON.parse(localStorage.getItem("activeUser") || "null");

  if (!activeUser || activeUser.role !== "owner" || !activeUser.restoID) {
    alert("Session expired. Please login again.");
    location.replace("login.html");
    throw new Error("Invalid owner context");
  }

  // simpan flag navigasi aman
  sessionStorage.setItem("fromInviteAdmin", "1");
})();

/* ======================================================
   SAFE GET ACTIVE OWNER (HELPER)
====================================================== */
function getActiveOwner() {
  const user = JSON.parse(localStorage.getItem("activeUser") || "null");
  if (!user || user.role !== "owner" || !user.restoID) {
    throw new Error("Owner context missing");
  }
  return user;
}

/* ======================================================
   ADMIN CONFIG
====================================================== */
const ADMIN_CONFIG = {
  cashier: {
    label: "Admin Cashier",
    redirect: "recievers.html",
    permissions: ["orders", "payments"]
  },
  menu: {
    label: "Admin Menu",
    redirect: "menu-manager.html",
    permissions: ["menu", "stock"]
  },
  room: {
    label: "Admin Room",
    redirect: "room-manager.html",
    permissions: ["room"]
  }
};

/* ======================================================
   DOM
====================================================== */
const form = document.getElementById("inviteForm");
const result = document.getElementById("result");

/* ======================================================
   UTIL
====================================================== */
function generateToken(len = 24) {
  const chars =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  let token = "";
  for (let i = 0; i < len; i++) {
    token += chars[Math.floor(Math.random() * chars.length)];
  }
  return token;
}

/* ======================================================
   SUBMIT INVITE
====================================================== */
form.addEventListener("submit", (e) => {
  e.preventDefault();
  result.innerHTML = "";

  let owner;
  try {
    owner = getActiveOwner();
  } catch (err) {
    alert("Session expired. Please login again.");
    location.replace("login.html");
    return;
  }

  const email = document.getElementById("email").value.trim().toLowerCase();
  const adminType = document.getElementById("adminType").value;

  if (!email) {
    result.innerHTML = "<div class='error'>‚ùå Email wajib diisi</div>";
    return;
  }

  if (!ADMIN_CONFIG[adminType]) {
    result.innerHTML = "<div class='error'>‚ùå Pilih tipe admin</div>";
    return;
  }

  const invites =
    JSON.parse(localStorage.getItem("menuvaInvites")) || [];

  /* --------------------------------------------------
     CEK INVITE AKTIF (1 ADMIN TYPE = 1 INVITE AKTIF)
  -------------------------------------------------- */
  const existingInvite = invites.find(
    i =>
      i.restoID === owner.restoID &&
      i.adminType === adminType &&
      !i.isUsed &&
      new Date() < new Date(i.expireAt)
  );

  if (existingInvite) {
    showInvite(existingInvite);
    result.innerHTML = `
      <div class="success">
        ‚ÑπÔ∏è Invite aktif untuk <b>${ADMIN_CONFIG[adminType].label}</b> sudah ada
      </div>`;
    return;
  }

  /* --------------------------------------------------
     CREATE INVITE
  -------------------------------------------------- */
  const invite = {
    inviteID: "INV-" + crypto.randomUUID(),
    email,
    restoID: owner.restoID,
    ownerID: owner.userID,
    role: "admin",
    adminType,
    permissions: ADMIN_CONFIG[adminType].permissions,
    redirect: ADMIN_CONFIG[adminType].redirect,

    // üîë PENTING: token hanya untuk aktivasi awal
    token: generateToken(),
    isUsed: false,

    createdAt: new Date().toISOString(),
    expireAt: new Date(Date.now() + 86400000).toISOString() // 24 jam
  };

  invites.push(invite);
  localStorage.setItem("menuvaInvites", JSON.stringify(invites));
  localStorage.setItem("lastInviteAdminType", adminType);

  showInvite(invite);

  result.innerHTML = `
    <div class="success">
      ‚úÖ Invite <b>${ADMIN_CONFIG[adminType].label}</b> berhasil dibuat
    </div>`;

  form.reset();
});

/* ======================================================
   SHOW INVITE
====================================================== */
function showInvite(invite) {
  const adminCfg = ADMIN_CONFIG[invite.adminType];

  const basePath = location.pathname.replace("invite-admin.html", "");
  const inviteURL =
    location.origin + basePath + "accept-invite.html?token=" + invite.token;

  document.getElementById("inviteLink").value = inviteURL;
  document.getElementById("inviteBox").style.display = "block";

  result.innerHTML = adminCfg
    ? `<div class="success">üîë Invite aktif: <b>${adminCfg.label}</b></div>`
    : `<div class="success">üîë Invite aktif</div>`;

  generateQRCode(inviteURL);
}

/* ======================================================
   QR + COPY
====================================================== */
function copyInviteLink() {
  const input = document.getElementById("inviteLink");
  navigator.clipboard.writeText(input.value);
  alert("‚úÖ Invite link copied");
}

function generateQRCode(url) {
  const qrBox = document.getElementById("qrBox");
  qrBox.innerHTML = "";
  new QRCode(qrBox, {
    text: url,
    width: 180,
    height: 180
  });
}

function downloadQRCode() {
  const canvas = document.querySelector("#qrBox canvas");
  if (!canvas) {
    alert("QR code belum tersedia");
    return;
  }
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/png");
  link.download = "invite-admin-qr.png";
  link.click();
}

/* ======================================================
   SAFE BACK
====================================================== */
function goBack() {
  sessionStorage.removeItem("fromInviteAdmin");
  location.replace("admin.html");
}

/* ======================================================
   LOAD ACTIVE INVITE
====================================================== */
window.addEventListener("DOMContentLoaded", () => {
  let owner;
  try {
    owner = getActiveOwner();
  } catch {
    return;
  }

  const invites =
    JSON.parse(localStorage.getItem("menuvaInvites")) || [];
  const lastType = localStorage.getItem("lastInviteAdminType");

  let activeInvite = null;

  if (lastType) {
    activeInvite = invites.find(
      i =>
        i.restoID === owner.restoID &&
        i.adminType === lastType &&
        !i.isUsed &&
        new Date() < new Date(i.expireAt)
    );
  }

  if (!activeInvite) {
    activeInvite = invites.find(
      i =>
        i.restoID === owner.restoID &&
        !i.isUsed &&
        new Date() < new Date(i.expireAt)
    );
  }

  if (activeInvite) {
    showInvite(activeInvite);
    const select = document.getElementById("adminType");
    if (select) select.value = activeInvite.adminType;
  }
});
</script>

</body>
</html>
